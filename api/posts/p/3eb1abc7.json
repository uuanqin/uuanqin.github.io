{"data":{"title":"CSAPP LAB-5 æ‰‹å†™åŠ¨æ€å­˜å‚¨åˆ†é…å™¨","slug":"CSAPP LABS/CSAPP LAB-5 æ‰‹å†™åŠ¨æ€å­˜å‚¨åˆ†é…å™¨","description":"è¯¾æœ¬æ¡ˆä¾‹å®è·µ","date":"2024-06-13T04:01:31.000Z","updated":"2024-06-19T11:29:12.531Z","language":"zh-CN","comments":true,"url":"p/3eb1abc7/","cover":"https://cdn.gallery.uuanqin.top/img/20240617204205.webp","images":[],"content":"<p>æˆ‘ä¹Ÿå¤§æ¦‚å¯Ÿè§‰åˆ°æˆ‘ä»¬è¯¾ç¨‹çš„å®éªŒæ˜¯æŒ‘ç€ CSAPP ä¸­åŸç‰ˆå®éªŒå»åšçš„ï¼Œå¹¶è¿›è¡Œäº†ç®€åŒ–ï¼Œæ‰€ä»¥å’Œç½‘ä¸Šçš„å®éªŒé¡ºåºä¸å¤ªä¸€æ ·ï¼Œä½†å†…å®¹æ˜¯å¤§è‡´ç›¸åŒçš„ã€‚</p>\n\n<div class=\"callout\" data-callout=\"notice\">\n<div class=\"callout-title\">\n<div class=\"callout-title-icon\">\n<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-pencil\"><path d=\"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z\"/><path d=\"m15 5 4 4\"/></svg>\n</div>\n<div class=\"callout-title-inner\">CSAPP LAB å®éªŒ</div>\n</div>\n<div class=\"callout-content\"><p></p>\n<ul>\n<li><a class=\"uuanqin-bilink\" target=\"_blank\" href=\"/p/c5970284/\"><span class=\"yukari\">ç«™å†…æ–‡ç« </span>CSAPP LAB-1 ä½æ“ä½œ</a></li>\n<li><a class=\"uuanqin-bilink\" target=\"_blank\" href=\"/p/d1f3cf37/\"><span class=\"yukari\">ç«™å†…æ–‡ç« </span>CSAPP LAB-2 äºŒè¿›åˆ¶ç‚¸å¼¹å®éªŒ</a></li>\n<li><a class=\"uuanqin-bilink\" target=\"_blank\" href=\"/p/67787353/\"><span class=\"yukari\">ç«™å†…æ–‡ç« </span>CSAPP LAB-3 ç¼“å†²åŒºæº¢å‡ºç‚¸å¼¹</a></li>\n<li><a class=\"uuanqin-bilink\" target=\"_blank\" href=\"/p/9d6b717/\"><span class=\"yukari\">ç«™å†…æ–‡ç« </span>CSAPP LAB-4 ä»£ç ä¼˜åŒ–</a></li>\n<li>CSAPP LAB-5 æ‰‹å†™åŠ¨æ€å­˜å‚¨åˆ†é…å™¨ï¼ˆæœ¬æ–‡ï¼‰</li>\n</ul>\n</div></div><p>è¿™æ¬¡çš„å®éªŒ<strong>å»ºè®®å…ˆçœ‹è¯¾æœ¬çš„ç¬¬ä¹ç« çš„ 9.9 éƒ¨åˆ†</strong>ï¼ˆã€ŠCSAPPã€‹ç¬¬ä¸‰ç‰ˆï¼‰ï¼Œç†è§£å…¶ä¸­çš„å†…å®¹åè¿›è¡Œå®ç°ã€‚è€Œä¸”å¤§éƒ¨åˆ†ä»£ç è¯¾æœ¬ä¸Šéƒ½æœ‰ã€‚ä¸ç®¡ä½ ç°åœ¨ã€ŠCSAPPã€‹å­¦åˆ°å“ªä¸€ä¸ªéƒ¨åˆ†ï¼Œéƒ½å¯ä»¥ç›´æ¥çœ‹ 9.9 ç« ï¼Œä¸ç”¨æ‹…å¿ƒæ²¡æœ‰é“ºå«å†…å®¹ã€‚</p>\n<p>æœ¬æ–‡å°†ä»‹ç»ä¸€ä¸ªåŠ¨æ€å­˜å‚¨åˆ†é…å™¨çš„ç®€å•å®ç°ï¼šéšå¼ç©ºé—²é“¾è¡¨ + ç«‹å³è¾¹ç•Œæ ‡è®°åˆå¹¶æ–¹å¼ + é¦–æ¬¡åŒ¹é…/ä¸‹æ¬¡åŒ¹é…ç®—æ³•ã€‚æ›´é«˜çº§çš„å®ç°å¯ä»¥çœ‹æ–‡æœ«å‚è€ƒæ–‡ç« ã€‚</p>\n<blockquote>\n<p>è¿™æ˜¯æˆ‘ CSAPP è¯¾ç¨‹çš„æœ€åä¸€ä¸ªå®éªŒäº†ï¼Œæ¯æ¬¡ä¸“æŒ‘ğŸ‘©åŠ©æ•™éªŒæ”¶ï¼Œæ¸©æŸ”è´´å¿ƒç»™åˆ†é«˜ğŸ˜ï¼</p>\n</blockquote>\n<h1 id=\"å®éªŒä»‹ç»å’Œè¦æ±‚\"><a class=\"markdownIt-Anchor\" href=\"#å®éªŒä»‹ç»å’Œè¦æ±‚\"></a> å®éªŒä»‹ç»å’Œè¦æ±‚</h1>\n<p>æœ¬å®éªŒéœ€è¦ç”¨ c è¯­è¨€å®ç°ä¸€ä¸ªåŠ¨æ€çš„å­˜å‚¨åˆ†é…å™¨ï¼Œä¹Ÿå°±æ˜¯ä½ è‡ªå·±ç‰ˆæœ¬çš„ <code>malloc</code>ï¼Œ<code>free</code>ï¼Œ<code>realloc</code> å‡½æ•°ã€‚</p>\n<p>è§£å‹æ–‡ä»¶ï¼š</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tar xvf malloclab-handout.tar</span><br></pre></td></tr></table></figure>\n<p>æˆ‘ä»¬éœ€è¦ä¿®æ”¹çš„å”¯ä¸€æ–‡ä»¶æ˜¯ <code>mm.c</code>ï¼ŒåŒ…å«å¦‚ä¸‹å‡ ä¸ªéœ€è¦å®ç°çš„å‡½æ•°ï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">mm_init:åœ¨è°ƒç”¨mm_mallocï¼Œmm_reallocæˆ–mm_freeä¹‹å‰ï¼Œè°ƒç”¨mm_initè¿›è¡Œåˆå§‹åŒ–ï¼Œæ­£ç¡®è¿”å›0ã€‚</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">mm_init</span><span class=\"params\">(<span class=\"type\">void</span>)</span>; </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">mm_mallocï¼šåœ¨å †åŒºåŸŸåˆ†é…æŒ‡å®šå¤§å°çš„å—ï¼Œåˆ†é…çš„ç©ºé—´ï¼Œè¿”å›çš„æŒ‡é’ˆåº”è¯¥æ˜¯8å­—èŠ‚å¯¹é½çš„</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"type\">void</span> *<span class=\"title function_\">mm_malloc</span><span class=\"params\">(<span class=\"type\">size_t</span> size)</span>; </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">mm_free:é‡Šæ”¾æŒ‡é’ˆæŒ‡å‘çš„block</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">mm_free</span><span class=\"params\">(<span class=\"type\">void</span> *ptr)</span>; </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">è¿”å›æŒ‡å‘ä¸€ä¸ªå¤§å°ä¸ºsizeçš„åŒºåŸŸæŒ‡é’ˆï¼Œæ»¡è¶³ä¸€ä¸‹æ¡ä»¶ï¼š</span></span><br><span class=\"line\"><span class=\"comment\">* if ptr is NULL, the call is equivalent to mm_malloc(size); </span></span><br><span class=\"line\"><span class=\"comment\">* if size is equal to zero, the call is equivalent to mm_free(ptr); </span></span><br><span class=\"line\"><span class=\"comment\">* if ptr is not NULLï¼šå…ˆæŒ‰ç…§sizeæŒ‡å®šçš„å¤§å°åˆ†é…ç©ºé—´ï¼Œå°†åŸæœ‰æ•°æ®ä»å¤´åˆ°å°¾æ‹·è´åˆ°æ–°åˆ†é…çš„å†…å­˜åŒºåŸŸï¼Œè€Œåé‡Šæ”¾åŸæ¥ptræ‰€æŒ‡å†…å­˜åŒºåŸŸ</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"type\">void</span> *<span class=\"title function_\">mm_realloc</span><span class=\"params\">(<span class=\"type\">void</span> *ptr, <span class=\"type\">size_t</span> size)</span>;</span><br></pre></td></tr></table></figure>\n<p>è®°ä½å“¦ï¼Œæœ¬æ¬¡å®éªŒçš„ä»»åŠ¡è¦æ±‚ä¹‹ä¸€æ˜¯æŒ‡é’ˆæ˜¯ 8 å­—èŠ‚å¯¹é½çš„ã€‚</p>\n<p>æˆ‘ä»¬å¯ä»¥è°ƒç”¨å®éªŒæä¾›ç»™æˆ‘ä»¬çš„å‡½æ•°ï¼Œè¿™äº›å‡½æ•°å®šä¹‰åœ¨ <code>memory.c</code> ä¸­ï¼š</p>\n<ul>\n<li><code>void *mem_sbrk(int incr)</code>: Expands the heap by incr bytes, where incr is a positive non-zero integer and returns a generic pointer to the first byte of the newly allocated heap area.</li>\n<li><code>void *mem_heap_lo(void)</code>: Returns a generic pointer to the first byte in the heap.</li>\n<li><code>void *mem_heap_hi(void)</code>: Returns a generic pointer to the last byte in the heap.</li>\n<li><code>size_t mem_heapsize(void)</code>: Returns the current size of the heap in bytes.</li>\n<li><code>size_t mem_pagesize(void)</code>: Returns the systemâ€™s page size in bytes (4K onLinux systems).</li>\n</ul>\n<p>åœ¨è¿™ç¯‡æ–‡ç« çš„å®ç°æ–¹å¼ä¸­ï¼Œåªéœ€è¦ä½¿ç”¨ <code>void *mem_sbrk(int incr)</code>ï¼Œä¸æ ‡å‡†å®ç°ä¸åŒçš„æ˜¯ï¼Œè¿™ä¸ªå‡½æ•°æ‹’ç»æ”¶ç¼©å †çš„è¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯ä¸èƒ½è¾“å…¥è´Ÿæ•°ã€‚<code>mem_sbrk</code> çš„ä½œç”¨å¯ä»¥ç»“åˆè¯¾æœ¬ 9.9 ç« è¿›è¡Œç†è§£ã€‚</p>\n<p>éªŒè¯æˆ‘ä»¬çš„åŠ¨æ€çš„å­˜å‚¨åˆ†é…å™¨ï¼š</p>\n<ul>\n<li><code>mdriver.c</code>ï¼šè´Ÿè´£æµ‹è¯• <code>mm.c</code> çš„æ­£ç¡®æ€§,ç©ºé—´åˆ©ç”¨ç‡å’Œååé‡</li>\n<li>æ‰§è¡Œ <code>make</code> æŒ‡ä»¤ç”Ÿæˆ <code>mdriver</code> å¯æ‰§è¡Œæ–‡ä»¶</li>\n<li><code>mdriver</code> çš„ä½¿ç”¨ï¼š\n<ul>\n<li><code>-f &lt;tracefile&gt;</code>:  <code>-f</code> åæ·»åŠ ä¸€äº› trace file æ¥æµ‹è¯•æˆ‘ä»¬å®ç°çš„å‡½æ•°</li>\n<li><code>-V</code>: æ‰“å°å‡ºè¯Šæ–­ä¿¡æ¯ã€‚</li>\n<li>ä¾‹å¦‚ï¼š<code>./mdriver -V  -f short1-bal.rep</code></li>\n</ul>\n</li>\n</ul>\n<p>ä¸€äº›ç¼–ç¨‹è§„åˆ™ï¼š</p>\n<ul>\n<li>ä¸èƒ½æ”¹å˜ <code>mm.c</code> ä¸­å‡½æ•°æ¥å£</li>\n<li>ä¸èƒ½ç›´æ¥è°ƒç”¨ä»»ä½•å†…å­˜ç®¡ç†çš„åº“å‡½æ•°å’Œç³»ç»Ÿå‡½æ•° <code>malloc</code>, <code>calloc</code>, <code>free</code>, <code>realloc</code>, <code>sbrk</code>, <code>brk</code></li>\n<li>ä¸èƒ½å®šä¹‰ä»»ä½•å…¨å±€æˆ–è€…é™æ€å¤åˆæ•°æ®ç»“æ„å¦‚ <code>arrays</code>, <code>structs</code>, <code>trees</code>ï¼Œå…è®¸ä½¿ç”¨ <code>integers</code>, <code>floats</code> ä»¥åŠ <code>pointers</code> ç­‰ç®€å•æ•°æ®ç±»å‹</li>\n<li>è¿”å›çš„æŒ‡é’ˆéœ€è¦ 8 å­—èŠ‚å¯¹é½</li>\n</ul>\n<h1 id=\"å…³é”®æ¦‚å¿µ\"><a class=\"markdownIt-Anchor\" href=\"#å…³é”®æ¦‚å¿µ\"></a> å…³é”®æ¦‚å¿µ</h1>\n<p>æˆ‘æŠŠè¯¾æœ¬æ¶‰åŠåˆ°çš„å…³é”®æ¦‚å¿µæ¨¡å‹ç®€è¦ä»‹ç»ä¸€ä¸‹ã€‚</p>\n<p>æœ¬æ–‡ä»‹ç»çš„æ˜¯éšå¼ç©ºé—²é“¾è¡¨ + ç«‹å³è¾¹ç•Œæ ‡è®°åˆå¹¶æ–¹å¼ + é¦–æ¬¡åŒ¹é…/ä¸‹æ¬¡åŒ¹é…ç®—æ³•ã€‚</p>\n<p>æ›´å¤šè¯¦ç»†å†…å®¹ç†è§£å°±çœ‹ä¸‹ä¸€èŠ‚çš„ä»£ç æ³¨é‡Šå’¯ï¼</p>\n<h2 id=\"éšå¼ç©ºé—²é“¾è¡¨çš„æ’å®šå½¢å¼\"><a class=\"markdownIt-Anchor\" href=\"#éšå¼ç©ºé—²é“¾è¡¨çš„æ’å®šå½¢å¼\"></a> éšå¼ç©ºé—²é“¾è¡¨çš„æ’å®šå½¢å¼</h2>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/20240617202828.webp\" alt=\"image.png\" /></p>\n<p>ä¸€ä¸ªæ­£æ–¹å½¢è¡¨ç¤º 4 å­—èŠ‚ï¼ˆä¸€ä¸ªå­—ï¼‰ï¼Œè™šçº¿è¡¨ç¤ºåŒå­—å¯¹é½æ ‡å¿—ã€‚æ­£æ–¹å½¢ä¸­çš„å¤´éƒ¨å°¾éƒ¨æ ‡è®°ä¸º <code>size/is_alloc</code>ã€‚</p>\n<h2 id=\"æ ‡è®°è¾¹ç•Œåˆå¹¶\"><a class=\"markdownIt-Anchor\" href=\"#æ ‡è®°è¾¹ç•Œåˆå¹¶\"></a> æ ‡è®°è¾¹ç•Œåˆå¹¶</h2>\n<p>Knuth æå‡ºäº†è¾¹ç•Œæ ‡è®°æŠ€æœ¯ï¼Œå…è®¸åœ¨å¸¸æ•°æ—¶é—´å†…è¿›è¡Œå¯¹å‰é¢çš„å—çš„åˆå¹¶ã€‚</p>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/20240617001201.webp\" alt=\"image.png\" /></p>\n<p>è¿™ç§æ€æƒ³ï¼Œæ˜¯åœ¨æ¯ä¸ªå—çš„ç»“å°¾å¤„æ·»åŠ ä¸€ä¸ªè„šéƒ¨ï¼ˆfooterï¼Œè¾¹ç•Œæ ‡è®°ï¼‰ï¼Œå…¶ä¸­è„šéƒ¨å°±æ˜¯å¤´éƒ¨çš„ä¸€ä¸ªå‰¯æœ¬ã€‚å¦‚æœæ¯ä¸ªå—åŒ…æ‹¬è¿™æ ·ä¸€ä¸ªè„šéƒ¨ï¼Œé‚£ä¹ˆåˆ†é…å™¨å°±å¯ä»¥é€šè¿‡æ£€æŸ¥å®ƒçš„è„šéƒ¨ï¼Œåˆ¤æ–­å‰é¢ä¸€ä¸ªå—çš„èµ·å§‹ä½ç½®å’ŒçŠ¶æ€ï¼Œè¿™ä¸ªè„šéƒ¨æ€»æ˜¯åœ¨è·å½“å‰å—å¼€å§‹ä½ç½®ä¸€ä¸ªå­—çš„è·ç¦»ã€‚</p>\n<p>è€ƒè™‘å½“åˆ†é…å™¨é‡Šæ”¾å½“å‰å—æ—¶æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„æƒ…å†µï¼š</p>\n<ol>\n<li>å‰é¢çš„å—å’Œåé¢çš„å—éƒ½æ˜¯å·²åˆ†é…çš„ã€‚</li>\n<li>å‰é¢çš„å—æ˜¯å·²åˆ†é…çš„ï¼Œåé¢çš„å—æ˜¯ç©ºé—²çš„ã€‚</li>\n<li>å‰é¢çš„å—æ˜¯ç©ºé—²çš„ï¼Œè€Œåé¢çš„å—æ˜¯å·²åˆ†é…çš„ã€‚</li>\n<li>å‰é¢çš„å’Œåé¢çš„å—éƒ½æ˜¯ç©ºé—²çš„ã€‚</li>\n</ol>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/20240617001349.webp\" alt=\"image.png\" /></p>\n<h2 id=\"åŒ¹é…ç®—æ³•\"><a class=\"markdownIt-Anchor\" href=\"#åŒ¹é…ç®—æ³•\"></a> åŒ¹é…ç®—æ³•</h2>\n<p>åŒ¹é…ç®—æ³•ï¼š</p>\n<ul>\n<li>é¦–æ¬¡åŒ¹é…ï¼ˆFirst Fitï¼‰ã€‚ä»å¤´å¼€å§‹æœç´¢ç©ºé—²é“¾è¡¨ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªåˆé€‚çš„ç©ºé—²å—ã€‚\n<ul>\n<li>ä¼˜ç‚¹ï¼šè¶‹å‘äºå°†å¤§çš„ç©ºé—²å—ä¿ç•™åœ¨é“¾è¡¨çš„åé¢ã€‚</li>\n<li>ç¼ºç‚¹ï¼šå®ƒè¶‹å‘äºåœ¨é è¿‘é“¾è¡¨èµ·å§‹å¤„ç•™ä¸‹å°ç©ºé—²å—çš„ã€Œç¢ç‰‡ã€ï¼Œå¢å¤§äº†å¯¹è¾ƒå¤§å—çš„æœç´¢æ—¶é—´ã€‚</li>\n</ul>\n</li>\n<li>ä¸‹ä¸€æ¬¡é€‚é…ï¼ˆNext Fitï¼‰ã€‚å’Œé¦–æ¬¡é€‚é…å¾ˆç›¸ä¼¼ï¼Œåªä¸è¿‡ä¸æ˜¯ä»é“¾è¡¨çš„èµ·å§‹å¤„å¼€å§‹æ¯æ¬¡æœç´¢ï¼Œè€Œæ˜¯ä»ä¸Šä¸€æ¬¡æŸ¥è¯¢ç»“æŸçš„åœ°æ–¹å¼€å§‹ã€‚ç”± Donald Knuth æå‡ºã€‚åŸºäºæ€æƒ³ï¼šå¦‚æœä¸Šä¸€æ¬¡åœ¨æŸä¸ªç©ºé—²å—é‡Œå‘ç°äº†ä¸€ä¸ªåŒ¹é…ï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½ä¸‹ä¸€æ¬¡æˆ‘ä»¬ä¹Ÿèƒ½åœ¨è¿™ä¸ªå‰©ä½™å—ä¸­å‘ç°åŒ¹é…ã€‚\n<ul>\n<li>ä¼˜ç‚¹ï¼šæ¯”é¦–æ¬¡é€‚é…è¿è¡Œèµ·æ¥æ˜æ˜¾å¿«ä¸€äº›ã€‚</li>\n<li>ç¼ºç‚¹ï¼šå†…å­˜åˆ©ç”¨ç‡æ¯”é¦–æ¬¡åŒ¹é…ä½ã€‚</li>\n</ul>\n</li>\n<li>æœ€ä½³é€‚é…ï¼ˆBest Fitï¼‰ã€‚æœ€ä½³é€‚é…æ£€æŸ¥æ¯ä¸ªç©ºé—²å—ï¼Œé€‰æ‹©é€‚åˆæ‰€éœ€è¯·æ±‚å¤§å°çš„æœ€å°ç©ºé—²å—ã€‚\n<ul>\n<li>ä¼˜ç‚¹ï¼šå†…å­˜åˆ©ç”¨ç‡è¾ƒé«˜ã€‚</li>\n<li>ç¼ºç‚¹ï¼šåœ¨ç®€å•ç©ºé—²é“¾è¡¨ç»„ç»‡ç»“æ„ä¸­ï¼ˆæ¯”å¦‚ä¸Šé¢æåˆ°çš„éšå¼ç©ºé—²é“¾è¡¨ï¼‰ï¼Œéœ€è¦å¯¹å †è¿›è¡Œå½»åº•æœç´¢ã€‚</li>\n</ul>\n</li>\n</ul>\n<h1 id=\"mmc-æ–‡ä»¶\"><a class=\"markdownIt-Anchor\" href=\"#mmc-æ–‡ä»¶\"></a> <code>mm.c</code> æ–‡ä»¶</h1>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\"> * mm-naive.c - The fastest, least memory-efficient malloc package.</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * In this naive approach, a block is allocated by simply incrementing</span></span><br><span class=\"line\"><span class=\"comment\"> * the brk pointer.  A block is pure payload. There are no headers or</span></span><br><span class=\"line\"><span class=\"comment\"> * footers.  Blocks are never coalesced or reused. Realloc is</span></span><br><span class=\"line\"><span class=\"comment\"> * implemented directly using mm_malloc and mm_free.</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * NOTE TO STUDENTS: Replace this header comment with your own header</span></span><br><span class=\"line\"><span class=\"comment\"> * comment that gives a high level description of your solution.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;assert.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;mm.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;memlib.h&quot;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/*********************************************************</span></span><br><span class=\"line\"><span class=\"comment\"> * NOTE TO STUDENTS: Before you do anything else, please</span></span><br><span class=\"line\"><span class=\"comment\"> * provide your team information in the following struct.</span></span><br><span class=\"line\"><span class=\"comment\"> ********************************************************/</span></span><br><span class=\"line\"><span class=\"type\">team_t</span> team = &#123;</span><br><span class=\"line\">    <span class=\"comment\">/* Team name */</span></span><br><span class=\"line\">    <span class=\"string\">&quot;SA23xxxxxx&quot;</span>,</span><br><span class=\"line\">    <span class=\"comment\">/* First member&#x27;s full name */</span></span><br><span class=\"line\">    <span class=\"string\">&quot;uuanqin&quot;</span>,</span><br><span class=\"line\">    <span class=\"comment\">/* First member&#x27;s email address */</span></span><br><span class=\"line\">    <span class=\"string\">&quot;uuanqin@uuanqin.top&quot;</span>,</span><br><span class=\"line\">    <span class=\"comment\">/* Second member&#x27;s full name (leave blank if none) */</span></span><br><span class=\"line\">    <span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">    <span class=\"comment\">/* Second member&#x27;s email address (leave blank if none) */</span></span><br><span class=\"line\">    <span class=\"string\">&quot;&quot;</span>&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/*********  ä¸€äº›å¿…è¦çš„å® ***************/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* single word (4) or double word (8) alignment */</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> ALIGNMENT 8</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* rounds up to the nearest multiple of ALIGNMENT */</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> ALIGN(size) (((size) + (ALIGNMENT - 1)) &amp; ~0x7)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SIZE_T_SIZE (ALIGN(sizeof(size_t)))</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// åŸºæœ¬å¸¸é‡</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> WSIZE 4       <span class=\"comment\">// å­—çš„å¤§å°ï¼ˆå¤´éƒ¨ã€è„šéƒ¨å¤§å°ï¼‰</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> DSIZE 8       <span class=\"comment\">// åŒå­—å¤§å°</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CHUNKSIZE (1 &lt;&lt; 12)  <span class=\"comment\">// æ¯æ¬¡æ‰©å±•å †æ—¶ä½¿ç”¨è¿™ä¸ªå¤§å°</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> MAX(x, y) ((x) &gt; (y) ? (x) : (y))</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> PACK(size, is_alloc) ((size) | (is_alloc))   <span class=\"comment\">// å°†å¤§å°å’Œåˆ†é…ä½æ‰“åŒ…ç»„è£…</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// è¯»å–/å†™å…¥ æŒ‡å®šä½ç½®çš„å€¼</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> GET(p) (*(unsigned int *)(p))                </span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> PUT(p, val) (*(unsigned int *)(p) = (val))</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// è·å–å¤´éƒ¨çš„ä¿¡æ¯</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> GET_SIZE(p) (GET(p) &amp; ~0x7)</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> GET_ALLOC(p) (GET(p) &amp; 0x1)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// ç»™å®šå—çš„æŒ‡é’ˆbpï¼Œè·å–å…¶å¤´éƒ¨å’Œè„šéƒ¨çš„æŒ‡é’ˆï¼ˆæ³¨æ„ï¼ŒbpæŒ‡å‘æœ‰æ•ˆè½½è·çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼‰</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> HDRP(bp) ((char *)(bp) - WSIZE)</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> FTRP(bp) ((char *)(bp) + GET_SIZE(HDRP(bp)) - DSIZE) <span class=\"comment\">// ä¾èµ–ä¸å¤´éƒ¨å·²åˆ†é…å¥½å¤§å°</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// ç»™å®šå—çš„æŒ‡é’ˆbpï¼Œè®¡ç®—å‰åå—çš„æŒ‡é’ˆï¼ˆæ³¨æ„ï¼ŒbpæŒ‡å‘æœ‰æ•ˆè½½è·çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼‰</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> NEXT_BLKP(bp) ((char *)(bp) + GET_SIZE(((char *)(bp) - WSIZE)))</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> PREV_BLKP(bp) ((char *)(bp) - GET_SIZE(((char *)(bp) - DSIZE)))</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// å †çš„èµ·å§‹ä½ç½®</span></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> *heap_listp; <span class=\"comment\">// æ€»æ˜¯æŒ‡å‘åºè¨€å—ï¼Œæˆ‘ä»¬å¯ä»¥å°å°ä¼˜åŒ–ä¸ºæŒ‡å‘ä¸‹ä¸€ä¸ªå—</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// å‡½æ•°æ³¨å†Œ</span></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> *<span class=\"title function_\">coalesce</span><span class=\"params\">(<span class=\"type\">void</span> *bp)</span>;</span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> *<span class=\"title function_\">extend_heap</span><span class=\"params\">(<span class=\"type\">size_t</span> words)</span>;</span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> *<span class=\"title function_\">find_fit</span><span class=\"params\">(<span class=\"type\">size_t</span> asize)</span>;</span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title function_\">place</span><span class=\"params\">(<span class=\"type\">void</span> *bp,<span class=\"type\">size_t</span> asize)</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// æ˜¯å¦å¯åŠ¨ä¸‹æ¬¡é€‚é…</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> NEXT_FIT</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> *<span class=\"title function_\">algo_first_fit</span><span class=\"params\">(<span class=\"type\">size_t</span> asize)</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> NEXT_FIT</span></span><br><span class=\"line\">    <span class=\"type\">static</span> <span class=\"type\">void</span> *<span class=\"title function_\">algo_next_fit</span><span class=\"params\">(<span class=\"type\">size_t</span> asize)</span>;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\"> * mm_init - initialize the malloc package.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">mm_init</span><span class=\"params\">(<span class=\"type\">void</span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">// åˆ›å»ºä¸€ä¸ªç©ºçš„ç©ºé—²é“¾è¡¨</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((heap_listp = mem_sbrk(<span class=\"number\">4</span> * WSIZE)) == (<span class=\"type\">void</span> *)<span class=\"number\">-1</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// å› ä¸ºåºè¨€å—+ç»“å°¾å—åªéœ€è¦ä¸‰ä¸ªå­—èŠ‚ã€‚æˆ‘ä»¬åˆå¿…é¡»ä¿è¯å †çš„å¼€å§‹ä½ç½®æ˜¯åŒå­—å¯¹é½çš„ã€‚</span></span><br><span class=\"line\">    <span class=\"comment\">// PUT(heap_listp, 0);  // è¯¾æœ¬ä¸­åŠ äº†è¿™ä¸€æ¡ï¼Œä¸»è¦æ˜¯ä¸ºäº†å ä½ï¼Œæ²¡æœ‰ä»€ä¹ˆå«ä¹‰ã€‚</span></span><br><span class=\"line\">    PUT(heap_listp + (<span class=\"number\">1</span> * WSIZE), PACK(DSIZE, <span class=\"number\">1</span>)); <span class=\"comment\">// åºè¨€å—å¤´éƒ¨</span></span><br><span class=\"line\">    PUT(heap_listp + (<span class=\"number\">2</span> * WSIZE), PACK(DSIZE, <span class=\"number\">1</span>)); <span class=\"comment\">// åºè¨€å—è„šéƒ¨</span></span><br><span class=\"line\">    PUT(heap_listp + (<span class=\"number\">3</span> * WSIZE), PACK(<span class=\"number\">0</span>, <span class=\"number\">1</span>));     <span class=\"comment\">// ç»“å°¾å—å¤´éƒ¨</span></span><br><span class=\"line\">    heap_listp += (<span class=\"number\">2</span> * WSIZE);                     <span class=\"comment\">// ç§»åŠ¨å †æŒ‡é’ˆåˆ°åºè¨€å—ä¸­é—´</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ä½¿ç”¨ç©ºé—²å—æ‰©å±•å †</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (extend_heap(CHUNKSIZE / WSIZE) == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> *<span class=\"title function_\">extend_heap</span><span class=\"params\">(<span class=\"type\">size_t</span> words)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">char</span> *bp;</span><br><span class=\"line\">    <span class=\"type\">size_t</span> size;</span><br><span class=\"line\">    size = (words % <span class=\"number\">2</span>) ? (words + <span class=\"number\">1</span>) * WSIZE : words * WSIZE; <span class=\"comment\">// ä¿è¯sizeæ˜¯å¥‡æ•°ä¸ªå­—èŠ‚ï¼Œå› ä¸ºæœ‰ä¸€ä¸ªå­—èŠ‚ç”¨æ¥æ”¾ç©ºé—²å—çš„å¤´éƒ¨</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((<span class=\"type\">long</span>)(bp = mem_sbrk(size)) == <span class=\"number\">-1</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    PUT(HDRP(bp), PACK(size, <span class=\"number\">0</span>));           <span class=\"comment\">// ç©ºé—²å—çš„å¤´éƒ¨</span></span><br><span class=\"line\">    PUT(FTRP(bp), PACK(size, <span class=\"number\">0</span>));           <span class=\"comment\">// ç©ºé—²å—çš„å°¾éƒ¨</span></span><br><span class=\"line\">    PUT(HDRP(NEXT_BLKP(bp)), PACK(<span class=\"number\">0</span>, <span class=\"number\">1</span>));  <span class=\"comment\">// æ–°çš„ç»“å°¾å—</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> coalesce(bp); <span class=\"comment\">// åˆå¹¶å—</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\"> * mm_free - Freeing a block does nothing.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">mm_free</span><span class=\"params\">(<span class=\"type\">void</span> *ptr)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">size_t</span> size = GET_SIZE(HDRP(ptr));</span><br><span class=\"line\">    <span class=\"comment\">// å¯¹å½“å‰å—çš„æ ‡è®°ä½è¿›è¡Œæ”¹å˜</span></span><br><span class=\"line\">    PUT(HDRP(ptr), PACK(size, <span class=\"number\">0</span>));</span><br><span class=\"line\">    PUT(FTRP(ptr), PACK(size, <span class=\"number\">0</span>));</span><br><span class=\"line\">    coalesce(ptr);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// åˆå¹¶å—</span></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> *<span class=\"title function_\">coalesce</span><span class=\"params\">(<span class=\"type\">void</span> *bp)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">size_t</span> prev_alloc = GET_ALLOC(FTRP(PREV_BLKP(bp)));  <span class=\"comment\">// æ£€æŸ¥å—å‰é¢æ˜¯å¦è¢«åˆ†é…</span></span><br><span class=\"line\">    <span class=\"type\">size_t</span> next_alloc = GET_ALLOC(HDRP(NEXT_BLKP(bp)));  <span class=\"comment\">// æ£€æŸ¥å—åé¢æ˜¯å¦è¢«åˆ†é…</span></span><br><span class=\"line\">    <span class=\"type\">size_t</span> size = GET_SIZE(HDRP(bp));</span><br><span class=\"line\">    <span class=\"comment\">// å› ä¸ºåºè¨€å—å’Œç»“å°¾å—çš„è®¾è®¡ï¼Œä½¿å¾—è¾¹ç•Œæƒ…å†µçš„æ£€æŸ¥å˜å¾—ç®€å•</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (prev_alloc &amp;&amp; next_alloc)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> bp;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (prev_alloc &amp;&amp; !next_alloc)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        size += GET_SIZE(HDRP(NEXT_BLKP(bp)));</span><br><span class=\"line\">        PUT(HDRP(bp), PACK(size, <span class=\"number\">0</span>));</span><br><span class=\"line\">        PUT(FTRP(bp), PACK(size, <span class=\"number\">0</span>));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (!prev_alloc &amp;&amp; next_alloc)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        size += GET_SIZE(HDRP(PREV_BLKP(bp)));</span><br><span class=\"line\">        PUT(FTRP(bp), PACK(size, <span class=\"number\">0</span>));</span><br><span class=\"line\">        PUT(HDRP(PREV_BLKP(bp)), PACK(size, <span class=\"number\">0</span>));</span><br><span class=\"line\">        bp = PREV_BLKP(bp);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        size += GET_SIZE(HDRP(PREV_BLKP(bp))) + GET_SIZE(FTRP(NEXT_BLKP(bp)));</span><br><span class=\"line\">        PUT(HDRP(PREV_BLKP(bp)), PACK(size, <span class=\"number\">0</span>));</span><br><span class=\"line\">        PUT(FTRP(NEXT_BLKP(bp)), PACK(size, <span class=\"number\">0</span>));</span><br><span class=\"line\">        bp = PREV_BLKP(bp);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> bp;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\"> * mm_malloc - Allocate a block by incrementing the brk pointer.</span></span><br><span class=\"line\"><span class=\"comment\"> *     Always allocate a block whose size is a multiple of the alignment.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"type\">void</span> *<span class=\"title function_\">mm_malloc</span><span class=\"params\">(<span class=\"type\">size_t</span> size)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">size_t</span> asize; <span class=\"comment\">// é¢„ç•™äº†å¤´éƒ¨å’Œè„šéƒ¨çš„å¤§å°</span></span><br><span class=\"line\">    <span class=\"type\">size_t</span> extend_size;</span><br><span class=\"line\">    <span class=\"type\">char</span> *bp;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (size &lt;= <span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ç”±äºè¾¹ç•ŒåŒå­—å¯¹é½çš„æƒ…å†µï¼Œæœ€å°çš„åˆ†é…å¤§å°æ˜¯DSIZEã€‚å¤´éƒ¨4+å°¾éƒ¨4+æœ€å°çš„å†…å®¹ä¸º1-&gt;å¯¹é½è¾¹ç•Œåä¸º16ï¼ˆCSAPP è¯¾æœ¬ç»ƒä¹ é¢˜9.7ï¼‰</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (size &lt;= DSIZE)</span><br><span class=\"line\">        asize = <span class=\"number\">2</span> * DSIZE;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"comment\">// éœ€è¦åˆ†é…çš„å¤§å°+å¤´éƒ¨+å°¾éƒ¨</span></span><br><span class=\"line\">        asize = ALIGN(size+DSIZE); <span class=\"comment\">// ALIGN(size) (((size) + (ALIGNMENT - 1)) &amp; ~0x7)</span></span><br><span class=\"line\">        <span class=\"comment\">// è¯¾æœ¬ï¼šasize = DSIZE * ((size + (DSIZE) + (DSIZE - 1)) / DSIZE); </span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ä½¿ç”¨é€‚é…ç®—æ³•</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((bp = find_fit(asize)) != <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        place(bp, asize);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> bp;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// æ‰¾ä¸åˆ°åˆé€‚çš„åŒ¹é…å°±æ‰©å±•</span></span><br><span class=\"line\">    extend_size = MAX(asize, CHUNKSIZE);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((bp = extend_heap(extend_size / WSIZE)) == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    place(bp, asize);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> bp;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\"> * mm_realloc - Implemented simply in terms of mm_malloc and mm_free</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"type\">void</span> *<span class=\"title function_\">mm_realloc</span><span class=\"params\">(<span class=\"type\">void</span> *ptr, <span class=\"type\">size_t</span> size)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">void</span> *oldptr = ptr;</span><br><span class=\"line\">    <span class=\"type\">void</span> *newptr;</span><br><span class=\"line\">    <span class=\"type\">size_t</span> copySize;</span><br><span class=\"line\"></span><br><span class=\"line\">    newptr = mm_malloc(size);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (newptr == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (ptr == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> newptr;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    copySize = GET_SIZE(HDRP(oldptr));</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (size &lt; copySize)</span><br><span class=\"line\">        copySize = size;</span><br><span class=\"line\">    <span class=\"built_in\">memcpy</span>(newptr, oldptr, copySize);</span><br><span class=\"line\">    mm_free(oldptr);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> newptr;</span><br><span class=\"line\">    <span class=\"comment\">// return NULL;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// æ”¾ç½®å—ï¼ˆè¯¾æœ¬ç»ƒä¹ 9.9ï¼‰</span></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title function_\">place</span><span class=\"params\">(<span class=\"type\">void</span> *bp,<span class=\"type\">size_t</span> asize)</span>&#123;</span><br><span class=\"line\">    <span class=\"type\">size_t</span> free_block_size = GET_SIZE(HDRP(bp));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ç©ºé—²å—å‡å»éœ€è¦åˆ†é…çš„å¤§å°ï¼Œå¾—åˆ°çš„ç¢ç‰‡å¿…é¡»è‡³å°‘èƒ½å®¹çº³ä¸€ä¸ªæœ€å°çš„å¯åˆ†é…çš„å—ï¼ˆ2*DSIZEï¼Œä¹Ÿå°±æ˜¯å¤´éƒ¨4+å°¾éƒ¨4+æœ€å°çš„å†…å®¹ä¸º1-&gt;å¯¹é½è¾¹ç•Œåä¸º16ï¼‰</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>((free_block_size - asize)&gt;=<span class=\"number\">2</span>*DSIZE)&#123;</span><br><span class=\"line\">        <span class=\"comment\">// è£å‰ª</span></span><br><span class=\"line\">        PUT(HDRP(bp),PACK(asize,<span class=\"number\">1</span>));</span><br><span class=\"line\">        PUT(FTRP(bp),PACK(asize,<span class=\"number\">1</span>));</span><br><span class=\"line\">        bp = NEXT_BLKP(bp);</span><br><span class=\"line\">        PUT(HDRP(bp),PACK(free_block_size-asize,<span class=\"number\">0</span>));</span><br><span class=\"line\">        PUT(FTRP(bp),PACK(free_block_size-asize,<span class=\"number\">0</span>));</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        PUT(HDRP(bp),PACK(free_block_size,<span class=\"number\">1</span>));</span><br><span class=\"line\">        PUT(FTRP(bp),PACK(free_block_size,<span class=\"number\">1</span>));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/***** é€‚é…ç®—æ³•  ******/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> *<span class=\"title function_\">find_fit</span><span class=\"params\">(<span class=\"type\">size_t</span> asize)</span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// asize é¢„ç•™äº†å¤´éƒ¨å’Œè„šéƒ¨çš„å¤§å°</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> NEXT_FIT</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> algo_next_fit(asize);</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">else</span></span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> algo_first_fit(asize);</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// é¦–æ¬¡åŒ¹é…ç®—æ³•ï¼ˆè¯¾æœ¬ç»ƒä¹ 9.8ï¼‰</span></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> *<span class=\"title function_\">algo_first_fit</span><span class=\"params\">(<span class=\"type\">size_t</span> asize)</span>&#123;</span><br><span class=\"line\">    <span class=\"type\">void</span>* bp =heap_listp;</span><br><span class=\"line\">    <span class=\"keyword\">while</span>(GET_SIZE(HDRP(bp))&gt;<span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!GET_ALLOC(HDRP(bp)) &amp;&amp; (asize&lt;=GET_SIZE(HDRP(bp))))&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> bp;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        bp = NEXT_BLKP(bp);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// ä¸‹æ¬¡é€‚é…ç®—æ³•</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> NEXT_FIT</span></span><br><span class=\"line\">    <span class=\"type\">static</span> <span class=\"type\">void</span>* last_heap_listp = <span class=\"literal\">NULL</span>; <span class=\"comment\">// ä¸Šæ¬¡éå†çš„æŒ‡é’ˆ</span></span><br><span class=\"line\">    <span class=\"type\">static</span> <span class=\"type\">void</span> *<span class=\"title function_\">algo_next_fit</span><span class=\"params\">(<span class=\"type\">size_t</span> asize)</span>&#123;</span><br><span class=\"line\">        <span class=\"type\">void</span>* bp;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(last_heap_listp!=<span class=\"literal\">NULL</span>)&#123;</span><br><span class=\"line\">            bp =last_heap_listp;</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">            bp =heap_listp;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">while</span>(GET_SIZE(HDRP(bp))&gt;<span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(!GET_ALLOC(HDRP(bp)) &amp;&amp; (asize&lt;=GET_SIZE(HDRP(bp))))&#123;</span><br><span class=\"line\">                last_heap_listp=bp;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> bp;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            bp = NEXT_BLKP(bp);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        last_heap_listp = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// ä»å¤´å†æœç´¢ä¸€é</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> algo_first_fit(asize);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h1 id=\"åè®°\"><a class=\"markdownIt-Anchor\" href=\"#åè®°\"></a> åè®°</h1>\n<p>è¿™ä¸ªå®éªŒï¼Œæ‰‹æ‰“ä»£ç ï¼Œbug çœŸå¤šã€‚çœŸä¸èƒ½ç›¸ä¿¡è‚‰çœ¼å¯¹ç…§ï¼Œåªèƒ½ä¿¡ CV å¤§æ³•ã€‚</p>\n<p>é™äºæ•™å­¦å®‰æ’å’Œæœ¬äººæ—¶é—´ï¼ŒCSAPP LABS å°±æ›´æ–°åˆ°è¿™é‡Œã€‚å…¶å®è¿™äº›å®éªŒè¦åŸºæœ¬å®Œæˆä¹Ÿå¹¶ä¸å›°éš¾ï¼Œåœ¨æ“ä½œçš„åŒæ—¶å¯ä»¥å­¦åˆ°è®¸å¤š C è¯­è¨€çš„çŸ¥è¯†ï¼Œç§¯ç´¯ç¼–ç¨‹ç»éªŒï¼Œå¯¹åç»­ç†è§£è®¡ç®—æœºéƒ½æœ‰å¸®åŠ©ã€‚</p>\n<p>å¸Œæœ›å¤§å®¶åœ¨çŸ¥è¯†çš„æµ·æ´‹é‡Œã€åœ¨å­˜å‚¨å™¨å±±ä¸­æ”¶è·æ»¡æ»¡ï¼ğŸ¥³ğŸ¥³ğŸ¥³</p>\n<h1 id=\"æœ¬æ–‡å‚è€ƒ\"><a class=\"markdownIt-Anchor\" href=\"#æœ¬æ–‡å‚è€ƒ\"></a> æœ¬æ–‡å‚è€ƒ</h1>\n<ul>\n<li>ã€ŠCSAPPã€‹ç¬¬ä¸‰ç‰ˆç¬¬ä¹ç« å†…å®¹</li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/672618494\">CSAPPè¯¾ç¨‹Lab6 Malloc Lab - çŸ¥ä¹ (zhihu.com)</a></li>\n<li><a href=\"https://www.jianshu.com/p/6e59fde0e6c0\">CSAPPä¹‹è¯¦è§£MollocLab - ç®€ä¹¦ (jianshu.com)</a></li>\n</ul>\n","raw":"---\ntitle: CSAPP LAB-5 æ‰‹å†™åŠ¨æ€å­˜å‚¨åˆ†é…å™¨\ntags:\n  - CSAPP\n  - C\n  - malloc\n  - å†…å­˜åˆ†é…\ncover: 'https://cdn.gallery.uuanqin.top/img/20240617204205.webp'\ncategories:\n  - CSAPP LABS\nabbrlink: 3eb1abc7\ndate: 2024-06-13 12:01:31\ndescription: è¯¾æœ¬æ¡ˆä¾‹å®è·µ\ntop_img:\n---\n\næˆ‘ä¹Ÿå¤§æ¦‚å¯Ÿè§‰åˆ°æˆ‘ä»¬è¯¾ç¨‹çš„å®éªŒæ˜¯æŒ‘ç€ CSAPP ä¸­åŸç‰ˆå®éªŒå»åšçš„ï¼Œå¹¶è¿›è¡Œäº†ç®€åŒ–ï¼Œæ‰€ä»¥å’Œç½‘ä¸Šçš„å®éªŒé¡ºåºä¸å¤ªä¸€æ ·ï¼Œä½†å†…å®¹æ˜¯å¤§è‡´ç›¸åŒçš„ã€‚\n\n> [!notice] CSAPP LAB å®éªŒ\n>\n> - [[CSAPP LAB-1 ä½æ“ä½œ]]\n> - [[CSAPP LAB-2 äºŒè¿›åˆ¶ç‚¸å¼¹å®éªŒ]]\n> - [[CSAPP LAB-3 ç¼“å†²åŒºæº¢å‡ºç‚¸å¼¹]]\n> - [[CSAPP LAB-4 ä»£ç ä¼˜åŒ–]]\n> - CSAPP LAB-5 æ‰‹å†™åŠ¨æ€å­˜å‚¨åˆ†é…å™¨ï¼ˆæœ¬æ–‡ï¼‰\n\nè¿™æ¬¡çš„å®éªŒ**å»ºè®®å…ˆçœ‹è¯¾æœ¬çš„ç¬¬ä¹ç« çš„ 9.9 éƒ¨åˆ†**ï¼ˆã€ŠCSAPPã€‹ç¬¬ä¸‰ç‰ˆï¼‰ï¼Œç†è§£å…¶ä¸­çš„å†…å®¹åè¿›è¡Œå®ç°ã€‚è€Œä¸”å¤§éƒ¨åˆ†ä»£ç è¯¾æœ¬ä¸Šéƒ½æœ‰ã€‚ä¸ç®¡ä½ ç°åœ¨ã€ŠCSAPPã€‹å­¦åˆ°å“ªä¸€ä¸ªéƒ¨åˆ†ï¼Œéƒ½å¯ä»¥ç›´æ¥çœ‹ 9.9 ç« ï¼Œä¸ç”¨æ‹…å¿ƒæ²¡æœ‰é“ºå«å†…å®¹ã€‚\n\næœ¬æ–‡å°†ä»‹ç»ä¸€ä¸ªåŠ¨æ€å­˜å‚¨åˆ†é…å™¨çš„ç®€å•å®ç°ï¼šéšå¼ç©ºé—²é“¾è¡¨ + ç«‹å³è¾¹ç•Œæ ‡è®°åˆå¹¶æ–¹å¼ + é¦–æ¬¡åŒ¹é…/ä¸‹æ¬¡åŒ¹é…ç®—æ³•ã€‚æ›´é«˜çº§çš„å®ç°å¯ä»¥çœ‹æ–‡æœ«å‚è€ƒæ–‡ç« ã€‚\n\n> è¿™æ˜¯æˆ‘ CSAPP è¯¾ç¨‹çš„æœ€åä¸€ä¸ªå®éªŒäº†ï¼Œæ¯æ¬¡ä¸“æŒ‘ğŸ‘©åŠ©æ•™éªŒæ”¶ï¼Œæ¸©æŸ”è´´å¿ƒç»™åˆ†é«˜ğŸ˜ï¼\n\n# å®éªŒä»‹ç»å’Œè¦æ±‚\n\næœ¬å®éªŒéœ€è¦ç”¨ c è¯­è¨€å®ç°ä¸€ä¸ªåŠ¨æ€çš„å­˜å‚¨åˆ†é…å™¨ï¼Œä¹Ÿå°±æ˜¯ä½ è‡ªå·±ç‰ˆæœ¬çš„ `malloc`ï¼Œ`free`ï¼Œ`realloc` å‡½æ•°ã€‚\n\nè§£å‹æ–‡ä»¶ï¼š\n\n```sh\ntar xvf malloclab-handout.tar\n```\n\næˆ‘ä»¬éœ€è¦ä¿®æ”¹çš„å”¯ä¸€æ–‡ä»¶æ˜¯ `mm.c`ï¼ŒåŒ…å«å¦‚ä¸‹å‡ ä¸ªéœ€è¦å®ç°çš„å‡½æ•°ï¼š\n\n```c\n/*\nmm_init:åœ¨è°ƒç”¨mm_mallocï¼Œmm_reallocæˆ–mm_freeä¹‹å‰ï¼Œè°ƒç”¨mm_initè¿›è¡Œåˆå§‹åŒ–ï¼Œæ­£ç¡®è¿”å›0ã€‚\n*/\nint mm_init(void); \n\n/*\nmm_mallocï¼šåœ¨å †åŒºåŸŸåˆ†é…æŒ‡å®šå¤§å°çš„å—ï¼Œåˆ†é…çš„ç©ºé—´ï¼Œè¿”å›çš„æŒ‡é’ˆåº”è¯¥æ˜¯8å­—èŠ‚å¯¹é½çš„\n*/\nvoid *mm_malloc(size_t size); \n\n/*\nmm_free:é‡Šæ”¾æŒ‡é’ˆæŒ‡å‘çš„block\n*/\nvoid mm_free(void *ptr); \n\n/*\nè¿”å›æŒ‡å‘ä¸€ä¸ªå¤§å°ä¸ºsizeçš„åŒºåŸŸæŒ‡é’ˆï¼Œæ»¡è¶³ä¸€ä¸‹æ¡ä»¶ï¼š\n* if ptr is NULL, the call is equivalent to mm_malloc(size); \n* if size is equal to zero, the call is equivalent to mm_free(ptr); \n* if ptr is not NULLï¼šå…ˆæŒ‰ç…§sizeæŒ‡å®šçš„å¤§å°åˆ†é…ç©ºé—´ï¼Œå°†åŸæœ‰æ•°æ®ä»å¤´åˆ°å°¾æ‹·è´åˆ°æ–°åˆ†é…çš„å†…å­˜åŒºåŸŸï¼Œè€Œåé‡Šæ”¾åŸæ¥ptræ‰€æŒ‡å†…å­˜åŒºåŸŸ\n*/\nvoid *mm_realloc(void *ptr, size_t size);\n```\n\nè®°ä½å“¦ï¼Œæœ¬æ¬¡å®éªŒçš„ä»»åŠ¡è¦æ±‚ä¹‹ä¸€æ˜¯æŒ‡é’ˆæ˜¯ 8 å­—èŠ‚å¯¹é½çš„ã€‚\n\næˆ‘ä»¬å¯ä»¥è°ƒç”¨å®éªŒæä¾›ç»™æˆ‘ä»¬çš„å‡½æ•°ï¼Œè¿™äº›å‡½æ•°å®šä¹‰åœ¨ `memory.c` ä¸­ï¼š\n\n- `void *mem_sbrk(int incr)`: Expands the heap by incr bytes, where incr is a positive non-zero integer and returns a generic pointer to the first byte of the newly allocated heap area.\n- `void *mem_heap_lo(void)`: Returns a generic pointer to the first byte in the heap.\n- `void *mem_heap_hi(void)`: Returns a generic pointer to the last byte in the heap.\n- `size_t mem_heapsize(void)`: Returns the current size of the heap in bytes.\n- `size_t mem_pagesize(void)`: Returns the systemâ€™s page size in bytes (4K onLinux systems).\n\nåœ¨è¿™ç¯‡æ–‡ç« çš„å®ç°æ–¹å¼ä¸­ï¼Œåªéœ€è¦ä½¿ç”¨ `void *mem_sbrk(int incr)`ï¼Œä¸æ ‡å‡†å®ç°ä¸åŒçš„æ˜¯ï¼Œè¿™ä¸ªå‡½æ•°æ‹’ç»æ”¶ç¼©å †çš„è¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯ä¸èƒ½è¾“å…¥è´Ÿæ•°ã€‚`mem_sbrk` çš„ä½œç”¨å¯ä»¥ç»“åˆè¯¾æœ¬ 9.9 ç« è¿›è¡Œç†è§£ã€‚\n\néªŒè¯æˆ‘ä»¬çš„åŠ¨æ€çš„å­˜å‚¨åˆ†é…å™¨ï¼š\n\n- `mdriver.c`ï¼šè´Ÿè´£æµ‹è¯• `mm.c` çš„æ­£ç¡®æ€§,ç©ºé—´åˆ©ç”¨ç‡å’Œååé‡\n- æ‰§è¡Œ `make` æŒ‡ä»¤ç”Ÿæˆ `mdriver` å¯æ‰§è¡Œæ–‡ä»¶\n-  `mdriver` çš„ä½¿ç”¨ï¼š\n\t- `-f <tracefile>`:  `-f` åæ·»åŠ ä¸€äº› trace file æ¥æµ‹è¯•æˆ‘ä»¬å®ç°çš„å‡½æ•°\n\t- `-V`: æ‰“å°å‡ºè¯Šæ–­ä¿¡æ¯ã€‚\n\t- ä¾‹å¦‚ï¼š`./mdriver -V  -f short1-bal.rep`\n\nä¸€äº›ç¼–ç¨‹è§„åˆ™ï¼š\n\n- ä¸èƒ½æ”¹å˜ `mm.c` ä¸­å‡½æ•°æ¥å£\n- ä¸èƒ½ç›´æ¥è°ƒç”¨ä»»ä½•å†…å­˜ç®¡ç†çš„åº“å‡½æ•°å’Œç³»ç»Ÿå‡½æ•° `malloc`, `calloc`, `free`, `realloc`, `sbrk`, `brk`\n - ä¸èƒ½å®šä¹‰ä»»ä½•å…¨å±€æˆ–è€…é™æ€å¤åˆæ•°æ®ç»“æ„å¦‚ `arrays`, `structs`, `trees`ï¼Œå…è®¸ä½¿ç”¨ `integers`, `floats` ä»¥åŠ `pointers` ç­‰ç®€å•æ•°æ®ç±»å‹\n- è¿”å›çš„æŒ‡é’ˆéœ€è¦ 8 å­—èŠ‚å¯¹é½\n\n\n# å…³é”®æ¦‚å¿µ\n\næˆ‘æŠŠè¯¾æœ¬æ¶‰åŠåˆ°çš„å…³é”®æ¦‚å¿µæ¨¡å‹ç®€è¦ä»‹ç»ä¸€ä¸‹ã€‚\n\næœ¬æ–‡ä»‹ç»çš„æ˜¯éšå¼ç©ºé—²é“¾è¡¨ + ç«‹å³è¾¹ç•Œæ ‡è®°åˆå¹¶æ–¹å¼ + é¦–æ¬¡åŒ¹é…/ä¸‹æ¬¡åŒ¹é…ç®—æ³•ã€‚\n\næ›´å¤šè¯¦ç»†å†…å®¹ç†è§£å°±çœ‹ä¸‹ä¸€èŠ‚çš„ä»£ç æ³¨é‡Šå’¯ï¼\n\n## éšå¼ç©ºé—²é“¾è¡¨çš„æ’å®šå½¢å¼\n\n![image.png](https://cdn.gallery.uuanqin.top/img/20240617202828.webp)\n\nä¸€ä¸ªæ­£æ–¹å½¢è¡¨ç¤º 4 å­—èŠ‚ï¼ˆä¸€ä¸ªå­—ï¼‰ï¼Œè™šçº¿è¡¨ç¤ºåŒå­—å¯¹é½æ ‡å¿—ã€‚æ­£æ–¹å½¢ä¸­çš„å¤´éƒ¨å°¾éƒ¨æ ‡è®°ä¸º `size/is_alloc`ã€‚\n\n## æ ‡è®°è¾¹ç•Œåˆå¹¶\n\nKnuth æå‡ºäº†è¾¹ç•Œæ ‡è®°æŠ€æœ¯ï¼Œå…è®¸åœ¨å¸¸æ•°æ—¶é—´å†…è¿›è¡Œå¯¹å‰é¢çš„å—çš„åˆå¹¶ã€‚\n\n![image.png](https://cdn.gallery.uuanqin.top/img/20240617001201.webp)\n\nè¿™ç§æ€æƒ³ï¼Œæ˜¯åœ¨æ¯ä¸ªå—çš„ç»“å°¾å¤„æ·»åŠ ä¸€ä¸ªè„šéƒ¨ï¼ˆfooterï¼Œè¾¹ç•Œæ ‡è®°ï¼‰ï¼Œå…¶ä¸­è„šéƒ¨å°±æ˜¯å¤´éƒ¨çš„ä¸€ä¸ªå‰¯æœ¬ã€‚å¦‚æœæ¯ä¸ªå—åŒ…æ‹¬è¿™æ ·ä¸€ä¸ªè„šéƒ¨ï¼Œé‚£ä¹ˆåˆ†é…å™¨å°±å¯ä»¥é€šè¿‡æ£€æŸ¥å®ƒçš„è„šéƒ¨ï¼Œåˆ¤æ–­å‰é¢ä¸€ä¸ªå—çš„èµ·å§‹ä½ç½®å’ŒçŠ¶æ€ï¼Œè¿™ä¸ªè„šéƒ¨æ€»æ˜¯åœ¨è·å½“å‰å—å¼€å§‹ä½ç½®ä¸€ä¸ªå­—çš„è·ç¦»ã€‚\n\nè€ƒè™‘å½“åˆ†é…å™¨é‡Šæ”¾å½“å‰å—æ—¶æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„æƒ…å†µï¼š\n\n1) å‰é¢çš„å—å’Œåé¢çš„å—éƒ½æ˜¯å·²åˆ†é…çš„ã€‚\n2) å‰é¢çš„å—æ˜¯å·²åˆ†é…çš„ï¼Œåé¢çš„å—æ˜¯ç©ºé—²çš„ã€‚\n3) å‰é¢çš„å—æ˜¯ç©ºé—²çš„ï¼Œè€Œåé¢çš„å—æ˜¯å·²åˆ†é…çš„ã€‚\n4) å‰é¢çš„å’Œåé¢çš„å—éƒ½æ˜¯ç©ºé—²çš„ã€‚\n\n![image.png](https://cdn.gallery.uuanqin.top/img/20240617001349.webp)\n\n## åŒ¹é…ç®—æ³•\n\nåŒ¹é…ç®—æ³•ï¼š\n\n- é¦–æ¬¡åŒ¹é…ï¼ˆFirst Fitï¼‰ã€‚ä»å¤´å¼€å§‹æœç´¢ç©ºé—²é“¾è¡¨ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªåˆé€‚çš„ç©ºé—²å—ã€‚\n\t- ä¼˜ç‚¹ï¼šè¶‹å‘äºå°†å¤§çš„ç©ºé—²å—ä¿ç•™åœ¨é“¾è¡¨çš„åé¢ã€‚\n\t- ç¼ºç‚¹ï¼šå®ƒè¶‹å‘äºåœ¨é è¿‘é“¾è¡¨èµ·å§‹å¤„ç•™ä¸‹å°ç©ºé—²å—çš„ã€Œç¢ç‰‡ã€ï¼Œå¢å¤§äº†å¯¹è¾ƒå¤§å—çš„æœç´¢æ—¶é—´ã€‚\n- ä¸‹ä¸€æ¬¡é€‚é…ï¼ˆNext Fitï¼‰ã€‚å’Œé¦–æ¬¡é€‚é…å¾ˆç›¸ä¼¼ï¼Œåªä¸è¿‡ä¸æ˜¯ä»é“¾è¡¨çš„èµ·å§‹å¤„å¼€å§‹æ¯æ¬¡æœç´¢ï¼Œè€Œæ˜¯ä»ä¸Šä¸€æ¬¡æŸ¥è¯¢ç»“æŸçš„åœ°æ–¹å¼€å§‹ã€‚ç”± Donald Knuth æå‡ºã€‚åŸºäºæ€æƒ³ï¼šå¦‚æœä¸Šä¸€æ¬¡åœ¨æŸä¸ªç©ºé—²å—é‡Œå‘ç°äº†ä¸€ä¸ªåŒ¹é…ï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½ä¸‹ä¸€æ¬¡æˆ‘ä»¬ä¹Ÿèƒ½åœ¨è¿™ä¸ªå‰©ä½™å—ä¸­å‘ç°åŒ¹é…ã€‚\n\t- ä¼˜ç‚¹ï¼šæ¯”é¦–æ¬¡é€‚é…è¿è¡Œèµ·æ¥æ˜æ˜¾å¿«ä¸€äº›ã€‚\n\t- ç¼ºç‚¹ï¼šå†…å­˜åˆ©ç”¨ç‡æ¯”é¦–æ¬¡åŒ¹é…ä½ã€‚\n- æœ€ä½³é€‚é…ï¼ˆBest Fitï¼‰ã€‚æœ€ä½³é€‚é…æ£€æŸ¥æ¯ä¸ªç©ºé—²å—ï¼Œé€‰æ‹©é€‚åˆæ‰€éœ€è¯·æ±‚å¤§å°çš„æœ€å°ç©ºé—²å—ã€‚\n\t- ä¼˜ç‚¹ï¼šå†…å­˜åˆ©ç”¨ç‡è¾ƒé«˜ã€‚\n\t- ç¼ºç‚¹ï¼šåœ¨ç®€å•ç©ºé—²é“¾è¡¨ç»„ç»‡ç»“æ„ä¸­ï¼ˆæ¯”å¦‚ä¸Šé¢æåˆ°çš„éšå¼ç©ºé—²é“¾è¡¨ï¼‰ï¼Œéœ€è¦å¯¹å †è¿›è¡Œå½»åº•æœç´¢ã€‚\n\n\n# `mm.c` æ–‡ä»¶\n\n```c\n/*\n * mm-naive.c - The fastest, least memory-efficient malloc package.\n *\n * In this naive approach, a block is allocated by simply incrementing\n * the brk pointer.  A block is pure payload. There are no headers or\n * footers.  Blocks are never coalesced or reused. Realloc is\n * implemented directly using mm_malloc and mm_free.\n *\n * NOTE TO STUDENTS: Replace this header comment with your own header\n * comment that gives a high level description of your solution.\n */\n#include <stdio.h>\n#include <stdlib.h>\n#include <assert.h>\n#include <unistd.h>\n#include <string.h>\n\n#include \"mm.h\"\n#include \"memlib.h\"\n\n/*********************************************************\n * NOTE TO STUDENTS: Before you do anything else, please\n * provide your team information in the following struct.\n ********************************************************/\nteam_t team = {\n    /* Team name */\n    \"SA23xxxxxx\",\n    /* First member's full name */\n    \"uuanqin\",\n    /* First member's email address */\n    \"uuanqin@uuanqin.top\",\n    /* Second member's full name (leave blank if none) */\n    \"\",\n    /* Second member's email address (leave blank if none) */\n    \"\"};\n\n/*********  ä¸€äº›å¿…è¦çš„å® ***************/\n\n/* single word (4) or double word (8) alignment */\n#define ALIGNMENT 8\n\n/* rounds up to the nearest multiple of ALIGNMENT */\n#define ALIGN(size) (((size) + (ALIGNMENT - 1)) & ~0x7)\n\n#define SIZE_T_SIZE (ALIGN(sizeof(size_t)))\n\n\n// åŸºæœ¬å¸¸é‡\n#define WSIZE 4       // å­—çš„å¤§å°ï¼ˆå¤´éƒ¨ã€è„šéƒ¨å¤§å°ï¼‰\n#define DSIZE 8       // åŒå­—å¤§å°\n#define CHUNKSIZE (1 << 12)  // æ¯æ¬¡æ‰©å±•å †æ—¶ä½¿ç”¨è¿™ä¸ªå¤§å°\n\n\n#define MAX(x, y) ((x) > (y) ? (x) : (y))\n\n#define PACK(size, is_alloc) ((size) | (is_alloc))   // å°†å¤§å°å’Œåˆ†é…ä½æ‰“åŒ…ç»„è£…\n\n// è¯»å–/å†™å…¥ æŒ‡å®šä½ç½®çš„å€¼\n#define GET(p) (*(unsigned int *)(p))                \n#define PUT(p, val) (*(unsigned int *)(p) = (val))\n\n// è·å–å¤´éƒ¨çš„ä¿¡æ¯\n#define GET_SIZE(p) (GET(p) & ~0x7)\n#define GET_ALLOC(p) (GET(p) & 0x1)\n\n// ç»™å®šå—çš„æŒ‡é’ˆbpï¼Œè·å–å…¶å¤´éƒ¨å’Œè„šéƒ¨çš„æŒ‡é’ˆï¼ˆæ³¨æ„ï¼ŒbpæŒ‡å‘æœ‰æ•ˆè½½è·çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼‰\n#define HDRP(bp) ((char *)(bp) - WSIZE)\n#define FTRP(bp) ((char *)(bp) + GET_SIZE(HDRP(bp)) - DSIZE) // ä¾èµ–ä¸å¤´éƒ¨å·²åˆ†é…å¥½å¤§å°\n\n// ç»™å®šå—çš„æŒ‡é’ˆbpï¼Œè®¡ç®—å‰åå—çš„æŒ‡é’ˆï¼ˆæ³¨æ„ï¼ŒbpæŒ‡å‘æœ‰æ•ˆè½½è·çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼‰\n#define NEXT_BLKP(bp) ((char *)(bp) + GET_SIZE(((char *)(bp) - WSIZE)))\n#define PREV_BLKP(bp) ((char *)(bp) - GET_SIZE(((char *)(bp) - DSIZE)))\n\n// å †çš„èµ·å§‹ä½ç½®\nstatic void *heap_listp; // æ€»æ˜¯æŒ‡å‘åºè¨€å—ï¼Œæˆ‘ä»¬å¯ä»¥å°å°ä¼˜åŒ–ä¸ºæŒ‡å‘ä¸‹ä¸€ä¸ªå—\n\n// å‡½æ•°æ³¨å†Œ\nstatic void *coalesce(void *bp);\nstatic void *extend_heap(size_t words);\nstatic void *find_fit(size_t asize);\nstatic void place(void *bp,size_t asize);\n\n// æ˜¯å¦å¯åŠ¨ä¸‹æ¬¡é€‚é…\n#define NEXT_FIT\n\nstatic void *algo_first_fit(size_t asize);\n\n#ifdef NEXT_FIT\n    static void *algo_next_fit(size_t asize);\n#endif\n\n\n/*\n * mm_init - initialize the malloc package.\n */\nint mm_init(void)\n{\n    // åˆ›å»ºä¸€ä¸ªç©ºçš„ç©ºé—²é“¾è¡¨\n    if ((heap_listp = mem_sbrk(4 * WSIZE)) == (void *)-1)\n    {\n        return -1;\n    }\n    // å› ä¸ºåºè¨€å—+ç»“å°¾å—åªéœ€è¦ä¸‰ä¸ªå­—èŠ‚ã€‚æˆ‘ä»¬åˆå¿…é¡»ä¿è¯å †çš„å¼€å§‹ä½ç½®æ˜¯åŒå­—å¯¹é½çš„ã€‚\n    // PUT(heap_listp, 0);  // è¯¾æœ¬ä¸­åŠ äº†è¿™ä¸€æ¡ï¼Œä¸»è¦æ˜¯ä¸ºäº†å ä½ï¼Œæ²¡æœ‰ä»€ä¹ˆå«ä¹‰ã€‚\n    PUT(heap_listp + (1 * WSIZE), PACK(DSIZE, 1)); // åºè¨€å—å¤´éƒ¨\n    PUT(heap_listp + (2 * WSIZE), PACK(DSIZE, 1)); // åºè¨€å—è„šéƒ¨\n    PUT(heap_listp + (3 * WSIZE), PACK(0, 1));     // ç»“å°¾å—å¤´éƒ¨\n    heap_listp += (2 * WSIZE);                     // ç§»åŠ¨å †æŒ‡é’ˆåˆ°åºè¨€å—ä¸­é—´\n\n    // ä½¿ç”¨ç©ºé—²å—æ‰©å±•å †\n    if (extend_heap(CHUNKSIZE / WSIZE) == NULL)\n    {\n        return -1;\n    }\n\n    return 0;\n}\n\nstatic void *extend_heap(size_t words)\n{\n    char *bp;\n    size_t size;\n    size = (words % 2) ? (words + 1) * WSIZE : words * WSIZE; // ä¿è¯sizeæ˜¯å¥‡æ•°ä¸ªå­—èŠ‚ï¼Œå› ä¸ºæœ‰ä¸€ä¸ªå­—èŠ‚ç”¨æ¥æ”¾ç©ºé—²å—çš„å¤´éƒ¨\n    if ((long)(bp = mem_sbrk(size)) == -1)\n    {\n        return NULL;\n    }\n    PUT(HDRP(bp), PACK(size, 0));           // ç©ºé—²å—çš„å¤´éƒ¨\n    PUT(FTRP(bp), PACK(size, 0));           // ç©ºé—²å—çš„å°¾éƒ¨\n    PUT(HDRP(NEXT_BLKP(bp)), PACK(0, 1));  // æ–°çš„ç»“å°¾å—\n\n    return coalesce(bp); // åˆå¹¶å—\n}\n\n/*\n * mm_free - Freeing a block does nothing.\n */\nvoid mm_free(void *ptr)\n{\n    size_t size = GET_SIZE(HDRP(ptr));\n    // å¯¹å½“å‰å—çš„æ ‡è®°ä½è¿›è¡Œæ”¹å˜\n    PUT(HDRP(ptr), PACK(size, 0));\n    PUT(FTRP(ptr), PACK(size, 0));\n    coalesce(ptr);\n}\n\n// åˆå¹¶å—\nstatic void *coalesce(void *bp)\n{\n    size_t prev_alloc = GET_ALLOC(FTRP(PREV_BLKP(bp)));  // æ£€æŸ¥å—å‰é¢æ˜¯å¦è¢«åˆ†é…\n    size_t next_alloc = GET_ALLOC(HDRP(NEXT_BLKP(bp)));  // æ£€æŸ¥å—åé¢æ˜¯å¦è¢«åˆ†é…\n    size_t size = GET_SIZE(HDRP(bp));\n    // å› ä¸ºåºè¨€å—å’Œç»“å°¾å—çš„è®¾è®¡ï¼Œä½¿å¾—è¾¹ç•Œæƒ…å†µçš„æ£€æŸ¥å˜å¾—ç®€å•\n    if (prev_alloc && next_alloc)\n    {\n        return bp;\n    }\n    else if (prev_alloc && !next_alloc)\n    {\n        size += GET_SIZE(HDRP(NEXT_BLKP(bp)));\n        PUT(HDRP(bp), PACK(size, 0));\n        PUT(FTRP(bp), PACK(size, 0));\n    }\n    else if (!prev_alloc && next_alloc)\n    {\n        size += GET_SIZE(HDRP(PREV_BLKP(bp)));\n        PUT(FTRP(bp), PACK(size, 0));\n        PUT(HDRP(PREV_BLKP(bp)), PACK(size, 0));\n        bp = PREV_BLKP(bp);\n    }\n    else\n    {\n        size += GET_SIZE(HDRP(PREV_BLKP(bp))) + GET_SIZE(FTRP(NEXT_BLKP(bp)));\n        PUT(HDRP(PREV_BLKP(bp)), PACK(size, 0));\n        PUT(FTRP(NEXT_BLKP(bp)), PACK(size, 0));\n        bp = PREV_BLKP(bp);\n    }\n    return bp;\n}\n\n\n\n/*\n * mm_malloc - Allocate a block by incrementing the brk pointer.\n *     Always allocate a block whose size is a multiple of the alignment.\n */\nvoid *mm_malloc(size_t size)\n{\n    size_t asize; // é¢„ç•™äº†å¤´éƒ¨å’Œè„šéƒ¨çš„å¤§å°\n    size_t extend_size;\n    char *bp;\n    if (size <= 0)\n        return NULL;\n\n    // ç”±äºè¾¹ç•ŒåŒå­—å¯¹é½çš„æƒ…å†µï¼Œæœ€å°çš„åˆ†é…å¤§å°æ˜¯DSIZEã€‚å¤´éƒ¨4+å°¾éƒ¨4+æœ€å°çš„å†…å®¹ä¸º1->å¯¹é½è¾¹ç•Œåä¸º16ï¼ˆCSAPP è¯¾æœ¬ç»ƒä¹ é¢˜9.7ï¼‰\n    if (size <= DSIZE)\n        asize = 2 * DSIZE;\n    else\n        // éœ€è¦åˆ†é…çš„å¤§å°+å¤´éƒ¨+å°¾éƒ¨\n        asize = ALIGN(size+DSIZE); // ALIGN(size) (((size) + (ALIGNMENT - 1)) & ~0x7)\n        // è¯¾æœ¬ï¼šasize = DSIZE * ((size + (DSIZE) + (DSIZE - 1)) / DSIZE); \n\n    // ä½¿ç”¨é€‚é…ç®—æ³•\n    if ((bp = find_fit(asize)) != NULL)\n    {\n        place(bp, asize);\n        return bp;\n    }\n\n    // æ‰¾ä¸åˆ°åˆé€‚çš„åŒ¹é…å°±æ‰©å±•\n    extend_size = MAX(asize, CHUNKSIZE);\n    if ((bp = extend_heap(extend_size / WSIZE)) == NULL)\n    {\n        return NULL;\n    }\n    place(bp, asize);\n    return bp;\n}\n\n\n\n/*\n * mm_realloc - Implemented simply in terms of mm_malloc and mm_free\n */\nvoid *mm_realloc(void *ptr, size_t size)\n{\n    void *oldptr = ptr;\n    void *newptr;\n    size_t copySize;\n\n    newptr = mm_malloc(size);\n    if (newptr == NULL)\n        return NULL;\n    if (ptr == NULL)\n    {\n        return newptr;\n    }\n\n    copySize = GET_SIZE(HDRP(oldptr));\n    if (size < copySize)\n        copySize = size;\n    memcpy(newptr, oldptr, copySize);\n    mm_free(oldptr);\n    return newptr;\n    // return NULL;\n}\n\n// æ”¾ç½®å—ï¼ˆè¯¾æœ¬ç»ƒä¹ 9.9ï¼‰\nstatic void place(void *bp,size_t asize){\n    size_t free_block_size = GET_SIZE(HDRP(bp));\n\n    // ç©ºé—²å—å‡å»éœ€è¦åˆ†é…çš„å¤§å°ï¼Œå¾—åˆ°çš„ç¢ç‰‡å¿…é¡»è‡³å°‘èƒ½å®¹çº³ä¸€ä¸ªæœ€å°çš„å¯åˆ†é…çš„å—ï¼ˆ2*DSIZEï¼Œä¹Ÿå°±æ˜¯å¤´éƒ¨4+å°¾éƒ¨4+æœ€å°çš„å†…å®¹ä¸º1->å¯¹é½è¾¹ç•Œåä¸º16ï¼‰\n    if((free_block_size - asize)>=2*DSIZE){\n        // è£å‰ª\n        PUT(HDRP(bp),PACK(asize,1));\n        PUT(FTRP(bp),PACK(asize,1));\n        bp = NEXT_BLKP(bp);\n        PUT(HDRP(bp),PACK(free_block_size-asize,0));\n        PUT(FTRP(bp),PACK(free_block_size-asize,0));\n    }else{\n        PUT(HDRP(bp),PACK(free_block_size,1));\n        PUT(FTRP(bp),PACK(free_block_size,1));\n    }\n\n}\n\n/***** é€‚é…ç®—æ³•  ******/\n\nstatic void *find_fit(size_t asize){\n    // asize é¢„ç•™äº†å¤´éƒ¨å’Œè„šéƒ¨çš„å¤§å°\n#ifdef NEXT_FIT\n    return algo_next_fit(asize);\n#else\n    return algo_first_fit(asize);\n#endif\n}\n\n// é¦–æ¬¡åŒ¹é…ç®—æ³•ï¼ˆè¯¾æœ¬ç»ƒä¹ 9.8ï¼‰\nstatic void *algo_first_fit(size_t asize){\n    void* bp =heap_listp;\n    while(GET_SIZE(HDRP(bp))>0){\n        if(!GET_ALLOC(HDRP(bp)) && (asize<=GET_SIZE(HDRP(bp)))){\n            return bp;\n        }\n        bp = NEXT_BLKP(bp);\n    }\n    return NULL;\n}\n\n// ä¸‹æ¬¡é€‚é…ç®—æ³•\n#ifdef NEXT_FIT\n    static void* last_heap_listp = NULL; // ä¸Šæ¬¡éå†çš„æŒ‡é’ˆ\n    static void *algo_next_fit(size_t asize){\n        void* bp;\n        if(last_heap_listp!=NULL){\n            bp =last_heap_listp;\n        }else{\n            bp =heap_listp;\n        }\n        \n        while(GET_SIZE(HDRP(bp))>0){\n            if(!GET_ALLOC(HDRP(bp)) && (asize<=GET_SIZE(HDRP(bp)))){\n                last_heap_listp=bp;\n                return bp;\n            }\n            bp = NEXT_BLKP(bp);\n        }\n        last_heap_listp = NULL;\n\n        // ä»å¤´å†æœç´¢ä¸€é\n        return algo_first_fit(asize);\n    }\n#endif\n\n```\n\n# åè®°\n\nè¿™ä¸ªå®éªŒï¼Œæ‰‹æ‰“ä»£ç ï¼Œbug çœŸå¤šã€‚çœŸä¸èƒ½ç›¸ä¿¡è‚‰çœ¼å¯¹ç…§ï¼Œåªèƒ½ä¿¡ CV å¤§æ³•ã€‚\n\né™äºæ•™å­¦å®‰æ’å’Œæœ¬äººæ—¶é—´ï¼ŒCSAPP LABS å°±æ›´æ–°åˆ°è¿™é‡Œã€‚å…¶å®è¿™äº›å®éªŒè¦åŸºæœ¬å®Œæˆä¹Ÿå¹¶ä¸å›°éš¾ï¼Œåœ¨æ“ä½œçš„åŒæ—¶å¯ä»¥å­¦åˆ°è®¸å¤š C è¯­è¨€çš„çŸ¥è¯†ï¼Œç§¯ç´¯ç¼–ç¨‹ç»éªŒï¼Œå¯¹åç»­ç†è§£è®¡ç®—æœºéƒ½æœ‰å¸®åŠ©ã€‚\n\nå¸Œæœ›å¤§å®¶åœ¨çŸ¥è¯†çš„æµ·æ´‹é‡Œã€åœ¨å­˜å‚¨å™¨å±±ä¸­æ”¶è·æ»¡æ»¡ï¼ğŸ¥³ğŸ¥³ğŸ¥³\n\n# æœ¬æ–‡å‚è€ƒ\n- ã€ŠCSAPPã€‹ç¬¬ä¸‰ç‰ˆç¬¬ä¹ç« å†…å®¹\n- [CSAPPè¯¾ç¨‹Lab6 Malloc Lab - çŸ¥ä¹ (zhihu.com)](https://zhuanlan.zhihu.com/p/672618494)\n- [CSAPPä¹‹è¯¦è§£MollocLab - ç®€ä¹¦ (jianshu.com)](https://www.jianshu.com/p/6e59fde0e6c0)\n","categories":[{"name":"CSAPP LABS","api":"api/categories/CSAPP-LABS.json"}],"tags":[{"name":"CSAPP","api":"api/tags/CSAPP.json"},{"name":"C","api":"api/tags/C.json"},{"name":"malloc","api":"api/tags/malloc.json"},{"name":"å†…å­˜åˆ†é…","api":"api/tags/å†…å­˜åˆ†é….json"}]},"api":"api/posts/p/3eb1abc7.json"}