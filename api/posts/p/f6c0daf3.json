{"data":{"title":"Butterfly 侧边栏实现 Obsidian 关系图谱","slug":"博客站点维护/Hexo/Butterfly 侧边栏实现 Obsidian 关系图谱","description":"通过自制脚本实现文章关系图绘制以及加入 Hexo 部署自动化流程中","date":"2023-08-11T14:30:29.000Z","updated":"2025-01-14T12:40:33.890Z","language":"zh-CN","comments":true,"url":"p/f6c0daf3/","cover":"https://cdn.gallery.uuanqin.top/img/relationcover.png","images":[],"content":"\n<div class=\"callout\" data-callout=\"success\">\n<div class=\"callout-title\">\n<div class=\"callout-title-icon\">\n<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-check\"><path d=\"M20 6 9 17l-5-5\"/></svg>\n</div>\n<div class=\"callout-title-inner\">本文不涉及对主题源代码的修改</div>\n</div>\n<div class=\"callout-content\"><p></p>\n</div></div>\n<div class=\"callout\" data-callout=\"hint\">\n<div class=\"callout-title\">\n<div class=\"callout-title-icon\">\n<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-flame\"><path d=\"M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z\"/></svg>\n</div>\n<div class=\"callout-title-inner\">兼容性信息</div>\n</div>\n<div class=\"callout-content\"><p></p>\n<ul>\n<li>文章中脚本已适配 cosma 2.4.0 版本 <code>231227</code></li>\n<li>cosma v2.1.0 版本更新后，原生支持 Obsidian 标题形式的双向链接，但优先识别 id 字段。本脚本执行过程会向输出文件增加 id 元数据，所以脚本在新版本 cosma 下仍能<strong>正确实现</strong>预期的功能。更多信息详见：<a href=\"https://cosma.arthurperret.fr/changelog.html\">Cosma | Changelog (arthurperret.fr)</a></li>\n</ul>\n</div></div><p>本文包含的项目：</p>\n<p><a href=\"https://github.com/uuanqin/obsidian2cosma\"><img src= \"/image/loading.gif\" data-lazy-src=\"https://github-readme-stats.uuanqin.top/api/pin/?username=uuanqin&amp;repo=obsidian2cosma\" alt=\"Readme Card\" /></a></p>\n<h1 id=\"挖坑\"><a class=\"markdownIt-Anchor\" href=\"#挖坑\"></a> 挖坑</h1>\n<p>由于最近使用 Obsidian 写文章，页面之间的链接越来越丰富，关系图谱越来越复杂。我在想能不能有一种方法可以把 Obsidian 的这张关系图导出放在网站上呢？经历一番探索之后，我发现 Obsidian 官方是推出过关系图生成网页的功能的：<a href=\"https://obsidian.md/publish\">Obsidian Publish</a>，但它是付费服务。</p>\n<p>终于，我在 Obsidian 的论坛找到了我想要的：<a href=\"https://forum.obsidian.md/t/share-the-graph-view-and-notes-as-html-page-for-free-with-obsidian2cosma/51070\">Share the graph view and notes as HTML page for free with obsidian2cosma - Share &amp; showcase - Obsidian Forum</a>。在这篇帖子中，作者利用一款可以生成这种关系图的开源 APP <a href=\"https://cosma.arthurperret.fr/installing.html\">Cosma</a> 进行生成。Cosma 可以生成一个 HTML 网页，在包含关系图的同时提供对各个结点的交互，让用户在多种视图下审阅知识库的内容。</p>\n<p>为了让文章中的双向链接能被 Cosma 识别，帖子作者 <a href=\"https://github.com/kevinpolisano\">Kévin Polisano</a> 还自己编写了一个 <a href=\"https://github.com/kevinpolisano/obsidian2cosma\">Python 命令行工具</a>，将 Obsidian 知识库中的文章的 Front-matter、以及双向链接的格式进行替换，以使得 Cosma 能够识别文章。这一点就让我看到了 Hexo 关系图谱实现的可能性，于是耗时一个星期的挖坑开始了…</p>\n<h1 id=\"效果\"><a class=\"markdownIt-Anchor\" href=\"#效果\"></a> 效果</h1>\n<p>文章在 Obsidian 中显示的关系视图是这样的：</p>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/20230811225333.png\" alt=\"image.png\" width=\"300px\" /></p>\n<p>在 Hexo 侧边栏是这样的：</p>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/20230811225838.png\" alt=\"image.png\" width=\"350px\" /></p>\n<p>主关系图网页是这样的：</p>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/20230811230008.png\" alt=\"image.png\" /></p>\n<p>包含了各种标签筛选、视图以及文章查看等功能。</p>\n<h1 id=\"思路\"><a class=\"markdownIt-Anchor\" href=\"#思路\"></a> 思路</h1>\n<p>整个过程分为几个步骤，我的愿景是脚本全自动进行。在 Hexo 进行本地部署或上传至服务器时进行以下操作：</p>\n<ol>\n<li>使用脚本转换 Hexo 中 <code>_posts</code> 目录下的文章为 Cosma 可以识别的文章</li>\n<li>运行两次 Cosma，根据不同的配置文件生成两个不一样的 <code>cosmoscope.html</code>（这就是我说的那个关键的包含关系图谱网页）</li>\n<li>将其中一个 <code>cosmoscope.html</code> 用脚本进行修剪，用做侧边栏的展示</li>\n<li>将处理好的 <code>cosmoscope.html</code> 粘贴到 Hexo 博客 <code>source</code> 目录下某指定文件夹中</li>\n<li>删除转换后的文件，以免 Obsidian 仓库混淆</li>\n<li>脚本进行剩余的本地部署或发布操作</li>\n</ol>\n<h1 id=\"操作\"><a class=\"markdownIt-Anchor\" href=\"#操作\"></a> 操作</h1>\n<h2 id=\"转换-obsidian-文章为-cosma-可识别的文章\"><a class=\"markdownIt-Anchor\" href=\"#转换-obsidian-文章为-cosma-可识别的文章\"></a> 转换 Obsidian 文章为 Cosma 可识别的文章</h2>\n<p>这一步是关键一步。只要能导出 HTML 关系图谱网页那么一切都好办了。</p>\n<p>前面提到过 Kévin Polisano 写了一个脚本实现了这样的功能，但是限于这个脚本的诞生条件（Cosma 有未修复的 Bug）以及创作环境（作者是法国人且常用 Linux/IOS，脚本有很多兼容性 Bug），导致它的脚本跑不起来。</p>\n<p>在我仔细研读源代码后决定将其重写代码以让它正确工作。项目地址如下：</p>\n<p><a href=\"https://github.com/uuanqin/obsidian2cosma\"><img src= \"/image/loading.gif\" data-lazy-src=\"https://github-readme-stats.uuanqin.top/api/pin/?username=uuanqin&amp;repo=obsidian2cosma\" alt=\"Readme Card\" /></a></p>\n<blockquote>\n<p><em>欢迎大家来捧场 🎉🎉！喜欢可以点个 star ⭐</em></p>\n</blockquote>\n<p>这个脚本最主要特点：<strong>Windows/Linux/MacOS 适配</strong>、<strong>Cosma/Zettlr 兼容</strong>、<strong>适合 Hexo 类型文章管理</strong>、<strong>语言支持（更适合中国宝宝体质）</strong>。</p>\n<p>我在原脚本的基础上修复了一些 Bug 也增加了一些功能以适配我的需求：</p>\n\n<div class=\"callout\" data-callout=\"cite\">\n<div class=\"callout-title\">\n<div class=\"callout-title-icon\">\n<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-quote\"><path d=\"M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z\"/><path d=\"M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2h.75c0 2.25.25 4-2.75 4v3c0 1 0 1 1 1z\"/></svg>\n</div>\n<div class=\"callout-title-inner\">修复与增强</div>\n</div>\n<div class=\"callout-content\"><p></p>\n<ul>\n<li>重写了 YAML 解析器，使之可以解析更多格式的 YAML，摆脱特定关键字的依赖。</li>\n<li>重写了创建 ID 的逻辑。</li>\n<li>功能：更改 front-matter 中的关键字名称。</li>\n<li>修复了在 Windows 上复制源文件创建日期时出现的错误。</li>\n<li>提高在 Windows 上工作的效率。</li>\n<li>为频繁使用脚本提供交互增强。</li>\n<li>支持使用 UTF-8 字符集，中文标题文章也能用。</li>\n<li>更新 <a href=\"http://README.md\">README.md</a> 并增加其中文版本。</li>\n<li>其他：ID 冲突检测、程序运行时间计算等</li>\n</ul>\n<p><em>—— 摘自 <a href=\"https://github.com/uuanqin/obsidian2cosma/blob/main/README_zh.md\">uuanqin/obsidian2cosma(github.com) 中文文档</a></em></p>\n</div></div><h2 id=\"使用-cosma-生成关系图谱-html\"><a class=\"markdownIt-Anchor\" href=\"#使用-cosma-生成关系图谱-html\"></a> 使用 Cosma 生成关系图谱 HTML</h2>\n<p>在使用了上述脚本后，输出的 Markdown 文件会在指定的文件夹中，这里假设为 <code>data/</code>。接下来我们使用 Cosma 进行读取和转换。</p>\n<p>Cosma 的安装与使用请详详细细阅读官网：<a href=\"https://cosma.arthurperret.fr/about.html\">Cosma | About Cosma (arthurperret.fr)</a></p>\n<p>我的设想是使用两个不同的 Cosma 配置文件生成两种 <code>cosmoscope.html</code>：一个用做侧边栏的基础展示，不需要那么多花里胡哨的功能，视图更清晰一些即可，这里我称之 <code>cosmoscope_trim.html</code>；另一个用做正式的交互网页，一般原封不动即可。</p>\n<h2 id=\"对-cosmoscopehtml-进行修剪与美化\"><a class=\"markdownIt-Anchor\" href=\"#对-cosmoscopehtml-进行修剪与美化\"></a> 对 <code>cosmoscope.html</code> 进行修剪与美化</h2>\n<p>在上一步中，配置文件只能调一些基本结点样式而已，不能关闭一些功能。这就会导致 <code>cosmoscope_trim.html</code> 文件很大，在侧边栏中显示不全。因此，这里我通过浏览器 F12 确定删减的标签与更改的样式，在将这个操作新写成另一个 Python 脚本。</p>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/20230811233922.png\" alt=\"image.png\" /></p>\n<p>此外，我对这个网页增加了一个按钮，让读者可以进入到主关系视图网页。项目来自：<a href=\"https://codepen.io/jqueryalmeida/pen/ZxmzYe\">Css buttom (codepen.io)</a></p>\n<p>脚本分享：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">&quot;&quot;&quot;</span></span><br><span class=\"line\"><span class=\"string\">  此脚本将根据 Cosma CLI 2.4.0 生成的关系图谱网页进行修剪。</span></span><br><span class=\"line\"><span class=\"string\">  作者：uuanqin（wuanqin@mail.ustc.edu.cn）</span></span><br><span class=\"line\"><span class=\"string\">&quot;&quot;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> os</span><br><span class=\"line\"><span class=\"keyword\">import</span> re</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> bs4 <span class=\"keyword\">import</span> BeautifulSoup</span><br><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\"><span class=\"keyword\">from</span> pathlib <span class=\"keyword\">import</span> Path</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">trim</span>(<span class=\"params\">target_html</span>):</span><br><span class=\"line\">    <span class=\"string\">&quot;&quot;&quot;</span></span><br><span class=\"line\"><span class=\"string\">    修剪 HTML文件使之能在侧边栏展出</span></span><br><span class=\"line\"><span class=\"string\">    :return:</span></span><br><span class=\"line\"><span class=\"string\">    &quot;&quot;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    soup = BeautifulSoup(<span class=\"built_in\">open</span>(target_html,<span class=\"string\">&quot;r&quot;</span>,encoding=<span class=\"string\">&quot;utf-8&quot;</span>), <span class=\"string\">&#x27;html.parser&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># 删除多余元素</span></span><br><span class=\"line\">    soup.html.body.aside.decompose()</span><br><span class=\"line\">    soup.html.body.main.decompose()</span><br><span class=\"line\">    soup.html.body.button.decompose() <span class=\"comment\"># 2.4.0</span></span><br><span class=\"line\">    soup.html.body.button.decompose() <span class=\"comment\"># 2.4.0</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> div <span class=\"keyword\">in</span> soup.html.body.find_all(<span class=\"string\">&quot;div&quot;</span>, &#123;<span class=\"string\">&#x27;class&#x27;</span>: <span class=\"string\">&#x27;graph-controls&#x27;</span>&#125;):</span><br><span class=\"line\">        div.decompose()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># 修改css，使得图片占据全画面</span></span><br><span class=\"line\">    style_str = soup.html.style.string</span><br><span class=\"line\">    style_str = re.sub(<span class=\"string\">r&quot;(width: )calc\\(100vw - 30rem\\)(;)&quot;</span>,<span class=\"string\">r&quot;\\1 100vw\\2&quot;</span>,style_str,count=<span class=\"number\">1</span>,flags=re.DOTALL)</span><br><span class=\"line\">    soup.html.style.string = style_str</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># 项目地址 https://codepen.io/jqueryalmeida/pen/ZxmzYe</span></span><br><span class=\"line\">    <span class=\"comment\"># CSS部分</span></span><br><span class=\"line\">    css_string = <span class=\"string\">&quot;&quot;&quot;</span></span><br><span class=\"line\"><span class=\"string\">   .btn-b &#123;</span></span><br><span class=\"line\"><span class=\"string\">    position: absolute;</span></span><br><span class=\"line\"><span class=\"string\">    bottom: 9%;</span></span><br><span class=\"line\"><span class=\"string\">    right: 2%;</span></span><br><span class=\"line\"><span class=\"string\">    cursor: pointer;</span></span><br><span class=\"line\"><span class=\"string\">    font-size: 10px;</span></span><br><span class=\"line\"><span class=\"string\">    text-align: left;</span></span><br><span class=\"line\"><span class=\"string\">    background: #a188fc;</span></span><br><span class=\"line\"><span class=\"string\">    background: linear-gradient(to right, #0f4eb4 1%, #07a1e9 100%);</span></span><br><span class=\"line\"><span class=\"string\">    color: #ddffff;</span></span><br><span class=\"line\"><span class=\"string\">    padding: 0rem 0rem 0rem 0rem;</span></span><br><span class=\"line\"><span class=\"string\">    border-radius: 10rem 50rem 50rem 10rem;</span></span><br><span class=\"line\"><span class=\"string\">    -webkit-transition: all 0.7s;</span></span><br><span class=\"line\"><span class=\"string\">    -moz-transition: all 0.7s;</span></span><br><span class=\"line\"><span class=\"string\">    transition: all 0.7s;</span></span><br><span class=\"line\"><span class=\"string\">    display: flex;</span></span><br><span class=\"line\"><span class=\"string\">    align-items: center;</span></span><br><span class=\"line\"><span class=\"string\">    justify-content: space-between;</span></span><br><span class=\"line\"><span class=\"string\">   &#125;</span></span><br><span class=\"line\"><span class=\"string\">   .btn-b:after &#123;</span></span><br><span class=\"line\"><span class=\"string\">    content: &quot;&quot;;</span></span><br><span class=\"line\"><span class=\"string\">    position: absolute;</span></span><br><span class=\"line\"><span class=\"string\">    right: -1px;</span></span><br><span class=\"line\"><span class=\"string\">    margin-left: 1em;</span></span><br><span class=\"line\"><span class=\"string\">    width: 35px;</span></span><br><span class=\"line\"><span class=\"string\">    height: 35px;</span></span><br><span class=\"line\"><span class=\"string\">    border-radius: 50%;</span></span><br><span class=\"line\"><span class=\"string\">    box-shadow: 0px 2px 8px 0px rgba(15, 78, 180, 0.22);</span></span><br><span class=\"line\"><span class=\"string\">    background: #3bc1ff url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48IS0tISBGb250IEF3ZXNvbWUgUHJvIDYuNC4yIGJ5IEBmb250YXdlc29tZSAtIGh0dHBzOi8vZm9udGF3ZXNvbWUuY29tIExpY2Vuc2UgLSBodHRwczovL2ZvbnRhd2Vzb21lLmNvbS9saWNlbnNlIChDb21tZXJjaWFsIExpY2Vuc2UpIENvcHlyaWdodCAyMDIzIEZvbnRpY29ucywgSW5jLiAtLT48cGF0aCBkPSJNMzQ0IDBINDg4YzEzLjMgMCAyNCAxMC43IDI0IDI0VjE2OGMwIDkuNy01LjggMTguNS0xNC44IDIyLjJzLTE5LjMgMS43LTI2LjItNS4ybC0zOS0zOS04NyA4N2MtOS40IDkuNC0yNC42IDkuNC0zMy45IDBsLTMyLTMyYy05LjQtOS40LTkuNC0yNC42IDAtMzMuOWw4Ny04N0wzMjcgNDFjLTYuOS02LjktOC45LTE3LjItNS4yLTI2LjJTMzM0LjMgMCAzNDQgMHpNMTY4IDUxMkgyNGMtMTMuMyAwLTI0LTEwLjctMjQtMjRWMzQ0YzAtOS43IDUuOC0xOC41IDE0LjgtMjIuMnMxOS4zLTEuNyAyNi4yIDUuMmwzOSAzOSA4Ny04N2M5LjQtOS40IDI0LjYtOS40IDMzLjkgMGwzMiAzMmM5LjQgOS40IDkuNCAyNC42IDAgMzMuOWwtODcgODcgMzkgMzljNi45IDYuOSA4LjkgMTcuMiA1LjIgMjYuMnMtMTIuNSAxNC44LTIyLjIgMTQuOHoiLz48L3N2Zz4=) no-repeat center;</span></span><br><span class=\"line\"><span class=\"string\">    background-size: 50%;</span></span><br><span class=\"line\"><span class=\"string\">   &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;&quot;&quot;</span></span><br><span class=\"line\">    new_style_tag = soup.new_tag(<span class=\"string\">&quot;style&quot;</span>)</span><br><span class=\"line\">    new_style_tag.string = css_string</span><br><span class=\"line\">    soup.html.head.append(new_style_tag)</span><br><span class=\"line\">    <span class=\"comment\"># HTML部分</span></span><br><span class=\"line\">    new_div_tag = soup.new_tag(<span class=\"string\">&quot;div&quot;</span>)</span><br><span class=\"line\">    new_div_tag[<span class=\"string\">&quot;class&quot;</span>] = <span class=\"string\">&quot;btn-b&quot;</span></span><br><span class=\"line\">    <span class=\"comment\"># 链接</span></span><br><span class=\"line\">    new_a_tag = soup.new_tag(<span class=\"string\">&quot;a&quot;</span>)</span><br><span class=\"line\">    new_a_tag[<span class=\"string\">&quot;href&quot;</span>] = <span class=\"string\">&quot;/DO_NOT_render/cosmoscope/cosmoscope.html&quot;</span></span><br><span class=\"line\">    new_a_tag[<span class=\"string\">&quot;target&quot;</span>] = <span class=\"string\">&quot;_blank&quot;</span></span><br><span class=\"line\">    new_a_tag.append(new_div_tag)</span><br><span class=\"line\">    soup.html.body.div.insert_after(new_a_tag)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># 重新写回</span></span><br><span class=\"line\">    p = Path(target_html)</span><br><span class=\"line\">    output_html =  os.path.dirname(target_html)+<span class=\"string\">&quot;/&quot;</span>+p.stem+<span class=\"string\">&#x27;_trim.html&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">with</span> <span class=\"built_in\">open</span>(output_html,<span class=\"string\">&quot;w&quot;</span>,encoding=<span class=\"string\">&quot;utf-8&quot;</span>) <span class=\"keyword\">as</span> f:</span><br><span class=\"line\">        f.write(soup.prettify())</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&quot;__main__&quot;</span>:</span><br><span class=\"line\">    <span class=\"comment\"># target_html = &quot;cosma_dir/cosmoscope.html&quot;</span></span><br><span class=\"line\">    trim(sys.argv[<span class=\"number\">1</span>])</span><br></pre></td></tr></table></figure>\n<h2 id=\"hexo-侧边栏配置\"><a class=\"markdownIt-Anchor\" href=\"#hexo-侧边栏配置\"></a> Hexo 侧边栏配置</h2>\n<p>实现无缝侧边栏参考我这篇教程：<a class=\"uuanqin-bilink\" target=\"_blank\" href=\"/p/568ad08/\"><span class=\"bilink-pop-up\">站内文章</span>Butterfly 不改动主题源码实现自定义侧边栏</a></p>\n<p>widge.yml：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">class_name:</span> <span class=\"string\">seamless-card</span></span><br><span class=\"line\">\t<span class=\"attr\">id_name:</span></span><br><span class=\"line\">\t<span class=\"attr\">name:</span></span><br><span class=\"line\">\t<span class=\"attr\">icon:</span></span><br><span class=\"line\">\t<span class=\"attr\">order:</span></span><br><span class=\"line\">\t<span class=\"attr\">html:</span> <span class=\"string\">|</span></span><br><span class=\"line\">\t\t<span class=\"string\">&lt;div</span> <span class=\"string\">style=&quot;height:</span> <span class=\"string\">250px&quot;&gt;</span></span><br><span class=\"line\">\t\t<span class=\"string\">&lt;iframe</span> <span class=\"string\">src=&quot;/DO_NOT_render/cosmoscope/cosmoscope_trim.html&quot;</span> <span class=\"string\">frameborder=&quot;no&quot;</span> <span class=\"string\">style=&quot;width:</span> <span class=\"number\">100</span><span class=\"string\">%;</span> <span class=\"attr\">height:</span> <span class=\"number\">100</span><span class=\"string\">%&quot;&gt;&lt;/iframe&gt;</span></span><br><span class=\"line\">\t\t<span class=\"string\">&lt;/div&gt;</span></span><br></pre></td></tr></table></figure>\n<p>可以看到 iframe 指向 <code>cosmoscope_trim.html</code>。</p>\n<h2 id=\"hexo-部署自动化\"><a class=\"markdownIt-Anchor\" href=\"#hexo-部署自动化\"></a> Hexo 部署自动化</h2>\n<p>上文 <a href=\"#%E6%80%9D%E8%B7%AF\">思路</a>，中提到的自动化步骤，通过了 npm script 及其钩子实现。</p>\n<p>以前的文章中我提到过钩子的用法：</p>\n<ul>\n<li>使用钩子在 Hexo 部署前检查 Obsidian 是否启动：<a class=\"uuanqin-bilink\" target=\"_blank\" href=\"/p/d4bc55f2/\"><span class=\"bilink-pop-up\">站内文章</span>Hexo 博客适配 Obsidian 新语法</a></li>\n<li>Hexo 发布后自动刷新 CDN：<a class=\"uuanqin-bilink\" target=\"_blank\" href=\"/p/b05ac1ee/\"><span class=\"bilink-pop-up\">站内文章</span>将 CDN 缓存自动刷新加入到博客发布的工作流（Hexo、WordPress）</a></li>\n</ul>\n<p>分享我目前的 npm script：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">&quot;scripts&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\"><span class=\"attr\">&quot;build&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;hexo generate&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\"><span class=\"attr\">&quot;clean&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;hexo clean&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\"><span class=\"attr\">&quot;deploy&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;hexo deploy&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\"><span class=\"attr\">&quot;server&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;hexo server&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\"><span class=\"attr\">&quot;prepublish&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;npm run check-obsidian &amp;&amp; npm run check-markdown-filename&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\"><span class=\"attr\">&quot;publish&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;hexo clean &amp;&amp; hexo g &amp;&amp; npm run gen-cosma &amp;&amp; hexo d&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\"><span class=\"attr\">&quot;postpublish&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;hexo algolia &amp;&amp; npm run flush-cdn&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\"><span class=\"attr\">&quot;prestart&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;npm run check-obsidian &amp;&amp; npm run check-markdown-filename&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\"><span class=\"attr\">&quot;start&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;hexo clean &amp;&amp; hexo g &amp;&amp; npm run gen-cosma &amp;&amp; hexo s&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\"><span class=\"attr\">&quot;flush-cdn&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;node my_scripts/auto_flush_cdn.js&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\"><span class=\"attr\">&quot;check-obsidian&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;node my_scripts/check_obsidian.js&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\"><span class=\"attr\">&quot;check-markdown-filename&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;python my_scripts/check_md_name.py source/_posts&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\"><span class=\"attr\">&quot;ob2co&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;python my_scripts/obsidian2cosma.py -i source/_posts -o my_scripts/cosma_dir/data --ignore -f --method abbrlink --attrreplacement categories,types date,begin --verbose&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\"><span class=\"attr\">&quot;cosma-total&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;cd my_scripts/cosma_dir/dir_total &amp;&amp; cosma m&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\"><span class=\"attr\">&quot;cosma-trim&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;cd my_scripts/cosma_dir/dir_trim &amp;&amp; cosma m &amp;&amp; python ../../cosmoscope_trim.py ../../cosma_dir/dir_trim/cosmoscope.html&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\"><span class=\"attr\">&quot;cosma-copy&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;copy \\&quot;.\\\\my_scripts\\\\cosma_dir\\\\dir_total\\\\cosmoscope.html\\&quot; \\&quot;.\\\\source\\\\DO_NOT_render\\\\cosmoscope\\\\cosmoscope.html\\&quot; &amp; copy \\&quot;.\\\\my_scripts\\\\cosma_dir\\\\dir_trim\\\\cosmoscope_trim.html\\&quot; \\&quot;.\\\\source\\\\DO_NOT_render\\\\cosmoscope\\\\cosmoscope_trim.html\\&quot;&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\"><span class=\"attr\">&quot;cosma-rm-output&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;echo \\&quot;删除转换后的输出文件 - Cosma\\&quot; &amp;&amp; rmdir /s /q .\\\\my_scripts\\\\cosma_dir\\\\data\\\\&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\"><span class=\"attr\">&quot;gen-cosma&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;npm run ob2co &amp;&amp; npm run cosma-total &amp;&amp; npm run cosma-trim &amp;&amp; npm run cosma-copy &amp;&amp; npm run cosma-rm-output&quot;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<p>每个步骤保持分开，以方便调试。</p>\n<p>obsidian2cosma 脚本指令：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">python my_scripts/obsidian2cosma.py</span><br><span class=\"line\">\t-i <span class=\"built_in\">source</span>/_posts</span><br><span class=\"line\">\t-o my_scripts/cosma_dir/data</span><br><span class=\"line\">\t--ignore</span><br><span class=\"line\">\t-f</span><br><span class=\"line\">\t--method abbrlink</span><br><span class=\"line\">\t--attrreplacement categories,types <span class=\"built_in\">date</span>,begin</span><br><span class=\"line\">\t--verbose</span><br></pre></td></tr></table></figure>\n<h1 id=\"后记\"><a class=\"markdownIt-Anchor\" href=\"#后记\"></a> 后记</h1>\n<p>最终能完成这样的效果我也很欣慰，和设想的差不多，<s>似乎感受到了一丢丢程序员改变世界的力量 🤭🤭🤭</s>。很多细节我没有详细写出，但是把最重要的思路理清了，有问题的小伙伴可直接评论。</p>\n<h2 id=\"后续改进\"><a class=\"markdownIt-Anchor\" href=\"#后续改进\"></a> 后续改进</h2>\n<ul class=\"contains-task-list\">\n<li class=\"task-list-item\"><input class=\"task-list-item-checkbox\" checked=\"\" disabled=\"\" type=\"checkbox\"> 事后清洁，删除输出的 Markdown 文档以免混淆 Obsidian</li>\n<li class=\"task-list-item\"><input class=\"task-list-item-checkbox\" disabled=\"\" type=\"checkbox\"> 处理侧边栏图片报错问题，太吵了（有点困难，因为 js 有压缩，只能另辟蹊径）</li>\n<li class=\"task-list-item\"><input class=\"task-list-item-checkbox\" disabled=\"\" type=\"checkbox\"> 研究不同页面 Focus</li>\n<li class=\"task-list-item\"><input class=\"task-list-item-checkbox\" disabled=\"\" type=\"checkbox\"> 主页面增加原文跳转链接（这可能得深入源码去改，或者编写脚本，统一从源 HTML 创造 N 份版本）</li>\n<li class=\"task-list-item\"><input class=\"task-list-item-checkbox\" disabled=\"\" type=\"checkbox\"> 攻克侧边栏 Iframe 网页内的夜间模式问题</li>\n<li class=\"task-list-item\"><input class=\"task-list-item-checkbox\" disabled=\"\" type=\"checkbox\"> 移动端适配不是很友好</li>\n<li class=\"task-list-item\"><input class=\"task-list-item-checkbox\" disabled=\"\" type=\"checkbox\"> 历史记录 history 臃肿，需要不时删一删</li>\n<li class=\"task-list-item\"><input class=\"task-list-item-checkbox\" checked=\"\" disabled=\"\" type=\"checkbox\"> cosma 2.1.0 侧边栏显示图像过小（只能等更新，脚本暂时无法处理）（新版本已修复问题）</li>\n<li class=\"task-list-item\"><input class=\"task-list-item-checkbox\" disabled=\"\" type=\"checkbox\"> 完整网页加载较慢。原因是 cosma 需要对所有的网络图片进行加载，没有懒加载功能。这会导致 CDN 流量过大。</li>\n</ul>\n<blockquote>\n<p>其实，自己弄一个简单的，就可以解决上面所有问题。</p>\n</blockquote>\n<h2 id=\"踩过的坑\"><a class=\"markdownIt-Anchor\" href=\"#踩过的坑\"></a> 踩过的坑</h2>\n<ol>\n<li>npm script 中使用 copy 命令时，路径用 <code>\\\\</code> 分隔，不然会找不到文件</li>\n<li>你可能会把 Obsidian2cosma 脚本输出的文档放在了平时用 Obsidian 写作的 Vault 内。请注意，这样的话 Obsidian 仓库中就会出现两个同名但不同文件夹的文章，会导致<strong>以后</strong>平时插入双向链接或修改双向链接时出现双向链接题目不对的问题，进而导致<strong>第二次</strong>使用该脚本时一些链接识别不出的问题。</li>\n<li>博客根目录不要创建 <code>scripts</code> 目录并在里面放自己写的脚本，除非你知道自己在做什么。否则导致 <code>hexo clean</code> 出错。针对这一点，我似乎找到了根源：<a href=\"https://hexo.io/zh-cn/docs/plugins.html#%E8%84%9A%E6%9C%AC%EF%BC%88Scripts%EF%BC%89\">插件 | Hexo</a></li>\n</ol>\n<h1 id=\"本文参考\"><a class=\"markdownIt-Anchor\" href=\"#本文参考\"></a> 本文参考</h1>\n<ul>\n<li><a href=\"https://docs.zettlr.com/en/academic/zkn-method/\">Zettelkasten Methods - Zettlr Docs</a></li>\n<li><a href=\"https://cosma.arthurperret.fr/user-manual.html\">Cosma | User Manual (arthurperret.fr)</a></li>\n<li><a href=\"https://forum.obsidian.md/t/share-the-graph-view-and-notes-as-html-page-for-free-with-obsidian2cosma/51070\">Share the graph view and notes as HTML page for free with obsidian2cosma - Share &amp; showcase - Obsidian Forum</a></li>\n<li><a href=\"https://blog.csdn.net/qq_19934363/article/details/118091299\">Python os.system 乱码_输微的博客-CSDN 博客</a></li>\n<li><a href=\"https://stackoverflow.com/questions/4996405/how-do-i-change-the-file-creation-date-of-a-windows-file#:~:text=pip%20install%20win32-setctime%20And%20then%20use%20it%20like,dependency%20other%20that%20the%20built-in%20ctypes%20Python%20library%3A\">stackoverflow.com/questions/4996405/how-do-i-change-the-file-creation-date-of-a-windows-file#:~:text=pip install win32-setctime And then use it like,dependency other that the built-in ctypes Python library%3A</a></li>\n<li><a href=\"https://www.winhelponline.com/blog/change-accessed-modified-created-file-date-timestamp-windows/\">winhelponline.com/blog/change-accessed-modified-created-file-date-timestamp-windows/</a></li>\n<li><a href=\"https://yaml.org/spec/1.2.2/#a-long-long-long-long-link\">YAML Ain’t Markup Language (YAML™) revision 1.2.2</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/429205730\">Python 正则表达式细节小记 - 知乎 (zhihu.com)</a></li>\n<li><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/HTML/Global_attributes/id\">id - HTML（超文本标记语言） | MDN (mozilla.org)</a></li>\n<li><a href=\"https://www.windowsdigitals.com/change-file-date-timestamp-cmd-powershell/#:~:text=Set-ItemProperty%20-Path%20%22example.txt%22%20-Name%20CreationTime%20-Value%20%24NewDate,Set-ItemProperty%20-Path%20%22example.txt%22%20-Name%20LastWriteTime%20-Value%20%24NewDate\">Change File(s) Date &amp; Timestamp via CMD or PowerShell (windowsdigitals.com)</a></li>\n<li><a href=\"https://blog.csdn.net/yedajiang44/article/details/118176272\">powershell 执行多条命令_powershell 执行多条命令_yedajiang44 的博客-CSDN 博客</a></li>\n</ul>\n","raw":"---\ntitle: Butterfly 侧边栏实现 Obsidian 关系图谱\ntags:\n  - Butterfly\n  - Obsidian\n  - Cosma\n  - Python\n  - NPM\n  - script\n  - YAML\n  - Markdown\n  - HTML\n  - CSS\n  - 项目\n  - GitHub\ncover: 'https://cdn.gallery.uuanqin.top/img/relationcover.png'\ndescription: 通过自制脚本实现文章关系图绘制以及加入 Hexo 部署自动化流程中\ncategories:\n  - 博客站点维护\n  - Hexo\nabbrlink: f6c0daf3\ndate: 2023-08-11 22:30:29\ntop_img:\n---\n\n> [!success] 本文不涉及对主题源代码的修改\n\n> [!hint] 兼容性信息\n> - 文章中脚本已适配 cosma 2.4.0 版本 `231227`\n> - cosma v2.1.0 版本更新后，原生支持 Obsidian 标题形式的双向链接，但优先识别 id 字段。本脚本执行过程会向输出文件增加 id 元数据，所以脚本在新版本 cosma 下仍能**正确实现**预期的功能。更多信息详见：[Cosma | Changelog (arthurperret.fr)](https://cosma.arthurperret.fr/changelog.html)\n\n本文包含的项目：\n\n [![Readme Card](https://github-readme-stats.uuanqin.top/api/pin/?username=uuanqin&repo=obsidian2cosma)](https://github.com/uuanqin/obsidian2cosma)\n\n# 挖坑\n\n由于最近使用 Obsidian 写文章，页面之间的链接越来越丰富，关系图谱越来越复杂。我在想能不能有一种方法可以把 Obsidian 的这张关系图导出放在网站上呢？经历一番探索之后，我发现 Obsidian 官方是推出过关系图生成网页的功能的：[Obsidian Publish](https://obsidian.md/publish)，但它是付费服务。\n\n终于，我在 Obsidian 的论坛找到了我想要的：[Share the graph view and notes as HTML page for free with obsidian2cosma - Share & showcase - Obsidian Forum](https://forum.obsidian.md/t/share-the-graph-view-and-notes-as-html-page-for-free-with-obsidian2cosma/51070)。在这篇帖子中，作者利用一款可以生成这种关系图的开源 APP [Cosma](https://cosma.arthurperret.fr/installing.html) 进行生成。Cosma 可以生成一个 HTML 网页，在包含关系图的同时提供对各个结点的交互，让用户在多种视图下审阅知识库的内容。\n\n为了让文章中的双向链接能被 Cosma 识别，帖子作者 [Kévin Polisano](https://github.com/kevinpolisano) 还自己编写了一个 [Python 命令行工具](https://github.com/kevinpolisano/obsidian2cosma)，将 Obsidian 知识库中的文章的 Front-matter、以及双向链接的格式进行替换，以使得 Cosma 能够识别文章。这一点就让我看到了 Hexo 关系图谱实现的可能性，于是耗时一个星期的挖坑开始了......\n\n# 效果\n\n文章在 Obsidian 中显示的关系视图是这样的：\n\n![image.png|300](https://cdn.gallery.uuanqin.top/img/20230811225333.png)\n\n在 Hexo 侧边栏是这样的：\n\n![image.png|350](https://cdn.gallery.uuanqin.top/img/20230811225838.png)\n\n主关系图网页是这样的：\n\n![image.png](https://cdn.gallery.uuanqin.top/img/20230811230008.png)\n\n包含了各种标签筛选、视图以及文章查看等功能。\n\n# 思路\n\n整个过程分为几个步骤，我的愿景是脚本全自动进行。在 Hexo 进行本地部署或上传至服务器时进行以下操作：\n\n1. 使用脚本转换 Hexo 中 `_posts` 目录下的文章为 Cosma 可以识别的文章\n2. 运行两次 Cosma，根据不同的配置文件生成两个不一样的 `cosmoscope.html`（这就是我说的那个关键的包含关系图谱网页）\n3. 将其中一个 `cosmoscope.html` 用脚本进行修剪，用做侧边栏的展示\n4. 将处理好的 `cosmoscope.html` 粘贴到 Hexo 博客 `source` 目录下某指定文件夹中\n5. 删除转换后的文件，以免 Obsidian 仓库混淆\n6. 脚本进行剩余的本地部署或发布操作\n\n# 操作\n\n## 转换 Obsidian 文章为 Cosma 可识别的文章\n\n这一步是关键一步。只要能导出 HTML 关系图谱网页那么一切都好办了。\n\n前面提到过 Kévin Polisano 写了一个脚本实现了这样的功能，但是限于这个脚本的诞生条件（Cosma 有未修复的 Bug）以及创作环境（作者是法国人且常用 Linux/IOS，脚本有很多兼容性 Bug），导致它的脚本跑不起来。\n\n在我仔细研读源代码后决定将其重写代码以让它正确工作。项目地址如下：\n\n[![Readme Card](https://github-readme-stats.uuanqin.top/api/pin/?username=uuanqin&repo=obsidian2cosma)](https://github.com/uuanqin/obsidian2cosma)\n\n> _欢迎大家来捧场 🎉🎉！喜欢可以点个 star ⭐_\n\n这个脚本最主要特点：**Windows/Linux/MacOS 适配**、**Cosma/Zettlr 兼容**、**适合 Hexo 类型文章管理**、**语言支持（更适合中国宝宝体质）**。\n\n我在原脚本的基础上修复了一些 Bug 也增加了一些功能以适配我的需求：\n\n> [!Cite] 修复与增强\n>\n> - 重写了 YAML 解析器，使之可以解析更多格式的 YAML，摆脱特定关键字的依赖。\n> - 重写了创建 ID 的逻辑。\n> - 功能：更改 front-matter 中的关键字名称。\n> - 修复了在 Windows 上复制源文件创建日期时出现的错误。\n> - 提高在 Windows 上工作的效率。\n> - 为频繁使用脚本提供交互增强。\n> - 支持使用 UTF-8 字符集，中文标题文章也能用。\n> - 更新 README.md 并增加其中文版本。\n> - 其他：ID 冲突检测、程序运行时间计算等\n>\n> _—— 摘自 [uuanqin/obsidian2cosma(github.com) 中文文档](https://github.com/uuanqin/obsidian2cosma/blob/main/README_zh.md)_\n\n## 使用 Cosma 生成关系图谱 HTML\n\n在使用了上述脚本后，输出的 Markdown 文件会在指定的文件夹中，这里假设为 `data/`。接下来我们使用 Cosma 进行读取和转换。\n\nCosma 的安装与使用请详详细细阅读官网：[Cosma | About Cosma (arthurperret.fr)](https://cosma.arthurperret.fr/about.html)\n\n我的设想是使用两个不同的 Cosma 配置文件生成两种 `cosmoscope.html`：一个用做侧边栏的基础展示，不需要那么多花里胡哨的功能，视图更清晰一些即可，这里我称之 `cosmoscope_trim.html`；另一个用做正式的交互网页，一般原封不动即可。\n\n## 对 `cosmoscope.html` 进行修剪与美化\n\n在上一步中，配置文件只能调一些基本结点样式而已，不能关闭一些功能。这就会导致 `cosmoscope_trim.html` 文件很大，在侧边栏中显示不全。因此，这里我通过浏览器 F12 确定删减的标签与更改的样式，在将这个操作新写成另一个 Python 脚本。\n\n![image.png](https://cdn.gallery.uuanqin.top/img/20230811233922.png)\n\n此外，我对这个网页增加了一个按钮，让读者可以进入到主关系视图网页。项目来自：[Css buttom (codepen.io)](https://codepen.io/jqueryalmeida/pen/ZxmzYe)\n\n脚本分享：\n\n```python\n\"\"\"\n  此脚本将根据 Cosma CLI 2.4.0 生成的关系图谱网页进行修剪。\n  作者：uuanqin（wuanqin@mail.ustc.edu.cn）\n\"\"\"\n\nimport os\nimport re\n\nfrom bs4 import BeautifulSoup\nimport sys\nfrom pathlib import Path\n\ndef trim(target_html):\n    \"\"\"\n    修剪 HTML文件使之能在侧边栏展出\n    :return:\n    \"\"\"\n\n    soup = BeautifulSoup(open(target_html,\"r\",encoding=\"utf-8\"), 'html.parser')\n\n    # 删除多余元素\n    soup.html.body.aside.decompose()\n    soup.html.body.main.decompose()\n    soup.html.body.button.decompose() # 2.4.0\n    soup.html.body.button.decompose() # 2.4.0\n    for div in soup.html.body.find_all(\"div\", {'class': 'graph-controls'}):\n        div.decompose()\n\n\n    # 修改css，使得图片占据全画面\n    style_str = soup.html.style.string\n    style_str = re.sub(r\"(width: )calc\\(100vw - 30rem\\)(;)\",r\"\\1 100vw\\2\",style_str,count=1,flags=re.DOTALL)\n    soup.html.style.string = style_str\n\n    # 项目地址 https://codepen.io/jqueryalmeida/pen/ZxmzYe\n    # CSS部分\n    css_string = \"\"\"\n   .btn-b {\n    position: absolute;\n    bottom: 9%;\n    right: 2%;\n    cursor: pointer;\n    font-size: 10px;\n    text-align: left;\n    background: #a188fc;\n    background: linear-gradient(to right, #0f4eb4 1%, #07a1e9 100%);\n    color: #ddffff;\n    padding: 0rem 0rem 0rem 0rem;\n    border-radius: 10rem 50rem 50rem 10rem;\n    -webkit-transition: all 0.7s;\n    -moz-transition: all 0.7s;\n    transition: all 0.7s;\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n   }\n   .btn-b:after {\n    content: \"\";\n    position: absolute;\n    right: -1px;\n    margin-left: 1em;\n    width: 35px;\n    height: 35px;\n    border-radius: 50%;\n    box-shadow: 0px 2px 8px 0px rgba(15, 78, 180, 0.22);\n    background: #3bc1ff url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48IS0tISBGb250IEF3ZXNvbWUgUHJvIDYuNC4yIGJ5IEBmb250YXdlc29tZSAtIGh0dHBzOi8vZm9udGF3ZXNvbWUuY29tIExpY2Vuc2UgLSBodHRwczovL2ZvbnRhd2Vzb21lLmNvbS9saWNlbnNlIChDb21tZXJjaWFsIExpY2Vuc2UpIENvcHlyaWdodCAyMDIzIEZvbnRpY29ucywgSW5jLiAtLT48cGF0aCBkPSJNMzQ0IDBINDg4YzEzLjMgMCAyNCAxMC43IDI0IDI0VjE2OGMwIDkuNy01LjggMTguNS0xNC44IDIyLjJzLTE5LjMgMS43LTI2LjItNS4ybC0zOS0zOS04NyA4N2MtOS40IDkuNC0yNC42IDkuNC0zMy45IDBsLTMyLTMyYy05LjQtOS40LTkuNC0yNC42IDAtMzMuOWw4Ny04N0wzMjcgNDFjLTYuOS02LjktOC45LTE3LjItNS4yLTI2LjJTMzM0LjMgMCAzNDQgMHpNMTY4IDUxMkgyNGMtMTMuMyAwLTI0LTEwLjctMjQtMjRWMzQ0YzAtOS43IDUuOC0xOC41IDE0LjgtMjIuMnMxOS4zLTEuNyAyNi4yIDUuMmwzOSAzOSA4Ny04N2M5LjQtOS40IDI0LjYtOS40IDMzLjkgMGwzMiAzMmM5LjQgOS40IDkuNCAyNC42IDAgMzMuOWwtODcgODcgMzkgMzljNi45IDYuOSA4LjkgMTcuMiA1LjIgMjYuMnMtMTIuNSAxNC44LTIyLjIgMTQuOHoiLz48L3N2Zz4=) no-repeat center;\n    background-size: 50%;\n   }\n    \"\"\"\n    new_style_tag = soup.new_tag(\"style\")\n    new_style_tag.string = css_string\n    soup.html.head.append(new_style_tag)\n    # HTML部分\n    new_div_tag = soup.new_tag(\"div\")\n    new_div_tag[\"class\"] = \"btn-b\"\n    # 链接\n    new_a_tag = soup.new_tag(\"a\")\n    new_a_tag[\"href\"] = \"/DO_NOT_render/cosmoscope/cosmoscope.html\"\n    new_a_tag[\"target\"] = \"_blank\"\n    new_a_tag.append(new_div_tag)\n    soup.html.body.div.insert_after(new_a_tag)\n\n\n    # 重新写回\n    p = Path(target_html)\n    output_html =  os.path.dirname(target_html)+\"/\"+p.stem+'_trim.html'\n\n    with open(output_html,\"w\",encoding=\"utf-8\") as f:\n        f.write(soup.prettify())\n\nif __name__ == \"__main__\":\n    # target_html = \"cosma_dir/cosmoscope.html\"\n    trim(sys.argv[1])\n```\n\n## Hexo 侧边栏配置\n\n实现无缝侧边栏参考我这篇教程：[[Butterfly 不改动主题源码实现自定义侧边栏]]\n\nwidge.yml：\n\n```yaml\n- class_name: seamless-card\n\tid_name:\n\tname:\n\ticon:\n\torder:\n\thtml: |\n\t\t<div style=\"height: 250px\">\n\t\t<iframe src=\"/DO_NOT_render/cosmoscope/cosmoscope_trim.html\" frameborder=\"no\" style=\"width: 100%; height: 100%\"></iframe>\n\t\t</div>\n```\n\n可以看到 iframe 指向 `cosmoscope_trim.html`。\n\n## Hexo 部署自动化\n\n上文 [思路](#思路)，中提到的自动化步骤，通过了 npm script 及其钩子实现。\n\n以前的文章中我提到过钩子的用法：\n\n- 使用钩子在 Hexo 部署前检查 Obsidian 是否启动：[[Hexo 博客适配 Obsidian 新语法]]\n- Hexo 发布后自动刷新 CDN：[[将 CDN 缓存自动刷新加入到博客发布的工作流（Hexo、WordPress）]]\n\n分享我目前的 npm script：\n\n```json\n\"scripts\": {\n\"build\": \"hexo generate\",\n\"clean\": \"hexo clean\",\n\"deploy\": \"hexo deploy\",\n\"server\": \"hexo server\",\n\"prepublish\": \"npm run check-obsidian && npm run check-markdown-filename\",\n\"publish\": \"hexo clean && hexo g && npm run gen-cosma && hexo d\",\n\"postpublish\": \"hexo algolia && npm run flush-cdn\",\n\"prestart\": \"npm run check-obsidian && npm run check-markdown-filename\",\n\"start\": \"hexo clean && hexo g && npm run gen-cosma && hexo s\",\n\"flush-cdn\": \"node my_scripts/auto_flush_cdn.js\",\n\"check-obsidian\": \"node my_scripts/check_obsidian.js\",\n\"check-markdown-filename\": \"python my_scripts/check_md_name.py source/_posts\",\n\"ob2co\": \"python my_scripts/obsidian2cosma.py -i source/_posts -o my_scripts/cosma_dir/data --ignore -f --method abbrlink --attrreplacement categories,types date,begin --verbose\",\n\"cosma-total\": \"cd my_scripts/cosma_dir/dir_total && cosma m\",\n\"cosma-trim\": \"cd my_scripts/cosma_dir/dir_trim && cosma m && python ../../cosmoscope_trim.py ../../cosma_dir/dir_trim/cosmoscope.html\",\n\"cosma-copy\": \"copy \\\".\\\\my_scripts\\\\cosma_dir\\\\dir_total\\\\cosmoscope.html\\\" \\\".\\\\source\\\\DO_NOT_render\\\\cosmoscope\\\\cosmoscope.html\\\" & copy \\\".\\\\my_scripts\\\\cosma_dir\\\\dir_trim\\\\cosmoscope_trim.html\\\" \\\".\\\\source\\\\DO_NOT_render\\\\cosmoscope\\\\cosmoscope_trim.html\\\"\",\n\"cosma-rm-output\": \"echo \\\"删除转换后的输出文件 - Cosma\\\" && rmdir /s /q .\\\\my_scripts\\\\cosma_dir\\\\data\\\\\",\n\"gen-cosma\": \"npm run ob2co && npm run cosma-total && npm run cosma-trim && npm run cosma-copy && npm run cosma-rm-output\"\n}\n```\n\n每个步骤保持分开，以方便调试。\n\nobsidian2cosma 脚本指令：\n\n```sh\npython my_scripts/obsidian2cosma.py\n\t-i source/_posts\n\t-o my_scripts/cosma_dir/data\n\t--ignore\n\t-f\n\t--method abbrlink\n\t--attrreplacement categories,types date,begin\n\t--verbose\n```\n\n# 后记\n\n最终能完成这样的效果我也很欣慰，和设想的差不多，~~似乎感受到了一丢丢程序员改变世界的力量 🤭🤭🤭~~。很多细节我没有详细写出，但是把最重要的思路理清了，有问题的小伙伴可直接评论。\n\n## 后续改进\n\n- [x] 事后清洁，删除输出的 Markdown 文档以免混淆 Obsidian\n- [ ] 处理侧边栏图片报错问题，太吵了（有点困难，因为 js 有压缩，只能另辟蹊径）\n- [ ] 研究不同页面 Focus\n- [ ] 主页面增加原文跳转链接（这可能得深入源码去改，或者编写脚本，统一从源 HTML 创造 N 份版本）\n- [ ] 攻克侧边栏 Iframe 网页内的夜间模式问题\n- [ ] 移动端适配不是很友好\n- [ ] 历史记录 history 臃肿，需要不时删一删\n- [x] cosma 2.1.0 侧边栏显示图像过小（只能等更新，脚本暂时无法处理）（新版本已修复问题）\n- [ ] 完整网页加载较慢。原因是 cosma 需要对所有的网络图片进行加载，没有懒加载功能。这会导致 CDN 流量过大。\n\n> 其实，自己弄一个简单的，就可以解决上面所有问题。\n\n## 踩过的坑\n\n1. npm script 中使用 copy 命令时，路径用 `\\\\` 分隔，不然会找不到文件\n2. 你可能会把 Obsidian2cosma 脚本输出的文档放在了平时用 Obsidian 写作的 Vault 内。请注意，这样的话 Obsidian 仓库中就会出现两个同名但不同文件夹的文章，会导致**以后**平时插入双向链接或修改双向链接时出现双向链接题目不对的问题，进而导致**第二次**使用该脚本时一些链接识别不出的问题。\n3. 博客根目录不要创建 `scripts` 目录并在里面放自己写的脚本，除非你知道自己在做什么。否则导致 `hexo clean` 出错。针对这一点，我似乎找到了根源：[插件 | Hexo](https://hexo.io/zh-cn/docs/plugins.html#%E8%84%9A%E6%9C%AC%EF%BC%88Scripts%EF%BC%89)\n\n# 本文参考\n\n- [Zettelkasten Methods - Zettlr Docs](https://docs.zettlr.com/en/academic/zkn-method/)\n- [Cosma | User Manual (arthurperret.fr)](https://cosma.arthurperret.fr/user-manual.html)\n- [Share the graph view and notes as HTML page for free with obsidian2cosma - Share & showcase - Obsidian Forum](https://forum.obsidian.md/t/share-the-graph-view-and-notes-as-html-page-for-free-with-obsidian2cosma/51070)\n- [Python os.system 乱码\\_输微的博客-CSDN 博客](https://blog.csdn.net/qq_19934363/article/details/118091299)\n- [stackoverflow.com/questions/4996405/how-do-i-change-the-file-creation-date-of-a-windows-file#:~:text=pip install win32-setctime And then use it like,dependency other that the built-in ctypes Python library%3A](https://stackoverflow.com/questions/4996405/how-do-i-change-the-file-creation-date-of-a-windows-file#:~:text=pip%20install%20win32-setctime%20And%20then%20use%20it%20like,dependency%20other%20that%20the%20built-in%20ctypes%20Python%20library%3A)\n- [winhelponline.com/blog/change-accessed-modified-created-file-date-timestamp-windows/](https://www.winhelponline.com/blog/change-accessed-modified-created-file-date-timestamp-windows/)\n- [YAML Ain’t Markup Language (YAML™) revision 1.2.2](https://yaml.org/spec/1.2.2/#a-long-long-long-long-link)\n- [Python 正则表达式细节小记 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/429205730)\n- [id - HTML（超文本标记语言） | MDN (mozilla.org)](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Global_attributes/id)\n- [Change File(s) Date & Timestamp via CMD or PowerShell (windowsdigitals.com)](https://www.windowsdigitals.com/change-file-date-timestamp-cmd-powershell/#:~:text=Set-ItemProperty%20-Path%20%22example.txt%22%20-Name%20CreationTime%20-Value%20%24NewDate,Set-ItemProperty%20-Path%20%22example.txt%22%20-Name%20LastWriteTime%20-Value%20%24NewDate)\n- [powershell 执行多条命令\\_powershell 执行多条命令\\_yedajiang44 的博客-CSDN 博客](https://blog.csdn.net/yedajiang44/article/details/118176272)\n","categories":[{"name":"博客站点维护","api":"api/categories/博客站点维护.json"},{"name":"Hexo","api":"api/categories/博客站点维护/Hexo.json"}],"tags":[{"name":"Python","api":"api/tags/Python.json"},{"name":"HTML","api":"api/tags/HTML.json"},{"name":"CSS","api":"api/tags/CSS.json"},{"name":"GitHub","api":"api/tags/GitHub.json"},{"name":"Markdown","api":"api/tags/Markdown.json"},{"name":"Obsidian","api":"api/tags/Obsidian.json"},{"name":"Butterfly","api":"api/tags/Butterfly.json"},{"name":"YAML","api":"api/tags/YAML.json"},{"name":"NPM","api":"api/tags/NPM.json"},{"name":"Cosma","api":"api/tags/Cosma.json"},{"name":"script","api":"api/tags/script.json"},{"name":"项目","api":"api/tags/项目.json"}]},"api":"api/posts/p/f6c0daf3.json"}