{"data":{"title":"Hexo Btterfly 引入 Waline 评论系统以及常见问题解决","slug":"博客站点维护/Waline/Hexo Btterfly 引入 Waline 评论系统以及常见问题解决","description":"引入 Waline 方式以及一些问题的解决","date":"2023-04-27T08:27:09.000Z","updated":"2024-12-12T17:57:53.661Z","language":"zh-CN","comments":true,"url":"p/591f2165/","cover":"https://cdn.gallery.uuanqin.top/img/waline-comment.png","images":[],"content":"<h1 id=\"引入-waline-评论\"><a class=\"markdownIt-Anchor\" href=\"#引入-waline-评论\"></a> 引入 Waline 评论</h1>\n<p>Hexo 博客框架 Butterfly 主题中引入 Waline 评论操作可以参考以下文章解决：</p>\n<ul>\n<li><a href=\"https://butterfly.js.org/posts/ceeb73f/#%E8%A9%95%E8%AB%96\">Butterfly 安裝文檔(四) 主題配置-2 | Butterfly</a></li>\n<li><a href=\"https://waline.js.org/guide/get-started/\">快速上手 | Waline</a></li>\n</ul>\n<p>注意：</p>\n<ul>\n<li>\n<p>在 <a href=\"https://waline.js.org/guide/get-started/\">快速上手 | Waline</a> 这篇文章中，请按照指引完成 Vercel 的部署，并完成<strong>域名绑定</strong>小节（虽然它说可选，但我强烈建议你完成，否则你的评论系统只能在严苛的网络环境中运行）</p>\n</li>\n<li>\n<p>在 Butterfly 的主题配置文件中有两处需要改：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">comments:</span></span><br><span class=\"line\">  <span class=\"attr\">use:</span> <span class=\"string\">Waline</span> <span class=\"comment\"># Valine,Disqus</span></span><br><span class=\"line\">  <span class=\"comment\"># ...</span></span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"attr\">waline:</span></span><br><span class=\"line\">  <span class=\"attr\">serverURL:</span> <span class=\"string\">https://pl.uuanqin.top</span> <span class=\"comment\"># Waline server address url</span></span><br></pre></td></tr></table></figure>\n<p>注意 serverURL 填自己创建子域名</p>\n</li>\n</ul>\n<h1 id=\"切换数据库\"><a class=\"markdownIt-Anchor\" href=\"#切换数据库\"></a> 切换数据库</h1>\n<p>文档：<a href=\"https://waline.js.org/guide/database.html\">多数据库服务支持 | Waline</a></p>\n<p>基本步骤：</p>\n<ul>\n<li>打开 Waline 管理面板，导出数据</li>\n<li>准备好自己的数据库</li>\n<li>依据文档要求添加环境变量</li>\n<li>删除 Vercel 中原有数据库相关的环境变量。或者把这些变量的多环境「Production」取消掉。</li>\n<li>Vercel 重新部署</li>\n<li>登录 Waline，并成为第一个注册用户</li>\n<li>打开管理面板导入数据，等待数据导入成功。</li>\n</ul>\n<p>把数据从 LeanCloud 切换到自己服务器数据库的好处是：</p>\n<ol>\n<li><strong>评论数据加载迅速</strong></li>\n<li>数据维护方便</li>\n</ol>\n<p>如果你是从 LeanCloud 迁入 MySQL，建议紧接着看下一小节完成时区转换问题。</p>\n<h1 id=\"加速-waline\"><a class=\"markdownIt-Anchor\" href=\"#加速-waline\"></a> 加速 Waline</h1>\n<p>按照官网配置好的 Waline 在国内的加载速度还是有点慢，现记录下一些可用的加速手段：</p>\n<ol>\n<li>Waline 的 js 文件、css 文件全部替换为国内高速访问的 CDN 链接，或直接存储在本站。国内常用 CDN 镜像站详见：<a class=\"uuanqin-bilink\" target=\"_blank\" href=\"/p/7b17333d/\"><span class=\"yukari\">站内文章</span>国内访问 Hexo 博客优化加速（静态资源 CDN 链接替换）</a></li>\n<li>使用的「文章反应」「表情包」等素材均替换为国内镜像。比如 Waline 内置的表情包源为 unpkg，我们可以切换到国内 unpkg 的镜像站。参考：<a class=\"uuanqin-bilink\" target=\"_blank\" href=\"/p/eeb2ee0e/\"><span class=\"yukari\">站内文章</span>学会通过看文档配置 Butterfly 主题中的 Waline 客户端</a>。</li>\n<li>评论区头像服务使用国内的 Cravatar 服务。详见：<a class=\"uuanqin-bilink\" target=\"_blank\" href=\"/p/1d248fa3/\"><span class=\"yukari\">站内文章</span>Waline 配置头像服务（含常用公共头像服务介绍）</a></li>\n<li>Vercel 使用国内加速域名、将数据库服务部署到国内。上文已介绍了相关操作方法。</li>\n</ol>\n<h1 id=\"更多美化设置\"><a class=\"markdownIt-Anchor\" href=\"#更多美化设置\"></a> 更多美化设置</h1>\n<p>推荐本站的索引文章： <a class=\"uuanqin-bilink\" target=\"_blank\" href=\"/p/dd188b35/\"><span class=\"yukari\">站内文章</span>【索引】定制自己的 Waline 评论系统</a></p>\n<h1 id=\"vercel-中的-waline-的维护\"><a class=\"markdownIt-Anchor\" href=\"#vercel-中的-waline-的维护\"></a> Vercel 中的 Waline 的维护</h1>\n<p>一点开发与维护提示：</p>\n<ul>\n<li>Vercel 中的环境变量可以配置多环境生效设置。</li>\n<li>默认情况下，GitHub 提交到 <code>main</code> 分支为 Production 正式环境，其他分支则是 Preview 环境。</li>\n<li>并不是所有的改动提交到 GitHub 上时都会生效，默认情况下仅有 <code>index.js</code> 改动时才会生效。</li>\n</ul>\n<p>官方文档：<a href=\"https://vercel.com/docs/deployments/git#production-branch\">Deploying Git Repositories with Vercel</a></p>\n<p>有时候在后台可能会看到升级提示：</p>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/202411192359292.webp\" alt=\"image.png\" width=\"475px\" /></p>\n<p>官方文档会提示你进入到对应的 GitHub 仓库中，修改 package.json 文件中的 <code>@waline/vercel</code> 版本号为最新版本即可。但其实现在 Waline 版本号不需要改了，他一直是 <code>latest</code>，我们只需要在 Vercel 重新部署即可。</p>\n<h1 id=\"页面统计量\"><a class=\"markdownIt-Anchor\" href=\"#页面统计量\"></a> 页面统计量</h1>\n<p>强烈建议开启 Waline 自带的 <a href=\"https://waline.js.org/guide/features/pageview.html\">页面浏览量统计</a> 功能！原因：</p>\n<ol>\n<li>为网站统计服务提供备选方案。有时候你可能选择更换统计服务，又或者是改了域名，你的访问数据可能会被清空，而迁移又十分麻烦！</li>\n<li>评论数据和统计数据绑在一起，更方便维护。</li>\n</ol>\n<p>如果之前使用了不蒜子（Busuanzi）进行了页面浏览量统计，可以考虑将页面统计量迁移到 Waline 中，详见这篇文章：<a class=\"uuanqin-bilink\" target=\"_blank\" href=\"/p/e400f664/\"><span class=\"yukari\">站内文章</span>将不蒜子中的数据迁移到 Waline</a>。</p>\n<h1 id=\"使用-waline-可能遇到的问题\"><a class=\"markdownIt-Anchor\" href=\"#使用-waline-可能遇到的问题\"></a> 使用 Waline 可能遇到的问题</h1>\n<h2 id=\"问题-1无法获取和发布评论\"><a class=\"markdownIt-Anchor\" href=\"#问题-1无法获取和发布评论\"></a> 问题 1：无法获取和发布评论</h2>\n<p><strong>问题：评论框已经能在博客中显示，但是获取不到评论内容，且无法发布评论。出现 Failed to Fetch 错误。但使用魔法后评论系统正常运行。</strong></p>\n<p>解决：打开 F12 控制台并重新加载问题页面，你可能会发现 vervel.app 无法访问：</p>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/vercal评论问题.png\" alt=\"vercal评论问题\" width=\"475px\" /></p>\n<p>注意到页面向 vercel.app 发送了 GET 请求，但此时 vercel.app 在国内环境是无法访问的。</p>\n<p>排查方向：</p>\n<ul>\n<li>\n<p>首先确保按照 <a href=\"https://waline.js.org/guide/get-started/\">快速上手 | Waline</a> 设置好了评论系统子域名，或再参考一下这篇文章 <a href=\"https://blog.csdn.net/Panzer_Jack/article/details/127418379?spm=1001.2101.3001.6650.13&amp;utm_medium=distribute.pc_relevant.none-task-blog-2~default~OPENSEARCH~Rate-13-127418379-blog-127204331.pc_relevant_recovery_v2&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~OPENSEARCH~Rate-13-127418379-blog-127204331.pc_relevant_recovery_v2&amp;utm_relevant_index=14\">关于waline国内无法使用的解决方案 （vercel.app国内无法使用问题）_vercel 国内访问-CSDN博客</a></p>\n<p>在域名服务器商（例如 阿里云&gt;云解析 DNS&gt;域名解析&gt;解析设置）处添加新的 <code>CNAME</code> 解析记录：</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>Type</th>\n<th>Name</th>\n<th>Value</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>CNAME</td>\n<td><em>example</em>（你想要的子域名名称</td>\n<td><strong><a href=\"http://cname.vercel-dns.com\">cname.vercel-dns.com</a></strong> （也可以是<strong><a href=\"http://cname-china.vercel-dns.com\">cname-china.vercel-dns.com</a></strong>）</td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li>确保在 Butterfly 的主题配置文件中设置了正确的 Waline 服务器地址（比如设置为<em><a href=\"http://example.yourdomain.com\">example.yourdomain.com</a></em>）。</li>\n</ul>\n<h2 id=\"问题-2从-leancloud-迁入-mysql-数据库后时间显示错误\"><a class=\"markdownIt-Anchor\" href=\"#问题-2从-leancloud-迁入-mysql-数据库后时间显示错误\"></a> 问题 2：从 LeanCloud 迁入 MySQL 数据库后时间显示错误</h2>\n<p>问题描述：利用数据导入导出工具从 LeanCloud 把数据迁入 MySQL 后，数据中与时间相关的字段均落后 8 小时。且发布新评论时插入数据库字段中的时间均超前 8 小时。</p>\n<p>下面介绍一种能解决问题的方式。</p>\n<p>导入评论数据后，立即执行以下 SQL 恢复正确的时间：</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">UPDATE</span> `waline<span class=\"operator\">-</span>comments`.wl_Comment <span class=\"keyword\">SET</span></span><br><span class=\"line\">        createdAt <span class=\"operator\">=</span> DATE_ADD(createdAt, <span class=\"type\">INTERVAL</span> <span class=\"number\">8</span> <span class=\"keyword\">HOUR</span>),</span><br><span class=\"line\">        updatedAt <span class=\"operator\">=</span> DATE_ADD(updatedAt, <span class=\"type\">INTERVAL</span> <span class=\"number\">8</span> <span class=\"keyword\">HOUR</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">UPDATE</span> `waline<span class=\"operator\">-</span>comments`.wl_Comment <span class=\"keyword\">SET</span></span><br><span class=\"line\">        insertedAt <span class=\"operator\">=</span> DATE_ADD(insertedAt, <span class=\"type\">INTERVAL</span> <span class=\"number\">8</span> <span class=\"keyword\">HOUR</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">UPDATE</span> `waline<span class=\"operator\">-</span>comments`.wl_Counter <span class=\"keyword\">SET</span></span><br><span class=\"line\">        createdAt <span class=\"operator\">=</span> DATE_ADD(createdAt, <span class=\"type\">INTERVAL</span> <span class=\"number\">8</span> <span class=\"keyword\">HOUR</span>),</span><br><span class=\"line\">        updatedAt <span class=\"operator\">=</span> DATE_ADD(updatedAt, <span class=\"type\">INTERVAL</span> <span class=\"number\">8</span> <span class=\"keyword\">HOUR</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">UPDATE</span> `waline<span class=\"operator\">-</span>comments`.wl_Users <span class=\"keyword\">SET</span></span><br><span class=\"line\">        createdAt <span class=\"operator\">=</span> DATE_ADD(createdAt, <span class=\"type\">INTERVAL</span> <span class=\"number\">8</span> <span class=\"keyword\">HOUR</span>),</span><br><span class=\"line\">        updatedAt <span class=\"operator\">=</span> DATE_ADD(updatedAt, <span class=\"type\">INTERVAL</span> <span class=\"number\">8</span> <span class=\"keyword\">HOUR</span>);</span><br></pre></td></tr></table></figure>\n<p>调整 MySQL 数据库时区：修改服务器文件：<code>/etc/my.cnf.d/mysql-server.cnf</code>：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[mysqld]</span><br><span class=\"line\">default-time_zone = &#x27;+0:00&#x27;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 重启mysqld</span></span><br><span class=\"line\">systemctl restart mysqld.service </span><br></pre></td></tr></table></figure>\n<p>这样评论的时间就能正确展示，新评论时间也能正确设置了。</p>\n","raw":"---\ntitle: Hexo Btterfly 引入 Waline 评论系统以及常见问题解决\ntags:\n  - Waline\n  - Butterfly\n  - Vercel\n  - 问题解决\ncover: 'https://cdn.gallery.uuanqin.top/img/waline-comment.png'\ndescription: 引入 Waline 方式以及一些问题的解决\nabbrlink: 591f2165\ncategories:\n  - 博客站点维护\n  - Waline\ndate: 2023-04-27 16:27:09\n---\n\n# 引入 Waline 评论\n\nHexo 博客框架 Butterfly 主题中引入 Waline 评论操作可以参考以下文章解决：\n\n* [Butterfly 安裝文檔(四) 主題配置-2 | Butterfly](https://butterfly.js.org/posts/ceeb73f/#評論)\n* [快速上手 | Waline](https://waline.js.org/guide/get-started/)\n\n注意：\n\n* 在 [快速上手 | Waline](https://waline.js.org/guide/get-started/) 这篇文章中，请按照指引完成 Vercel 的部署，并完成**域名绑定**小节（虽然它说可选，但我强烈建议你完成，否则你的评论系统只能在严苛的网络环境中运行）\n* 在 Butterfly 的主题配置文件中有两处需要改：\n\n  ```yaml\n  comments:\n    use: Waline # Valine,Disqus\n    # ...\n    \n  waline:\n    serverURL: https://pl.uuanqin.top # Waline server address url\n  ```\n\n  注意 serverURL 填自己创建子域名\n\n# 切换数据库\n\n文档：[多数据库服务支持 | Waline](https://waline.js.org/guide/database.html)\n\n基本步骤：\n\n- 打开 Waline 管理面板，导出数据\n- 准备好自己的数据库\n- 依据文档要求添加环境变量\n- 删除 Vercel 中原有数据库相关的环境变量。或者把这些变量的多环境「Production」取消掉。\n- Vercel 重新部署\n- 登录 Waline，并成为第一个注册用户\n- 打开管理面板导入数据，等待数据导入成功。\n\n把数据从 LeanCloud 切换到自己服务器数据库的好处是：\n\n1. **评论数据加载迅速**\n2. 数据维护方便\n\n如果你是从 LeanCloud 迁入 MySQL，建议紧接着看下一小节完成时区转换问题。\n\n# 加速 Waline\n\n按照官网配置好的 Waline 在国内的加载速度还是有点慢，现记录下一些可用的加速手段：\n\n1. Waline 的 js 文件、css 文件全部替换为国内高速访问的 CDN 链接，或直接存储在本站。国内常用 CDN 镜像站详见：[[国内访问 Hexo 博客优化加速（静态资源 CDN 链接替换）]]\n2. 使用的「文章反应」「表情包」等素材均替换为国内镜像。比如 Waline 内置的表情包源为 unpkg，我们可以切换到国内 unpkg 的镜像站。参考：[[学会通过看文档配置 Butterfly 主题中的 Waline 客户端]]。\n3. 评论区头像服务使用国内的 Cravatar 服务。详见：[[Waline 配置头像服务（含常用公共头像服务介绍）]]\n4. Vercel 使用国内加速域名、将数据库服务部署到国内。上文已介绍了相关操作方法。\n\n# 更多美化设置\n\n推荐本站的索引文章： [[【索引】定制自己的 Waline 评论系统]]\n\n# Vercel 中的 Waline 的维护\n\n一点开发与维护提示：\n\n- Vercel 中的环境变量可以配置多环境生效设置。\n- 默认情况下，GitHub 提交到 `main` 分支为 Production 正式环境，其他分支则是 Preview 环境。\n- 并不是所有的改动提交到 GitHub 上时都会生效，默认情况下仅有 `index.js` 改动时才会生效。\n\n官方文档：[Deploying Git Repositories with Vercel](https://vercel.com/docs/deployments/git#production-branch)\n\n有时候在后台可能会看到升级提示：\n\n![image.png|475](https://cdn.gallery.uuanqin.top/img/202411192359292.webp)\n\n官方文档会提示你进入到对应的 GitHub 仓库中，修改 package.json 文件中的 `@waline/vercel` 版本号为最新版本即可。但其实现在 Waline 版本号不需要改了，他一直是 `latest`，我们只需要在 Vercel 重新部署即可。\n\n# 页面统计量\n\n强烈建议开启 Waline 自带的 [页面浏览量统计](https://waline.js.org/guide/features/pageview.html) 功能！原因：\n\n1. 为网站统计服务提供备选方案。有时候你可能选择更换统计服务，又或者是改了域名，你的访问数据可能会被清空，而迁移又十分麻烦！\n2. 评论数据和统计数据绑在一起，更方便维护。\n\n如果之前使用了不蒜子（Busuanzi）进行了页面浏览量统计，可以考虑将页面统计量迁移到 Waline 中，详见这篇文章：[[将不蒜子中的数据迁移到 Waline]]。\n\n# 使用 Waline 可能遇到的问题\n\n## 问题 1：无法获取和发布评论\n\n**问题：评论框已经能在博客中显示，但是获取不到评论内容，且无法发布评论。出现 Failed to Fetch 错误。但使用魔法后评论系统正常运行。**\n\n解决：打开 F12 控制台并重新加载问题页面，你可能会发现 vervel.app 无法访问：\n\n![vercal评论问题|475](https://cdn.gallery.uuanqin.top/img/vercal%E8%AF%84%E8%AE%BA%E9%97%AE%E9%A2%98.png)\n\n注意到页面向 vercel.app 发送了 GET 请求，但此时 vercel.app 在国内环境是无法访问的。\n\n排查方向：\n\n* 首先确保按照 [快速上手 | Waline](https://waline.js.org/guide/get-started/) 设置好了评论系统子域名，或再参考一下这篇文章 [关于waline国内无法使用的解决方案 （vercel.app国内无法使用问题）_vercel 国内访问-CSDN博客](https://blog.csdn.net/Panzer_Jack/article/details/127418379?spm=1001.2101.3001.6650.13&utm_medium=distribute.pc_relevant.none-task-blog-2~default~OPENSEARCH~Rate-13-127418379-blog-127204331.pc_relevant_recovery_v2&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~OPENSEARCH~Rate-13-127418379-blog-127204331.pc_relevant_recovery_v2&utm_relevant_index=14)\n\n  在域名服务器商（例如 阿里云>云解析 DNS>域名解析>解析设置）处添加新的 `CNAME` 解析记录：\n\n| Type  | Name                | Value                                                          |\n| ----- | ------------------- | -------------------------------------------------------------- |\n| CNAME | *example*（你想要的子域名名称 |  **cname.vercel-dns.com** （也可以是**cname-china.vercel-dns.com**） |\n\n* 确保在 Butterfly 的主题配置文件中设置了正确的 Waline 服务器地址（比如设置为*example.yourdomain.com*）。\n\n## 问题 2：从 LeanCloud 迁入 MySQL 数据库后时间显示错误\n\n问题描述：利用数据导入导出工具从 LeanCloud 把数据迁入 MySQL 后，数据中与时间相关的字段均落后 8 小时。且发布新评论时插入数据库字段中的时间均超前 8 小时。\n\n下面介绍一种能解决问题的方式。\n\n导入评论数据后，立即执行以下 SQL 恢复正确的时间：\n\n```sql\nUPDATE `waline-comments`.wl_Comment SET\n        createdAt = DATE_ADD(createdAt, INTERVAL 8 HOUR),\n        updatedAt = DATE_ADD(updatedAt, INTERVAL 8 HOUR);\n\nUPDATE `waline-comments`.wl_Comment SET\n        insertedAt = DATE_ADD(insertedAt, INTERVAL 8 HOUR);\n\nUPDATE `waline-comments`.wl_Counter SET\n        createdAt = DATE_ADD(createdAt, INTERVAL 8 HOUR),\n        updatedAt = DATE_ADD(updatedAt, INTERVAL 8 HOUR);\n\nUPDATE `waline-comments`.wl_Users SET\n        createdAt = DATE_ADD(createdAt, INTERVAL 8 HOUR),\n        updatedAt = DATE_ADD(updatedAt, INTERVAL 8 HOUR);\n```\n\n调整 MySQL 数据库时区：修改服务器文件：`/etc/my.cnf.d/mysql-server.cnf`：\n\n```conf\n[mysqld]\ndefault-time_zone = '+0:00'\n```\n\n```sh\n# 重启mysqld\nsystemctl restart mysqld.service \n```\n\n这样评论的时间就能正确展示，新评论时间也能正确设置了。","categories":[{"name":"博客站点维护","api":"api/categories/博客站点维护.json"},{"name":"Waline","api":"api/categories/博客站点维护/Waline.json"}],"tags":[{"name":"问题解决","api":"api/tags/问题解决.json"},{"name":"Waline","api":"api/tags/Waline.json"},{"name":"Butterfly","api":"api/tags/Butterfly.json"},{"name":"Vercel","api":"api/tags/Vercel.json"}]},"api":"api/posts/p/591f2165.json"}