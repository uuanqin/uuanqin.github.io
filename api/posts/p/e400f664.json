{"data":{"title":"将不蒜子中的数据迁移到 Waline","slug":"博客站点维护/Waline/将不蒜子中的数据迁移到 Waline","description":"写了个脚本，页面统计数据掌控在自己的手中","date":"2024-11-22T18:55:57.000Z","updated":"2026-02-01T08:42:41.968Z","language":"zh-CN","comments":true,"url":"p/e400f664/","cover":"https://cdn.gallery.uuanqin.top/img/202411230428848.webp","images":[],"content":"<p>折腾重定向之后（详见 <a class=\"uuanqin-bilink\" target=\"_blank\" href=\"/p/41b77d61/\"><span class=\"bilink-pop-up\">站内文章</span>这篇文章</a>），一个以前没考虑到的小问题来了——不蒜子页面的统计量清零了。</p>\n<p>虽然不是什么大问题，但是感觉有点可惜啊。而且通过页面浏览量还能分析哪些文章比较多人看，可以把维护精力放到一些不是很水的文章上面（我猜蜀黍也容易在那出没）。这种情况应该很多博主都遇到，于是赶紧友链朋友圈搜搜大家都是怎么做的：</p>\n<ul>\n<li>方法一：自建不蒜子服务，并通过其他项目将不蒜子数据迁移到自建服务上。但是看起来好麻烦啊喂😮，不是很想再维护多一个系统。</li>\n<li>方法二：选用其他的统计服务。但是我的目的是想知道 busuanzi 中原来记录有的数据。</li>\n<li>方法三：使用 Waline 评论系统带有页面浏览量统计，Butterfly 主题支持切换。结果打开配置文件一看，我早就把 Waline 的这个功能关闭了，统计还是得从头算起。</li>\n</ul>\n<p>最后我的方案是：</p>\n<ul>\n<li>决定把统计数据交给 Waline，「内聚」一下，少一点系统的维护。而且数据存在于服务器 MySQL 里，个人容易掌控。</li>\n<li>我需要工具或脚本获取 busuanzi 服务器中原有的数据，导出成文件以便整理</li>\n<li>根据导出的数据生成 SQL 方便在 Waline 中更新</li>\n</ul>\n<p>于是，一个 Python 命令行程序诞生了：</p>\n<p><a href=\"https://github.com/uuanqin/busuanzi2waline\"><img src= \"/image/loading.gif\" data-lazy-src=\"https://github-readme-stats.uuanqin.top/api/pin/?username=uuanqin&amp;repo=busuanzi2waline\" alt=\"Readme Card\" /></a></p>\n<p>GitHub 项目地址：<a href=\"https://github.com/uuanqin/busuanzi2waline\">uuanqin/busuanzi2waline: 将不蒜子的页面浏览量导出为 json 格式的文件，并生成SQL语句以更新Waline数据库</a></p>\n<p>自我吐槽：写脚本花的时间也很多好吧！</p>\n<p>这篇文章主要分享解决思路，具体操作详看该项目的 README 说明。</p>\n<h1 id=\"获取不算子中的统计数据\"><a class=\"markdownIt-Anchor\" href=\"#获取不算子中的统计数据\"></a> 获取不算子中的统计数据</h1>\n<p>不蒜子并没有提供现成的 API 直接获取数据。参考了一些文章，他们的方式是向不蒜子的服务器发送一个 HTTP 请求，请求头 <code>Referer</code> 参数设置为目标网址。比如使用 <code>curl</code> 命令如下：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -H &quot;Referer: &#123;url&#125;&quot; -X GET http://busuanzi.ibruce.info/busuanzi?jsonpCallback=BusuanziCallback_577649258772</span><br></pre></td></tr></table></figure>\n<p>然后返回以下字符串：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">try</span>&#123;<span class=\"title class_\">BusuanziCallback</span>_1046609647591(&#123;<span class=\"string\">&quot;site_uv&quot;</span>:<span class=\"number\">21497</span>,<span class=\"string\">&quot;page_pv&quot;</span>:<span class=\"number\">2</span>,<span class=\"string\">&quot;version&quot;</span>:<span class=\"number\">2.4</span>,<span class=\"string\">&quot;site_pv&quot;</span>:<span class=\"number\">38425</span>&#125;);&#125;<span class=\"keyword\">catch</span>(e)&#123;&#125;</span><br></pre></td></tr></table></figure>\n<p><code>page_pv</code> 就是我们想要的数据，可以用一个正则提取出 JSON 就行。</p>\n<h1 id=\"拿到所有的网址\"><a class=\"markdownIt-Anchor\" href=\"#拿到所有的网址\"></a> 拿到所有的网址</h1>\n<p>直接处理网站地图就行。因为安装有插件 <a href=\"https://www.npmjs.com/package/hexo-generator-sitemap\">hexo-generator-sitemap</a>，网址地图 <code>sitemap.txt</code> 就躺在根目录下，我们只需要简单处理即可。</p>\n<p>我的文章路径为 <code>https://blog.uuanqin.top/p/xxxxxxx/</code>，我就把这些挑出来就行（使用顺手的编辑器快速编写正则）。</p>\n<h1 id=\"waline-存储页面浏览量的方式\"><a class=\"markdownIt-Anchor\" href=\"#waline-存储页面浏览量的方式\"></a> Waline 存储页面浏览量的方式</h1>\n<p>Waline 数据库有三个表，其中 <code>wl_Counter</code> 表是专门用于统计每个页面的数据的，比如页面浏览量、各个反应表情的数量。</p>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/202411230355094.webp\" alt=\"image.png\" /></p>\n<p>注意到，<code>url</code> 字段并不是 <code>UNIQUE</code> 的，Waline 在更新数据时会更新所有 <code>url</code> 属性匹配的记录。</p>\n<p>并且，只有在文章被浏览，或有人点了文章反应，一条对应 <code>url</code> 的记录才会出现在数据库中。</p>\n\n<details class=\"callout\" data-callout=\"example\" data-callout-fold=\"-\">\n<summary class=\"callout-title\">\n<div class=\"callout-title-icon\">\n<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-list\"><line x1=\"8\" x2=\"21\" y1=\"6\" y2=\"6\"/><line x1=\"8\" x2=\"21\" y1=\"12\" y2=\"12\"/><line x1=\"8\" x2=\"21\" y1=\"18\" y2=\"18\"/><line x1=\"3\" x2=\"3.01\" y1=\"6\" y2=\"6\"/><line x1=\"3\" x2=\"3.01\" y1=\"12\" y2=\"12\"/><line x1=\"3\" x2=\"3.01\" y1=\"18\" y2=\"18\"/></svg>\n</div>\n<div class=\"callout-title-inner\">小插曲：找出缺失的那道菜</div>\n<div class=\"callout-fold\"></div>\n</summary>\n<div class=\"callout-content\"><p>给你两份菜单，除了其中一份菜单少一样菜外，两份菜单中的菜名都能一一对应起来，两份菜单上的菜排列顺序是乱的，如何找出缺失的那道菜是什么？不要写代码，立即通过现成的软件解决。</p>\n<p>背景是我发现 Waline 数据库莫名其妙多出一个文章记录，我想找出来是哪一条。</p>\n<p>IDEA、记事本等文本编辑器没想出来。我反正使用了 Excel 的排序和函数弄出来了。</p>\n<p>此外，ChatGPT、讯飞星火、文心一言、豆包也都能正确回答。</p>\n</div></details><h1 id=\"生成-sql\"><a class=\"markdownIt-Anchor\" href=\"#生成-sql\"></a> 生成 SQL</h1>\n<p>我们总不会一个一个更改数据表或手动添加记录。我的思路是，数据表 <code>wl_Counter</code> 有对应 url 的记录就跳过，没有的就加上。对应的 SQL 应该长这样：</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">INSERT</span> <span class=\"keyword\">INTO</span> wl_Counter (url, <span class=\"type\">time</span>) <span class=\"keyword\">SELECT</span> <span class=\"string\">&#x27;/p/d4bc55f2/&#x27;</span>, <span class=\"number\">0</span> <span class=\"keyword\">WHERE</span> <span class=\"keyword\">NOT</span> <span class=\"keyword\">EXISTS</span> (<span class=\"keyword\">SELECT</span> <span class=\"number\">1</span> <span class=\"keyword\">FROM</span> wl_Counter <span class=\"keyword\">WHERE</span> url <span class=\"operator\">=</span> <span class=\"string\">&#x27;/p/d4bc55f2/&#x27;</span>);  </span><br><span class=\"line\"><span class=\"keyword\">INSERT</span> <span class=\"keyword\">INTO</span> wl_Counter (url, <span class=\"type\">time</span>) <span class=\"keyword\">SELECT</span> <span class=\"string\">&#x27;/p/e1ee5eca/&#x27;</span>, <span class=\"number\">0</span> <span class=\"keyword\">WHERE</span> <span class=\"keyword\">NOT</span> <span class=\"keyword\">EXISTS</span> (<span class=\"keyword\">SELECT</span> <span class=\"number\">1</span> <span class=\"keyword\">FROM</span> wl_Counter <span class=\"keyword\">WHERE</span> url <span class=\"operator\">=</span> <span class=\"string\">&#x27;/p/e1ee5eca/&#x27;</span>);  </span><br></pre></td></tr></table></figure>\n<p>为匹配的 url 增加页面统计量，那么用于更新的 SQL 应该长这样：</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">UPDATE</span> wl_Counter <span class=\"keyword\">SET</span> <span class=\"type\">time</span> <span class=\"operator\">=</span> IFNULL(<span class=\"type\">time</span>, <span class=\"number\">0</span>) <span class=\"operator\">+</span> <span class=\"number\">2</span> <span class=\"keyword\">WHERE</span> url <span class=\"operator\">=</span> <span class=\"string\">&#x27;/p/d4bc55f2/&#x27;</span>;  </span><br><span class=\"line\"><span class=\"keyword\">UPDATE</span> wl_Counter <span class=\"keyword\">SET</span> <span class=\"type\">time</span> <span class=\"operator\">=</span> IFNULL(<span class=\"type\">time</span>, <span class=\"number\">0</span>) <span class=\"operator\">+</span> <span class=\"number\">2</span> <span class=\"keyword\">WHERE</span> url <span class=\"operator\">=</span> <span class=\"string\">&#x27;/p/e1ee5eca/&#x27;</span>;</span><br></pre></td></tr></table></figure>\n<p>我们可以编写脚本完成这些事情。</p>\n<h1 id=\"不蒜子数据导出脚本\"><a class=\"markdownIt-Anchor\" href=\"#不蒜子数据导出脚本\"></a> 不蒜子数据导出脚本</h1>\n<p><a href=\"https://github.com/uuanqin/busuanzi2waline\"><img src= \"/image/loading.gif\" data-lazy-src=\"https://github-readme-stats.uuanqin.top/api/pin/?username=uuanqin&amp;repo=busuanzi2waline\" alt=\"Readme Card\" /></a></p>\n<p>GitHub 项目地址：<a href=\"https://github.com/uuanqin/busuanzi2waline\">uuanqin/busuanzi2waline: 将不蒜子的页面浏览量导出为 json 格式的文件，并生成SQL语句以更新Waline数据库</a></p>\n<p>本脚本的主要功能有：</p>\n<ul>\n<li>根据提供的 sitemap 将不蒜子中存储的数据导出为 JSON 格式</li>\n<li>支持通过从不蒜子导出的数据生成对应的 SQL 语句，以将数据更新到 Waline 中</li>\n<li>由于每次脚本请求会记入不蒜子的统计量，有特殊需求的用户可以通过构造 sitemap 刷新网站的页面统计量</li>\n</ul>\n<p>可调整的参数：</p>\n<ul>\n<li>线程启动的间隔时间。设置太小的话请求速度过快，容易出错。</li>\n<li>请求失败重试次数（梯度随机重试）</li>\n</ul>\n<p>只需运行脚本：</p>\n<pre class=\"highlight\"><code class=\"shell\">python sql_generator.py -gi -gu \n</code></pre>\n<p>得到 <code>out_add.json</code> 文件中的数据即为导出的数据。</p>\n<pre class=\"highlight\"><code class=\"json\"><span class=\"punctuation\">[</span>  \n\t<span class=\"punctuation\">&#123;</span>  \n\t\t<span class=\"attr\">&quot;site_uv&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">419</span><span class=\"punctuation\">,</span>  \n\t\t<span class=\"attr\">&quot;page_pv&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">2</span><span class=\"punctuation\">,</span>  \n\t\t<span class=\"attr\">&quot;version&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">2.4</span><span class=\"punctuation\">,</span>  \n\t\t<span class=\"attr\">&quot;site_pv&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">434</span><span class=\"punctuation\">,</span>  \n\t\t<span class=\"attr\">&quot;url&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;/p/d4bc55f2/&quot;</span>  \n\t<span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span>  \n\t<span class=\"punctuation\">&#123;</span>  \n\t\t<span class=\"attr\">&quot;site_uv&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">420</span><span class=\"punctuation\">,</span>  \n\t\t<span class=\"attr\">&quot;page_pv&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">2</span><span class=\"punctuation\">,</span>  \n\t\t<span class=\"attr\">&quot;version&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">2.4</span><span class=\"punctuation\">,</span>  \n\t\t<span class=\"attr\">&quot;site_pv&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">435</span><span class=\"punctuation\">,</span>  \n\t\t<span class=\"attr\">&quot;url&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;/p/e1ee5eca/&quot;</span>  \n\t<span class=\"punctuation\">&#125;</span>  \n<span class=\"punctuation\">]</span>  \n</code></pre>\n<p>其中：</p>\n<ul>\n<li><code>page_pv</code> 表示对应路径 <code>url</code> 下的页面浏览量</li>\n<li><code>site_pv</code> 表示网站 <a href=\"https://blog.uuanqin.top\">https://blog.uuanqin.top</a> 的页面浏览量</li>\n<li><code>site_pv</code> 表示网站 <a href=\"https://blog.uuanqin.top\">https://blog.uuanqin.top</a> 的独立访客数</li>\n</ul>\n<p>得到文件 <code>out_ins.sql</code>、<code>out_add.sql</code> 即为生成的 SQL。</p>\n<h1 id=\"完成\"><a class=\"markdownIt-Anchor\" href=\"#完成\"></a> 完成</h1>\n<p>然后就大功告成了！你还可以修改 <code>sitemap.txt</code> 文件，将一些奇奇怪怪地址的统计量聚合一下。比如以下这两个地址其实指向同一个页面，我们可以将分别获取它们的统计量多次更新 Waline 数据库即可。</p>\n<ul>\n<li><code>https://a.com/xxx/index.html</code></li>\n<li><code>https://a.com/xxx</code></li>\n</ul>\n<p>此外，刷出某网站的页面统计量的功能也算是脚本的额外功能吧。如果你想将评论系统中的页面访问数据迁移到不蒜子，可以通过这个脚本刷出来。具体方法是在 <code>sitemap.txt</code> 构造多个相同的地址就行。</p>\n<h1 id=\"本文参考\"><a class=\"markdownIt-Anchor\" href=\"#本文参考\"></a> 本文参考</h1>\n<ul>\n<li><a href=\"https://waline.js.org/guide/features/pageview.html\">浏览量统计 | Waline</a></li>\n<li><a href=\"https://github.com/walinejs/waline/blob/main/assets/waline.sql\">waline/assets/waline.sql at main · walinejs/waline</a></li>\n<li><a href=\"https://ibruce.info/2015/04/04/busuanzi/\">不蒜子 | 不如</a></li>\n<li><a href=\"https://chriszheng.science/2019/01/23/Export-busuanzi-data/\">导出不蒜子的访问量数据 | M-x Chris-An-Emacser</a></li>\n<li><a href=\"https://docs.qq.com/doc/DSFhCWkhmb1lWZWNE\">不蒜子统计常见问题</a></li>\n<li><a href=\"https://www.techgrow.cn/posts/fc73f615.html\">不蒜子统计数据更改 | Clay 的技术空间</a></li>\n<li><a href=\"https://blog.zhheo.com/p/7b5f.html\">自搭建不蒜子busuanzi从2.8之前版本升级数据方案教程 | 张洪Heo</a></li>\n</ul>\n","raw":"---\ntitle: 将不蒜子中的数据迁移到 Waline\ncategories:\n  - 博客站点维护\n  - Waline\nabbrlink: e400f664\ntags:\n  - 不蒜子\n  - busuanzi\n  - Waline\n  - SQL\n  - MySQL\n  - Python\ncover: https://cdn.gallery.uuanqin.top/img/202411230428848.webp\ndescription: 写了个脚本，页面统计数据掌控在自己的手中\nsummary: >-\n  本文主要讲述了作者在不蒜子统计系统中遇到的页面浏览量清零问题，并分享了三种解决方案。最终，作者选择了将数据迁移到 Waline 评论系统，并编写了一个Python脚本来实现数据迁移。文章详细介绍了获取不蒜子数据的步骤、Waline存储页面浏览量的方式、生成SQL语句的方法以及数据导出脚本的功能。此外，作者还提供了相关的参考资料。通过本文，读者可以了解如何解决不蒜子统计页面浏览量清零的问题，并学习如何使用 Waline 系统进行页面浏览量统计。\ndate: 2024-11-23 02:55:57\ntop_img:\n---\n\n折腾重定向之后（详见 [[域名 DNS 服务托管至 Cloudflare 以及 301 重定向的配置|这篇文章]]），一个以前没考虑到的小问题来了——不蒜子页面的统计量清零了。\n\n虽然不是什么大问题，但是感觉有点可惜啊。而且通过页面浏览量还能分析哪些文章比较多人看，可以把维护精力放到一些不是很水的文章上面（我猜蜀黍也容易在那出没）。这种情况应该很多博主都遇到，于是赶紧友链朋友圈搜搜大家都是怎么做的：\n\n- 方法一：自建不蒜子服务，并通过其他项目将不蒜子数据迁移到自建服务上。但是看起来好麻烦啊喂😮，不是很想再维护多一个系统。\n- 方法二：选用其他的统计服务。但是我的目的是想知道 busuanzi 中原来记录有的数据。\n- 方法三：使用 Waline 评论系统带有页面浏览量统计，Butterfly 主题支持切换。结果打开配置文件一看，我早就把 Waline 的这个功能关闭了，统计还是得从头算起。\n\n最后我的方案是：\n\n- 决定把统计数据交给 Waline，「内聚」一下，少一点系统的维护。而且数据存在于服务器 MySQL 里，个人容易掌控。\n- 我需要工具或脚本获取 busuanzi 服务器中原有的数据，导出成文件以便整理\n- 根据导出的数据生成 SQL 方便在 Waline 中更新\n\n于是，一个 Python 命令行程序诞生了：\n\n[![Readme Card](https://github-readme-stats.uuanqin.top/api/pin/?username=uuanqin&repo=busuanzi2waline)](https://github.com/uuanqin/busuanzi2waline)\n\nGitHub 项目地址：[uuanqin/busuanzi2waline: 将不蒜子的页面浏览量导出为 json 格式的文件，并生成SQL语句以更新Waline数据库](https://github.com/uuanqin/busuanzi2waline)\n\n自我吐槽：写脚本花的时间也很多好吧！\n\n这篇文章主要分享解决思路，具体操作详看该项目的 README 说明。\n\n# 获取不算子中的统计数据\n\n不蒜子并没有提供现成的 API 直接获取数据。参考了一些文章，他们的方式是向不蒜子的服务器发送一个 HTTP 请求，请求头 `Referer` 参数设置为目标网址。比如使用 `curl` 命令如下：\n\n```shell\ncurl -H \"Referer: {url}\" -X GET http://busuanzi.ibruce.info/busuanzi?jsonpCallback=BusuanziCallback_577649258772\n```\n\n然后返回以下字符串：\n\n```js\ntry{BusuanziCallback_1046609647591({\"site_uv\":21497,\"page_pv\":2,\"version\":2.4,\"site_pv\":38425});}catch(e){}\n```\n\n`page_pv` 就是我们想要的数据，可以用一个正则提取出 JSON 就行。\n\n# 拿到所有的网址\n\n直接处理网站地图就行。因为安装有插件 [hexo-generator-sitemap](https://www.npmjs.com/package/hexo-generator-sitemap)，网址地图 `sitemap.txt` 就躺在根目录下，我们只需要简单处理即可。\n\n我的文章路径为 `https://blog.uuanqin.top/p/xxxxxxx/`，我就把这些挑出来就行（使用顺手的编辑器快速编写正则）。\n\n# Waline 存储页面浏览量的方式\n\nWaline 数据库有三个表，其中 `wl_Counter` 表是专门用于统计每个页面的数据的，比如页面浏览量、各个反应表情的数量。\n\n![image.png](https://cdn.gallery.uuanqin.top/img/202411230355094.webp)\n\n注意到，`url` 字段并不是 `UNIQUE` 的，Waline 在更新数据时会更新所有 `url` 属性匹配的记录。\n\n并且，只有在文章被浏览，或有人点了文章反应，一条对应 `url` 的记录才会出现在数据库中。\n\n> [!example]- 小插曲：找出缺失的那道菜\n> 给你两份菜单，除了其中一份菜单少一样菜外，两份菜单中的菜名都能一一对应起来，两份菜单上的菜排列顺序是乱的，如何找出缺失的那道菜是什么？不要写代码，立即通过现成的软件解决。\n>\n> 背景是我发现 Waline 数据库莫名其妙多出一个文章记录，我想找出来是哪一条。\n>\n> IDEA、记事本等文本编辑器没想出来。我反正使用了 Excel 的排序和函数弄出来了。\n>\n> 此外，ChatGPT、讯飞星火、文心一言、豆包也都能正确回答。\n\n# 生成 SQL\n\n我们总不会一个一个更改数据表或手动添加记录。我的思路是，数据表 `wl_Counter` 有对应 url 的记录就跳过，没有的就加上。对应的 SQL 应该长这样：\n\n```sql  \nINSERT INTO wl_Counter (url, time) SELECT '/p/d4bc55f2/', 0 WHERE NOT EXISTS (SELECT 1 FROM wl_Counter WHERE url = '/p/d4bc55f2/');  \nINSERT INTO wl_Counter (url, time) SELECT '/p/e1ee5eca/', 0 WHERE NOT EXISTS (SELECT 1 FROM wl_Counter WHERE url = '/p/e1ee5eca/');  \n```\n\n为匹配的 url 增加页面统计量，那么用于更新的 SQL 应该长这样：\n\n```sql\nUPDATE wl_Counter SET time = IFNULL(time, 0) + 2 WHERE url = '/p/d4bc55f2/';  \nUPDATE wl_Counter SET time = IFNULL(time, 0) + 2 WHERE url = '/p/e1ee5eca/';\n```\n\n我们可以编写脚本完成这些事情。\n\n# 不蒜子数据导出脚本\n\n[![Readme Card](https://github-readme-stats.uuanqin.top/api/pin/?username=uuanqin&repo=busuanzi2waline)](https://github.com/uuanqin/busuanzi2waline)\n\nGitHub 项目地址：[uuanqin/busuanzi2waline: 将不蒜子的页面浏览量导出为 json 格式的文件，并生成SQL语句以更新Waline数据库](https://github.com/uuanqin/busuanzi2waline)\n\n本脚本的主要功能有：\n\n- 根据提供的 sitemap 将不蒜子中存储的数据导出为 JSON 格式\n- 支持通过从不蒜子导出的数据生成对应的 SQL 语句，以将数据更新到 Waline 中\n- 由于每次脚本请求会记入不蒜子的统计量，有特殊需求的用户可以通过构造 sitemap 刷新网站的页面统计量\n\n可调整的参数：\n\n- 线程启动的间隔时间。设置太小的话请求速度过快，容易出错。\n- 请求失败重试次数（梯度随机重试）\n\n只需运行脚本：\n\n```shell  \npython sql_generator.py -gi -gu \n```  \n\n得到 `out_add.json` 文件中的数据即为导出的数据。\n\n```json  \n[  \n\t{  \n\t\t\"site_uv\": 419,  \n\t\t\"page_pv\": 2,  \n\t\t\"version\": 2.4,  \n\t\t\"site_pv\": 434,  \n\t\t\"url\": \"/p/d4bc55f2/\"  \n\t},  \n\t{  \n\t\t\"site_uv\": 420,  \n\t\t\"page_pv\": 2,  \n\t\t\"version\": 2.4,  \n\t\t\"site_pv\": 435,  \n\t\t\"url\": \"/p/e1ee5eca/\"  \n\t}  \n]  \n```  \n\n其中：\n\n- `page_pv` 表示对应路径 `url` 下的页面浏览量\n- `site_pv` 表示网站 https://blog.uuanqin.top 的页面浏览量\n- `site_pv` 表示网站 https://blog.uuanqin.top 的独立访客数\n\n得到文件 `out_ins.sql`、`out_add.sql` 即为生成的 SQL。\n\n# 完成\n\n然后就大功告成了！你还可以修改 `sitemap.txt` 文件，将一些奇奇怪怪地址的统计量聚合一下。比如以下这两个地址其实指向同一个页面，我们可以将分别获取它们的统计量多次更新 Waline 数据库即可。\n\n- `https://a.com/xxx/index.html`\n- `https://a.com/xxx`\n\n此外，刷出某网站的页面统计量的功能也算是脚本的额外功能吧。如果你想将评论系统中的页面访问数据迁移到不蒜子，可以通过这个脚本刷出来。具体方法是在 `sitemap.txt` 构造多个相同的地址就行。\n\n# 本文参考\n- [浏览量统计 | Waline](https://waline.js.org/guide/features/pageview.html)\n- [waline/assets/waline.sql at main · walinejs/waline](https://github.com/walinejs/waline/blob/main/assets/waline.sql)\n- [不蒜子 | 不如](https://ibruce.info/2015/04/04/busuanzi/)\n- [导出不蒜子的访问量数据 | M-x Chris-An-Emacser](https://chriszheng.science/2019/01/23/Export-busuanzi-data/)\n- [不蒜子统计常见问题](https://docs.qq.com/doc/DSFhCWkhmb1lWZWNE)\n- [不蒜子统计数据更改 | Clay 的技术空间](https://www.techgrow.cn/posts/fc73f615.html)\n- [自搭建不蒜子busuanzi从2.8之前版本升级数据方案教程 | 张洪Heo](https://blog.zhheo.com/p/7b5f.html)","categories":[{"name":"博客站点维护","api":"api/categories/博客站点维护.json"},{"name":"Waline","api":"api/categories/博客站点维护/Waline.json"}],"tags":[{"name":"Python","api":"api/tags/Python.json"},{"name":"Waline","api":"api/tags/Waline.json"},{"name":"MySQL","api":"api/tags/MySQL.json"},{"name":"SQL","api":"api/tags/SQL.json"},{"name":"不蒜子","api":"api/tags/不蒜子.json"},{"name":"busuanzi","api":"api/tags/busuanzi.json"}]},"api":"api/posts/p/e400f664.json"}