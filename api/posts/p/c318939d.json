{"data":{"title":"AHK 鼠标增强（CClose 源码撷英）","slug":"核心协同/自动化/AHK 鼠标增强（CClose 源码撷英）","description":"提取CClose中有用的脚本代码进行解析","date":"2023-05-26T15:09:27.000Z","updated":"2024-11-01T18:30:21.751Z","language":"zh-CN","comments":true,"url":"p/c318939d/","cover":"https://cdn.gallery.uuanqin.top/img/cclosecover.png","images":[],"content":"<p>刷抖音刷到一个项目，就是一个可以增加鼠标功能的操作。它为鼠标赋予了以下操作：</p>\n<table>\n<thead>\n<tr>\n<th>Action</th>\n<th>+ Target</th>\n<th>= Result</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Middle click</td>\n<td rowspan=\"3\">+ title bar</td>\n<td>= close window</td>\n</tr>\n<tr>\n<td>Right click</td>\n<td>= minimize window</td>\n</tr>\n<tr>\n<td>Hold left click</td>\n<td>= toggle window always on top</td>\n</tr>\n<tr>\n<td>Double press</td>\n<td>+ Esc key</td>\n<td>= close active window</td>\n</tr>\n<tr>\n<td>Right click</td>\n<td>+ taskbar button</td>\n<td>= move pointer to “Close window”</td>\n</tr>\n</tbody>\n</table>\n<p>软件不大，主要使用 AutoHotKey 脚本进行开发。鼠标快捷操作挺好用的，尤其是中键关闭窗口的操作，统一了浏览器关闭标签页的动作。但是我看中了其中的脚本语言 AutoHotKey，感觉它很有用处，遂决定剖析源码，提取其中执行快捷操作的有用脚本进行学习。</p>\n<p>以下是原项目的地址：</p>\n<blockquote>\n<p><a href=\"https://github.com/chaohershi/cclose/tree/master\">chaohershi/cclose: A Windows utility that helps you close windows faster or pin windows always on top. (github.com)</a></p>\n</blockquote>\n<p>原项目的 AutoHotKey 脚本语言版本应该是 V1，下面我将用 V2 版本进行改写并对其进行了简化 <s>（😥 其实是删去我看不懂但实际影响不大的内容）</s> 。读者可以摘取其中的片段作为自己的脚本。改进点：</p>\n<ul>\n<li>AutoHotKey 语法升级：从 V1 到 V2</li>\n<li>启用部分快捷功能有提示</li>\n</ul>\n<p>解析开始 🔽</p>\n<h1 id=\"公共函数部分\"><a class=\"markdownIt-Anchor\" href=\"#公共函数部分\"></a> 公共函数部分</h1>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#Requires AutoHotkey v2<span class=\"number\">.0</span></span><br><span class=\"line\"></span><br><span class=\"line\">; 检测鼠标是否在指定的WinTitle窗口中</span><br><span class=\"line\">MouseIsOver(WinTitle)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tMouseGetPos  , , &amp;win</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"title function_\">WinExist</span><span class=\"params\">(WinTitle <span class=\"string\">&quot; ahk_id &quot;</span> win)</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">; 检测鼠标是否悬停在标题</span><br><span class=\"line\">MouseIsOverTitlebar()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tCoordMode <span class=\"string\">&quot;Mouse&quot;</span>, <span class=\"string\">&quot;Screen&quot;</span></span><br><span class=\"line\">\tMouseGetPos &amp;x, &amp;y, &amp;win</span><br><span class=\"line\">    ; 用于存储目标窗口左上角的 X 和 Y 坐标的变量的引用</span><br><span class=\"line\">\tWinGetPos &amp;xWin, &amp;yWin, , , <span class=\"string\">&quot;ahk_id &quot;</span> win</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> <span class=\"title function_\">WinExist</span><span class=\"params\">(<span class=\"string\">&quot;ahk_class Shell_TrayWnd ahk_id &quot;</span> win)</span> || <span class=\"title function_\">WinExist</span><span class=\"params\">(<span class=\"string\">&quot;ahk_class Shell_SecondaryTrayWnd ahk_id &quot;</span> win)</span> ; exclude the taskbar</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (y &gt;= yWin &amp;&amp; y &lt; yWin + <span class=\"number\">30</span> * A_ScreenDPI / <span class=\"number\">96</span>)</span><br><span class=\"line\">    ; <span class=\"keyword\">if</span> within title bar width</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">; 展示<span class=\"number\">1</span>s钟的标签</span><br><span class=\"line\">ShowToolTip(msg)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    ToolTip msg,,<span class=\"number\">0</span></span><br><span class=\"line\">    SetTimer () =&gt; ToolTip(), <span class=\"number\">-1000</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"第一部分-标题操作\"><a class=\"markdownIt-Anchor\" href=\"#第一部分-标题操作\"></a> 第一部分 标题操作</h1>\n<table>\n<thead>\n<tr>\n<th>Action</th>\n<th>+ Target</th>\n<th>= Result</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Middle click</td>\n<td rowspan=\"3\">+ title bar</td>\n<td>= close window</td>\n</tr>\n<tr>\n<td>Right click</td>\n<td>= minimize window</td>\n</tr>\n<tr>\n<td>Hold left click</td>\n<td>= toggle window always on top</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#HotIf <span class=\"title function_\">MouseIsOverTitlebar</span><span class=\"params\">()</span></span><br><span class=\"line\">; 功能：鼠标中键点击标题关闭窗口</span><br><span class=\"line\">MButton::</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    ; alternative to WinClose, as WinClose is a somewhat forceful method, e.g., <span class=\"keyword\">if</span> multiple Microsoft Excel instances exist, WinClose will close them all at once.</span><br><span class=\"line\">    ; <span class=\"number\">0x112</span> = WM_SYSCOMMAND, <span class=\"number\">0xF060</span> = SC_CLOSE https:<span class=\"comment\">//autohotkey.com/docs/commands/WinClose.htm#Remarks</span></span><br><span class=\"line\">    ; https:<span class=\"comment\">//learn.microsoft.com/zh-cn/windows/win32/menurc/wm-syscommand</span></span><br><span class=\"line\">    MouseGetPos  , , &amp;win         ; 我加的，要不然它不起作用</span><br><span class=\"line\">    PostMessage <span class=\"number\">0x112</span>, <span class=\"number\">0xF060</span>, , win</span><br><span class=\"line\">    <span class=\"title function_\">ShowToolTip</span><span class=\"params\">(<span class=\"string\">&quot;窗口关闭&quot;</span>)</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">; 功能：鼠标右键点击标题最小化窗口</span><br><span class=\"line\">RButton::</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    err_code := KeyWait(<span class=\"string\">&quot;RButton&quot;</span>, <span class=\"string\">&quot;T0.4&quot;</span>)</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(err_code = <span class=\"number\">0</span>) ;超时</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        Send <span class=\"string\">&quot;&#123;Click, Right&#125;&quot;</span> ; n.b., <span class=\"keyword\">do</span> not use Send &#123;RButton&#125;</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        ; https:<span class=\"comment\">//learn.microsoft.com/zh-cn/windows/win32/menurc/wm-syscommand</span></span><br><span class=\"line\">        MouseGetPos  , , &amp;win           ; 我加的，要不然它不起作用</span><br><span class=\"line\">        PostMessage <span class=\"number\">0x112</span>, <span class=\"number\">0xF020</span>, ,win ; alternative to WinMinimize</span><br><span class=\"line\">        <span class=\"title function_\">ShowToolTip</span><span class=\"params\">(<span class=\"string\">&quot;窗口最小化&quot;</span>)</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">; 窗口置顶功能</span><br><span class=\"line\">~LButton::</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    CoordMode <span class=\"string\">&quot;Mouse&quot;</span>, <span class=\"string\">&quot;Screen&quot;</span></span><br><span class=\"line\">    MouseGetPos &amp;xOld, &amp;yOld, &amp;win</span><br><span class=\"line\">    ExStyle := WinGetExStyle(win)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (ExStyle &amp; <span class=\"number\">0x8</span>) ; <span class=\"number\">0x8</span> is WS_EX_TOPMOST</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        ExStyle := <span class=\"string\">&quot;窗口已取消置顶&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        ExStyle := <span class=\"string\">&quot;窗口已置顶&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    err_code := KeyWait(<span class=\"string\">&quot;LButton&quot;</span>, <span class=\"string\">&quot;T1&quot;</span>) ; wait <span class=\"keyword\">for</span> the left mouse button to be released with timeout <span class=\"built_in\">set</span> to <span class=\"number\">1</span> second</span><br><span class=\"line\">    MouseGetPos &amp;xNew, &amp;yNew</span><br><span class=\"line\">    <span class=\"title function_\">if</span> <span class=\"params\">(xOld = xNew &amp;&amp; yOld = yNew &amp;&amp; err_code = <span class=\"number\">0</span>)</span> ; <span class=\"keyword\">if</span> the mouse did not move during the timeout period</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        WinSetAlwaysOnTop <span class=\"number\">-1</span>, <span class=\"string\">&quot;A&quot;</span> ; toggle window always on top</span><br><span class=\"line\">        <span class=\"title function_\">ShowToolTip</span><span class=\"params\">(ExStyle)</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"第二部分-双击-esc-关闭窗口\"><a class=\"markdownIt-Anchor\" href=\"#第二部分-双击-esc-关闭窗口\"></a> 第二部分 双击 Esc 关闭窗口</h1>\n<table>\n<thead>\n<tr>\n<th>Action</th>\n<th>+ Target</th>\n<th>= Result</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Double press</td>\n<td>+ Esc key</td>\n<td>= close active window</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">; 功能：双击Esc关闭窗口</span><br><span class=\"line\">#HotIf</span><br><span class=\"line\">~Esc::</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    id_old := WinGetID(<span class=\"string\">&quot;A&quot;</span>)</span><br><span class=\"line\">    process_name := WinGetProcessName(<span class=\"string\">&quot;A&quot;</span>)</span><br><span class=\"line\">    KeyWait <span class=\"string\">&quot;Esc&quot;</span> ; wait <span class=\"keyword\">for</span> the Esc key to be released</span><br><span class=\"line\">    err_code := KeyWait(<span class=\"string\">&quot;Esc&quot;</span>, <span class=\"string\">&quot;D T0.4&quot;</span>)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (err_code = <span class=\"number\">1</span>)&#123;</span><br><span class=\"line\">        id_new := WinGetID(<span class=\"string\">&quot;A&quot;</span>) ; get the window id after the Esc key has being pressed again</span><br><span class=\"line\">        win_class := WinGetClass(<span class=\"string\">&quot;A&quot;</span>)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (id_old = id_new &amp;&amp; win_class != <span class=\"string\">&quot;Shell_TrayWnd&quot;</span> &amp;&amp; win_class != <span class=\"string\">&quot;Shell_SecondaryTrayWnd&quot;</span> &amp;&amp; win_class != <span class=\"string\">&quot;Progman&quot;</span> &amp;&amp; win_class != <span class=\"string\">&quot;WorkerW&quot;</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            ; <span class=\"keyword\">if</span> the current window is the same one as before and is not taskbar or desktop</span><br><span class=\"line\">            Send <span class=\"string\">&quot;!&#123;F4&#125;&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"第三部分-右击任务栏\"><a class=\"markdownIt-Anchor\" href=\"#第三部分-右击任务栏\"></a> 第三部分 右击任务栏</h1>\n<table>\n<thead>\n<tr>\n<th>Action</th>\n<th>+ Target</th>\n<th>= Result</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Right click</td>\n<td>+ taskbar button</td>\n<td>= move pointer to “Close window”</td>\n</tr>\n</tbody>\n</table>\n<p>右击任务栏后，如果鼠标自动悬停在关闭窗口上：</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">; 功能，右击任务栏图标鼠标自动跳转到关闭窗口</span><br><span class=\"line\">#HotIf <span class=\"title function_\">MouseIsOver</span><span class=\"params\">(<span class=\"string\">&quot;ahk_class Shell_TrayWnd&quot;</span>)</span> || <span class=\"title function_\">MouseIsOver</span><span class=\"params\">(<span class=\"string\">&quot;ahk_class Shell_SecondaryTrayWnd&quot;</span>)</span> ; apply the following hotkey only when the mouse is over the taskbar</span><br><span class=\"line\">~RButton:: ; when right clicked</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    CoordMode <span class=\"string\">&quot;Mouse&quot;</span>, <span class=\"string\">&quot;Screen&quot;</span></span><br><span class=\"line\">    MouseGetPos &amp;xOld, &amp;yOld</span><br><span class=\"line\">    Sleep <span class=\"number\">500</span> ; wait <span class=\"keyword\">for</span> the Jump List to pop up, n.b., this line also helps to provide a uniform waiting experience</span><br><span class=\"line\">    MouseGetPos &amp;xNew, &amp;yNew</span><br><span class=\"line\">    CoordMode <span class=\"string\">&quot;Mouse&quot;</span>, <span class=\"string\">&quot;Window&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (Abs(xNew - xOld) &lt; <span class=\"number\">8</span> &amp;&amp; Abs(yNew - yOld) &lt; <span class=\"number\">8</span>) ; <span class=\"keyword\">if</span> the mouse did not move much</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        Loop <span class=\"number\">6</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> <span class=\"title function_\">WinActive</span><span class=\"params\">(<span class=\"string\">&quot;ahk_class Windows.UI.Core.CoreWindow&quot;</span>)</span> ; <span class=\"keyword\">if</span> the Jump List pops <span class=\"title function_\">up</span> <span class=\"params\">(right clicked on the taskbar app buttons)</span></span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                WinGetPos , , &amp;width, &amp;height ; get the size of the last found <span class=\"title function_\">window</span> <span class=\"params\">(Jump List)</span></span><br><span class=\"line\">                <span class=\"title function_\">MouseMove</span> <span class=\"params\">(width / <span class=\"number\">2</span>)</span>, <span class=\"params\">(height - <span class=\"number\">3</span> * width / <span class=\"number\">32</span>)</span>, 10 ; move the mouse to the bottom of the Jump <span class=\"title function_\">List</span> <span class=\"params\">(<span class=\"string\">&quot;Close window&quot;</span>)</span></span><br><span class=\"line\">                <span class=\"keyword\">break</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            Sleep 250 ; wait <span class=\"keyword\">for</span> more time</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"总结\"><a class=\"markdownIt-Anchor\" href=\"#总结\"></a> 总结</h1>\n<p>上面的示例代码可以组成一个.ahk 文件，实现所有 CClose 的基本功能。</p>\n<p>开机自启动方法：</p>\n<ol>\n<li>Win+R 打开运行窗口，输入 shell:startup</li>\n<li>把脚本的快捷方式丢到里面即可</li>\n</ol>\n<p>未来可以改进的地方：</p>\n<ul class=\"contains-task-list\">\n<li class=\"task-list-item\"><input class=\"task-list-item-checkbox\" disabled=\"\" type=\"checkbox\"> 控制部分功能的启用与禁用（好的，又成 CClose 的轮子版了😅）</li>\n<li class=\"task-list-item\"><input class=\"task-list-item-checkbox\" disabled=\"\" type=\"checkbox\"> 进一步，对自己的脚本进行控制和管理</li>\n<li class=\"task-list-item\"><input class=\"task-list-item-checkbox\" disabled=\"\" type=\"checkbox\"> 对使用了管理员权限运行的系统无效</li>\n<li class=\"task-list-item\"><input class=\"task-list-item-checkbox\" disabled=\"\" type=\"checkbox\"> 状态栏图标改一下</li>\n<li class=\"task-list-item\"><input class=\"task-list-item-checkbox\" disabled=\"\" type=\"checkbox\"> 学习制作一个 Windows 软件</li>\n</ul>\n<p>目前存在的问题：</p>\n<ul class=\"contains-task-list\">\n<li class=\"task-list-item\"><input class=\"task-list-item-checkbox\" disabled=\"\" type=\"checkbox\"> 在运行《荒野大镖客 2》时部分情况下会触发。估计全屏游戏都会出现这个问题，待修复和改进。</li>\n</ul>\n","raw":"---\ntitle: AHK 鼠标增强（CClose 源码撷英）\ntags:\n  - CClose\n  - 快捷键\n  - 鼠标\n  - AutoHotKey\ncover: 'https://cdn.gallery.uuanqin.top/img/cclosecover.png'\ndescription: 提取CClose中有用的脚本代码进行解析\nabbrlink: c318939d\ncategories:\n  - 核心协同\n  - 自动化\ndate: 2023-05-26 23:09:27\ntop_img:\n---\n\n刷抖音刷到一个项目，就是一个可以增加鼠标功能的操作。它为鼠标赋予了以下操作：\n\n| Action          | + Target         | = Result                         |\n| --------------- | ---------------- | -------------------------------- |\n| Middle click    | + title bar      | = close window                   |\n| Right click     | + title bar      | = minimize window                |\n| Hold left click | + title bar      | = toggle window always on top    |\n| Double press    | + Esc key        | = close active window            |\n| Right click     | + taskbar button | = move pointer to \"Close window\" |\n\n软件不大，主要使用 AutoHotKey 脚本进行开发。鼠标快捷操作挺好用的，尤其是中键关闭窗口的操作，统一了浏览器关闭标签页的动作。但是我看中了其中的脚本语言 AutoHotKey，感觉它很有用处，遂决定剖析源码，提取其中执行快捷操作的有用脚本进行学习。\n\n以下是原项目的地址：\n\n> [chaohershi/cclose: A Windows utility that helps you close windows faster or pin windows always on top. (github.com)](https://github.com/chaohershi/cclose/tree/master)\n\n原项目的 AutoHotKey 脚本语言版本应该是 V1，下面我将用 V2 版本进行改写并对其进行了简化 ~~（😥 其实是删去我看不懂但实际影响不大的内容）~~ 。读者可以摘取其中的片段作为自己的脚本。改进点：\n\n- AutoHotKey 语法升级：从 V1 到 V2\n- 启用部分快捷功能有提示\n\n解析开始 🔽\n\n# 公共函数部分\n\n```c\n#Requires AutoHotkey v2.0\n\n; 检测鼠标是否在指定的WinTitle窗口中\nMouseIsOver(WinTitle)\n{\n\tMouseGetPos  , , &win\n\treturn WinExist(WinTitle \" ahk_id \" win)\n}\n\n; 检测鼠标是否悬停在标题\nMouseIsOverTitlebar()\n{\n\tCoordMode \"Mouse\", \"Screen\"\n\tMouseGetPos &x, &y, &win\n    ; 用于存储目标窗口左上角的 X 和 Y 坐标的变量的引用\n\tWinGetPos &xWin, &yWin, , , \"ahk_id \" win\n\n\tif WinExist(\"ahk_class Shell_TrayWnd ahk_id \" win) || WinExist(\"ahk_class Shell_SecondaryTrayWnd ahk_id \" win) ; exclude the taskbar\n\t{\n\t\treturn false\n\t}\n\telse if (y >= yWin && y < yWin + 30 * A_ScreenDPI / 96)\n    ; if within title bar width\n\t{\n        return true\n\t}\n    return false\n}\n\n; 展示1s钟的标签\nShowToolTip(msg)\n{\n    ToolTip msg,,0\n    SetTimer () => ToolTip(), -1000\n}\n```\n\n# 第一部分 标题操作\n\n| Action          | + Target    | = Result                      |\n| --------------- | ----------- | ----------------------------- |\n| Middle click    | + title bar | = close window                |\n| Right click     | + title bar | = minimize window             |\n| Hold left click | + title bar | = toggle window always on top |\n\n```C\n#HotIf MouseIsOverTitlebar()\n; 功能：鼠标中键点击标题关闭窗口\nMButton::\n{\n    ; alternative to WinClose, as WinClose is a somewhat forceful method, e.g., if multiple Microsoft Excel instances exist, WinClose will close them all at once.\n    ; 0x112 = WM_SYSCOMMAND, 0xF060 = SC_CLOSE https://autohotkey.com/docs/commands/WinClose.htm#Remarks\n    ; https://learn.microsoft.com/zh-cn/windows/win32/menurc/wm-syscommand\n    MouseGetPos  , , &win         ; 我加的，要不然它不起作用\n    PostMessage 0x112, 0xF060, , win\n    ShowToolTip(\"窗口关闭\")\n}\n\n; 功能：鼠标右键点击标题最小化窗口\nRButton::\n{\n    err_code := KeyWait(\"RButton\", \"T0.4\")\n    if(err_code = 0) ;超时\n    {\n        Send \"{Click, Right}\" ; n.b., do not use Send {RButton}\n    }else{\n        ; https://learn.microsoft.com/zh-cn/windows/win32/menurc/wm-syscommand\n        MouseGetPos  , , &win           ; 我加的，要不然它不起作用\n        PostMessage 0x112, 0xF020, ,win ; alternative to WinMinimize\n        ShowToolTip(\"窗口最小化\")\n    }\n}\n\n; 窗口置顶功能\n~LButton::\n{\n    CoordMode \"Mouse\", \"Screen\"\n    MouseGetPos &xOld, &yOld, &win\n    ExStyle := WinGetExStyle(win)\n    if (ExStyle & 0x8) ; 0x8 is WS_EX_TOPMOST\n    {\n        ExStyle := \"窗口已取消置顶\"\n    }\n    else\n    {\n        ExStyle := \"窗口已置顶\"\n    }\n    err_code := KeyWait(\"LButton\", \"T1\") ; wait for the left mouse button to be released with timeout set to 1 second\n    MouseGetPos &xNew, &yNew\n    if (xOld = xNew && yOld = yNew && err_code = 0) ; if the mouse did not move during the timeout period\n    {\n        WinSetAlwaysOnTop -1, \"A\" ; toggle window always on top\n        ShowToolTip(ExStyle)\n    }\n}\n```\n\n# 第二部分 双击 Esc 关闭窗口\n\n| Action       | + Target  | = Result              |\n| ------------ | --------- | --------------------- |\n| Double press | + Esc key | = close active window |\n\n```C\n; 功能：双击Esc关闭窗口\n#HotIf\n~Esc::\n{\n    id_old := WinGetID(\"A\")\n    process_name := WinGetProcessName(\"A\")\n    KeyWait \"Esc\" ; wait for the Esc key to be released\n    err_code := KeyWait(\"Esc\", \"D T0.4\")\n    if (err_code = 1){\n        id_new := WinGetID(\"A\") ; get the window id after the Esc key has being pressed again\n        win_class := WinGetClass(\"A\")\n        if (id_old = id_new && win_class != \"Shell_TrayWnd\" && win_class != \"Shell_SecondaryTrayWnd\" && win_class != \"Progman\" && win_class != \"WorkerW\")\n        {\n            ; if the current window is the same one as before and is not taskbar or desktop\n            Send \"!{F4}\"\n        }\n    }\n}\n```\n\n# 第三部分 右击任务栏\n\n| Action      | + Target         | = Result                         |\n| ----------- | ---------------- | -------------------------------- |\n| Right click | + taskbar button | = move pointer to \"Close window\" |\n\n右击任务栏后，如果鼠标自动悬停在关闭窗口上：\n\n```C\n; 功能，右击任务栏图标鼠标自动跳转到关闭窗口\n#HotIf MouseIsOver(\"ahk_class Shell_TrayWnd\") || MouseIsOver(\"ahk_class Shell_SecondaryTrayWnd\") ; apply the following hotkey only when the mouse is over the taskbar\n~RButton:: ; when right clicked\n{\n    CoordMode \"Mouse\", \"Screen\"\n    MouseGetPos &xOld, &yOld\n    Sleep 500 ; wait for the Jump List to pop up, n.b., this line also helps to provide a uniform waiting experience\n    MouseGetPos &xNew, &yNew\n    CoordMode \"Mouse\", \"Window\"\n    if (Abs(xNew - xOld) < 8 && Abs(yNew - yOld) < 8) ; if the mouse did not move much\n    {\n        Loop 6\n        {\n            if WinActive(\"ahk_class Windows.UI.Core.CoreWindow\") ; if the Jump List pops up (right clicked on the taskbar app buttons)\n            {\n                WinGetPos , , &width, &height ; get the size of the last found window (Jump List)\n                MouseMove (width / 2), (height - 3 * width / 32), 10 ; move the mouse to the bottom of the Jump List (\"Close window\")\n                break\n            }\n            Sleep 250 ; wait for more time\n        }\n    }\n}\n```\n\n# 总结\n\n上面的示例代码可以组成一个.ahk 文件，实现所有 CClose 的基本功能。\n\n开机自启动方法：\n\n1. Win+R 打开运行窗口，输入 shell:startup\n2. 把脚本的快捷方式丢到里面即可\n\n未来可以改进的地方：\n\n- [ ] 控制部分功能的启用与禁用（好的，又成 CClose 的轮子版了😅）\n- [ ] 进一步，对自己的脚本进行控制和管理\n- [ ] 对使用了管理员权限运行的系统无效\n- [ ] 状态栏图标改一下\n- [ ] 学习制作一个 Windows 软件\n\n目前存在的问题：\n\n- [ ] 在运行《荒野大镖客 2》时部分情况下会触发。估计全屏游戏都会出现这个问题，待修复和改进。\n","categories":[{"name":"核心协同","api":"api/categories/核心协同.json"},{"name":"自动化","api":"api/categories/核心协同/自动化.json"}],"tags":[{"name":"CClose","api":"api/tags/CClose.json"},{"name":"快捷键","api":"api/tags/快捷键.json"},{"name":"鼠标","api":"api/tags/鼠标.json"},{"name":"AutoHotKey","api":"api/tags/AutoHotKey.json"}]},"api":"api/posts/p/c318939d.json"}