{"data":{"title":"实现网站国内外分流（境外接入 Cloudflare）","slug":"博客站点维护/实现网站国内外分流（境外接入 Cloudflare）","description":"要补课的站长请点进来","date":"2024-12-09T19:28:48.000Z","updated":"2025-10-16T16:28:32.566Z","language":"zh-CN","comments":true,"url":"p/55893d1/","cover":"https://cdn.gallery.uuanqin.top/img/202412100327066.webp","images":[],"content":"<p>前不久我在 <a class=\"uuanqin-bilink\" target=\"_blank\" href=\"/p/41b77d61/\"><span class=\"bilink-pop-up\">站内文章</span>这篇文章</a> 中提到我的 <code>uuanqin.top</code> 域名 DNS 全线接入 Cloudflare，很多小伙伴反馈说 cf 国内访问速度很不稳定，时快时慢（有一部分是我乱套 CDN 的原因），于是我打算这段时间就致力于解决这个问题。</p>\n<p>通过不同方案的探索并结合自己的实际情况终于试出来了，现记录操作思路。</p>\n<h1 id=\"效果预览\"><a class=\"markdownIt-Anchor\" href=\"#效果预览\"></a> 效果预览</h1>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/202412100216983.webp\" alt=\"image.png\" /></p>\n<table>\n<thead>\n<tr>\n<th>分流方式</th>\n<th>境内访问</th>\n<th>境外访问</th>\n<th>备注</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>只使用腾讯云 CDN（境内加速）</td>\n<td>🟩&lt;50 ms</td>\n<td>🟧300ms<br>🔴部分超时</td>\n<td>没买境外套餐包的话，境外加速流量 <a href=\"https://cloud.tencent.com/document/product/228/2949\">按量计费</a>。</td>\n</tr>\n<tr>\n<td>只使用 Cloudflare 代理</td>\n<td>🟨200ms<br>🔴部分超时</td>\n<td>🟩&lt;50 ms <!-- 以防合并1 --></td>\n<td>国内访问极其不稳定，忽快忽慢。「减速 CDN」果然名不虚传。</td>\n</tr>\n<tr>\n<td>双线自动分流后</td>\n<td colspan=\"2\">🟩&lt;50 ms</td>\n<td>🎉 访客对于分线过程无感知</td>\n</tr>\n</tbody>\n</table>\n<p>境内用境内 CDN，境外用境外 CDN，取长补短。为了更加节省开支或避免由于攻击造成的高额账单，国内线路可以不用 CDN，直接连接国内源站。</p>\n<p>数据来源：<a href=\"https://www.itdog.cn/ping/blog.uuanqin.top\">blog.uuanqin.top_在线ping-ITDOG</a></p>\n<h1 id=\"原理简述\"><a class=\"markdownIt-Anchor\" href=\"#原理简述\"></a> 原理简述</h1>\n<blockquote>\n<p>思路浓缩在这里了</p>\n</blockquote>\n<p>阿里云云解析 DNS / 腾讯云 DNSPod 支持境内外分线解析，<code>blog.uuanqin.top</code> 将根据用户 IP 选择合适的线路。由于 <code>blog.uuanqin.top</code> 配置的是 <code>CNAME</code> 的记录类型，访客对于分线过程无感知，浏览器地址栏不变。</p>\n<p>利用 Cloudflare for SaaS 实现 <code>blog.uuanqin.top</code> CNAME 指向中间域名 <code>cname.qinq.us.kg</code>，进而通过 Cloudflare 管理其 DNS 记录，再 CNAME/A 到源站。</p>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/202412101730674.webp\" alt=\"image.png\" /></p>\n<p>通过观察上图，你可以为境内外线路配置各种选择。比如，博主的选择为：</p>\n<ul>\n<li>境内线路：国内 CDN -&gt; 国内云服务器</li>\n<li>境外线路：Cloudflare CDN -&gt; 国内云服务器</li>\n</ul>\n<p>至于国内 CDN 或源站的选择看你自己的情况，文章主要将介绍两个操作重点：</p>\n<ul>\n<li>使用腾讯云 DNSPod 进行线路选择</li>\n<li>CNAME 方式接入 Cloudflare</li>\n</ul>\n\n<details class=\"callout\" data-callout=\"note\" data-callout-fold=\"-\">\n<summary class=\"callout-title\">\n<div class=\"callout-title-icon\">\n<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-pencil\"><path d=\"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z\"/><path d=\"m15 5 4 4\"/></svg>\n</div>\n<div class=\"callout-title-inner\">简要介绍 Cloudflare for SaaS</div>\n<div class=\"callout-fold\"></div>\n</summary>\n<div class=\"callout-content\"><p>「软件即服务」简称 SaaS。假设当前一个用户想建设自己的网站或电子邮箱，传统方式为需要用户自己准备机器与应用并自己维护。而在 SaaS 方式下，服务商自己搞定了机器和应用程序，SaaS 用户通过订阅的方式获得服务商提供的应用程序服务。<br />\n<img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/saas-application-vs-on-premises.svg\" alt=\"saas-application-vs-on-premises.svg\" width=\"440px\" /><br />\n用户使用 SaaS 服务建设自己的网站后，可能还有自定义域名的需求。这些自定义域名最终指向的就是 SaaS 服务商的服务器。Cloudflare 为 SaaS 服务商提供类似的功能，即 Cloudflare for SaaS。这样不管用户自定义的域名是什么，最终会回退到托管在 Cloudflare 上的域名（回退源），从而让用户享受到 Cloudflare 的防护服务。</p>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/202412100254649.webp\" alt=\"image.png\" width=\"500px\" /></p>\n<p>在本文中，<code>qinq.us.kg</code> 扮演的是 SaaS 服务商的角色，<code>blog.uuanqin.top</code> 扮演的是用户的角色。</p>\n</div></details><h1 id=\"准备材料\"><a class=\"markdownIt-Anchor\" href=\"#准备材料\"></a> 准备材料</h1>\n<blockquote>\n<p>一堆账号直接劝退</p>\n</blockquote>\n<p>在开始之前，我们需要准备以下账号或服务：</p>\n<ol>\n<li>Cloudflare 账号。用于使用 Cloudflare SaaS 服务。</li>\n<li>阿里云云解析 DNS / 腾讯云 DNSPod 账号。用于实现境内外自动分流。下文将以腾讯云 DNSPod 进行演示。</li>\n<li>PayPal 账号。用于使用 Cloudflare for SaaS 服务。注册材料涉及：身份证、银联借记卡/信用卡。注册方式自行网络搜索。<strong>请放心，Cloudflare 免费额度管够，本文操作过程不会花 1 分钱。</strong></li>\n<li>2 个域名。\n<ol>\n<li>1 个是正式的博客访问域名，对访客可见。这里以 <code>uuanqin.top</code> 为例。</li>\n<li>1 个用于中间域名，对外不可见。域名能正常用就行。这里以免费域名 <code>qinq.us.kg</code> 为例。免费域名 <code>.us.kg</code> 注册方式详看 <a href=\"https://www.tjsky.net/tutorial/922\">@秋风于渭水</a> 的文章。注册材料可能涉及：\n<ol>\n<li>GitHub 账号</li>\n<li>Gmail 账号/Outlook 账号。</li>\n</ol>\n</li>\n</ol>\n</li>\n<li>【可选】CDN 服务商。用于国内加速。</li>\n<li>【可选】GitHub Page。用于境外源站。</li>\n</ol>\n\n<details class=\"callout\" data-callout=\"cite\" data-callout-fold=\"-\">\n<summary class=\"callout-title\">\n<div class=\"callout-title-icon\">\n<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-quote\"><path d=\"M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z\"/><path d=\"M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2h.75c0 2.25.25 4-2.75 4v3c0 1 0 1 1 1z\"/></svg>\n</div>\n<div class=\"callout-title-inner\">免费域名 <code>.us.kg</code> 于 <code>250221</code> 暂停解析</div>\n<div class=\"callout-fold\"></div>\n</summary>\n<div class=\"callout-content\"><p>Due to the misuse of the <strong><a href=\"http://US.KG\">US.KG</a></strong> domain by certain criminal organizations, it has been reported to the <strong>.KG</strong> registry. As a result, the <strong>.KG</strong> domain registry has <strong>suspended DNS resolution</strong> for all <code>*.US.KG</code> domains, making them temporarily inaccessible.</p>\n<p>——<a href=\"https://github.com/DigitalPlatDev/FreeDomain\">DigitalPlatDev/FreeDomain</a>。博主提示：免费域名并不稳定，建议购买正规域名。</p>\n</div></details><h1 id=\"选择-dns-解析商\"><a class=\"markdownIt-Anchor\" href=\"#选择-dns-解析商\"></a> 选择 DNS 解析商</h1>\n<p>两个域名应该交给谁解析：</p>\n<table>\n<thead>\n<tr>\n<th>域名</th>\n<th>用途</th>\n<th>DNS 解析商</th>\n<th>选择这个 DNS 的理由</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>uuanqin.top</code></td>\n<td>公共访问</td>\n<td>阿里云云解析<br>腾讯云 DNSPod</td>\n<td>我们必须使用这两家服务商的智能分线功能</td>\n</tr>\n<tr>\n<td><code>qinq.us.kg</code></td>\n<td>中间媒介</td>\n<td>Cloudflare</td>\n<td>我们必须使用 Cloudflare for SaaS 服务</td>\n</tr>\n</tbody>\n</table>\n\n<div class=\"callout\" data-callout=\"hint\">\n<div class=\"callout-title\">\n<div class=\"callout-title-icon\">\n<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-flame\"><path d=\"M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z\"/></svg>\n</div>\n<div class=\"callout-title-inner\">我们也可以只将子域名 <code>blog.uuanqin.top</code> 交给 DNSPod 解析</div>\n</div>\n<div class=\"callout-content\"><p>因为 Cloudflare 留有太多东西了，不好迁移。我打算只将 <code>blog.uuanqin.top</code> 交给 DNSPod 解析。</p>\n<p>NS 解析梳理：在 <code>uuanqin.top</code> 域名注册商中指定 NS 为 Cloudflare，然后在 Cloudflare 中新增两条 NS 记录，将 <code>blog.uuanqin.top</code> 交给 DNSPod 解析。<br />\n<img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/202412100231328.webp\" alt=\"image.png\" width=\"450px\" /></p>\n<p>Cloudflare 的「代理状态」为「仅 DNS」（也就是没有点亮小黄云）时速度不会有太大影响。</p>\n</div></div><h1 id=\"添加-dns-记录\"><a class=\"markdownIt-Anchor\" href=\"#添加-dns-记录\"></a> 添加 DNS 记录</h1>\n<p>Cloudflare 中加入一条记录用于中间域名，<strong>必须点上小黄云</strong>。这里我就设置为 <code>cname.qinq.us.kg</code>，指向境外源站（或者境内服务器也行，反正使用小黄云代理相当于套了一层 CDN）。</p>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/202412100246952.webp\" alt=\"image.png\" width=\"500px\" /></p>\n<p>DNSPod 配置 3 条线路类型：国内、国外、默认。</p>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/202412100243078.webp\" alt=\"image.png\" width=\"500px\" /></p>\n<h1 id=\"使用-cloudflare-for-saas\"><a class=\"markdownIt-Anchor\" href=\"#使用-cloudflare-for-saas\"></a> 使用 Cloudflare for SaaS</h1>\n<p>回到 Cloudflare，点开中间域名 <code>qinq.us.kg</code> 下的 SSL/TLS-&gt;自定义主机名。开通并使用 Cloudflare for SaaS，这个过程需要 PayPal 订购。免费额度详看：<a href=\"https://developers.cloudflare.com/cloudflare-for-platforms/cloudflare-for-saas/plans/\">Plans — Cloudflare for SaaS · Cloudflare for Platforms docs</a>，反正用不完。</p>\n<p>设置回退源并添加自定义主机名：</p>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/202412100255283.webp\" alt=\"image.png\" /></p>\n<p>注意：</p>\n<ul>\n<li>回退源必须点亮小黄云</li>\n<li>自定义主机名需要对证书和主机名验证，根据提示在 DNSPod 中添加两条 <code>TXT</code> 记录即可。注意，由于 DNSPod 的特性，主机记录域名部分需要省略。</li>\n</ul>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/202412100258488.webp\" alt=\"image.png\" /></p>\n<h1 id=\"成功了\"><a class=\"markdownIt-Anchor\" href=\"#成功了\"></a> 成功了</h1>\n<p>等待所有 DNS 生效后，你可以测测网站速度有没有提升。</p>\n<p>直接访问中间域名 <code>cname.qinq.us.kg</code> 会怎么样？</p>\n<p>后续内容可选择性观看。</p>\n<h2 id=\"可选github-page-作为源站\"><a class=\"markdownIt-Anchor\" href=\"#可选github-page-作为源站\"></a> 【可选】GitHub Page 作为源站</h2>\n<p>在 Cloudflare 配置 DNS 记录指向 <code>xxx.github.io</code>。然后来到项目设置，验证中间域名 <code>cname.qinq.us.kg</code> 的 DNS 记录即可。</p>\n\n<div class=\"callout\" data-callout=\"error\">\n<div class=\"callout-title\">\n<div class=\"callout-title-icon\">\n<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-zap\"><polygon points=\"13 2 3 14 12 14 11 22 21 10 12 10 13 2\"/></svg>\n</div>\n<div class=\"callout-title-inner\">网站出现「重定向次数过多」问题的解决</div>\n</div>\n<div class=\"callout-content\"><p>如果我们访问自己的博客网站出现「重定向次数过多」的问题时，修改 Cloudflare 中 SSL 加密模式为【完全】即可。</p>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/202410260220517.webp\" alt=\"image.png\" width=\"400px\" /></p>\n<p>这种情况一般出现于源服务器配置好 HTTPS 的情况。比如 GitHub Page 强制 HTTPS 选项勾上时。</p>\n<p>参考：<a href=\"https://nutswp.com/%E8%A7%A3%E5%86%B3%E4%BD%BF%E7%94%A8cloudflare%E5%87%BA%E7%8E%B0%E9%87%8D%E5%AE%9A%E5%90%91%E6%AC%A1%E8%BF%87%E5%A4%9A%E9%97%AE%E9%A2%98/\">解决使用Cloudflare出现重定向次过多问题 - 【NUTSWP】</a></p>\n</div></div>\n<div class=\"callout\" data-callout=\"warning\">\n<div class=\"callout-title\">\n<div class=\"callout-title-icon\">\n<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-alert-triangle\"><path d=\"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z\"/><path d=\"M12 9v4\"/><path d=\"M12 17h.01\"/></svg>\n</div>\n<div class=\"callout-title-inner\">境外自动化程序可能会找不到 GitHub Page 的内容</div>\n</div>\n<div class=\"callout-content\"><p>GitHub Pages 中只存在 <code>cname.qinq.us.kg</code> 这个站点，它通过检查请求头中的 Host 字段判断应该请求哪个站点。但是境外机器使用爬虫爬取时，携带的请求中 Host 字段为 <code>blog.uuanqin.top</code>，这会导致部分境外自动化程序找不到境外源站而引发 404 错误。</p>\n<p>关于 GitHub Page 自动化爬虫 404 的问题尝试了很多办法没有解决。原因：</p>\n<ul>\n<li>GitHub Page <a href=\"https://docs.github.com/zh/pages/configuring-a-custom-domain-for-your-github-pages-site/managing-a-custom-domain-for-your-github-pages-site\">不支持多自定义域名</a>。即使换成 Vercel 支持多域名也不一定有用，因为 DNS 在当前文章情景下不好验证。</li>\n<li>Cloudflare「重写规则」中 <a href=\"https://developer.mozilla.org/zh-CN/docs/Glossary/Forbidden_header_name\">不允许重写 Host 请求头</a>。</li>\n</ul>\n</div></div><h2 id=\"可选hexo-中部署时增加-github-page-的部署\"><a class=\"markdownIt-Anchor\" href=\"#可选hexo-中部署时增加-github-page-的部署\"></a> 【可选】Hexo 中部署时增加 GitHub Page 的部署</h2>\n<p>在 <code>_config.yml</code> 中配置一个新的仓库。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Deployment</span></span><br><span class=\"line\"><span class=\"comment\">## Docs: https://hexo.io/docs/one-command-deployment</span></span><br><span class=\"line\"><span class=\"attr\">deploy:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">type:</span> <span class=\"string\">git</span></span><br><span class=\"line\">    <span class=\"attr\">repo:</span> <span class=\"string\">git@xxx.xxx.xxx.xxx:/home/git/hexo_repo/hexo.git</span></span><br><span class=\"line\">    <span class=\"attr\">branch:</span> <span class=\"string\">master</span></span><br><span class=\"line\">  <span class=\"comment\"># GitHub Page</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">type:</span> <span class=\"string\">git</span></span><br><span class=\"line\">    <span class=\"attr\">repo:</span> <span class=\"string\">git@github.com:uuanqin/uuanqin.github.io.git</span></span><br><span class=\"line\">    <span class=\"attr\">branch:</span> <span class=\"string\">master</span></span><br></pre></td></tr></table></figure>\n<p>如果前面在 GitHub Page 中设置了自定义域名，你会发现仓库自动增加一个 <code>CNAME</code> 文件。为了避免上传时将这个文件覆盖掉，我们需要在博客项目 <code>source</code> 文件夹下手动增加 <code>CNAME</code> 文件。保险起见，我们可以在 <code>_config.yml</code> 设置其为无需渲染的文件：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">skip_render:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">CNAME</span> <span class=\"comment\"># GitHub Page 自定义域名的配置</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"可选cloudflare-缓存策略调整\"><a class=\"markdownIt-Anchor\" href=\"#可选cloudflare-缓存策略调整\"></a> 【可选】Cloudflare 缓存策略调整</h2>\n<p>有时候点了小黄云，感觉境外没提升多少速度啊？各种速度配置赶紧上一下，并检查一下有没有配置缓存策略吧。</p>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/202412100305270.webp\" alt=\"image.png\" width=\"375px\" /></p>\n<h1 id=\"后记\"><a class=\"markdownIt-Anchor\" href=\"#后记\"></a> 后记</h1>\n<p>站长必修课又补上一了个课时！该折腾的还是得折腾。</p>\n<h1 id=\"本文参考\"><a class=\"markdownIt-Anchor\" href=\"#本文参考\"></a> 本文参考</h1>\n<ul>\n<li><a href=\"https://post.smzdm.com/p/aov495g7/\">【网络】双域名同时托管Cloudflare SaaS加速解决方案_网络存储_什么值得买</a></li>\n<li><a href=\"https://www.tjsky.net/tutorial/922\">常见免费、便宜域名注册渠道一览 - 秋风于渭水</a></li>\n<li><a href=\"https://blog.csdn.net/zacji/article/details/140628748\">顶级域名和二级域名的区别-CSDN博客</a></li>\n<li><a href=\"https://developers.cloudflare.com/cloudflare-for-platforms/cloudflare-for-saas/\">Cloudflare for SaaS · Cloudflare for Platforms docs</a></li>\n<li><a href=\"https://hexo.io/zh-cn/docs/one-command-deployment.html\">一键部署 | Hexo</a></li>\n<li><a href=\"https://docs.github.com/zh/pages/configuring-a-custom-domain-for-your-github-pages-site/managing-a-custom-domain-for-your-github-pages-site#configuring-a-subdomain\">管理 GitHub Pages 站点的自定义域 - GitHub 文档</a></li>\n<li><a href=\"https://xiaoa.me/archives/cfsaas.html\">网站用上CloudFlare SaaS回源优选教程 - 半日闲</a></li>\n<li><a href=\"https://www.cloudflare-cn.com/learning/cloud/what-is-saas/\">什么是 SaaS？| SaaS 定义 | Cloudflare</a></li>\n<li><a href=\"https://blog.cloudflare.com/zh-cn/waf-for-saas/\">SaaS 提供商的安全性</a></li>\n<li><a href=\"https://www.nodeseek.com/post-42661-1\">⭐Dooongの教程 通过CloudFlare+SaaS回源优选IP使国内用户高速访问网站</a></li>\n</ul>\n<p>推荐阅读：<a href=\"https://blog.hyperknot.com/p/understanding-round-robin-dns\">Understanding Round Robin DNS - by Zsolt Ero</a></p>\n","raw":"---\ntitle: 实现网站国内外分流（境外接入 Cloudflare）\ntags:\n  - DNS\n  - DNSPod\n  - CDN\n  - Cloudflare\n  - SaaS\n  - PayPal\n  - us.kg\n  - hexo\n  - GitHub\n  - GitHub Page\ncover: 'https://cdn.gallery.uuanqin.top/img/202412100327066.webp'\ndescription: 要补课的站长请点进来\ncategories:\n  - 博客站点维护\nabbrlink: 55893d1\ndate: 2024-12-10 03:28:48\ntop_img:\nswiper_index: 5\nswiper_desc: 博主精选\nswiper_cover: 'https://cdn.gallery.uuanqin.top/img/202412100327066.webp'\n---\n\n前不久我在 [[域名 DNS 服务托管至 Cloudflare 以及 301 重定向的配置|这篇文章]] 中提到我的 `uuanqin.top` 域名 DNS 全线接入 Cloudflare，很多小伙伴反馈说 cf 国内访问速度很不稳定，时快时慢（有一部分是我乱套 CDN 的原因），于是我打算这段时间就致力于解决这个问题。\n\n通过不同方案的探索并结合自己的实际情况终于试出来了，现记录操作思路。\n\n# 效果预览\n\n![image.png](https://cdn.gallery.uuanqin.top/img/202412100216983.webp)\n\n| 分流方式              | 境内访问              | 境外访问                    | 备注                                                                            |\n| ----------------- | ----------------- | ----------------------- | ----------------------------------------------------------------------------- |\n| 只使用腾讯云 CDN（境内加速）  | 🟩<50 ms          | 🟧300ms<br>🔴部分超时       | 没买境外套餐包的话，境外加速流量 [按量计费](https://cloud.tencent.com/document/product/228/2949)。 |\n| 只使用 Cloudflare 代理 | 🟨200ms<br>🔴部分超时 | 🟩<50 ms <!-- 以防合并1 --> | 国内访问极其不稳定，忽快忽慢。「减速 CDN」果然名不虚传。                                                |\n| 双线自动分流后           | 🟩<50 ms          | 🟩<50 ms                | 🎉 访客对于分线过程无感知                                                                |\n\n境内用境内 CDN，境外用境外 CDN，取长补短。为了更加节省开支或避免由于攻击造成的高额账单，国内线路可以不用 CDN，直接连接国内源站。\n\n数据来源：[blog.uuanqin.top_在线ping-ITDOG](https://www.itdog.cn/ping/blog.uuanqin.top)\n\n# 原理简述\n\n> 思路浓缩在这里了\n\n阿里云云解析 DNS / 腾讯云 DNSPod 支持境内外分线解析，`blog.uuanqin.top` 将根据用户 IP 选择合适的线路。由于 `blog.uuanqin.top` 配置的是 `CNAME` 的记录类型，访客对于分线过程无感知，浏览器地址栏不变。\n\n利用 Cloudflare for SaaS 实现 `blog.uuanqin.top` CNAME 指向中间域名 `cname.qinq.us.kg`，进而通过 Cloudflare 管理其 DNS 记录，再 CNAME/A 到源站。\n\n![image.png](https://cdn.gallery.uuanqin.top/img/202412101730674.webp)\n\n通过观察上图，你可以为境内外线路配置各种选择。比如，博主的选择为：\n\n- 境内线路：国内 CDN -> 国内云服务器\n- 境外线路：Cloudflare CDN -> 国内云服务器\n\n至于国内 CDN 或源站的选择看你自己的情况，文章主要将介绍两个操作重点：\n\n- 使用腾讯云 DNSPod 进行线路选择\n- CNAME 方式接入 Cloudflare\n\n> [!note]- 简要介绍 Cloudflare for SaaS\n> 「软件即服务」简称 SaaS。假设当前一个用户想建设自己的网站或电子邮箱，传统方式为需要用户自己准备机器与应用并自己维护。而在 SaaS 方式下，服务商自己搞定了机器和应用程序，SaaS 用户通过订阅的方式获得服务商提供的应用程序服务。\n> ![saas-application-vs-on-premises.svg|440](https://cdn.gallery.uuanqin.top/img/saas-application-vs-on-premises.svg)\n> 用户使用 SaaS 服务建设自己的网站后，可能还有自定义域名的需求。这些自定义域名最终指向的就是 SaaS 服务商的服务器。Cloudflare 为 SaaS 服务商提供类似的功能，即 Cloudflare for SaaS。这样不管用户自定义的域名是什么，最终会回退到托管在 Cloudflare 上的域名（回退源），从而让用户享受到 Cloudflare 的防护服务。\n>\n> ![image.png|500](https://cdn.gallery.uuanqin.top/img/202412100254649.webp)\n>\n> 在本文中，`qinq.us.kg` 扮演的是 SaaS 服务商的角色，`blog.uuanqin.top` 扮演的是用户的角色。\n\n\n# 准备材料\n\n> 一堆账号直接劝退\n\n在开始之前，我们需要准备以下账号或服务：\n\n1. Cloudflare 账号。用于使用 Cloudflare SaaS 服务。\n2. 阿里云云解析 DNS / 腾讯云 DNSPod 账号。用于实现境内外自动分流。下文将以腾讯云 DNSPod 进行演示。\n3. PayPal 账号。用于使用 Cloudflare for SaaS 服务。注册材料涉及：身份证、银联借记卡/信用卡。注册方式自行网络搜索。**请放心，Cloudflare 免费额度管够，本文操作过程不会花 1 分钱。**\n4. 2 个域名。\n\t1. 1 个是正式的博客访问域名，对访客可见。这里以 `uuanqin.top` 为例。\n\t2. 1 个用于中间域名，对外不可见。域名能正常用就行。这里以免费域名 `qinq.us.kg` 为例。免费域名 `.us.kg` 注册方式详看 [@秋风于渭水](https://www.tjsky.net/tutorial/922) 的文章。注册材料可能涉及：\n\t\t1. GitHub 账号\n\t\t2. Gmail 账号/Outlook 账号。\n5. 【可选】CDN 服务商。用于国内加速。\n6. 【可选】GitHub Page。用于境外源站。\n\n> [!cite]- 免费域名 `.us.kg` 于 `250221` 暂停解析\n> Due to the misuse of the **US.KG** domain by certain criminal organizations, it has been reported to the **.KG** registry. As a result, the **.KG** domain registry has **suspended DNS resolution** for all `*.US.KG` domains, making them temporarily inaccessible.\n> \n> ——[DigitalPlatDev/FreeDomain](https://github.com/DigitalPlatDev/FreeDomain)。博主提示：免费域名并不稳定，建议购买正规域名。\n\n# 选择 DNS 解析商\n\n两个域名应该交给谁解析：\n\n| 域名            | 用途   | DNS 解析商              | 选择这个 DNS 的理由                  |\n| ------------- | ---- | -------------------- | ----------------------------- |\n| `uuanqin.top` | 公共访问 | 阿里云云解析<br>腾讯云 DNSPod | 我们必须使用这两家服务商的智能分线功能           |\n| `qinq.us.kg`  | 中间媒介 | Cloudflare           | 我们必须使用 Cloudflare for SaaS 服务 |\n\n> [!hint] 我们也可以只将子域名 `blog.uuanqin.top` 交给 DNSPod 解析\n> 因为 Cloudflare 留有太多东西了，不好迁移。我打算只将 `blog.uuanqin.top` 交给 DNSPod 解析。\n>\n> NS 解析梳理：在 `uuanqin.top` 域名注册商中指定 NS 为 Cloudflare，然后在 Cloudflare 中新增两条 NS 记录，将 `blog.uuanqin.top` 交给 DNSPod 解析。\n> ![image.png|450](https://cdn.gallery.uuanqin.top/img/202412100231328.webp)\n>\n> Cloudflare 的「代理状态」为「仅 DNS」（也就是没有点亮小黄云）时速度不会有太大影响。\n\n# 添加 DNS 记录\n\nCloudflare 中加入一条记录用于中间域名，**必须点上小黄云**。这里我就设置为 `cname.qinq.us.kg`，指向境外源站（或者境内服务器也行，反正使用小黄云代理相当于套了一层 CDN）。\n\n![image.png|500](https://cdn.gallery.uuanqin.top/img/202412100246952.webp)\n\nDNSPod 配置 3 条线路类型：国内、国外、默认。\n\n![image.png|500](https://cdn.gallery.uuanqin.top/img/202412100243078.webp)\n\n# 使用 Cloudflare for SaaS\n\n回到 Cloudflare，点开中间域名 `qinq.us.kg` 下的 SSL/TLS->自定义主机名。开通并使用 Cloudflare for SaaS，这个过程需要 PayPal 订购。免费额度详看：[Plans — Cloudflare for SaaS · Cloudflare for Platforms docs](https://developers.cloudflare.com/cloudflare-for-platforms/cloudflare-for-saas/plans/)，反正用不完。\n\n设置回退源并添加自定义主机名：\n\n![image.png](https://cdn.gallery.uuanqin.top/img/202412100255283.webp)\n\n注意：\n\n- 回退源必须点亮小黄云\n- 自定义主机名需要对证书和主机名验证，根据提示在 DNSPod 中添加两条 `TXT` 记录即可。注意，由于 DNSPod 的特性，主机记录域名部分需要省略。\n\n![image.png](https://cdn.gallery.uuanqin.top/img/202412100258488.webp)\n\n# 成功了\n\n等待所有 DNS 生效后，你可以测测网站速度有没有提升。\n\n直接访问中间域名 `cname.qinq.us.kg` 会怎么样？\n\n后续内容可选择性观看。\n\n## 【可选】GitHub Page 作为源站\n\n在 Cloudflare 配置 DNS 记录指向 `xxx.github.io`。然后来到项目设置，验证中间域名 `cname.qinq.us.kg` 的 DNS 记录即可。\n\n> [!error] 网站出现「重定向次数过多」问题的解决\n> 如果我们访问自己的博客网站出现「重定向次数过多」的问题时，修改 Cloudflare 中 SSL 加密模式为【完全】即可。\n>\n> ![image.png|400](https://cdn.gallery.uuanqin.top/img/202410260220517.webp)\n>\n> 这种情况一般出现于源服务器配置好 HTTPS 的情况。比如 GitHub Page 强制 HTTPS 选项勾上时。\n>\n> 参考：[解决使用Cloudflare出现重定向次过多问题 - 【NUTSWP】](https://nutswp.com/%E8%A7%A3%E5%86%B3%E4%BD%BF%E7%94%A8cloudflare%E5%87%BA%E7%8E%B0%E9%87%8D%E5%AE%9A%E5%90%91%E6%AC%A1%E8%BF%87%E5%A4%9A%E9%97%AE%E9%A2%98/)\n\n> [!warning] 境外自动化程序可能会找不到 GitHub Page 的内容\n>  GitHub Pages 中只存在 `cname.qinq.us.kg` 这个站点，它通过检查请求头中的 Host 字段判断应该请求哪个站点。但是境外机器使用爬虫爬取时，携带的请求中 Host 字段为 `blog.uuanqin.top`，这会导致部分境外自动化程序找不到境外源站而引发 404 错误。\n>\n> 关于 GitHub Page 自动化爬虫 404 的问题尝试了很多办法没有解决。原因：\n>\n> - GitHub Page [不支持多自定义域名](https://docs.github.com/zh/pages/configuring-a-custom-domain-for-your-github-pages-site/managing-a-custom-domain-for-your-github-pages-site)。即使换成 Vercel 支持多域名也不一定有用，因为 DNS 在当前文章情景下不好验证。\n> - Cloudflare「重写规则」中 [不允许重写 Host 请求头](https://developer.mozilla.org/zh-CN/docs/Glossary/Forbidden_header_name)。\n\n## 【可选】Hexo 中部署时增加 GitHub Page 的部署\n\n在 `_config.yml` 中配置一个新的仓库。\n\n```yaml\n# Deployment\n## Docs: https://hexo.io/docs/one-command-deployment\ndeploy:\n  - type: git\n    repo: git@xxx.xxx.xxx.xxx:/home/git/hexo_repo/hexo.git\n    branch: master\n  # GitHub Page\n  - type: git\n    repo: git@github.com:uuanqin/uuanqin.github.io.git\n    branch: master\n```\n\n如果前面在 GitHub Page 中设置了自定义域名，你会发现仓库自动增加一个 `CNAME` 文件。为了避免上传时将这个文件覆盖掉，我们需要在博客项目 `source` 文件夹下手动增加 `CNAME` 文件。保险起见，我们可以在 `_config.yml` 设置其为无需渲染的文件：\n\n```yaml\nskip_render:\n  - CNAME # GitHub Page 自定义域名的配置\n```\n\n\n## 【可选】Cloudflare 缓存策略调整\n\n有时候点了小黄云，感觉境外没提升多少速度啊？各种速度配置赶紧上一下，并检查一下有没有配置缓存策略吧。\n\n![image.png|375](https://cdn.gallery.uuanqin.top/img/202412100305270.webp)\n\n# 后记\n\n站长必修课又补上一了个课时！该折腾的还是得折腾。\n\n# 本文参考\n- [【网络】双域名同时托管Cloudflare SaaS加速解决方案_网络存储_什么值得买](https://post.smzdm.com/p/aov495g7/)\n- [常见免费、便宜域名注册渠道一览 - 秋风于渭水](https://www.tjsky.net/tutorial/922)\n- [顶级域名和二级域名的区别-CSDN博客](https://blog.csdn.net/zacji/article/details/140628748)\n- [Cloudflare for SaaS · Cloudflare for Platforms docs](https://developers.cloudflare.com/cloudflare-for-platforms/cloudflare-for-saas/)\n- [一键部署 | Hexo](https://hexo.io/zh-cn/docs/one-command-deployment.html)\n- [管理 GitHub Pages 站点的自定义域 - GitHub 文档](https://docs.github.com/zh/pages/configuring-a-custom-domain-for-your-github-pages-site/managing-a-custom-domain-for-your-github-pages-site#configuring-a-subdomain)\n- [网站用上CloudFlare SaaS回源优选教程 - 半日闲](https://xiaoa.me/archives/cfsaas.html)\n- [什么是 SaaS？| SaaS 定义 | Cloudflare](https://www.cloudflare-cn.com/learning/cloud/what-is-saas/)\n- [SaaS 提供商的安全性](https://blog.cloudflare.com/zh-cn/waf-for-saas/)\n- [⭐Dooongの教程 通过CloudFlare+SaaS回源优选IP使国内用户高速访问网站](https://www.nodeseek.com/post-42661-1)\n\n推荐阅读：[Understanding Round Robin DNS - by Zsolt Ero](https://blog.hyperknot.com/p/understanding-round-robin-dns)","categories":[{"name":"博客站点维护","api":"api/categories/博客站点维护.json"}],"tags":[{"name":"CDN","api":"api/tags/CDN.json"},{"name":"DNS","api":"api/tags/DNS.json"},{"name":"DNSPod","api":"api/tags/DNSPod.json"},{"name":"Cloudflare","api":"api/tags/Cloudflare.json"},{"name":"SaaS","api":"api/tags/SaaS.json"},{"name":"PayPal","api":"api/tags/PayPal.json"},{"name":"us.kg","api":"api/tags/us-kg.json"},{"name":"hexo","api":"api/tags/hexo.json"},{"name":"GitHub","api":"api/tags/GitHub.json"},{"name":"GitHub Page","api":"api/tags/GitHub-Page.json"}]},"api":"api/posts/p/55893d1.json"}