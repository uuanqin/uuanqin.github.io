<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>我的 AI 摘要方案：Vercel+Redis+Hexo API+Spark Lite | 半方池水半方田</title><meta name="author" content="wuanqin"><meta name="copyright" content="wuanqin"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="自己尝试动手实现一个 AI 摘要"><meta property="og:type" content="article"><meta property="og:title" content="我的 AI 摘要方案：Vercel+Redis+Hexo API+Spark Lite"><meta property="og:url" content="https://blog.uuanqin.top/p/75efe9f3/index.html"><meta property="og:site_name" content="半方池水半方田"><meta property="og:description" content="自己尝试动手实现一个 AI 摘要"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.gallery.uuanqin.top/img/202506242301616.webp"><meta property="article:published_time" content="2025-06-24T15:19:05.000Z"><meta property="article:modified_time" content="2025-07-05T11:37:00.772Z"><meta property="article:author" content="wuanqin"><meta property="article:tag" content="JavaScript"><meta property="article:tag" content="Hexo"><meta property="article:tag" content="npm"><meta property="article:tag" content="Butterfly"><meta property="article:tag" content="Vercel"><meta property="article:tag" content="Redis"><meta property="article:tag" content="SparkLite"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.gallery.uuanqin.top/img/202506242301616.webp"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","headline":"我的 AI 摘要方案：Vercel+Redis+Hexo API+Spark Lite","url":"https://blog.uuanqin.top/p/75efe9f3/","image":"https://cdn.gallery.uuanqin.top/img/202506242301616.webp","datePublished":"2025-06-24T15:19:05.000Z","dateModified":"2025-07-05T11:37:00.772Z","author":[{"@type":"Person","name":"wuanqin","url":"https://blog.uuanqin.top"}]}</script><link rel="icon shortcut" href="/image/qlogo-400x400.webp"><link rel="canonical" href="https://blog.uuanqin.top/p/75efe9f3/index.html"><link rel="preconnect" href="//unpkg.com"><link rel="preconnect" href="//hm.baidu.com"><link rel="preconnect" href="//www.clarity.ms"><meta name="baidu-site-verification" content="codeva-IupgPifNxU"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/font-awesome/6.6.0/css/all.min.css"><link rel="stylesheet" href="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/node-snackbar/0.1.16/snackbar.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/fancyapps-ui/5.0.17/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>(()=>{var saveToLocal={set:(key,value,ttl)=>{ttl&&(ttl=Date.now()+864e5*ttl,localStorage.setItem(key,JSON.stringify({value:value,expiry:ttl})))},get:key=>{var itemStr=localStorage.getItem(key);if(itemStr){var{value:itemStr,expiry}=JSON.parse(itemStr);if(!(Date.now()>expiry))return itemStr;localStorage.removeItem(key)}}},activateDarkMode=(window.btf={saveToLocal:saveToLocal,getScript:(url,attr={})=>new Promise((resolve,reject)=>{let script=document.createElement('script');script.src=url,script.async=!0,Object.entries(attr).forEach(([key,val])=>script.setAttribute(key,val)),script.onload=script.onreadystatechange=()=>{script.readyState&&!/loaded|complete/.test(script.readyState)||resolve()},script.onerror=reject,document.head.appendChild(script)}),getCSS:(url,id)=>new Promise((resolve,reject)=>{let link=document.createElement('link');link.rel='stylesheet',link.href=url,id&&(link.id=id),link.onload=link.onreadystatechange=()=>{link.readyState&&!/loaded|complete/.test(link.readyState)||resolve()},link.onerror=reject,document.head.appendChild(link)}),addGlobalFn:(key,fn,name=!1,parent=window)=>{var globalFn;key.startsWith('pjax')||((globalFn=parent.globalFn||{})[key]=globalFn[key]||{},globalFn[key][name||Object.keys(globalFn[key]).length]=fn,parent.globalFn=globalFn)}},()=>{document.documentElement.setAttribute('data-theme','dark'),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute('content','#0d0d0d')}),activateLightMode=()=>{document.documentElement.setAttribute('data-theme','light'),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute('content','ffffff')},theme=(btf.activateDarkMode=activateDarkMode,btf.activateLightMode=activateLightMode,saveToLocal.get('theme')),hour=(new Date).getHours(),hour=((void 0===theme?hour<=8||23<=hour?activateDarkMode:activateLightMode:'light'===theme?activateLightMode:activateDarkMode)(),saveToLocal.get('aside-status'));void 0!==hour&&document.documentElement.classList.toggle('hide-aside','hide'===hour);/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add('apple')})();</script><script>var _hmt=_hmt||[];(()=>{var hm=document.createElement('script'),s=(hm.src='https://hm.baidu.com/hm.js?877eb1cd1993b0865452ed4011fcd2d8',document.getElementsByTagName('script')[0]);s.parentNode.insertBefore(hm,s)})(),btf.addGlobalFn('pjaxComplete',()=>{_hmt.push(['_trackPageview',window.location.pathname])},'baidu_analytics');</script><script>((c,l,a,r,t,y)=>{c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)},(t=l.createElement(r)).async=1,t.src='https://www.clarity.ms/tag/gwn59ub66c',(y=l.getElementsByTagName(r)[0]).parentNode.insertBefore(t,y)})(window,document,'clarity','script');</script><script>let GLOBAL_CONFIG={root:'/',algolia:{appId:'2JINTHATAF',apiKey:'086110423d680367cda9c0216b336eb8',indexName:'blog.uuanqin.top',hitsPerPage:6,languages:{input_placeholder:'搜索文章',hits_empty:'未找到符合您查询的内容：${query}',hits_stats:'找到 ${hits} 条结果，耗时 ${time} 毫秒'}},localSearch:void 0,translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:'繁',msgToSimplifiedChinese:'简'},highlight:{plugin:'highlight.js',highlightCopy:!0,highlightLang:!0,highlightHeightLimit:350,highlightFullpage:!0,highlightMacStyle:!0},copy:{success:'复制成功',error:'复制失败',noSupport:'浏览器不支持'},relativeDate:{homepage:!0,post:!1},runtime:'',dateSuffix:{just:'刚刚',min:'分钟前',hour:'小时前',day:'天前',month:'个月前'},copyright:void 0,lightbox:'fancybox',Snackbar:{chs_to_cht:'已切换为繁体中文',cht_to_chs:'已切换为简体中文',day_to_night:'已切换为深色模式',night_to_day:'已切换为浅色模式',bgLight:'#177ecd',bgDark:'#1f1f1f',position:'top-center'},infinitegrid:{js:'https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/egjs-infinitegrid/4.12.0/infinitegrid.min.js',buttonText:'加载更多'},isPhotoFigcaption:!1,islazyloadPlugin:!0,isAnchor:!1,percent:{toc:!0,rightside:!0},autoDarkmode:!1};</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:'我的 AI 摘要方案：Vercel+Redis+Hexo API+Spark Lite',isHighlightShrink:!1,isToc:!0,pageType:'post'};</script><link rel="stylesheet" href="//at.alicdn.com/t/c/font_4037705_yv0gf35i5r.css"><link rel="stylesheet" href="/css/iconfont_custom.css"><script src="/js/random.js?8"></script><link rel="stylesheet" href="/css/seamless_card.css"><link rel="stylesheet" href="/css/footer.css?0814"><link rel="stylesheet" href="/css/darktheme_modify.css?0814"><link rel="stylesheet" href="/css/markdown-it-obsidian-callouts.css"><link rel="stylesheet" href="/css/bi-links.css"><link rel="stylesheet" href="/css/links-card.css"><link rel="stylesheet" href="/css/links-bilibili-card.css"><link rel="stylesheet" href="/css/links-art-card.css"><link rel="stylesheet" href="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/KaTeX/0.16.9/katex.min.css"><meta name="google-site-verification" content="ppz3zz_ljO3DX-zHwknKzh4A9v_qNLtrhhpSDoCdps8"><link rel="stylesheet" href="/css/ai-summary.css"><link rel="stylesheet" href="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/Swiper/4.1.6/css/swiper.min.css"><link rel="stylesheet" href="/css/swiperstyle.css"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="半方池水半方田" type="application/atom+xml"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/image/avatar.webp" onerror="this.onerror=null;this.src='/image/loading.gif'" alt="avatar"></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">177</div></a><a href="/pages/tags/"><div class="headline">标签</div><div class="length-num">393</div></a><a href="/pages/categories/"><div class="headline">分类</div><div class="length-num">26</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw icon-nongtian iconfont"></i><span> 主页</span></a></div><div class="menus_item"><span class="group site-page"><i class="fa-fw icon-guanli iconfont"></i><span> 归档</span><i class="fa-chevron-down fas"></i></span><ul class="menus_item_child"><li><a class="child site-page" href="/DO_NOT_render/cosmoscope/cosmoscope_trim.html"><i class="fa-fw icon-guanxitu iconfont"></i><span> 关系图</span></a></li><li><a class="child site-page" href="/archives/"><i class="fa-fw icon-timeAxis iconfont"></i><span> 时间轴</span></a></li><li><a class="child site-page" href="/pages/categories/"><i class="fa-fw icon-2 iconfont"></i><span> 分类</span></a></li><li><a class="child site-page" href="/pages/tags/"><i class="fa-fw icon-24gf-tags iconfont"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><span class="group site-page"><i class="fa-fw icon-daimaguanli iconfont"></i><span> 项目</span><i class="fa-chevron-down fas"></i></span><ul class="menus_item_child"><li><a class="child site-page" target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/uuanqin/obsidian2cosma"><i class="fa-fw icon-xinghao iconfont"></i><span> PythonCLI obsidian2cosma</span></a></li><li><a class="child site-page" target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/uuanqin/waline-link-interceptor"><i class="fa-fw icon-a-lanjiezudangzhangaiwuzuzhi iconfont"></i><span> waline-link-interceptor</span></a></li><li><a class="child site-page" target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/uuanqin/hexo-filter-titlebased-link"><i class="fa-fw icon-line-bracketszhongkuohao iconfont"></i><span> hexo-filter-titlebased-link</span></a></li><li><a class="child site-page" target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/uuanqin/markdown-it-obsidian-imgsize"><i class="fa-fw icon-daxiao iconfont"></i><span> markdown-it-obsidian-imgsize</span></a></li><li><a class="child site-page" target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/uuanqin/busuanzi2waline"><i class="fa-fw icon-suantou iconfont"></i><span> PythonCLI busuanzi2waline</span></a></li><li><a class="child site-page" target="_blank" rel="external nofollow noopener noreferrer" href="https://greasyfork.org/zh-CN/scripts/466046-%E7%9F%A5%E7%BD%91-%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE-bibtex-%E5%A4%A9%E6%B4%A5%E5%A4%A7%E5%AD%A6"><i class="fa-fw icon-yinyong iconfont"></i><span> UserScripts bibtex-TJU</span></a></li><li><a class="child site-page" target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/uuanqin/hexo-filter-custom-link"><i class="fa-fw icon-neibujiekou iconfont"></i><span> hexo-filter-custom-link</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:randomPost();" rel="external nofollow noreferrer"><i class="fa-fw icon-suijibofang iconfont"></i><span> 随机</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="external nofollow noopener noreferrer" href="https://www.travellings.cn/go-by-clouds.html"><i class="fa-fw icon-huochepiao iconfont"></i><span> 开往</span></a></div><div class="menus_item"><a class="site-page" href="/pages/friends/"><i class="fa-fw icon-pengyoufill iconfont"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/pages/friend_circle/"><i class="fa-fw icon-pengyouquan iconfont"></i><span> 朋友圈</span></a></div><div class="menus_item"><span class="group site-page"><i class="fa-fw icon-guanfangwangzhan iconfont"></i><span> 关于</span><i class="fa-chevron-down fas"></i></span><ul class="menus_item_child"><li><a class="child site-page" href="/pages/about.html"><i class="fa-fw icon-mao iconfont"></i><span> 关于本站</span></a></li><li><a class="child site-page" href="/sitemap.xml"><i class="fa-fw icon-ditu iconfont"></i><span> 站点地图</span></a></li><li><a class="child site-page" target="_blank" rel="external nofollow noopener noreferrer" href="https://pl.uuanqin.top/ui"><i class="fa-fw icon-w iconfont"></i><span> 评论后台</span></a></li><li><a class="child site-page" target="_blank" rel="external nofollow noopener noreferrer" href="https://uuanqin.instatus.com/"><i class="fa-fw icon-jiankong iconfont"></i><span> 站点状态</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="fixed not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="/image/logo-bc.webp" alt="Logo"><span class="site-name">半方池水半方田</span></a><a class="nav-page-title" href="/"><span class="site-name">我的 AI 摘要方案：Vercel+Redis+Hexo API+Spark Lite</span><span class="site-name"><i class="fa-circle-arrow-left fa-solid"></i><span> 返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="search site-page social-icon"><i class="fa-fw fa-search fas"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw icon-nongtian iconfont"></i><span> 主页</span></a></div><div class="menus_item"><span class="group site-page"><i class="fa-fw icon-guanli iconfont"></i><span> 归档</span><i class="fa-chevron-down fas"></i></span><ul class="menus_item_child"><li><a class="child site-page" href="/DO_NOT_render/cosmoscope/cosmoscope_trim.html"><i class="fa-fw icon-guanxitu iconfont"></i><span> 关系图</span></a></li><li><a class="child site-page" href="/archives/"><i class="fa-fw icon-timeAxis iconfont"></i><span> 时间轴</span></a></li><li><a class="child site-page" href="/pages/categories/"><i class="fa-fw icon-2 iconfont"></i><span> 分类</span></a></li><li><a class="child site-page" href="/pages/tags/"><i class="fa-fw icon-24gf-tags iconfont"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><span class="group site-page"><i class="fa-fw icon-daimaguanli iconfont"></i><span> 项目</span><i class="fa-chevron-down fas"></i></span><ul class="menus_item_child"><li><a class="child site-page" target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/uuanqin/obsidian2cosma"><i class="fa-fw icon-xinghao iconfont"></i><span> PythonCLI obsidian2cosma</span></a></li><li><a class="child site-page" target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/uuanqin/waline-link-interceptor"><i class="fa-fw icon-a-lanjiezudangzhangaiwuzuzhi iconfont"></i><span> waline-link-interceptor</span></a></li><li><a class="child site-page" target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/uuanqin/hexo-filter-titlebased-link"><i class="fa-fw icon-line-bracketszhongkuohao iconfont"></i><span> hexo-filter-titlebased-link</span></a></li><li><a class="child site-page" target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/uuanqin/markdown-it-obsidian-imgsize"><i class="fa-fw icon-daxiao iconfont"></i><span> markdown-it-obsidian-imgsize</span></a></li><li><a class="child site-page" target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/uuanqin/busuanzi2waline"><i class="fa-fw icon-suantou iconfont"></i><span> PythonCLI busuanzi2waline</span></a></li><li><a class="child site-page" target="_blank" rel="external nofollow noopener noreferrer" href="https://greasyfork.org/zh-CN/scripts/466046-%E7%9F%A5%E7%BD%91-%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE-bibtex-%E5%A4%A9%E6%B4%A5%E5%A4%A7%E5%AD%A6"><i class="fa-fw icon-yinyong iconfont"></i><span> UserScripts bibtex-TJU</span></a></li><li><a class="child site-page" target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/uuanqin/hexo-filter-custom-link"><i class="fa-fw icon-neibujiekou iconfont"></i><span> hexo-filter-custom-link</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:randomPost();" rel="external nofollow noreferrer"><i class="fa-fw icon-suijibofang iconfont"></i><span> 随机</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="external nofollow noopener noreferrer" href="https://www.travellings.cn/go-by-clouds.html"><i class="fa-fw icon-huochepiao iconfont"></i><span> 开往</span></a></div><div class="menus_item"><a class="site-page" href="/pages/friends/"><i class="fa-fw icon-pengyoufill iconfont"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/pages/friend_circle/"><i class="fa-fw icon-pengyouquan iconfont"></i><span> 朋友圈</span></a></div><div class="menus_item"><span class="group site-page"><i class="fa-fw icon-guanfangwangzhan iconfont"></i><span> 关于</span><i class="fa-chevron-down fas"></i></span><ul class="menus_item_child"><li><a class="child site-page" href="/pages/about.html"><i class="fa-fw icon-mao iconfont"></i><span> 关于本站</span></a></li><li><a class="child site-page" href="/sitemap.xml"><i class="fa-fw icon-ditu iconfont"></i><span> 站点地图</span></a></li><li><a class="child site-page" target="_blank" rel="external nofollow noopener noreferrer" href="https://pl.uuanqin.top/ui"><i class="fa-fw icon-w iconfont"></i><span> 评论后台</span></a></li><li><a class="child site-page" target="_blank" rel="external nofollow noopener noreferrer" href="https://uuanqin.instatus.com/"><i class="fa-fw icon-jiankong iconfont"></i><span> 站点状态</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fa-bars fa-fw fas"></i></span></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">我的 AI 摘要方案：Vercel+Redis+Hexo API+Spark Lite</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-calendar-alt fa-fw far post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-06-24T15:19:05.000Z" title="发表于 2025-06-24 23:19:05">2025-06-24</time><span class="post-meta-separator">|</span><i class="fa-fw fa-history fas post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-07-05T11:37:00.772Z" title="更新于 2025-07-05 19:37:00">2025-07-05</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fa-fw fa-inbox fas post-meta-icon"></i><a class="post-meta-categories" href="/pages/categories/%E5%8D%9A%E5%AE%A2%E7%AB%99%E7%82%B9%E7%BB%B4%E6%8A%A4/">博客站点维护</a><i class="fa-angle-right fas post-meta-separator"></i><i class="fa-fw fa-inbox fas post-meta-icon"></i><a class="post-meta-categories" href="/pages/categories/%E5%8D%9A%E5%AE%A2%E7%AB%99%E7%82%B9%E7%BB%B4%E6%8A%A4/Hexo/">Hexo</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="fa-file-word fa-fw far post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">7.7k</span><span class="post-meta-separator">|</span><i class="fa-clock fa-fw far post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>34分钟</span></span><span class="post-meta-separator">|</span><span data-flag-title=""><i class="fa-eye fa-fw far post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span class="waline-pageview-count" data-path="/p/75efe9f3/"><i class="fa-solid fa-spin fa-spinner"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="fa-comments fa-fw far post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/p/75efe9f3/#post-comment"><span class="waline-comment-count" data-path="/p/75efe9f3/"><i class="fa-solid fa-spin fa-spinner"></i></span></a></span></div></div></div><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;这个页面已经有&quot;,&quot;messageNext&quot;:&quot;天没有更新了，文章部分内容可能已经过时&quot;,&quot;postUpdate&quot;:&quot;2025-07-05 19:37:00&quot;}" hidden=""></div><p>前段时间看到 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://blog.liushen.fun/">@LiuShen</a> 发表了一篇博客文章，我不禁感慨：继对友链朋友圈改进后，柳神终于盯上 AI 摘要的改进了！在 Liushen 文章中提到了 <a target="_blank" rel="external nofollow noopener noreferrer" href="/go.html?u=aHR0cHM6Ly93d3cua29ub3hpbi50b3Av">@konoXIN</a> 通过 Vercel 函数调用大模型的方法，对此我也受到启发，打算动手尝试自己的 AI 摘要解决方案。</p> <p>目前，静态博客 AI 摘要大概有以下三种：</p> <table> <thead> <tr> <th>AI 摘要生成方式</th> <th>作者部署速度</th> <th>读者获取摘要速度</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>直接调用大模型接口</td> <td>🟢快</td> <td>🔴慢，但可优化</td> <td>直接调用大模型接口固然很慢，但通过引入多级缓存，摘要获取时间可大大缩短，还能节约成本。</td> </tr> <tr> <td>本地预构建摘要</td> <td>🔴慢</td> <td>🟢快</td> <td>本地预构建，相当于把读者的访问时间转移到作者预构建的博客时间。这种无后端的配置方式灵活可调。</td> </tr> <tr> <td>第三方摘要服务</td> <td colspan="2">🟡取决于服务</td> <td>第三方摘要服务可能会收取一定的费用，但是能节省很多时间和精力成本。</td> </tr> </tbody> </table> <p>目前，博客圈里我了解到的上面方案对应的实现：</p> <table> <thead> <tr> <th>方案</th> <th>作者</th> <th>前端</th> <th>后端</th> </tr> </thead> <tbody> <tr> <td><a target="_blank" rel="external nofollow noopener noreferrer" href="https://blog.zhheo.com/p/ec57d8b2.html">TianliGPT</a></td> <td><a target="_blank" rel="external nofollow noopener noreferrer" href="https://tianli-blog.club/">@Tianli</a></td> <td>引入 js 文件/插件</td> <td>第三方后端管理</td> </tr> <tr> <td>插件 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://blog.liushen.fun/posts/40702a0d/">hexo-ai-summary</a></td> <td><a target="_blank" rel="external nofollow noopener noreferrer" href="https://blog.liushen.fun/">@LiuShen</a></td> <td>插件 + 修改主题源码</td> <td>无（本地提前生成好摘要）</td> </tr> <tr> <td>自定义 <a target="_blank" rel="external nofollow noopener noreferrer" href="/go.html?u=aHR0cHM6Ly93d3cua29ub3hpbi50b3AvcG9zdHMvZGI3YjM0MTgv">Vercel 代理方案</a></td> <td><a target="_blank" rel="external nofollow noopener noreferrer" href="/go.html?u=aHR0cHM6Ly93d3cua29ub3hpbi50b3Av">@konoXIN</a></td> <td>引入 js 文件</td> <td>Vercel 接口转发</td> </tr> </tbody> </table> <p>TianliGPT 方案是本站最初选择的方案，有专门的后端管理，内容合规、模型选择啥的基本不用操心。现在的 TianliGPT 在多款主题下也开发有多款插件，前端部署不是问题。要想省心省力，选择 TianliGPT 就行。</p> <p>hexo-ai-summary 是大佬 Liushen 提供的解决方案。这款方案通过提前生成博客摘要嵌入到每篇文章中，读者访问文章就能访问摘要，没有额外请求时延且不用担心另外的系统故障，此外可以灵活替换使用的大语言模型。此方案是速度与灵活性双重兼顾方案，要想读者以最快的速度获取文章摘要，选择 hexo-ai-summary 准没错。</p> <p>konoXIN 也实现了自己的 AI 摘要方案，用户访问文章时携带文章内容发送至 Vercel，Vercel 充当代理调用 LLM 接口，并将最终的摘要数据返回给用户。这种方案朴素、结构直观且有效，给想动 (zhe) 手 (teng) 的人更大的发挥空间。</p> <p>本文主要参考的是 konoXIN 的文章，并在原方案的基础上作出了改进。但总的来说不会有前面的方案那么完美，只能说是个人试验的小作品。当然也希望各位读者分享你们的方案与建议，期待和各位大佬探讨交流 ~</p> <h1 id="我的方案"><a class="markdownIt-Anchor" href="#我的方案"></a> 我的方案</h1> <h2 id="概述"><a class="markdownIt-Anchor" href="#概述"></a> 概述</h2> <p>相较于 <a target="_blank" rel="external nofollow noopener noreferrer" href="/go.html?u=aHR0cHM6Ly93d3cua29ub3hpbi50b3AvcG9zdHMvZGI3YjM0MTgv">konoXIN 的方案</a>，本方案改进点和可优化点如下表所示：</p> <table> <thead> <tr> <th>改进点</th> <th>可优化点（缺点…）</th> </tr> </thead> <tbody> <tr> <td>样式调整：<br>✅样式文件中，像素 px 统一使用 rem 单位<br>✅Hexo-Butterfly 主题夜间模式适配<br>✅多一个「关于」按钮<br><br>逻辑改进：<br>✅重构前后端代码，增加代码可读性<br>✅优化前端请求方式，减少不必要的参数携带<br>✅本地缓存 + Vercel 代理端 Redis 缓存<br>✅优化提示词模板</td> <td>🟥模块依赖较复杂，有一定的耦合性<br>🟥模型的灵活替换功能还需要额外的代码重构<br>🟥仅适合个人学习参考使用<br>🟥API 插件提供的信息过多，存在冗余或安全风险</td> </tr> </tbody> </table> <p>交互时序图（Sequence Diagram）如下：</p> <pre><code class="highlight mermaid">sequenceDiagram
    actor U as 用户
    participant F as 前端
    participant V as Vercel
    participant R as Redis
    participant L as 大模型
    participant B as 博客 API 服务
    activate U
    U -&gt;&gt; F : 访问文章
    activate F
    F -&gt;&gt; F : 查询本地缓存
    activate F
    deactivate F
    alt 本地无缓存
        F -&gt;&gt; V : 文章链接
        activate V
        V -&gt;&gt; R : 查询缓存
        activate R
        R --&gt;&gt; V : 查询结果
        deactivate R
        alt 服务端无缓存            
            V -&gt;&gt; B : 访问API接口获取全文
            activate B
            B --&gt;&gt; V : 文章数据
            deactivate B
            
            V -&gt;&gt; V : 数据清洗
            activate V
            deactivate V
            V -&gt;&gt; L : 提示词与清洗后的数据
            activate L
            L --&gt;&gt; V : 文章摘要
            deactivate L
            V -&gt;&gt; R : 缓存
            activate R
            deactivate R   
        end
        V --&gt;&gt; F : 文章摘要
        deactivate V
        F -&gt;&gt; F : 摘要本地缓存
        activate F
        deactivate F
    end
    F --&gt;&gt; U: 文章摘要
    deactivate F
    deactivate U</code></pre> <p>缓存方案概述：用户访问文章时，先找本地浏览器缓存，本地缓存不命中则发送请求至 Vercel。Vercel 接受请求后，先从 Redis 找缓存，Redis 不命中才向大模型服务获取文章摘要。所有缓存的时间均为 1 周。</p> <h2 id="前端文件导入"><a class="markdownIt-Anchor" href="#前端文件导入"></a> 前端：文件导入</h2> <div class="callout" data-callout="note"> <div class="callout-title"> <div class="callout-title-icon"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path><path d="m15 5 4 4"></path></svg> </div> <div class="callout-title-inner">本文所有代码文件均附于文末</div> </div> <div class="callout-content"><p></p> </div></div><p>按照自己主题的导入方式引入以下文件：</p> <ul> <li><code>ai-summary.js</code></li> <li><code>ai-summary.css</code></li> </ul> <p>hexo-butterfly 主题可在 <code>_config.butterfly.yml</code> 中配置。</p> <h2 id="后端vercel-提供的函数服务"><a class="markdownIt-Anchor" href="#后端vercel-提供的函数服务"></a> 后端：Vercel 提供的函数服务</h2> <div class="callout" data-callout="note"> <div class="callout-title"> <div class="callout-title-icon"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path><path d="m15 5 4 4"></path></svg> </div> <div class="callout-title-inner">本文所有代码文件均附于文末</div> </div> <div class="callout-content"><p></p> </div></div><p>我们使用 Vercel 函数服务代理文章摘要请求。官方文档：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://vercel.com/docs/functions">Vercel Functions</a>.</p> <p>建一个 GitHub 仓，里面编写代理逻辑以及 Redis 调用逻辑，然后通过 Vercel 导入这个项目。我的仓库目录如下：</p> <p><img src="/image/loading.gif" data-lazy-src="https://cdn.gallery.uuanqin.top/img/202506230041907.webp" alt="image.png" width="275px"></p> <p>文件说明：</p> <ul> <li><code>spark-lite.js</code>：编写代理逻辑。放在 <code>/api/ai-summary</code> 下。访问时可通过：<code>https://your-custom-domain/api/ai-summary/spark-lite</code> 进行访问。</li> <li><code>redis.js</code>：用于使用 Redis 服务。</li> </ul> <p>如代码有更新，<code>git push</code> 到代码仓后，Vercel 会自动重新部署。Vercel 自定义域名可自行配置。</p> <div class="callout" data-callout="warning"> <div class="callout-title"> <div class="callout-title-icon"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-alert-triangle"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><path d="M12 9v4"></path><path d="M12 17h.01"></path></svg> </div> <div class="callout-title-inner">注意：使用 Vercel 函数服务，相关 JavaScript 文件必须放置在名为 <code>api</code> 的文件夹中才能生效。</div> </div> <div class="callout-content"><p></p> </div></div><h3 id="讯飞星火-spark-lite"><a class="markdownIt-Anchor" href="#讯飞星火-spark-lite"></a> 讯飞星火 Spark Lite</h3> <p>在 <a target="_blank" rel="external nofollow noopener noreferrer" href="/go.html?u=aHR0cHM6Ly9jb25zb2xlLnhmeXVuLmNuL3NlcnZpY2VzL2NibQ==">讯飞星火</a> 侧申请自己的大模型应用，并申请 Spark Lite 的无限 Token。记下 APPID、API_SECRET、API_KEY、API_PASSWORD 关键信息。</p> <p><img src="/image/loading.gif" data-lazy-src="https://cdn.gallery.uuanqin.top/img/202506242242844.webp" alt="image.png"></p> <p>打开 Vercel，创建对应的环境变量供后续使用：</p> <p><img src="/image/loading.gif" data-lazy-src="https://cdn.gallery.uuanqin.top/img/202506242243395.webp" alt="image.png"></p> <h3 id="使用-vercel-中的-redis-集成服务"><a class="markdownIt-Anchor" href="#使用-vercel-中的-redis-集成服务"></a> 使用 Vercel 中的 Redis 集成服务</h3> <p>Redis 服务可以自己另外部署，且还能有更高的灵活性。本文介绍的是 Vercel 中的 Redis 集成组件。</p> <p>在 Vercel 中，可以使用 Redis 集成组件：</p> <p><img src="/image/loading.gif" data-lazy-src="https://cdn.gallery.uuanqin.top/img/202506230054761.webp" alt="image.png"></p> <p>选择 Redis：</p> <p><img src="/image/loading.gif" data-lazy-src="https://cdn.gallery.uuanqin.top/img/202506230054574.webp" alt="image.png"></p> <p>Vercel 免费用户（Hobby 计划）可以建一个 30MB 的，假设每篇摘要 200 字左右，这些空间可以应付上万篇文章摘要的需求，对于个人博客开发者来说完全够用。</p> <p>将 Redis 关联到 Vercel 对应的项目中，这样项目中就会多出一条环境变量——Redis 服务的地址。</p> <p><img src="/image/loading.gif" data-lazy-src="https://cdn.gallery.uuanqin.top/img/202506242235748.webp" alt="image.png"></p> <p>如果详看环境变量信息，除了在 Vercel 网站上看之外，还可以直接下载到代码仓中：</p> <figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm i -g vercel <span class="comment"># 如果没安装 vercel CLI</span></span><br><span class="line">vercel <span class="built_in">env</span> pull .env.development.local <span class="comment"># 拉取环境变量信息</span></span><br></pre></td></tr></tbody></table></figure> <p>使用 Redis 服务是记得安装好相应的包：<code>npm install redis</code>。并将生成的 <code>package.json</code> 以及 <code>package-lock.json</code> 一并加入到代码仓的版本管理中。</p> <h2 id="安装-api-插件"><a class="markdownIt-Anchor" href="#安装-api-插件"></a> 安装 API 插件</h2> <p>插件是在 Hexo 插件列表找的，基本符合我的要求。安装这个插件并根据自己的情况配置即可：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/wherewhere/hexo-generator-apis">wherewhere/hexo-generator-apis: Generate restful json data for Hexo plugins</a></p> <p>通过 <code>/api/posts/{path}.json</code> 请求可以得到文章元信息，里面有文章全文数据。Hexo 博客部署后，你可以尝试一下调用这个 API。</p> <h1 id="代码文件"><a class="markdownIt-Anchor" href="#代码文件"></a> 代码文件</h1> <h2 id="ai-summaryjs"><a class="markdownIt-Anchor" href="#ai-summaryjs"></a> <code>ai-summary.js</code></h2> <figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义样式常量 - 便于集中管理和修改</span></span><br><span class="line"><span class="keyword">const</span> <span class="constant_ variable">LEFT_STYLE</span> = <span class="string">"color: #fadfa3; background: #030307; padding:5px 0;"</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="constant_ variable">RIGHT_STYLE</span> = <span class="string">"background: #fadfa3; padding:5px 0;"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构建消息模板 - 使用多行模板字符串保持视觉结构</span></span><br><span class="line"><span class="keyword">const</span> <span class="constant_ variable">MESSAGE_TEMPLATE</span> = <span class="string">`</span></span><br><span class="line"><span class="string"> %c Spark Lite 文章摘要AI生成 %c https://uuanqin.top/ </span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="constant_ variable">PROXY_API_URL</span> = <span class="string">"https://ai-summary.uuanqin.top/api/ai-summary/spark-lite"</span>; <span class="comment">// 这里填的是 Vercel 的地址</span></span><br><span class="line"><span class="keyword">const</span> <span class="constant_ variable">LINK_AI_ABOUT</span> = <span class="string">"https://blog.uuanqin.top/p/75efe9f3/"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出格式化控制台消息</span></span><br><span class="line"><span class="language_ variable">console</span>.<span class="function_ title">log</span>(</span><br><span class="line">    <span class="constant_ variable">MESSAGE_TEMPLATE</span>,</span><br><span class="line">    <span class="constant_ variable">LEFT_STYLE</span>,</span><br><span class="line">    <span class="constant_ variable">RIGHT_STYLE</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 其他配置 (根据需要调整) ---</span></span><br><span class="line"><span class="keyword">const</span> sparkLite_postSelector = <span class="string">"#article-container"</span>; <span class="comment">// 文章内容容器的选择器，例如 #article-container, .post-content</span></span><br><span class="line"><span class="keyword">const</span> sparkLite_wordLimit = <span class="number">1000</span>;             <span class="comment">// 提交给 API 的最大字数限制</span></span><br><span class="line"><span class="keyword">const</span> sparkLite_typingAnimate = <span class="literal">true</span>;         <span class="comment">// 是否启用打字机效果</span></span><br><span class="line"><span class="comment">// 指定博客文章URL类型，只在这样的界面上生成ai摘要</span></span><br><span class="line"><span class="comment">// 通配符写法</span></span><br><span class="line"><span class="keyword">const</span> sparkLite_postURLs = [</span><br><span class="line">    <span class="comment">// "https://*.uuanqin.top/p/*",</span></span><br><span class="line">    <span class="comment">// "http://localhost:*/p/*"</span></span><br><span class="line">];</span><br><span class="line"><span class="comment">// 正则写法</span></span><br><span class="line"><span class="keyword">const</span> sparkLite_postURLs_regex = [</span><br><span class="line">    <span class="regexp">/^https:\/\/.*\.uuanqin\.top\/p\/[0-9a-fA-F]+\/$/</span>,</span><br><span class="line">    <span class="regexp">/^http:\/\/localhost:4000\/p\/[0-9a-fA-F]+\/$/</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="constant_ variable">MILLISECONDS_OF_A_WEEK</span> = <span class="number">7</span> * <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sparkLite_localCacheTime = <span class="constant_ variable">MILLISECONDS_OF_A_WEEK</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="function_ title">initDB</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="class_ title">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> {</span><br><span class="line">        <span class="keyword">const</span> request = indexedDB.<span class="function_ title">open</span>(<span class="string">'SparkLiteDB'</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        request.<span class="property">onupgradeneeded</span> = <span class="function">(<span class="params">e</span>) =&gt;</span> {</span><br><span class="line">            <span class="keyword">const</span> db = e.<span class="property">target</span>.<span class="property">result</span>;</span><br><span class="line">            <span class="keyword">if</span> (!db.<span class="property">objectStoreNames</span>.<span class="function_ title">contains</span>(<span class="string">'summaries'</span>)) {</span><br><span class="line">                <span class="keyword">const</span> store = db.<span class="function_ title">createObjectStore</span>(<span class="string">'summaries'</span>, {<span class="attr">keyPath</span>: <span class="string">'url'</span>});</span><br><span class="line">                store.<span class="function_ title">createIndex</span>(<span class="string">'timestamp'</span>, <span class="string">'timestamp'</span>, {<span class="attr">unique</span>: <span class="literal">false</span>});</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line"></span><br><span class="line">        request.<span class="property">onsuccess</span> = <span class="function">(<span class="params">e</span>) =&gt;</span> <span class="function_ title">resolve</span>(e.<span class="property">target</span>.<span class="property">result</span>);</span><br><span class="line">        request.<span class="property">onerror</span> = <span class="function">(<span class="params">e</span>) =&gt;</span> <span class="function_ title">reject</span>(e.<span class="property">target</span>.<span class="property">error</span>);</span><br><span class="line">    });</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> sparkLiteIsRunning = <span class="literal">false</span>; <span class="comment">// 重命名</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// --- insertAIDiv 函数 ---</span></span><br><span class="line"><span class="keyword">function</span> <span class="function_ title">insertAIDiv</span>(<span class="params">selector</span>) {</span><br><span class="line">    <span class="comment">// 首先移除现有的 "post-SparkLite" 类元素（如果有的话）</span></span><br><span class="line">    <span class="function_ title">removeExistingAIDiv</span>(); <span class="comment">// 需要同步修改 removeExistingAIDiv 函数选择器</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取目标元素</span></span><br><span class="line">    <span class="keyword">const</span> targetElement = <span class="language_ variable">document</span>.<span class="function_ title">querySelector</span>(selector);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果没有找到目标元素，不执行任何操作</span></span><br><span class="line">    <span class="keyword">if</span> (!targetElement) {</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建要插入的HTML元素</span></span><br><span class="line">    <span class="keyword">const</span> aiDiv = <span class="language_ variable">document</span>.<span class="function_ title">createElement</span>(<span class="string">'div'</span>);</span><br><span class="line">    aiDiv.<span class="property">className</span> = <span class="string">'post-SparkLite'</span>; <span class="comment">// 修改类名</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> aiTitleDiv = <span class="language_ variable">document</span>.<span class="function_ title">createElement</span>(<span class="string">'div'</span>);</span><br><span class="line">    aiTitleDiv.<span class="property">className</span> = <span class="string">'sparkLite-title'</span>; <span class="comment">// 修改类名</span></span><br><span class="line">    aiDiv.<span class="function_ title">appendChild</span>(aiTitleDiv);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> aiIcon = <span class="language_ variable">document</span>.<span class="function_ title">createElement</span>(<span class="string">'i'</span>);</span><br><span class="line">    aiIcon.<span class="property">className</span> = <span class="string">'sparkLite-title-icon'</span>; <span class="comment">// 修改类名</span></span><br><span class="line">    aiTitleDiv.<span class="function_ title">appendChild</span>(aiIcon);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 插入 SVG 图标 (保持不变或替换)</span></span><br><span class="line">    aiIcon.<span class="property">innerHTML</span> = <span class="string">`&lt;svg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' width='48px' height='48px' viewBox='0 0 48 48'&gt;</span></span><br><span class="line"><span class="string">  &lt;title&gt;机器人&lt;/title&gt;</span></span><br><span class="line"><span class="string">  &lt;g id='机器人' stroke='none' stroke-width='1' fill='none' fill-rule='evenodd'&gt;</span></span><br><span class="line"><span class="string">    &lt;path d='M34.717885,5.03561087 C36.12744,5.27055371 37.079755,6.60373651 36.84481,8.0132786 L35.7944,14.3153359 L38.375,14.3153359 C43.138415,14.3153359 47,18.1768855 47,22.9402569 L47,34.4401516 C47,39.203523 43.138415,43.0650727 38.375,43.0650727 L9.625,43.0650727 C4.861585,43.0650727 1,39.203523 1,34.4401516 L1,22.9402569 C1,18.1768855 4.861585,14.3153359 9.625,14.3153359 L12.2056,14.3153359 L11.15519,8.0132786 C10.920245,6.60373651 11.87256,5.27055371 13.282115,5.03561087 C14.69167,4.80066802 16.024865,5.7529743 16.25981,7.16251639 L17.40981,14.0624532 C17.423955,14.1470924 17.43373,14.2315017 17.43948,14.3153359 L30.56052,14.3153359 C30.56627,14.2313867 30.576045,14.1470924 30.59019,14.0624532 L31.74019,7.16251639 C31.975135,5.7529743 33.30833,4.80066802 34.717885,5.03561087 Z M38.375,19.4902885 L9.625,19.4902885 C7.719565,19.4902885 6.175,21.0348394 6.175,22.9402569 L6.175,34.4401516 C6.175,36.3455692 7.719565,37.89012 9.625,37.89012 L38.375,37.89012 C40.280435,37.89012 41.825,36.3455692 41.825,34.4401516 L41.825,22.9402569 C41.825,21.0348394 40.280435,19.4902885 38.375,19.4902885 Z M14.8575,23.802749 C16.28649,23.802749 17.445,24.9612484 17.445,26.3902253 L17.445,28.6902043 C17.445,30.1191812 16.28649,31.2776806 14.8575,31.2776806 C13.42851,31.2776806 12.27,30.1191812 12.27,28.6902043 L12.27,26.3902253 C12.27,24.9612484 13.42851,23.802749 14.8575,23.802749 Z M33.1425,23.802749 C34.57149,23.802749 35.73,24.9612484 35.73,26.3902253 L35.73,28.6902043 C35.73,30.1191812 34.57149,31.2776806 33.1425,31.2776806 C31.71351,31.2776806 30.555,30.1191812 30.555,28.6902043 L30.555,26.3902253 C30.555,24.9612484 31.71351,23.802749 33.1425,23.802749 Z' id='形状结合' fill='#444444' fill-rule='nonzero'&gt;&lt;/path&gt;</span></span><br><span class="line"><span class="string">  &lt;/g&gt;</span></span><br><span class="line"><span class="string">  &lt;/svg&gt;`</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> aiTitleTextDiv = <span class="language_ variable">document</span>.<span class="function_ title">createElement</span>(<span class="string">'div'</span>);</span><br><span class="line">    aiTitleTextDiv.<span class="property">className</span> = <span class="string">'sparkLite-title-text'</span>; <span class="comment">// 修改类名</span></span><br><span class="line">    aiTitleTextDiv.<span class="property">textContent</span> = <span class="string">'AI 摘要'</span>;</span><br><span class="line">    aiTitleDiv.<span class="function_ title">appendChild</span>(aiTitleTextDiv);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> aiAboutLink = <span class="language_ variable">document</span>.<span class="function_ title">createElement</span>(<span class="string">'a'</span>);</span><br><span class="line">    aiAboutLink.<span class="property">href</span> = <span class="constant_ variable">LINK_AI_ABOUT</span>;</span><br><span class="line">    aiAboutLink.<span class="property">target</span> = <span class="string">'_blank'</span>; <span class="comment">// 可选：在新标签页打开</span></span><br><span class="line">    aiAboutLink.<span class="property">className</span> = <span class="string">'sparkLite-about'</span>; <span class="comment">// 修改类名</span></span><br><span class="line">    aiAboutLink.<span class="property">style</span>.<span class="property">color</span> = <span class="string">'var(--ai-summary-lighttext)'</span>; <span class="comment">// 内联样式防止覆写</span></span><br><span class="line">    aiAboutLink.<span class="property">id</span> = <span class="string">'sparkLite-about'</span>; <span class="comment">// 修改 ID</span></span><br><span class="line">    aiAboutLink.<span class="property">textContent</span> = <span class="string">'关于'</span>; <span class="comment">// 修改显示文本</span></span><br><span class="line">    aiTitleDiv.<span class="function_ title">appendChild</span>(aiAboutLink);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> aiTagDiv = <span class="language_ variable">document</span>.<span class="function_ title">createElement</span>(<span class="string">'div'</span>);</span><br><span class="line">    aiTagDiv.<span class="property">className</span> = <span class="string">'sparkLite-tag'</span>; <span class="comment">// 修改类名</span></span><br><span class="line">    aiTagDiv.<span class="property">id</span> = <span class="string">'sparkLite-tag'</span>; <span class="comment">// 修改 ID</span></span><br><span class="line">    aiTagDiv.<span class="property">textContent</span> = <span class="string">'Spark Lite'</span>; <span class="comment">// 修改显示文本</span></span><br><span class="line">    aiTitleDiv.<span class="function_ title">appendChild</span>(aiTagDiv);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> aiExplanationDiv = <span class="language_ variable">document</span>.<span class="function_ title">createElement</span>(<span class="string">'div'</span>);</span><br><span class="line">    aiExplanationDiv.<span class="property">className</span> = <span class="string">'sparkLite-explanation'</span>; <span class="comment">// 修改类名</span></span><br><span class="line">    aiExplanationDiv.<span class="property">innerHTML</span> = <span class="string">'生成中...'</span> + <span class="string">'&lt;span class="blinking-cursor"&gt;&lt;/span&gt;'</span>;</span><br><span class="line">    aiDiv.<span class="function_ title">appendChild</span>(aiExplanationDiv);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将创建的元素插入到目标元素的顶部</span></span><br><span class="line">    targetElement.<span class="function_ title">insertBefore</span>(aiDiv, targetElement.<span class="property">firstChild</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// --- removeExistingAIDiv 函数 ---</span></span><br><span class="line"><span class="keyword">function</span> <span class="function_ title">removeExistingAIDiv</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="comment">// 查找具有 "post-SparkLite" 类的元素</span></span><br><span class="line">    <span class="keyword">const</span> existingAIDiv = <span class="language_ variable">document</span>.<span class="function_ title">querySelector</span>(<span class="string">".post-SparkLite"</span>); <span class="comment">// 修改选择器</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果找到了这个元素，就从其父元素中删除它</span></span><br><span class="line">    <span class="keyword">if</span> (existingAIDiv) {</span><br><span class="line">        existingAIDiv.<span class="property">parentElement</span>.<span class="function_ title">removeChild</span>(existingAIDiv);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 主要逻辑对象 ---</span></span><br><span class="line"><span class="keyword">const</span> sparkLite = { <span class="comment">// 重命名对象</span></span><br><span class="line">    <span class="comment">// --- fetchSparkLiteSummary 函数 (核心修改) ---</span></span><br><span class="line">    <span class="attr">fetchSparkLiteSummary</span>: <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params"></span>) {</span><br><span class="line">        <span class="comment">// const title = document.title;</span></span><br><span class="line">        <span class="keyword">const</span> url = <span class="language_ variable">window</span>.<span class="property">location</span>.<span class="property">href</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 先尝试从IndexedDB读取</span></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">const</span> db = <span class="keyword">await</span> <span class="function_ title">initDB</span>();</span><br><span class="line">            <span class="keyword">const</span> tx = db.<span class="function_ title">transaction</span>(<span class="string">'summaries'</span>, <span class="string">'readonly'</span>);</span><br><span class="line">            <span class="keyword">const</span> store = tx.<span class="function_ title">objectStore</span>(<span class="string">'summaries'</span>);</span><br><span class="line">            <span class="keyword">const</span> request = store.<span class="function_ title">get</span>(url);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> cachedData = <span class="keyword">await</span> <span class="keyword">new</span> <span class="class_ title">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> {</span><br><span class="line">                request.<span class="property">onsuccess</span> = <span class="function">() =&gt;</span> <span class="function_ title">resolve</span>(request.<span class="property">result</span>);</span><br><span class="line">                request.<span class="property">onerror</span> = <span class="function">() =&gt;</span> <span class="function_ title">resolve</span>(<span class="literal">null</span>);</span><br><span class="line">            });</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cachedData?.<span class="property">summary</span>) {</span><br><span class="line">                <span class="comment">// 检查缓存是否过期（7天有效期）</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">const</span> isExpired = <span class="class_ title">Date</span>.<span class="function_ title">now</span>() - cachedData.<span class="property">timestamp</span> &gt; sparkLite_localCacheTime;</span><br><span class="line">                <span class="keyword">if</span> (!isExpired) {</span><br><span class="line">                    <span class="keyword">return</span> cachedData.<span class="property">summary</span>;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">catch</span> (e) {</span><br><span class="line">            <span class="language_ variable">console</span>.<span class="function_ title">log</span>(<span class="string">'【AI 摘要前端】读取 IndexedDB 缓存失败'</span>, e);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> requestDataToProxy = {<span class="attr">post_url</span>: url};<span class="comment">// {content: content, title: title};</span></span><br><span class="line">        <span class="keyword">const</span> timeout = <span class="number">30000</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">const</span> controller = <span class="keyword">new</span> <span class="class_ title">AbortController</span>();</span><br><span class="line">            <span class="keyword">const</span> timeoutId = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> controller.<span class="function_ title">abort</span>(), timeout);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="function_ title">fetch</span>(<span class="constant_ variable">PROXY_API_URL</span>, {</span><br><span class="line">                <span class="attr">method</span>: <span class="string">'POST'</span>,</span><br><span class="line">                <span class="attr">headers</span>: {<span class="string">'Content-Type'</span>: <span class="string">'application/json'</span>},</span><br><span class="line">                <span class="attr">body</span>: <span class="class_ title">JSON</span>.<span class="function_ title">stringify</span>(requestDataToProxy),</span><br><span class="line">                <span class="attr">signal</span>: controller.<span class="property">signal</span></span><br><span class="line">            });</span><br><span class="line"></span><br><span class="line">            <span class="built_in">clearTimeout</span>(timeoutId);</span><br><span class="line">            <span class="keyword">const</span> data = <span class="keyword">await</span> response.<span class="function_ title">json</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (response.<span class="property">ok</span>) {</span><br><span class="line">                <span class="comment">// 成功获取摘要后存入IndexedDB</span></span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    <span class="keyword">const</span> db = <span class="keyword">await</span> <span class="function_ title">initDB</span>();</span><br><span class="line">                    <span class="keyword">const</span> tx = db.<span class="function_ title">transaction</span>(<span class="string">'summaries'</span>, <span class="string">'readwrite'</span>);</span><br><span class="line">                    tx.<span class="function_ title">objectStore</span>(<span class="string">'summaries'</span>).<span class="function_ title">put</span>({</span><br><span class="line">                        <span class="attr">url</span>: url,</span><br><span class="line">                        <span class="attr">summary</span>: data.<span class="property">summary</span>,</span><br><span class="line">                        <span class="attr">timestamp</span>: <span class="class_ title">Date</span>.<span class="function_ title">now</span>()</span><br><span class="line">                    });</span><br><span class="line">                } <span class="keyword">catch</span> (e) {</span><br><span class="line">                    <span class="language_ variable">console</span>.<span class="function_ title">log</span>(<span class="string">'【AI 摘要前端】IndexedDB 写入失败'</span>, e);</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">return</span> data.<span class="property">summary</span>;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="language_ variable">console</span>.<span class="function_ title">error</span>(<span class="string">`【AI 摘要前端】代理或 API 错误: <span class="subst">${data.error || response.statusText}</span>`</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">`【AI 摘要前端】获取摘要失败: <span class="subst">${data.error || <span class="string">`HTTP 状态码: <span class="subst">${response.status}</span>`</span>}</span>`</span>;</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">catch</span> (error) {</span><br><span class="line">            <span class="keyword">if</span> (error.<span class="property">name</span> === <span class="string">'AbortError'</span>) {</span><br><span class="line">                <span class="language_ variable">console</span>.<span class="function_ title">error</span>(<span class="string">'【AI 摘要前端】Spark Lite 请求超时 (通过代理)'</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'【AI 摘要前端】获取文章摘要超时，请稍后刷新重试。'</span>;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="language_ variable">console</span>.<span class="function_ title">error</span>(<span class="string">'【AI 摘要前端】Spark Lite 请求失败 (通过代理)：'</span>, error);</span><br><span class="line">                <span class="keyword">if</span> (error <span class="keyword">instanceof</span> <span class="class_ title">SyntaxError</span>) {</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">'【AI 摘要前端】获取文章摘要失败：代理服务器响应格式错误。'</span>;</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'【AI 摘要前端】获取文章摘要失败，请检查网络连接或代理服务器状态。'</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    },</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --- aiShowAnimation 函数 ---</span></span><br><span class="line">    <span class="comment">// 可以修改 console.error 和 element.innerHTML 中的 "TianliGPT" 为 "Spark Lite"</span></span><br><span class="line">    <span class="attr">aiShowAnimation</span>: <span class="keyword">function</span> (<span class="params">text</span>) {</span><br><span class="line">        <span class="keyword">const</span> element = <span class="language_ variable">document</span>.<span class="function_ title">querySelector</span>(<span class="string">".sparkLite-explanation"</span>); <span class="comment">// 修改选择器</span></span><br><span class="line">        <span class="keyword">if</span> (!element) {</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sparkLiteIsRunning) { <span class="comment">// 修改变量名</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查用户是否已定义 sparkLite_typingAnimate</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> sparkLite_typingAnimate !== <span class="string">"undefined"</span> &amp;&amp; !sparkLite_typingAnimate) { <span class="comment">// 修改变量名</span></span><br><span class="line">            element.<span class="property">innerHTML</span> = text;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        sparkLiteIsRunning = <span class="literal">true</span>; <span class="comment">// 修改变量名</span></span><br><span class="line">        <span class="keyword">const</span> typingDelay = <span class="number">25</span>;</span><br><span class="line">        <span class="keyword">const</span> waitingTime = <span class="number">1000</span>;</span><br><span class="line">        <span class="keyword">const</span> punctuationDelayMultiplier = <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line">        element.<span class="property">style</span>.<span class="property">display</span> = <span class="string">"block"</span>;</span><br><span class="line">        element.<span class="property">innerHTML</span> = <span class="string">`生成中...&lt;span class='blinking-cursor'&gt;&lt;/span&gt;`</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> animationRunning = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">let</span> currentIndex = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">let</span> initialAnimation = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">let</span> lastUpdateTime = performance.<span class="function_ title">now</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> <span class="function_ title">animate</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">            <span class="keyword">if</span> (currentIndex &lt; text.<span class="property">length</span> &amp;&amp; animationRunning) {</span><br><span class="line">                <span class="keyword">const</span> currentTime = performance.<span class="function_ title">now</span>();</span><br><span class="line">                <span class="keyword">const</span> timeDiff = currentTime - lastUpdateTime;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">const</span> letter = text.<span class="function_ title">slice</span>(currentIndex, currentIndex + <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">const</span> isPunctuation = <span class="regexp">/[，。！、？,.!?]/</span>.<span class="function_ title">test</span>(letter);</span><br><span class="line">                <span class="keyword">const</span> delay = isPunctuation ? typingDelay * punctuationDelayMultiplier : typingDelay;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (timeDiff &gt;= delay) {</span><br><span class="line">                    element.<span class="property">innerText</span> = text.<span class="function_ title">slice</span>(<span class="number">0</span>, currentIndex + <span class="number">1</span>);</span><br><span class="line">                    lastUpdateTime = currentTime;</span><br><span class="line">                    currentIndex++;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (currentIndex &lt; text.<span class="property">length</span>) {</span><br><span class="line">                        element.<span class="property">innerHTML</span> =</span><br><span class="line">                            text.<span class="function_ title">slice</span>(<span class="number">0</span>, currentIndex) +</span><br><span class="line">                            <span class="string">'&lt;span class="blinking-cursor"&gt;&lt;/span&gt;'</span>;</span><br><span class="line">                    } <span class="keyword">else</span> {</span><br><span class="line">                        element.<span class="property">innerHTML</span> = text;</span><br><span class="line">                        element.<span class="property">style</span>.<span class="property">display</span> = <span class="string">"block"</span>;</span><br><span class="line">                        sparkLiteIsRunning = <span class="literal">false</span>; <span class="comment">// 修改变量名</span></span><br><span class="line">                        observer.<span class="function_ title">disconnect</span>();<span class="comment">// 暂停监听</span></span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">                <span class="function_ title">requestAnimationFrame</span>(animate);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用IntersectionObserver对象优化ai离开视口后暂停的业务逻辑，提高性能</span></span><br><span class="line">        <span class="keyword">const</span> observer = <span class="keyword">new</span> <span class="class_ title">IntersectionObserver</span>(<span class="function">(<span class="params">entries</span>) =&gt;</span> {</span><br><span class="line">            animationRunning = entries[<span class="number">0</span>].<span class="property">isIntersecting</span>; <span class="comment">// 标志变量更新</span></span><br><span class="line">            <span class="keyword">if</span> (animationRunning &amp;&amp; initialAnimation) {</span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">                    <span class="function_ title">requestAnimationFrame</span>(animate);</span><br><span class="line">                }, <span class="number">200</span>);</span><br><span class="line">            }</span><br><span class="line">        }, {<span class="attr">threshold</span>: <span class="number">0</span>});</span><br><span class="line">        <span class="keyword">let</span> post_ai = <span class="language_ variable">document</span>.<span class="function_ title">querySelector</span>(<span class="string">'.post-SparkLite'</span>); <span class="comment">// 修改选择器</span></span><br><span class="line">        observer.<span class="function_ title">observe</span>(post_ai);<span class="comment">//启动新监听</span></span><br><span class="line">    },</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// --- runSparkLite 函数 (保持不变) ---</span></span><br><span class="line"><span class="keyword">function</span> <span class="function_ title">runSparkLite</span>(<span class="params"></span>) { <span class="comment">// 重命名函数</span></span><br><span class="line">    <span class="comment">// 确保在运行前移除可能存在的旧div，防止重复添加</span></span><br><span class="line">    <span class="function_ title">removeExistingAIDiv</span>();</span><br><span class="line">    <span class="comment">// 插入新的占位符</span></span><br><span class="line">    <span class="function_ title">insertAIDiv</span>(sparkLite_postSelector);</span><br><span class="line">    <span class="comment">// const content = sparkLite.getTitleAndContent(); // 调用重命名后的对象和方法</span></span><br><span class="line">    <span class="comment">// if (content) {</span></span><br><span class="line">    <span class="comment">//     // console.log('Spark Lite 本次提交的内容为：' + content); // 修改日志文本</span></span><br><span class="line">    <span class="comment">// } else {</span></span><br><span class="line">    <span class="comment">//     // 如果没有获取到内容，可能需要移除占位符或显示错误</span></span><br><span class="line">    <span class="comment">//     const aiExplanationDiv = document.querySelector(".sparkLite-explanation");</span></span><br><span class="line">    <span class="comment">//     if (aiExplanationDiv) {</span></span><br><span class="line">    <span class="comment">//         aiExplanationDiv.textContent = '未能获取到文章内容，无法生成摘要。';</span></span><br><span class="line">    <span class="comment">//     }</span></span><br><span class="line">    <span class="comment">//     return; // 提前退出，不进行 fetch</span></span><br><span class="line">    <span class="comment">// }</span></span><br><span class="line">    sparkLite.<span class="function_ title">fetchSparkLiteSummary</span>().<span class="function_ title">then</span>(<span class="function"><span class="params">summary</span> =&gt;</span> { <span class="comment">// 调用重命名后的方法</span></span><br><span class="line">        sparkLite.<span class="function_ title">aiShowAnimation</span>(summary); <span class="comment">// 调用重命名后的方法</span></span><br><span class="line">    });</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// --- checkURLAndRun 函数 (稍微调整，主要负责URL检查) ---</span></span><br><span class="line"><span class="keyword">function</span> <span class="function_ title">checkURLAndRun</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="comment">// 检查 AI 是否已在运行，防止重复启动动画等</span></span><br><span class="line">    <span class="keyword">if</span> (sparkLiteIsRunning) {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 返回 false 表示不应继续执行</span></span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 检查 AI 容器是否已存在 (如果存在，理论上不应再次运行完整流程，除非是内容更新)</span></span><br><span class="line">    <span class="comment">// 为简化逻辑，我们允许它继续，runSparkLite内部会处理移除和重新插入</span></span><br><span class="line">    <span class="comment">// if (document.querySelector(".post-SparkLite")) {</span></span><br><span class="line">    <span class="comment">//     return false;</span></span><br><span class="line">    <span class="comment">// }</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// URL 检查逻辑</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> sparkLite_postURLs === <span class="string">"undefined"</span> &amp;&amp; <span class="keyword">typeof</span> sparkLite_postURLs_regex === <span class="string">"undefined"</span>) {</span><br><span class="line">        <span class="language_ variable">console</span>.<span class="function_ title">log</span>(<span class="string">"【AI 摘要前端】没有设置页面链接模板，所以我为每个页面都生成ai摘要."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// 返回 true 表示检查通过，可以运行</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">const</span> <span class="function_ title">regExpEscape</span> = (<span class="params">s</span>) =&gt; {</span><br><span class="line">            <span class="keyword">return</span> s.<span class="function_ title">replace</span>(<span class="regexp">/[|\\{}()[\]^$+*?.]/g</span>, <span class="string">'\\$&amp;'</span>);</span><br><span class="line">        };</span><br><span class="line">        <span class="keyword">const</span> <span class="function_ title">wildcardToRegExp</span> = (<span class="params">s</span>) =&gt; {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="class_ title">RegExp</span>(<span class="string">'^'</span> + s.<span class="function_ title">split</span>(<span class="regexp">/\*+/</span>).<span class="function_ title">map</span>(regExpEscape).<span class="function_ title">join</span>(<span class="string">'.*'</span>) + <span class="string">'$'</span>);</span><br><span class="line">        };</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> currentURL = <span class="language_ variable">window</span>.<span class="property">location</span>.<span class="property">href</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> customPattern = sparkLite_postURLs.<span class="function_ title">map</span>(wildcardToRegExp);</span><br><span class="line">        <span class="keyword">const</span> urlPattern = [...customPattern, ...(sparkLite_postURLs_regex)];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 测试某个 URL 是否匹配任意一个规则</span></span><br><span class="line">        <span class="keyword">const</span> <span class="function_ title">testURL</span> = (<span class="params">url</span>) =&gt; {</span><br><span class="line">            <span class="keyword">return</span> urlPattern.<span class="function_ title">some</span>(<span class="function"><span class="params">re</span> =&gt;</span> re.<span class="function_ title">test</span>(url));</span><br><span class="line">        };</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="function_ title">testURL</span>(currentURL)) {</span><br><span class="line">            <span class="language_ variable">console</span>.<span class="function_ title">log</span>(<span class="string">"【AI 摘要前端】匹配到了页面URL，将在此页面生成摘要"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// URL匹配，检查通过</span></span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="language_ variable">console</span>.<span class="function_ title">log</span>(<span class="string">"【AI 摘要前端】因为不符合自定义的链接规则，我决定不执行摘要功能。"</span>);</span><br><span class="line">            <span class="function_ title">removeExistingAIDiv</span>(); <span class="comment">// 如果URL不匹配了，移除可能存在的旧AI框</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// URL不匹配，检查不通过</span></span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (error) {</span><br><span class="line">        <span class="language_ variable">console</span>.<span class="function_ title">error</span>(<span class="string">"【AI 摘要前端】我没有看懂你编写的自定义链接规则..."</span>, error);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 出错，检查不通过</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 新增：统一的初始化入口函数 ---</span></span><br><span class="line"><span class="keyword">function</span> <span class="function_ title">initializeSparkLite</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="comment">// 1. 检查文章容器是否存在</span></span><br><span class="line">    <span class="keyword">const</span> targetElement = <span class="language_ variable">document</span>.<span class="function_ title">querySelector</span>(sparkLite_postSelector);</span><br><span class="line">    <span class="keyword">if</span> (!targetElement) {</span><br><span class="line">        <span class="comment">// console.log("Spark Lite: Target post selector not found.");</span></span><br><span class="line">        <span class="function_ title">removeExistingAIDiv</span>(); <span class="comment">// 确保目标容器不在时，AI框也被移除</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 执行URL和运行状态检查</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="function_ title">checkURLAndRun</span>()) {</span><br><span class="line">        <span class="comment">// 3. 如果检查通过，执行核心逻辑</span></span><br><span class="line">        <span class="comment">// console.log("Spark Lite: Initialization checks passed, running...");</span></span><br><span class="line">        <span class="function_ title">runSparkLite</span>();</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// console.log("Spark Lite: Initialization checks failed (URL mismatch or already running).");</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// --- Event Listeners (使用新的初始化函数) ---</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 确保在移除旧监听器（如果可能）后添加新的</span></span><br><span class="line"><span class="comment">// （在简单脚本场景下通常不需要移除，但这是良好实践）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 增强路由变化监听 ---</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 保存原始的 pushState 和 replaceState 方法</span></span><br><span class="line"><span class="keyword">const</span> originalPushState = history.<span class="property">pushState</span>;</span><br><span class="line"><span class="keyword">const</span> originalReplaceState = history.<span class="property">replaceState</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 包装 pushState</span></span><br><span class="line">history.<span class="property">pushState</span> = <span class="keyword">function</span> (<span class="params"></span>) {</span><br><span class="line">    <span class="comment">// 调用原始方法</span></span><br><span class="line">    <span class="keyword">const</span> result = originalPushState.<span class="function_ title">apply</span>(<span class="language_ variable">this</span>, <span class="language_ variable">arguments</span>);</span><br><span class="line">    <span class="comment">// 创建并触发自定义事件，表明 URL 可能已更改</span></span><br><span class="line">    <span class="language_ variable">window</span>.<span class="function_ title">dispatchEvent</span>(<span class="keyword">new</span> <span class="class_ title">Event</span>(<span class="string">'pushstate'</span>));</span><br><span class="line">    <span class="comment">// 触发我们的初始化函数</span></span><br><span class="line">    <span class="comment">// 使用 setTimeout 确保在 DOM 更新后执行</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(initializeSparkLite, <span class="number">100</span>);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// 包装 replaceState</span></span><br><span class="line">history.<span class="property">replaceState</span> = <span class="keyword">function</span> (<span class="params"></span>) {</span><br><span class="line">    <span class="comment">// 调用原始方法</span></span><br><span class="line">    <span class="keyword">const</span> result = originalReplaceState.<span class="function_ title">apply</span>(<span class="language_ variable">this</span>, <span class="language_ variable">arguments</span>);</span><br><span class="line">    <span class="comment">// 创建并触发自定义事件，表明 URL 可能已更改</span></span><br><span class="line">    <span class="language_ variable">window</span>.<span class="function_ title">dispatchEvent</span>(<span class="keyword">new</span> <span class="class_ title">Event</span>(<span class="string">'replacestate'</span>));</span><br><span class="line">    <span class="comment">// 触发我们的初始化函数</span></span><br><span class="line">    <span class="comment">// 使用 setTimeout 确保在 DOM 更新后执行</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(initializeSparkLite, <span class="number">100</span>);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听 popstate 事件 (浏览器前进/后退按钮)</span></span><br><span class="line"><span class="language_ variable">window</span>.<span class="function_ title">addEventListener</span>(<span class="string">'popstate'</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="comment">// 触发我们的初始化函数</span></span><br><span class="line">    <span class="comment">// 使用 setTimeout 确保在 DOM 更新后执行</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(initializeSparkLite, <span class="number">100</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// --- (确保之前的事件监听器仍然存在) ---</span></span><br><span class="line"><span class="comment">// 初始加载</span></span><br><span class="line"><span class="language_ variable">document</span>.<span class="function_ title">removeEventListener</span>(<span class="string">"DOMContentLoaded"</span>, initializeSparkLite); <span class="comment">// 避免重复添加</span></span><br><span class="line"><span class="language_ variable">document</span>.<span class="function_ title">addEventListener</span>(<span class="string">"DOMContentLoaded"</span>, initializeSparkLite);</span><br></pre></td></tr></tbody></table></figure> <h2 id="ai-summarycss"><a class="markdownIt-Anchor" href="#ai-summarycss"></a> <code>ai-summary.css</code></h2> <figure class="css highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* AI 文章摘要样式框 */</span></span><br><span class="line"></span><br><span class="line"><span class="selector-pseudo">:root</span> {</span><br><span class="line">    <span class="comment">/* 主色调 */</span></span><br><span class="line">    <span class="attr">--ai-summary-main</span>: <span class="number">#5e72e4</span>; <span class="comment">/* 柔和的蓝色 */</span></span><br><span class="line">    <span class="attr">--ai-summary-secondbg</span>: <span class="number">#f8f9fa</span>; <span class="comment">/* 非常浅的灰色背景 */</span></span><br><span class="line">    <span class="attr">--ai-summary-card-bg</span>: <span class="number">#ffffff</span>; <span class="comment">/* 白色卡片背景 */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 文字颜色 */</span></span><br><span class="line">    <span class="attr">--ai-summary-fontcolor</span>: <span class="number">#2d3748</span>; <span class="comment">/* 深灰色文字 */</span></span><br><span class="line">    <span class="attr">--ai-summary-lighttext</span>: <span class="number">#718096</span>; <span class="comment">/* 中等灰色文字 */</span></span><br><span class="line">    <span class="attr">--ai-summary-white</span>: <span class="number">#ffffff</span>; <span class="comment">/* 纯白色 */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 边框样式 */</span></span><br><span class="line">    <span class="attr">--ai-summary-style-border-always</span>: <span class="number">0.0625rem</span> solid <span class="number">#e2e8f0</span>; <span class="comment">/* 浅灰色边框 (1px→0.0625rem) */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 悬停状态 */</span></span><br><span class="line">    <span class="attr">--ai-summary-hover</span>: <span class="number">#4c51bf</span>; <span class="comment">/* 深一点的蓝色用于悬停 */</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[data-theme=<span class="string">"dark"</span>]</span> {</span><br><span class="line">    <span class="comment">/* 主色调调整（降低饱和度，提高辨识度） */</span></span><br><span class="line">    <span class="attr">--ai-summary-main</span>: <span class="number">#7f9cf5</span>; <span class="comment">/* 夜间模式下更亮的蓝色，保持可读性 */</span></span><br><span class="line">    <span class="attr">--ai-summary-secondbg</span>: <span class="number">#1a202c</span>; <span class="comment">/* 深灰蓝背景（接近黑但不刺眼） */</span></span><br><span class="line">    <span class="attr">--ai-summary-card-bg</span>: <span class="number">#2d3748</span>; <span class="comment">/* 暗色卡片背景（对比度适中） */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 文字颜色调整（减少亮度，避免白光刺眼） */</span></span><br><span class="line">    <span class="attr">--ai-summary-fontcolor</span>: <span class="number">#e2e8f0</span>; <span class="comment">/* 浅灰白文字（确保可读性） */</span></span><br><span class="line">    <span class="attr">--ai-summary-lighttext</span>: <span class="number">#a0aec0</span>; <span class="comment">/* 中等灰文字（次要内容） */</span></span><br><span class="line">    <span class="attr">--ai-summary-white</span>: <span class="number">#ffffff</span>; <span class="comment">/* 纯白色保留（用于强调内容） */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 边框样式调整（暗色环境下更柔和） */</span></span><br><span class="line">    <span class="attr">--ai-summary-style-border-always</span>: <span class="number">0.0625rem</span> solid <span class="number">#4a5568</span>; <span class="comment">/* 深灰色边框 (1px→0.0625rem) */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 悬停状态调整（夜间模式下更明显） */</span></span><br><span class="line">    <span class="attr">--ai-summary-hover</span>: <span class="number">#667eea</span>; <span class="comment">/* 亮蓝色悬停效果 */</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.post-SparkLite</span> {</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--ai-summary-secondbg);</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">0.75rem</span>; <span class="comment">/* 12px→0.75rem */</span></span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0.75rem</span>; <span class="comment">/* 12px→0.75rem */</span></span><br><span class="line">    <span class="attribute">line-height</span>: <span class="number">1.3</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="built_in">var</span>(--ai-summary-style-border-always);</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">1rem</span> <span class="number">0</span>; <span class="comment">/* 16px→1rem */</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">max-width</span>: <span class="number">768px</span>) {</span><br><span class="line">    <span class="selector-class">.post-SparkLite</span> {</span><br><span class="line">        <span class="attribute">margin-top</span>: <span class="number">1.375rem</span>; <span class="comment">/* 22px→1.375rem */</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.sparkLite-title</span> {</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--ai-summary-lighttext);</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">0.5rem</span>; <span class="comment">/* 8px→0.5rem */</span></span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0.35rem</span>; <span class="comment">/* 0 12px→0 0.75rem */</span></span><br><span class="line">    <span class="attribute">cursor</span>: default;</span><br><span class="line">    user-<span class="selector-tag">select</span>: none;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.sparkLite-title-text</span> {</span><br><span class="line">    <span class="attribute">font-weight</span>: bold;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">0.5rem</span>; <span class="comment">/* 8px→0.5rem */</span></span><br><span class="line">    <span class="attribute">line-height</span>: <span class="number">1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.sparkLite-explanation</span> {</span><br><span class="line">    <span class="attribute">margin-top</span>: <span class="number">0.75rem</span>; <span class="comment">/* 12px→0.75rem */</span></span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0.5rem</span> <span class="number">0.75rem</span>; <span class="comment">/* 8px 12px→0.5rem 0.75rem */</span></span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--ai-summary-card-bg);</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">0.5rem</span>; <span class="comment">/* 8px→0.5rem */</span></span><br><span class="line">    <span class="attribute">border</span>: <span class="built_in">var</span>(--ai-summary-style-border-always);</span><br><span class="line">    <span class="comment">/*font-size: var(--global-font-size);*/</span></span><br><span class="line">    <span class="attribute">line-height</span>: <span class="number">1.4</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.sparkLite-tag</span> {</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.70rem</span>; <span class="comment">/* 12px→0.75rem */</span></span><br><span class="line">    <span class="attribute">background-color</span>: <span class="built_in">var</span>(--ai-summary-lighttext);</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--ai-summary-card-bg);</span><br><span class="line">    <span class="attribute">font-weight</span>: bold;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">0.25rem</span>; <span class="comment">/* 4px→0.25rem */</span></span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">0.75rem</span>;</span><br><span class="line">    <span class="attribute">line-height</span>: <span class="number">1</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0.25rem</span>; <span class="comment">/* 4px→0.25rem */</span></span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">transition</span>: <span class="number">0.3s</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.sparkLite-about</span> {</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.70rem</span>;</span><br><span class="line">    <span class="attribute">margin-left</span>: auto;</span><br><span class="line">    <span class="attribute">line-height</span>: <span class="number">1</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0.25rem</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">transition</span>: <span class="number">0.3s</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.sparkLite-title-icon</span> {</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">1.25rem</span>; <span class="comment">/* 20px→1.25rem */</span></span><br><span class="line">    <span class="attribute">height</span>: <span class="number">1.25rem</span>; <span class="comment">/* 20px→1.25rem */</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.sparkLite-title-icon</span> <span class="selector-tag">svg</span> {</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">1.25rem</span>; <span class="comment">/* 20px→1.25rem */</span></span><br><span class="line">    <span class="attribute">height</span>: <span class="number">1.25rem</span>; <span class="comment">/* 20px→1.25rem */</span></span><br><span class="line">    <span class="attribute">fill</span>: <span class="built_in">var</span>(--ai-summary-main);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.sparkLite-title-icon</span> <span class="selector-tag">svg</span> <span class="selector-tag">path</span> {</span><br><span class="line">    <span class="attribute">fill</span>: <span class="built_in">var</span>(--ai-summary-main);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure> <h2 id="spark-litejs"><a class="markdownIt-Anchor" href="#spark-litejs"></a> <code>spark-lite.js</code></h2> <figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    讯飞星火 API 文档：https://www.xfyun.cn/doc/spark/HTTP%E8%B0%83%E7%94%A8%E6%96%87%E6%A1%A3.html</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> getRedisClient <span class="keyword">from</span> <span class="string">'../../utils/redis'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 从环境变量读取敏感信息 ---</span></span><br><span class="line"><span class="keyword">const</span> <span class="constant_ variable">APPID</span> = process.<span class="property">env</span>.<span class="property">SPARK_APPID</span>; <span class="comment">// 可能仍需要</span></span><br><span class="line"><span class="keyword">const</span> <span class="constant_ variable">API_SECRET</span> = process.<span class="property">env</span>.<span class="property">SPARK_API_SECRET</span>; <span class="comment">// 用于新鉴权</span></span><br><span class="line"><span class="keyword">const</span> <span class="constant_ variable">API_KEY</span> = process.<span class="property">env</span>.<span class="property">SPARK_API_KEY</span>;       <span class="comment">// 用于新鉴权</span></span><br><span class="line"><span class="keyword">const</span> <span class="constant_ variable">API_PASSWORD</span> = process.<span class="property">env</span>.<span class="property">SPARK_API_PASSWORD</span>;       <span class="comment">// 用于新鉴权</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// --- Spark API 地址 (兼容 OpenAI 格式) ---</span></span><br><span class="line"><span class="keyword">const</span> <span class="constant_ variable">SPARK_API_URL</span> = <span class="string">"https://spark-api-open.xf-yun.com/v1/chat/completions"</span>;</span><br><span class="line"><span class="comment">// --- 确认 Lite 版或其他模型在新 API 中的标识符 ---</span></span><br><span class="line"><span class="keyword">const</span> <span class="constant_ variable">MODEL_NAME</span> = <span class="string">"lite"</span>; <span class="comment">// 请根据官方文档确认正确的模型名称</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="constant_ variable">SECONDS_OF_WEEK</span> = <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">7</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="constant_ variable">SYSTEM_PROMPT</span> = [</span><br><span class="line">    <span class="string">"你是一个严格遵循格式规则的摘要生成器。根据提供的文章内容，生成100-200字符的中文摘要，并严格遵守以下格式要求："</span>,</span><br><span class="line">    <span class="string">""</span>,</span><br><span class="line">    <span class="string">"## 核心规则（违反将导致任务失败）："</span>,</span><br><span class="line">    <span class="string">"1. 中英文/数字间必须添加空格！"</span>,</span><br><span class="line">    <span class="string">"   - 正确示例：'使用 Transformer 模型'"</span>,</span><br><span class="line">    <span class="string">"   - 正确示例：'在 2023 年发布的 GPT-4 模型'"</span>,</span><br><span class="line">    <span class="string">"   - 错误示例：'使用Transformer模型'（缺少空格）"</span>,</span><br><span class="line">    <span class="string">"   - 错误示例：'在2023年发布的GPT-4模型'（缺少空格）"</span>,</span><br><span class="line">    <span class="string">""</span>,</span><br><span class="line">    <span class="string">"2. 语言和格式要求："</span>,</span><br><span class="line">    <span class="string">"   - 仅使用中文（专业术语保留英文)"</span>,</span><br><span class="line">    <span class="string">"   - 绝对禁止 Markdown 符号：* _ \\ $ # 等"</span>,</span><br><span class="line">    <span class="string">"   - 第三人称客观叙述"</span>,</span><br><span class="line">    <span class="string">"   - 输出必须是完整句子"</span>,</span><br><span class="line">    <span class="string">""</span>,</span><br><span class="line">    <span class="string">"3. 长度控制："</span>,</span><br><span class="line">    <span class="string">"   - 严格控制在 100-200 个中文字符（约5-10句）"</span>,</span><br><span class="line">    <span class="string">""</span>,</span><br><span class="line">    <span class="string">"## 输出说明："</span>,</span><br><span class="line">    <span class="string">"直接输出摘要文本，不要任何额外说明。生成后必须人工检查："</span>,</span><br><span class="line">    <span class="string">"(1) 中英文间空格 (2) 无符号 (3) 纯文本"</span>,</span><br><span class="line">    <span class="string">"如发现违规，必须重新生成！"</span></span><br><span class="line">].<span class="function_ title">join</span>(<span class="string">'\n'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="function_ title">cleanText</span> = (<span class="params">htmlText, maxLength = <span class="number">2000</span></span>) =&gt; {</span><br><span class="line">    <span class="comment">// 合并多个替换操作</span></span><br><span class="line">    <span class="keyword">let</span> cleanedContent = htmlText</span><br><span class="line">        <span class="comment">// 1. 解码Unicode转义序列</span></span><br><span class="line">        .<span class="function_ title">replace</span>(<span class="regexp">/\\u([\dA-F]{4})/gi</span>, <span class="function">(<span class="params">_, code</span>) =&gt;</span></span><br><span class="line">            <span class="class_ title">String</span>.<span class="function_ title">fromCharCode</span>(<span class="built_in">parseInt</span>(code, <span class="number">16</span>)))</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 合并移除代码块、HTML标签、特定属性和callout块</span></span><br><span class="line">        .<span class="function_ title">replace</span>(</span><br><span class="line">            <span class="regexp">/&lt;code[\s\S]*?&lt;\/code&gt;|&lt;pre[\s\S]*?&lt;\/pre&gt;|&lt;div class="callout"[\s\S]*?&lt;\/div&gt;|&lt;img[^&gt;]*alt="([^"]*)"[^&gt;]*&gt;|&lt;[^&gt;]+&gt;|\b(data-[\w-]+|class|id|style|xmlns|viewBox|fill|stroke-width)="[^"]*"/gi</span>,</span><br><span class="line">            <span class="function">(<span class="params">match, altText</span>) =&gt;</span> altText ? altText : <span class="string">' '</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 处理Markdown链接（支持嵌套格式）</span></span><br><span class="line">        .<span class="function_ title">replace</span>(<span class="regexp">/\[([^\]]+)\]\([^)]+\)/g</span>, <span class="function">(<span class="params">_, text</span>) =&gt;</span></span><br><span class="line">            text.<span class="function_ title">replace</span>(<span class="regexp">/\*\*([^*]+)\*\*|__([^_]+)__|\*([^*]+)\*|_([^_]+)_/g</span>, <span class="string">'$1$2$3$4'</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 压缩空白字符</span></span><br><span class="line">        .<span class="function_ title">replace</span>(<span class="regexp">/\s+/g</span>, <span class="string">' '</span>)</span><br><span class="line">        .<span class="function_ title">replace</span>(<span class="regexp">/^ | $/g</span>, <span class="string">''</span>)</span><br><span class="line">        .<span class="function_ title">trim</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 截断优化</span></span><br><span class="line">    <span class="keyword">if</span> (cleanedContent.<span class="property">length</span> &lt;= maxLength) <span class="keyword">return</span> cleanedContent;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查找句子结束位置（优化版）</span></span><br><span class="line">    <span class="keyword">const</span> lastSentenceIndex = cleanedContent</span><br><span class="line">        .<span class="function_ title">substring</span>(<span class="number">0</span>, maxLength)</span><br><span class="line">        .<span class="function_ title">search</span>(<span class="regexp">/[.!?。！？](?=\s|$)/</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> truncIndex = lastSentenceIndex &gt; <span class="number">0</span> &amp;&amp; lastSentenceIndex &gt; maxLength - <span class="number">150</span> ?</span><br><span class="line">        lastSentenceIndex + <span class="number">1</span> :</span><br><span class="line">        <span class="class_ title">Math</span>.<span class="function_ title">min</span>(maxLength, cleanedContent.<span class="property">length</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> summary = cleanedContent.<span class="function_ title">substring</span>(<span class="number">0</span>, truncIndex);</span><br><span class="line">    <span class="keyword">return</span> summary + (truncIndex &lt; cleanedContent.<span class="property">length</span> ? <span class="string">'...'</span> : <span class="string">''</span>);</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="function_ title">extractUrlPath</span> = (<span class="params">urlString</span>) =&gt; {</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">const</span> url = <span class="keyword">new</span> <span class="function_ title">URL</span>(urlString);</span><br><span class="line">        <span class="comment">// 获取路径名（包含开头斜杠和可能的结尾斜杠）</span></span><br><span class="line">        <span class="keyword">let</span> path = url.<span class="property">pathname</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 移除开头和结尾的斜杠（如果存在）</span></span><br><span class="line">        path = path.<span class="function_ title">replace</span>(<span class="regexp">/^\/|\/$/g</span>, <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line">    } <span class="keyword">catch</span> (e) {</span><br><span class="line">        <span class="language_ variable">console</span>.<span class="function_ title">error</span>(<span class="string">"【服务端】无效的URL:"</span>, e);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 常量定义</span></span><br><span class="line"><span class="keyword">const</span> <span class="constant_ variable">HTTP_METHODS</span> = {</span><br><span class="line">    <span class="attr">POST</span>: <span class="string">'POST'</span>,</span><br><span class="line">    <span class="attr">OPTIONS</span>: <span class="string">'OPTIONS'</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="constant_ variable">ERROR_MESSAGES</span> = {</span><br><span class="line">    <span class="attr">MISSING_ENV</span>: <span class="string">'【服务端】内部错误：API凭证未配置'</span>,</span><br><span class="line">    <span class="attr">MISSING_URL</span>: <span class="string">'【服务端】请求体缺少 \'post_url\' 字段'</span>,</span><br><span class="line">    <span class="attr">BLOG_API_FAILURE</span>: <span class="string">'【服务端】获取文章元数据失败'</span>,</span><br><span class="line">    <span class="attr">BLOG_NOT_FOUND</span>: <span class="string">'【服务端】blog api 找不到文章的元数据'</span>,</span><br><span class="line">    <span class="attr">SPARK_CONNECTION_FAILED</span>: <span class="string">'【服务端】代理服务器未能连接到 Spark API'</span>,</span><br><span class="line">    <span class="attr">SPARK_RESPONSE_ERROR</span>: <span class="string">'【服务端】未能从 Spark 获取有效摘要内容'</span>,</span><br><span class="line">    <span class="attr">INVALID_METHOD</span>: <span class="function">(<span class="params">method</span>) =&gt;</span> <span class="string">`【服务端】Method <span class="subst">${method}</span> Not Allowed`</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="constant_ variable">CORS_HEADERS</span> = {</span><br><span class="line">    <span class="string">'Access-Control-Allow-Origin'</span>: <span class="string">'*'</span>,</span><br><span class="line">    <span class="string">'Access-Control-Allow-Methods'</span>: <span class="string">'POST, OPTIONS'</span>,</span><br><span class="line">    <span class="string">'Access-Control-Allow-Headers'</span>: <span class="string">'Content-Type, Authorization'</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// 主处理函数</span></span><br><span class="line"><span class="language_ variable">module</span>.<span class="property">exports</span> = <span class="function_ title">async</span> (req, res) =&gt; {</span><br><span class="line">    <span class="function_ title">setCorsHeaders</span>(res);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">method</span> === <span class="constant_ variable">HTTP_METHODS</span>.<span class="property">OPTIONS</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="function_ title">handleOptionsRequest</span>(res);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">method</span> === <span class="constant_ variable">HTTP_METHODS</span>.<span class="property">POST</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="function_ title">handlePostRequest</span>(req, res);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function_ title">handleInvalidMethod</span>(req, res);</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置CORS头</span></span><br><span class="line"><span class="keyword">function</span> <span class="function_ title">setCorsHeaders</span>(<span class="params">res</span>) {</span><br><span class="line">    <span class="class_ title">Object</span>.<span class="function_ title">entries</span>(<span class="constant_ variable">CORS_HEADERS</span>).<span class="function_ title">forEach</span>(<span class="function">(<span class="params">[key, value]</span>) =&gt;</span> {</span><br><span class="line">        res.<span class="function_ title">setHeader</span>(key, value);</span><br><span class="line">    });</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理OPTIONS请求</span></span><br><span class="line"><span class="keyword">function</span> <span class="function_ title">handleOptionsRequest</span>(<span class="params">res</span>) {</span><br><span class="line">    <span class="keyword">return</span> res.<span class="function_ title">status</span>(<span class="number">200</span>).<span class="function_ title">end</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理无效方法</span></span><br><span class="line"><span class="keyword">function</span> <span class="function_ title">handleInvalidMethod</span>(<span class="params">req, res</span>) {</span><br><span class="line">    res.<span class="function_ title">setHeader</span>(<span class="string">'Allow'</span>, [<span class="constant_ variable">HTTP_METHODS</span>.<span class="property">POST</span>, <span class="constant_ variable">HTTP_METHODS</span>.<span class="property">OPTIONS</span>]);</span><br><span class="line">    <span class="keyword">return</span> res.<span class="function_ title">status</span>(<span class="number">405</span>).<span class="function_ title">end</span>(<span class="constant_ variable">ERROR_MESSAGES</span>.<span class="function_ title">INVALID_METHOD</span>(req.<span class="property">method</span>));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理POST请求</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="function_ title">handlePostRequest</span>(<span class="params">req, res</span>) {</span><br><span class="line">    <span class="comment">// 验证环境变量</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="function_ title">validateEnvironmentVariables</span>()) {</span><br><span class="line">        <span class="language_ variable">console</span>.<span class="function_ title">error</span>(<span class="string">"Server Error: Spark environment variables not configured."</span>);</span><br><span class="line">        <span class="keyword">return</span> res.<span class="function_ title">status</span>(<span class="number">500</span>).<span class="function_ title">json</span>({ <span class="attr">error</span>: <span class="constant_ variable">ERROR_MESSAGES</span>.<span class="property">MISSING_ENV</span> });</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">const</span> { post_url } = req.<span class="property">body</span>;</span><br><span class="line">        <span class="keyword">if</span> (!post_url) {</span><br><span class="line">            <span class="keyword">return</span> res.<span class="function_ title">status</span>(<span class="number">400</span>).<span class="function_ title">json</span>({ <span class="attr">error</span>: <span class="constant_ variable">ERROR_MESSAGES</span>.<span class="property">MISSING_URL</span> });</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> post_path = <span class="function_ title">extractUrlPath</span>(post_url);</span><br><span class="line">        <span class="keyword">const</span> cachedSummary = <span class="keyword">await</span> <span class="function_ title">checkRedisCache</span>(post_path);</span><br><span class="line">        <span class="keyword">if</span> (cachedSummary) {</span><br><span class="line">            <span class="keyword">return</span> res.<span class="function_ title">status</span>(<span class="number">200</span>).<span class="function_ title">json</span>({ <span class="attr">summary</span>: cachedSummary });</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> { title, content } = <span class="keyword">await</span> <span class="function_ title">fetchBlogContent</span>(post_path);</span><br><span class="line">        <span class="keyword">const</span> summary = <span class="keyword">await</span> <span class="function_ title">generateSparkSummary</span>(title, content);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> <span class="function_ title">cacheResult</span>(post_path, summary);</span><br><span class="line">        <span class="keyword">return</span> res.<span class="function_ title">status</span>(<span class="number">200</span>).<span class="function_ title">json</span>({ summary });</span><br><span class="line"></span><br><span class="line">    } <span class="keyword">catch</span> (error) {</span><br><span class="line">        <span class="keyword">return</span> <span class="function_ title">handleError</span>(error, res);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证环境变量</span></span><br><span class="line"><span class="keyword">function</span> <span class="function_ title">validateEnvironmentVariables</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="keyword">return</span> <span class="constant_ variable">API_KEY</span> &amp;&amp; <span class="constant_ variable">API_SECRET</span> &amp;&amp; <span class="constant_ variable">APPID</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查Redis缓存</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="function_ title">checkRedisCache</span>(<span class="params">post_path</span>) {</span><br><span class="line">    <span class="keyword">const</span> redisClient = <span class="keyword">await</span> <span class="function_ title">getRedisClient</span>();</span><br><span class="line">    <span class="keyword">const</span> value = <span class="keyword">await</span> redisClient.<span class="function_ title">get</span>(post_path);  <span class="comment">// 直接获取值</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (value !== <span class="literal">null</span>) {</span><br><span class="line">        <span class="language_ variable">console</span>.<span class="function_ title">log</span>(<span class="string">"【服务端】Redis Hit!"</span>);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="language_ variable">console</span>.<span class="function_ title">log</span>(<span class="string">"【服务端】Redis Miss!"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取博客内容</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="function_ title">fetchBlogContent</span>(<span class="params">post_path</span>) {</span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="function_ title">fetch</span>(<span class="string">`https://blog.uuanqin.top/api/posts/<span class="subst">${post_path}</span>.json`</span>, {</span><br><span class="line">        <span class="attr">method</span>: <span class="string">'GET'</span>,</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!response || response.<span class="property">status</span> === <span class="number">404</span>) {</span><br><span class="line">        <span class="language_ variable">console</span>.<span class="function_ title">error</span>(<span class="string">"【服务端】进入blog api - 404"</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class_ title">Error</span>(<span class="constant_ variable">ERROR_MESSAGES</span>.<span class="property">BLOG_NOT_FOUND</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> blogData = <span class="keyword">await</span> response.<span class="function_ title">json</span>();</span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">        <span class="attr">title</span>: blogData.<span class="property">data</span>.<span class="property">title</span>,</span><br><span class="line">        <span class="attr">content</span>: <span class="function_ title">cleanText</span>(blogData.<span class="property">data</span>.<span class="property">content</span>)</span><br><span class="line">    };</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成Spark摘要</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="function_ title">generateSparkSummary</span>(<span class="params">title, content</span>) {</span><br><span class="line">    <span class="keyword">const</span> requestData = {</span><br><span class="line">        <span class="attr">model</span>: <span class="constant_ variable">MODEL_NAME</span>,</span><br><span class="line">        <span class="attr">messages</span>: [</span><br><span class="line">            {</span><br><span class="line">                <span class="attr">role</span>: <span class="string">"system"</span>,</span><br><span class="line">                <span class="attr">content</span>: <span class="constant_ variable">SYSTEM_PROMPT</span></span><br><span class="line">            },</span><br><span class="line">            {</span><br><span class="line">                <span class="attr">role</span>: <span class="string">"user"</span>,</span><br><span class="line">                <span class="attr">content</span>: <span class="string">`【文章标题】<span class="subst">${title || <span class="string">'无标题'</span>}</span>【文章内容】<span class="subst">${content}</span>`</span>,</span><br><span class="line">            }</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">temperature</span>: <span class="number">0.5</span>,</span><br><span class="line">        <span class="attr">max_tokens</span>: <span class="number">200</span></span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> headers = {</span><br><span class="line">        <span class="string">'Content-Type'</span>: <span class="string">'application/json'</span>,</span><br><span class="line">        <span class="string">'Authorization'</span>: <span class="string">`Bearer <span class="subst">${API_PASSWORD}</span>`</span></span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="function_ title">fetch</span>(<span class="constant_ variable">SPARK_API_URL</span>, {</span><br><span class="line">        <span class="attr">method</span>: <span class="string">'POST'</span>,</span><br><span class="line">        headers,</span><br><span class="line">        <span class="attr">body</span>: <span class="class_ title">JSON</span>.<span class="function_ title">stringify</span>(requestData)</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!response.<span class="property">ok</span>) {</span><br><span class="line">        <span class="keyword">const</span> errorData = <span class="keyword">await</span> response.<span class="function_ title">json</span>().<span class="function_ title">catch</span>(<span class="function">() =&gt;</span> ({}));</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class_ title">Error</span>(errorData.<span class="property">error</span>?.<span class="property">message</span> || <span class="constant_ variable">ERROR_MESSAGES</span>.<span class="property">SPARK_CONNECTION_FAILED</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> responseData = <span class="keyword">await</span> response.<span class="function_ title">json</span>();</span><br><span class="line">    <span class="keyword">const</span> assistantMessage = responseData.<span class="property">choices</span>?.[<span class="number">0</span>]?.<span class="property">message</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (assistantMessage?.<span class="property">role</span> === <span class="string">'assistant'</span> &amp;&amp; assistantMessage.<span class="property">content</span>) {</span><br><span class="line">        <span class="keyword">return</span> assistantMessage.<span class="property">content</span>.<span class="function_ title">trim</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class_ title">Error</span>(<span class="constant_ variable">ERROR_MESSAGES</span>.<span class="property">SPARK_RESPONSE_ERROR</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 缓存结果</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="function_ title">cacheResult</span>(<span class="params">post_path, summary</span>) {</span><br><span class="line">    <span class="keyword">const</span> redisClient = <span class="keyword">await</span> <span class="function_ title">getRedisClient</span>();</span><br><span class="line">    <span class="keyword">await</span> redisClient.<span class="function_ title">setEx</span>(post_path, <span class="constant_ variable">SECONDS_OF_WEEK</span>, summary);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 错误处理</span></span><br><span class="line"><span class="keyword">function</span> <span class="function_ title">handleError</span>(<span class="params">error, res</span>) {</span><br><span class="line">    <span class="language_ variable">console</span>.<span class="function_ title">error</span>(<span class="string">"【服务端】错误："</span>, error);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (error.<span class="property">message</span> <span class="keyword">in</span> <span class="constant_ variable">ERROR_MESSAGES</span>) {</span><br><span class="line">        <span class="keyword">return</span> res.<span class="function_ title">status</span>(<span class="number">400</span>).<span class="function_ title">json</span>({ <span class="attr">error</span>: error.<span class="property">message</span> });</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (error <span class="keyword">instanceof</span> <span class="class_ title">SyntaxError</span>) {</span><br><span class="line">        <span class="language_ variable">console</span>.<span class="function_ title">error</span>(<span class="string">"Failed to parse Spark API response as JSON."</span>);</span><br><span class="line">        <span class="keyword">return</span> res.<span class="function_ title">status</span>(<span class="number">500</span>).<span class="function_ title">json</span>({ <span class="attr">error</span>: <span class="string">'【服务端】代理服务器错误：无法解析 Spark API 响应'</span> });</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res.<span class="function_ title">status</span>(<span class="number">500</span>).<span class="function_ title">json</span>({</span><br><span class="line">        <span class="attr">error</span>: <span class="string">'【服务端】代理服务器内部错误'</span>+error.<span class="property">message</span>,</span><br><span class="line">        <span class="attr">details</span>: error.<span class="property">message</span></span><br><span class="line">    });</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 如果需要生成 Token，可能需要类似这样的辅助函数 (具体实现需查文档) ---</span></span><br><span class="line"><span class="comment">// function generateSparkToken(apiKey, apiSecret) {</span></span><br><span class="line"><span class="comment">//     // ... 根据讯飞文档实现 Token 生成逻辑 ...</span></span><br><span class="line"><span class="comment">//     return "generated_token_string";</span></span><br><span class="line"><span class="comment">// }</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure> <h2 id="redisjs"><a class="markdownIt-Anchor" href="#redisjs"></a> <code>redis.js</code></h2> <figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utils/redis.js</span></span><br><span class="line"><span class="keyword">import</span> { createClient } <span class="keyword">from</span> <span class="string">'redis'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> redisClient;</span><br><span class="line"><span class="keyword">let</span> isConnecting = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="function_ title">getRedisClient</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="keyword">if</span> (redisClient &amp;&amp; redisClient.<span class="property">isReady</span>) {</span><br><span class="line">        <span class="keyword">return</span> redisClient;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isConnecting) {</span><br><span class="line">        <span class="comment">// 等待现有连接完成</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="class_ title">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> {</span><br><span class="line">            <span class="keyword">const</span> <span class="function_ title">check</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">                <span class="keyword">if</span> (redisClient &amp;&amp; redisClient.<span class="property">isReady</span>) {</span><br><span class="line">                    <span class="function_ title">resolve</span>(redisClient);</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    <span class="built_in">setTimeout</span>(check, <span class="number">50</span>);</span><br><span class="line">                }</span><br><span class="line">            };</span><br><span class="line">            <span class="function_ title">check</span>();</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    isConnecting = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        redisClient = <span class="function_ title">createClient</span>({</span><br><span class="line">            <span class="attr">url</span>: process.<span class="property">env</span>.<span class="property">REDIS_URL</span>,</span><br><span class="line">            <span class="attr">socket</span>: {</span><br><span class="line">                <span class="comment">// 针对 Vercel 环境的优化设置</span></span><br><span class="line">                <span class="attr">reconnectStrategy</span>: <span class="function">(<span class="params">retries</span>) =&gt;</span> <span class="class_ title">Math</span>.<span class="function_ title">min</span>(retries * <span class="number">100</span>, <span class="number">3000</span>),</span><br><span class="line">                <span class="attr">keepAlive</span>: <span class="number">30000</span> <span class="comment">// 保持连接活跃</span></span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        redisClient.<span class="function_ title">on</span>(<span class="string">'error'</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> <span class="language_ variable">console</span>.<span class="function_ title">error</span>(<span class="string">'【服务端】Redis Client Error'</span>, err));</span><br><span class="line">        redisClient.<span class="function_ title">on</span>(<span class="string">'end'</span>, <span class="function">() =&gt;</span> <span class="language_ variable">console</span>.<span class="function_ title">log</span>(<span class="string">'【服务端】Redis connection closed'</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> redisClient.<span class="function_ title">connect</span>();</span><br><span class="line">        <span class="language_ variable">console</span>.<span class="function_ title">log</span>(<span class="string">'【服务端】Redis connected successfully'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> redisClient;</span><br><span class="line">    } <span class="keyword">catch</span> (err) {</span><br><span class="line">        <span class="language_ variable">console</span>.<span class="function_ title">error</span>(<span class="string">'【服务端】Redis connection failed'</span>, err);</span><br><span class="line">        <span class="keyword">throw</span> err;</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        isConnecting = <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure> <h1 id="后记"><a class="markdownIt-Anchor" href="#后记"></a> 后记</h1> <h2 id="后续改进"><a class="markdownIt-Anchor" href="#后续改进"></a> 后续改进</h2> <ul class="contains-task-list"> <li class="task-list-item"><input class="task-list-item-checkbox" disabled="" type="checkbox"> 代码重构，允许替换其他模型</li> <li class="task-list-item"><input class="task-list-item-checkbox" disabled="" type="checkbox"> 不要设置 7 天过期。随文章更新而调用大模型。但如果 Redis 有 Key 就立即返回以保证速度，更新我们后面再处理。</li> <li class="task-list-item"><input class="task-list-item-checkbox" disabled="" type="checkbox"> 对模型生成内容进行保底后处理（盘古之白、保证整句、字数限制）</li> <li class="task-list-item"><input class="task-list-item-checkbox" disabled="" type="checkbox"> <code>/p/77a4685d/#523</code> 类似这样的链接还没有正确匹配，需改进代码</li> </ul> <h2 id="心得"><a class="markdownIt-Anchor" href="#心得"></a> 心得</h2> <p>当 TianliGPT 的博客 AI 摘要诞生时，我深感震撼，这么酷的项目我自己也要实现一个。那段时间，这个小小的愿景驱动着我不断，苦学本领和技术。睡觉前，脑海中还会闪过无数种实现方案…但是由于这些年事情太多，这个计划一直被耽搁。直到最近看到 Liushen、KonoXIN 的作品，我才把这个两年前的 Flag 捡起来。</p> <p>这些年，也逛了不少精美的博客，饱览许多高品质的文章。能和博友们一起成长，是一件幸福的事情！</p> <h1 id="本文参考"><a class="markdownIt-Anchor" href="#本文参考"></a> 本文参考</h1> <ul> <li><a target="_blank" rel="external nofollow noopener noreferrer" href="/go.html?u=aHR0cHM6Ly93d3cua29ub3hpbi50b3AvcG9zdHMvZGI3YjM0MTgv">hexo基于TianliGPT使用免费的Spark-Lite制作AI摘要 | XIN’s Blog | 前端开发 | Vue.js &amp; JavaScript 技术分享</a></li> <li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://vercel.com/docs/functions">Vercel Functions</a></li> <li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://blog.zhheo.com/p/ec57d8b2.html">如何让博客支持AI摘要，使用TianliGPT自动生成文章的AI摘要 | 张洪Heo</a></li> <li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://blog.csdn.net/ivan5277/article/details/138669897">nodeJS如何接入redis_nodejs 连接redis-CSDN博客</a></li> </ul> </article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fa-circle-user fa-fw fas"></i>文章作者: </span><span class="post-copyright-info"><a href="https://blog.uuanqin.top">wuanqin</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fa-fw fa-square-arrow-up-right fas"></i>文章链接: </span><span class="post-copyright-info"><a href="https://blog.uuanqin.top/p/75efe9f3/">https://blog.uuanqin.top/p/75efe9f3/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fa-circle-exclamation fa-fw fas"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="/pages/cc.html" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://blog.uuanqin.top" target="_blank">半方池水半方田</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/pages/tags/JavaScript/">JavaScript</a><a class="post-meta__tags" href="/pages/tags/Hexo/">Hexo</a><a class="post-meta__tags" href="/pages/tags/npm/">npm</a><a class="post-meta__tags" href="/pages/tags/Butterfly/">Butterfly</a><a class="post-meta__tags" href="/pages/tags/Vercel/">Vercel</a><a class="post-meta__tags" href="/pages/tags/Redis/">Redis</a><a class="post-meta__tags" href="/pages/tags/SparkLite/">SparkLite</a></div><div class="post-share"><div class="social-share" data-image="https://cdn.gallery.uuanqin.top/img/202506242301616.webp" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://lib.baomitu.com/social-share.js/1.0.16/css/share.min.css" media="print" onload="this.media='all'"><script src="https://lib.baomitu.com/social-share.js/1.0.16/js/social-share.min.js" defer=""></script></div></div><div class="post-reward"><div class="reward-button"><i class="fa-qrcode fas"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/image/wx.png" target="_blank"><img class="post-qr-code-img" src="/image/wx.png" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/image/zfb.png" target="_blank"><img class="post-qr-code-img" src="/image/zfb.png" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/p/25e0b352/" title="UML 中类图与类的关系"><img class="cover" src="https://cdn.gallery.uuanqin.top/img/202506181034799.webp" onerror="onerror=null;src='/image/404img.webp'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">UML 中类图与类的关系</div></div><div class="info-2"><div class="info-item-1">关系是挺复杂的</div></div></div></a><a class="pagination-related" href="/p/77a4685d/" title="这里曾是苏州古城最大的田野——南园"><img class="cover" src="https://cdn.gallery.uuanqin.top/img/202507022308655.webp" onerror="onerror=null;src='/image/404img.webp'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">这里曾是苏州古城最大的田野——南园</div></div><div class="info-2"><div class="info-item-1">消失的菜园</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fa-fw fa-thumbs-up fas"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/p/e1ee5eca/" title="Hexo 博客与 Waline 评论区实现外链跳转中间页"><img class="cover" src="https://cdn.gallery.uuanqin.top/img/202408042352584.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fa-calendar-alt fa-fw far"></i> 2024-08-04</div><div class="info-item-2">Hexo 博客与 Waline 评论区实现外链跳转中间页</div></div><div class="info-2"><div class="info-item-1">博客与评论区统一拦截重定向</div></div></div></a><a class="pagination-related" href="/p/26a31d07/" title="博客网站网页变灰的操作方法"><img class="cover" src="https://cdn.gallery.uuanqin.top/img/1ff4099a6177a54d86cf9d60314eff95.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fa-calendar-alt fa-fw far"></i> 2022-03-26</div><div class="info-item-2">博客网站网页变灰的操作方法</div></div><div class="info-2"><div class="info-item-1">在「额外CSS」中加入代码。</div></div></div></a><a class="pagination-related" href="/p/1d248fa3/" title="Waline 配置头像服务（含常用公共头像服务介绍）"><img class="cover" src="https://cdn.gallery.uuanqin.top/img/202410130307005.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fa-calendar-alt fa-fw far"></i> 2024-10-13</div><div class="info-item-2">Waline 配置头像服务（含常用公共头像服务介绍）</div></div><div class="info-2"><div class="info-item-1">简要介绍常用公共头像服务，尝试在 Waline 中上手实践替换默认头像</div></div></div></a></div></div><hr class="custom-hr"><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fa-comments fa-fw fas"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-info card-widget text-center"><div class="avatar-img"><img src="/image/avatar.webp" onerror="this.onerror=null;this.src='/image/loading.gif'" alt="avatar"></div><div class="author-info-name">wuanqin</div><div class="author-info-description">只能懂一点点</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">177</div></a><a href="/pages/tags/"><div class="headline">标签</div><div class="length-num">393</div></a><a href="/pages/categories/"><div class="headline">分类</div><div class="length-num">26</div></a></div><a id="card-info-btn" href="/pages/building.html"><i class="fa-address-card fa-solid"></i><span>用户认证页/调试页</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/uuanqin" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fa-brands fa-github"></i></a><a class="social-icon" href="mailto:uuanqin@uuanqin.top" target="_blank" title="Email"><i class="fa-at fa-solid"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fa-rss fa-solid"></i></a><a class="social-icon" href="https://app.follow.is/share/users/uuanqin" rel="external nofollow noreferrer" target="_blank" title="Follow"><i class="fa-solid fa-square-rss"></i></a><a class="social-icon" href="https://steamcommunity.com/id/uuanqin/" rel="external nofollow noreferrer" target="_blank" title="Steam"><i class="fa-brands fa-steam"></i></a></div></div><div class="card-announcement card-widget"><div class="item-headline"><i class="fa-bullhorn fa-shake fas"></i><span>公告</span></div><div class="announcement_content">🌏全球访问本站的速度更快了！<br> ⚠️账单保卫行动：小破站正抵御坏人的攻击！部分省市用户近期将无法访问本站。 </div></div><div class="card-widget seamless-card"><div class="item-headline"><i></i><span></span></div><div class="item-content"><div style="height:250px"> <iframe src="/DO_NOT_render/cosmoscope/cosmoscope_trim.html" frameborder="no" style="width:100%;height:100%"></iframe> </div> </div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fa-stream fas"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%88%91%E7%9A%84%E6%96%B9%E6%A1%88"><span class="toc-number">1.</span> <span class="toc-text"> 我的方案</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text"> 概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E6%96%87%E4%BB%B6%E5%AF%BC%E5%85%A5"><span class="toc-number">1.2.</span> <span class="toc-text"> 前端：文件导入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E7%AB%AFvercel-%E6%8F%90%E4%BE%9B%E7%9A%84%E5%87%BD%E6%95%B0%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.3.</span> <span class="toc-text"> 后端：Vercel 提供的函数服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%AF%E9%A3%9E%E6%98%9F%E7%81%AB-spark-lite"><span class="toc-number">1.3.1.</span> <span class="toc-text"> 讯飞星火 Spark Lite</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-vercel-%E4%B8%AD%E7%9A%84-redis-%E9%9B%86%E6%88%90%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.3.2.</span> <span class="toc-text"> 使用 Vercel 中的 Redis 集成服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-api-%E6%8F%92%E4%BB%B6"><span class="toc-number">1.4.</span> <span class="toc-text"> 安装 API 插件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%96%87%E4%BB%B6"><span class="toc-number">2.</span> <span class="toc-text"> 代码文件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ai-summaryjs"><span class="toc-number">2.1.</span> <span class="toc-text"> ai-summary.js</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ai-summarycss"><span class="toc-number">2.2.</span> <span class="toc-text"> ai-summary.css</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#spark-litejs"><span class="toc-number">2.3.</span> <span class="toc-text"> spark-lite.js</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redisjs"><span class="toc-number">2.4.</span> <span class="toc-text"> redis.js</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%90%8E%E8%AE%B0"><span class="toc-number">3.</span> <span class="toc-text"> 后记</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E7%BB%AD%E6%94%B9%E8%BF%9B"><span class="toc-number">3.1.</span> <span class="toc-text"> 后续改进</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BF%83%E5%BE%97"><span class="toc-number">3.2.</span> <span class="toc-text"> 心得</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%AC%E6%96%87%E5%8F%82%E8%80%83"><span class="toc-number">4.</span> <span class="toc-text"> 本文参考</span></a></li></ol></div></div><div class="card-recent-post card-widget"><div class="item-headline"><i class="fa-history fas"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/p/10ab676/" title="线段树模板的理解和使用"><img src="https://cdn.gallery.uuanqin.top/img/202508270057686.webp" onerror="this.onerror=null;this.src='/image/404img.webp'" alt="线段树模板的理解和使用"></a><div class="content"><a class="title" href="/p/10ab676/" title="线段树模板的理解和使用">线段树模板的理解和使用</a><time datetime="2025-08-26T16:59:08.426Z" title="更新于 2025-08-27 00:59:08">2025-08-27</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"></div><div class="footer_custom_text"><div class="my-footer-svg-div"> <svg class="my-footer-wave-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 100" preserveAspectRatio="none"> <path class="my-footer-wave-path" d="M851.8,100c125,0,288.3-45,348.2-64V0H0v44c3.7-1,7.3-1.9,11-2.9C80.7,22,151.7,10.8,223.5,6.3C276.7,2.9,330,4,383,9.8 c52.2,5.7,103.3,16.2,153.4,32.8C623.9,71.3,726.8,100,851.8,100z"></path> </svg> </div> <div class="my-footer-content-div"> <div class="my-footer-content"> <div class="my-footer-content-column"> <div class="my-footer-logo"> <a class="my-footer-logo-link" href="#"> <span class="hidden-link-text">LOGO</span> <img src="/image/footer/qlogo_white_no_words.png" style="height:40%;width:40%"> </a> </div> <div class="my-footer-menu"> <h2 class="my-footer-menu-name">开始</h2> <ul id="menu-get-started" class="my-footer-menu-list"> <li class="menu-item menu-item-object-product menu-item-type-post_type"> <a href="/pages/about.html">关于本站</a> </li> </ul> </div> </div> <div class="my-footer-content-column"> <div class="my-footer-menu"> <h2 class="my-footer-menu-name">快速链接</h2> <ul id="menu-company" class="my-footer-menu-list"> <li class="menu-item menu-item-object-product menu-item-type-post_type"> <a target="_blank" rel="external nofollow noopener noreferrer" href="https://hexo.io/zh-cn/">Hexo</a>&nbsp;⨯&nbsp;<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a> </li> <li class="menu-item menu-item-object-category menu-item-type-taxonomy"> <a href="/archives/">时间轴</a>&nbsp;|&nbsp;<a href="/DO_NOT_render/cosmoscope/cosmoscope_trim.html">关系图</a>&nbsp;|&nbsp;<a href="/pages/categories/">分类</a> </li> <li class="menu-item menu-item-object-product menu-item-type-post_type"> <a href="/p/91b7dad/">同款页脚</a> </li> <li class="menu-item menu-item-object-product menu-item-type-post_type"> <a href="https://www.foreverblog.cn/" rel="external nofollow noopener noreferrer" target="_blank"> <img class="img-foreverblog" src="/image/footer/forever_logo_en_default_white.png" alt="" style="width:auto;height:21px;margin-top:6px"> </a> </li> </ul> </div> </div> <div class="my-footer-content-column"> <div class="my-footer-menu"> <h2 class="my-footer-menu-name">法律声明</h2> <ul id="menu-legal" class="my-footer-menu-list"> <li class="menu-item menu-item-170434 menu-item-object-page menu-item-privacy-policy menu-item-type-post_type"> <a href="/pages/privacy.html">隐私政策</a> </li> </ul> </div> <div class="my-footer-call-to-action"> <h2 class="my-footer-call-to-action-title">联系本站</h2> <ul id="menu-legal" class="my-footer-menu-list"> <li class="menu-item menu-item-170434 menu-item-object-page menu-item-privacy-policy menu-item-type-post_type"> <a href="/DO_NOT_render/wechatOA/index.html">微信公众号</a> </li> <li class="menu-item menu-item-170434 menu-item-object-page menu-item-privacy-policy menu-item-type-post_type"> <a class="my-footer-call-to-action-link" href="mailto:uuanqin@uuanqin.top" target="_self"> uuan<span style="display:none">@</span>qin@<span style="display:none">@</span>uuan<span style="display:none">@</span>qin.top </a> </li> </ul> </div> </div> <div class="my-footer-content-column"> <ul id="menu-get-started" class="my-footer-menu-list"> <li class="menu-item menu-item-object-product menu-item-type-post_type"> <a href="https://notbyai.fyi/" target="_blank" rel="external nofollow noopener noreferrer"><img class="img-not-ai" src="/image/footer/Written-By-Human-Not-By-AI-Badge-white.svg" alt="Written by Human, Not by AI"></a> </li> <li class="menu-item menu-item-object-product menu-item-type-post_type"> <a href="/pages/cc.html"><img src="/image/footer/by-nc-sa.svg" alt="署名-非商业性使用-相同方式共享 4.0 国际"></a> </li> <li class="menu-item menu-item-object-product menu-item-type-post_type"> ©2022-2025 By wuanqin </li> </ul> </div> <div class="my-footer-social-links"> <svg class="my-footer-social-amoeba-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 236 54"> <path class="my-footer-social-amoeba-path" d="M223.06,43.32c-.77-7.2,1.87-28.47-20-32.53C187.78,8,180.41,18,178.32,20.7s-5.63,10.1-4.07,16.7-.13,15.23-4.06,15.91-8.75-2.9-6.89-7S167.41,36,167.15,33a18.93,18.93,0,0,0-2.64-8.53c-3.44-5.5-8-11.19-19.12-11.19a21.64,21.64,0,0,0-18.31,9.18c-2.08,2.7-5.66,9.6-4.07,16.69s.64,14.32-6.11,13.9S108.35,46.5,112,36.54s-1.89-21.24-4-23.94S96.34,0,85.23,0,57.46,8.84,56.49,24.56s6.92,20.79,7,24.59c.07,2.75-6.43,4.16-12.92,2.38s-4-10.75-3.46-12.38c1.85-6.6-2-14-4.08-16.69a21.62,21.62,0,0,0-18.3-9.18C13.62,13.28,9.06,19,5.62,24.47A18.81,18.81,0,0,0,3,33a21.85,21.85,0,0,0,1.58,9.08,16.58,16.58,0,0,1,1.06,5A6.75,6.75,0,0,1,0,54H236C235.47,54,223.83,50.52,223.06,43.32Z"></path> </svg> <a class="github my-footer-social-link" href="https://github.com/uuanqin" target="_blank" rel="external nofollow noopener noreferrer"> <span class="hidden-link-text">Github</span> <svg class="my-footer-social-icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"> <path class="my-footer-social-icon-path" d="M 16 4 C 9.371094 4 4 9.371094 4 16 C 4 21.300781 7.4375 25.800781 12.207031 27.386719 C 12.808594 27.496094 13.027344 27.128906 13.027344 26.808594 C 13.027344 26.523438 13.015625 25.769531 13.011719 24.769531 C 9.671875 25.492188 8.96875 23.160156 8.96875 23.160156 C 8.421875 21.773438 7.636719 21.402344 7.636719 21.402344 C 6.546875 20.660156 7.71875 20.675781 7.71875 20.675781 C 8.921875 20.761719 9.554688 21.910156 9.554688 21.910156 C 10.625 23.746094 12.363281 23.214844 13.046875 22.910156 C 13.15625 22.132813 13.46875 21.605469 13.808594 21.304688 C 11.144531 21.003906 8.34375 19.972656 8.34375 15.375 C 8.34375 14.0625 8.8125 12.992188 9.578125 12.152344 C 9.457031 11.851563 9.042969 10.628906 9.695313 8.976563 C 9.695313 8.976563 10.703125 8.65625 12.996094 10.207031 C 13.953125 9.941406 14.980469 9.808594 16 9.804688 C 17.019531 9.808594 18.046875 9.941406 19.003906 10.207031 C 21.296875 8.65625 22.300781 8.976563 22.300781 8.976563 C 22.957031 10.628906 22.546875 11.851563 22.421875 12.152344 C 23.191406 12.992188 23.652344 14.0625 23.652344 15.375 C 23.652344 19.984375 20.847656 20.996094 18.175781 21.296875 C 18.605469 21.664063 18.988281 22.398438 18.988281 23.515625 C 18.988281 25.121094 18.976563 26.414063 18.976563 26.808594 C 18.976563 27.128906 19.191406 27.503906 19.800781 27.386719 C 24.566406 25.796875 28 21.300781 28 16 C 28 9.371094 22.628906 4 16 4 Z "></path> </svg> </a> <a class="email my-footer-social-link" href="mailto:uuanqin@uuanqin.top" target="_blank" rel="external nofollow noopener noreferrer"> <span class="hidden-link-text">Email</span> <svg class="my-footer-social-icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">  <path class="my-footer-social-icon-path" d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4L236.8 313.6c11.4 8.5 27 8.5 38.4 0L492.8 150.4c12.1-9.1 19.2-23.3 19.2-38.4c0-26.5-21.5-48-48-48H48zM0 176V384c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V176L294.4 339.2c-22.8 17.1-54 17.1-76.8 0L0 176z"></path> </svg> </a> <a class="follow my-footer-social-link" href="https://app.follow.is/share/users/uuanqin" target="_blank" rel="external nofollow noopener noreferrer"> <span class="hidden-link-text">Follow</span> <svg class="my-footer-social-icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">  <path class="my-footer-social-icon-path" d="M64 32C28.7 32 0 60.7 0 96L0 416c0 35.3 28.7 64 64 64l320 0c35.3 0 64-28.7 64-64l0-320c0-35.3-28.7-64-64-64L64 32zM96 136c0-13.3 10.7-24 24-24c137 0 248 111 248 248c0 13.3-10.7 24-24 24s-24-10.7-24-24c0-110.5-89.5-200-200-200c-13.3 0-24-10.7-24-24zm0 96c0-13.3 10.7-24 24-24c83.9 0 152 68.1 152 152c0 13.3-10.7 24-24 24s-24-10.7-24-24c0-57.4-46.6-104-104-104c-13.3 0-24-10.7-24-24zm0 120a32 32 0 1 1 64 0 32 32 0 1 1 -64 0z"></path> </svg> </a> <a class="my-footer-social-link rss" href="/atom.xml" target="_blank" rel="external nofollow noopener noreferrer"> <span class="hidden-link-text">RSS</span> <svg class="my-footer-social-icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">  <path class="my-footer-social-icon-path" d="M0 64C0 46.3 14.3 32 32 32c229.8 0 416 186.2 416 416c0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96C14.3 96 0 81.7 0 64zM0 416a64 64 0 1 1 128 0A64 64 0 1 1 0 416zM32 160c159.1 0 288 128.9 288 288c0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224c-17.7 0-32-14.3-32-32s14.3-32 32-32z"></path> </svg> </a> </div> </div> </div> <div class="my-footer-copyright"> <div class="my-footer-copyright-wrapper"> <p class="my-footer-copyright-text"> <a target="_blank" href="https://beian.miit.gov.cn/" rel="external nofollow noopener noreferrer"><img class="icp-icon" src="/image/footer/icp.ico"><span>津ICP备2022002156号-1</span></a> &nbsp;|&nbsp;<a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=12011202000621" rel="external nofollow noopener noreferrer"><img class="icp-icon" src="/image/footer/beian_logo.png"><span>津公网安备 12011202000621号</span></a> &nbsp;|&nbsp;&nbsp; <span>违法与不良信息举报邮箱&nbsp; j<span style="display:none">@</span>b@<span style="display:none">@</span>uuan<span style="display:none">@</span>q.in </span> </p> </div> </div> </div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fa-book-open fas"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fa-adjust fas"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fa-arrows-alt-h fas"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fa-cog fa-spin fas"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fa-list-ul fas"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fa-comments fas"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fa-arrow-up fas"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/fancyapps-ui/5.0.17/fancybox/fancybox.umd.js"></script><script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/instant.page/5.2.0/instantpage.min.js" type="module"></script><script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/vanilla-lazyload/19.1.3/lazyload.iife.min.js"></script><script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/node-snackbar/0.1.16/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/mermaid/11.9.0/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(()=>{let initFn=window.walineFn||null,isShuoshuo='shuoshuo'===GLOBAL_CONFIG_SITE.pageType,option={locale:{nick:'昵称',mail:'邮箱',link:'网站',placeholder:'都看到这了，不妨将你的真知灼见狠狠的塞满我......',requiredMeta:[],sofa:'评论区空空如也~喵呜呜呜',anonymous:'匿名访客',login:'登录(可选)'},search:!1,emoji:['https://github.elemecdn.com/@waline/emojis@1.2.0/tieba/','https://github.elemecdn.com/@waline/emojis@1.2.0/bilibili/','https://github.elemecdn.com/@waline/emojis@1.2.0/qq/','https://github.elemecdn.com/@waline/emojis@1.2.0/weibo/'],reaction:['/image/comment/reaction1.gif','/image/comment/reaction2.gif','/image/comment/reaction3.gif','/image/comment/reaction4.gif','/image/comment/reaction5.gif','/image/comment/reaction6.gif'],smms:{token:'Yx2wAPCKbYms7rNGNMOACsnLe1yL62I5'}},destroyWaline=ele=>ele.destroy(),initWaline=(Fn,el=document,path=window.location.pathname)=>{let waline=Fn({el:el.querySelector('#waline-wrap'),serverURL:'https://pl.uuanqin.top',pageview:!0,dark:'html[data-theme="dark"]',comment:!0,...option,path:!isShuoshuo&&option&&option.path||path});isShuoshuo&&(window.shuoshuoComment.destroyWaline=()=>{destroyWaline(waline),el.children.length&&(el.innerHTML='',el.classList.add('no-comment'))})};var loadWaline=(el,path)=>{initFn?initWaline(initFn,el,path):btf.getCSS('/css/mywaline.css').then(()=>import('https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/waline/3.3.0/waline.js')).then(({init})=>{initFn=init||Waline.init,initWaline(initFn,el,path),window.walineFn=initFn})};isShuoshuo?window.shuoshuoComment={loadComment:loadWaline}:setTimeout(loadWaline,0)})();</script></div><script src="/js/ai-summary.js"></script><script src="/js/gray_page.js"></script><script src="/js/bi-links.js"></script><script src="/js/links-art-card.js"></script><script src="/js/genuine_website_verification4.js"></script><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="fa-times fas"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div><script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/algoliasearch/4.25.2/algoliasearch-lite.umd.js"></script><script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/instantsearch.js/4.79.2/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script></div></div> <script data-pjax="">var parent,child;document.getElementById('recent-posts')&&'/'===location.pathname&&(parent=document.getElementById('recent-posts'),child='<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="/pages/categories/博客站点维护/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🎨 博客维护与美化 (41)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="/pages/categories/核心协同/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🔷 核心协同板块 (16)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="/pages/categories/百味人生/有感而发/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🏄‍♂️ 热爱生活 (3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="/pages/categories/嵌入式/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🧩 嵌入式开发 (16)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="/pages/categories/技术学习/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🧑‍💻 桩桩猫学技术 (15)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="/pages/categories/算法与数据结构/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🧮 算法日记 (17)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><a class="magnet_link_more"  href="/pages/categories/" style="flex:1;text-align: center;margin-bottom: 10px;">查看更多...</a></div></div>',console.log('已挂载magnet'),parent.insertAdjacentHTML('afterbegin',child));</script><style>#catalog_magnet{flex-wrap:wrap;display:flex;width:100%;justify-content:space-between;padding:10px 10px 0;align-content:flex-start}.magnet_item{flex-basis:calc(33.333333333333336% - 5px);background:#f2f2f2;margin-bottom:10px;border-radius:8px;transition:.2s ease-in-out}.magnet_item:hover{background:#690}.magnet_link_more{color:#555}.magnet_link{color:#000}.magnet_link:hover{color:#fff}@media screen and (max-width:600px){.magnet_item{flex-basis:100%}}.magnet_link_context{display:flex;padding:10px;font-size:16px;transition:.2s ease-in-out}.magnet_link_context:hover{padding:10px 20px}</style> <style></style> <script data-pjax="">var parent,child;document.getElementById('recent-posts')&&'/'==location.pathname&&(parent=document.getElementById('recent-posts'),child='<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src="https://cdn.gallery.uuanqin.top/img/hexoobsidian-Grammar.webp" alt="https://cdn.gallery.uuanqin.top/img/hexoobsidian-Grammar.webp"/></div><div class="blog-slider__content"><span class="blog-slider__code">2023-08-01</span><a class="blog-slider__title" href="p/d4bc55f2/">Hexo 博客适配 Obsidian 新语法</a><div class="blog-slider__text">你可能在寻找这篇文章</div><a class="blog-slider__button" href="p/d4bc55f2/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src="https://cdn.gallery.uuanqin.top/img/202408042352584.webp" alt="https://cdn.gallery.uuanqin.top/img/202408042352584.webp"/></div><div class="blog-slider__content"><span class="blog-slider__code">2024-08-04</span><a class="blog-slider__title" href="p/e1ee5eca/">Hexo 博客与 Waline 评论区实现外链跳转中间页</a><div class="blog-slider__text">文章推荐</div><a class="blog-slider__button" href="p/e1ee5eca/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src="https://cdn.gallery.uuanqin.top/img/202411272314587.webp" alt="https://cdn.gallery.uuanqin.top/img/202411272314587.webp"/></div><div class="blog-slider__content"><span class="blog-slider__code">2024-11-27</span><a class="blog-slider__title" href="p/8aa53d93/">自定义 Hexo 中的超链接样式</a><div class="blog-slider__text">最近更新完善</div><a class="blog-slider__button" href="p/8aa53d93/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src="https://cdn.gallery.uuanqin.top/img/202412010504201.webp" alt="https://cdn.gallery.uuanqin.top/img/202412010504201.webp"/></div><div class="blog-slider__content"><span class="blog-slider__code">2024-12-01</span><a class="blog-slider__title" href="p/7d2de43e/">防止网站被镜像的若干防护措施及反制手段</a><div class="blog-slider__text">近期热门</div><a class="blog-slider__button" href="p/7d2de43e/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src="https://cdn.gallery.uuanqin.top/img/202412100327066.webp" alt="https://cdn.gallery.uuanqin.top/img/202412100327066.webp"/></div><div class="blog-slider__content"><span class="blog-slider__code">2024-12-10</span><a class="blog-slider__title" href="p/55893d1/">实现网站国内外分流（境外接入 Cloudflare）</a><div class="blog-slider__text">博主精选</div><a class="blog-slider__button" href="p/55893d1/">详情</a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>',console.log('已挂载swiper'),parent.insertAdjacentHTML('afterbegin',child));</script>    <script data-pjax="" src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/Swiper/4.1.6/js/swiper.min.js"></script> <script data-pjax="" src="/js/swiperindex.js"></script> <style></style></body></html>