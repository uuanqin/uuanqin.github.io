{"data":{"title":"Nginx 与 CDN 完成重定向：从 HTTP 重定向到 HTTPS、从 WWW 重定向到根","slug":"博客站点维护/Nginx 与 CDN 完成重定向：从 HTTP 重定向到 HTTPS、从 WWW 重定向到根","description":"精解本博客域名配置，建议熟悉 CDN、HTTPS 配置后参考。","date":"2023-07-23T17:27:11.000Z","updated":"2024-12-12T18:01:05.304Z","language":"zh-CN","comments":true,"url":"p/83335cfa/","cover":"https://cdn.gallery.uuanqin.top/img/%E7%BD%91%E7%AB%99%E9%85%8D%E7%BD%AEcover.png","images":[],"content":"\n<div class=\"callout\" data-callout=\"hint\">\n<div class=\"callout-title\">\n<div class=\"callout-title-icon\">\n<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-flame\"><path d=\"M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z\"/></svg>\n</div>\n<div class=\"callout-title-inner\">文章推荐：在 DNS 侧配置重定向</div>\n</div>\n<div class=\"callout-content\"><p>通过 Cloudflare DNS 重定向规则可以更方便配置好重定向。详看这篇文章：<a class=\"uuanqin-bilink\" target=\"_blank\" href=\"/p/41b77d61/\"><span class=\"yukari\">站内文章</span>域名 DNS 服务托管至 Cloudflare 以及 301 重定向的配置</a></p>\n</div></div><p>今天填了一个一直想填的坑，就是把博客域名的重定向、CDN 回源设置给弄好和捋顺了。以前的做法是 www.uuanqin.top 和 uuanqin.top 同时使用，CDN 也配置两条域名，但我总感觉不优雅、也不安全。通过学习一些<strong>网络相关知识</strong>，我自己尝试动手实验，绘制了<strong>域名解析流程图</strong>（把 DNS 迭代查询和递归查询简化拉平了）。此外把一些关键的<strong>具体配置分享</strong>出来并简要分析。</p>\n<p>镇楼图先放出来：</p>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/20230724025849.png\" alt=\"image.png\" /></p>\n<p>上图即为本站域名跳转关系，呕心沥血绘制。看着很复杂，实际…这张图体现的配置我还是感觉不太完美，限于目前的知识储备也就这样了，希望路过的大佬们在评论区指点迷津！！</p>\n<blockquote>\n<p>本文目的在于<strong>分享交流</strong>，所有操作仅供参考。</p>\n</blockquote>\n<blockquote>\n<p>如果你是萌新站长，建议不要直接上手本篇文章内容，先弄明白这几篇文章循序渐进开始：</p>\n<ol>\n<li>拥有了域名，配置主机 A 记录，直接指向源站：<a href=\"https://help.aliyun.com/document_detail/29716.html?spm=a2c4g.11186623.0.0.37fc1f12nXmqC1\">新手引导 (aliyun.com)</a></li>\n<li>使用 CDN 服务，并加速域名：<a href=\"https://cloud.tencent.com/document/product/228/3149\">内容分发网络 CDN 从零开始配置 CDN-快速入门-文档中心-腾讯云 (tencent.com)</a></li>\n<li>网站使用 HTTPS：<a href=\"https://help.aliyun.com/document_detail/28534.html?spm=a2c4g.98728.0.0.4aa6115dQ3KtyS\">SSL 证书使用指南 (aliyun.com)</a></li>\n</ol>\n</blockquote>\n<h1 id=\"环境\"><a class=\"markdownIt-Anchor\" href=\"#环境\"></a> 环境</h1>\n<p>我的整个博客项目不同服务由不同服务商提供，之所以没选择 All in one 除了想自己边折腾边学习外，还是想让各种服务松耦合起来。</p>\n<p>博客使用的服务以及部分软件系统版本如下：</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">DNS 域名解析</th>\n<th style=\"text-align:center\">SSL 证书</th>\n<th style=\"text-align:center\">CDN 服务</th>\n<th style=\"text-align:center\">云服务器</th>\n<th style=\"text-align:center\">Web 服务</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\" colspan=\"2\">阿里云</td>\n<td style=\"text-align:center\">腾讯云</td>\n<td style=\"text-align:center\">阿里云 ECS（Linux）</td>\n<td style=\"text-align:center\">Nginx 1.22.1</td>\n</tr>\n</tbody>\n</table>\n<p>不管是阿里云还是腾讯云，相关服务的使用大差不差，本文只是给个思路。</p>\n<h1 id=\"配置效果与原因\"><a class=\"markdownIt-Anchor\" href=\"#配置效果与原因\"></a> 配置效果与原因</h1>\n<p>理想的域名配置效果应该是这样的：</p>\n<ol>\n<li>用户在地址栏输入 www.uuanqin.top 时会直接重定向到 uuanqin.top，地址栏不显示 www 地址</li>\n<li>所有 http 不安全链接自动指向 https 链接</li>\n<li>使用 HSTS 在尽可能保证安全的同时减少重定向次数</li>\n<li>精简 CDN 回源配置</li>\n</ol>\n<p>如果想直接看操作过程的跳下一节，想看原因的请继续往下阅读。</p>\n<h2 id=\"301-重定向的优点www-重定向到不带-www-的地址\"><a class=\"markdownIt-Anchor\" href=\"#301-重定向的优点www-重定向到不带-www-的地址\"></a> 301 重定向的优点（www 重定向到不带 www 的地址）</h2>\n<p>你会发现互联网上一些网站的输入 www 开头网址跳转后，地址栏 www 会消失（或相反：不输 www 反而跳到显示 www，例如 <a href=\"http://baidu.com\">baidu.com</a>）。它们都使用了一种非常重要的「自动转向」技术——301 重定向。</p>\n<p>301 重定向（301 Move Permanently），指<strong>页面永久性转移</strong>，表示为资源或页面永久性地转移到了另一个位置。301 是 HTTP 协议中的一种<strong>状态码</strong>，当用户或搜索引擎向服务器发出浏览请求时，服务器返回的 HTTP 数据流中头信息（header）中包含状态码 301 ，表示该资源已经永久改变了位置。</p>\n<p>过程如图：</p>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/20230724020428.png\" alt=\"image.png\" /></p>\n<p>利用 301 重定向设置网站别名有利于网站首选域的确定，对于同一资源页面多条路径的 301 重定向有助于 URL 权重的集中，利于网站 SEO。</p>\n<p>302 重定向（302 Move Temporarily），指页面<strong>暂时性转移</strong>，表示资源或页面暂时转移到另一个位置，常被用作网址劫持，容易导致网站降权，严重时网站会被封掉，不推荐使用。</p>\n<p>搜索引擎是这样对待两种重定向的：</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">重定向方式</th>\n<th style=\"text-align:center\">搜索引擎抓取操作</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">301 页面永久性转移</td>\n<td style=\"text-align:center\">抓取新内容的同时也将旧的网址替换成重定向之后的网址</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">302 页面暂时性转移</td>\n<td style=\"text-align:center\">抓取新的内容而保存旧的网址并认为新的网址只是暂时的</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"http-跳转到-https\"><a class=\"markdownIt-Anchor\" href=\"#http-跳转到-https\"></a> HTTP 跳转到 HTTPS</h2>\n<p>HTTP 协议也就是超文本传输协议，是一种使用<strong>明文数据</strong>传输的网络协议，不提供任何方式的数据加密。如果攻击者截取了 Web 浏览器和网站服务器之间的传输报文，就可以直接读懂其中的信息。</p>\n<p>为了数据传输的安全，另一种协议 HTTPS（安全套接字层超文本传输协议）诞生。HTTPS 在 HTTP 的基础上加入了 SSL/TLS 协议，SSL/TLS 依靠证书来验证服务器的身份，并为浏览器和服务器之间的通信加密。</p>\n<p>HTTP 和 HTTPS 使用的是完全不同的连接方式，同时使用的端口也不同，网络模型工作层不同：</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">协议</th>\n<th style=\"text-align:center\">传输方式</th>\n<th style=\"text-align:center\">端口</th>\n<th style=\"text-align:center\">工作层</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">HTTP 超文本传输协议</td>\n<td style=\"text-align:center\">明文传输</td>\n<td style=\"text-align:center\">80</td>\n<td style=\"text-align:center\">应用层</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">HTTPS 安全套接字层超文本传输协议</td>\n<td style=\"text-align:center\">SSL/TLS 协议加密</td>\n<td style=\"text-align:center\">443</td>\n<td style=\"text-align:center\">传输层</td>\n</tr>\n</tbody>\n</table>\n<p>HTTPS 有利于搜索排名的提升。百度和谷歌两大搜索引擎都已经明确表示，HTTPS 网站将会作为搜索排名的一个重要权重指标。也就是说 HTTPS 网站比起 HTTP 网站在搜索排名中更有优势。</p>\n<h2 id=\"为什么使用-cdn\"><a class=\"markdownIt-Anchor\" href=\"#为什么使用-cdn\"></a> 为什么使用 CDN？</h2>\n<p>当用户直接访问源站中的静态内容时，可能面临的体验问题：</p>\n<ul>\n<li>客户离服务器越远，访问速度越慢。</li>\n<li>客户数量越多，网络带宽费用越高。</li>\n<li>跨境用户访问体验较差。</li>\n</ul>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/20230724022324.png\" alt=\"image.png\" /></p>\n<p>CDN 如何改善您的网络体验：</p>\n<ul>\n<li>CDN 缓存内容后，用户仅需要访问就近的 CDN 节点即可获取静态内容。</li>\n<li>缓解源站带宽压力，网络费用更低。</li>\n<li>分布全球的跨境节点提升跨境访问体验。</li>\n</ul>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/20230724022332.png\" alt=\"image.png\" /></p>\n\n<div class=\"callout\" data-callout=\"hint\">\n<div class=\"callout-title\">\n<div class=\"callout-title-icon\">\n<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-flame\"><path d=\"M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z\"/></svg>\n</div>\n<div class=\"callout-title-inner\">为什么不要用 CDN？</div>\n</div>\n<div class=\"callout-content\"><p>CDN 增加网站的被攻击风险，若安全措施没有实施到位，容易产生高额账单。比如在 2024 年，本站遭遇大量恶意攻击并造成一定程度的财产损失。</p>\n</div></div><h2 id=\"hsts-是什么\"><a class=\"markdownIt-Anchor\" href=\"#hsts-是什么\"></a> HSTS 是什么？</h2>\n<p>上文提到 HTTPS 可以提高安全性，是“更加安全的 HTTP”，但 HTTPS 提供服务也不是安全的。</p>\n<p>最初网站是通过 HTTP 协议提供服务，为了安全起见，网站升级为 HTTPS 协议，可是当用户在浏览器中输入网址时，例如 www.uuanqin.top ，而不是输入完整的 www.uuanqin.top ，浏览器会向网站<strong>发起一次 HTTP 请求</strong>，这时浏览器获取到一个重定向到 HTTPS 的请求（就像上文我们说的 301 重定向），然后再使用 HTTPS 协议通信。在这个过程中，我们使用了一次明文的 HTTP 请求和重定向，而这个过程很容易被攻击者利用，攻击者可以以中间人的方式劫持这次请求，从而进行后续的攻击，例如窃听数据，篡改请求和响应，跳转到钓鱼网站等。</p>\n<p>为了避免这个问题，我们希望<strong>浏览器</strong>做到：当用户输入网址时（不带 https:// ）将其转换成 HTTPS 请求，从而绕过明文的 HTTP 请求和重定向。我们使用 HSTS 可以告诉浏览器这个网站是否是使用的 HTTPS。</p>\n<p>HSTS 的全称是 HTTP Strict-Transport-Security，它是一个 Web 安全策略机制。HSTS 的核心是<strong>HTTP 响应头</strong>（HTTP Response Header），它告诉浏览器在接下来的一段时间，这个域名只能通过 HTTPS 进行访问，如果该域名在浏览器中出现不安全访问，HSTS 会强制用户的访问。</p>\n<p>HSTS Header 中可以设置其过期时间，比如 1 年。注意如果网站 SSL 证书出现问题，那么用户在一年的时间里都没法正常访问你的网站了，当然，除非用户清除了浏览器缓存。</p>\n<p>HSTS 也并不安全。假设浏览器中没有该域名的 HSTS 信息时，用户第一次访问该网站时，依然需要使用明文的 HTTP 请求和重定向，解决方法是 Preload List，感兴趣的同学可以自己搜索，这里就不再赘述。</p>\n<h1 id=\"网址转换过程\"><a class=\"markdownIt-Anchor\" href=\"#网址转换过程\"></a> 网址转换过程</h1>\n<p>DNS 解析链接地址的大致流程如下：</p>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/202410272103714.webp\" alt=\"img\" width=\"400px\" /></p>\n<p>如果我们把上面 DNS 递归解析、迭代解析的过程拉平，并取出其中的主要结点，那么可以得到下图：</p>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/20230724025849.png\" alt=\"image.png\" /></p>\n<p>过程图解析：</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">浏览器有无 HSTS 缓存</th>\n<th>用户在地址栏输入</th>\n<th>路径</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">❌</td>\n<td rowspan=\"2\"><a href=\"http://uuanqin.top\">http://uuanqin.top</a></td>\n<td>腾讯云 CDN 将其重定向至 HTTPS 再访问 CDN 边缘节点，同时浏览器存储 HSTS 缓存</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">✅</td>\n<td>浏览器直接转换成 HTTPS 访问 CDN</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">-</td>\n<td>http<strong>s</strong>: <a href=\"//uuanqin.top\">//uuanqin.top</a></td>\n<td>直接访问 CDN</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">❌</td>\n<td rowspan=\"2\">http:// <strong>www.</strong> uuanqin.top</td>\n<td>直接访问到服务器主机，Nginx 重定向至 <a href=\"https://uuanqin.top\">https://uuanqin.top</a> 进行访问。过程中浏览器会存储 HSTS 缓存</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">✅</td>\n<td>浏览器直接转换成 HTTPS，并直接访问到服务器主机，Nginx 重定向至 <a href=\"https://uuanqin.top\">https://uuanqin.top</a> 进行访问</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">-</td>\n<td>http<strong>s</strong>: // <strong>www.</strong> uuanqin.top</td>\n<td>直接访问到服务器主机，Nginx 重定向至 <a href=\"https://uuanqin.top\">https://uuanqin.top</a> 进行访问</td>\n</tr>\n</tbody>\n</table>\n<p>其中 uuanqin.top 为 CDN 加速域名。通常第一次访问时没有 HSTS 缓存。</p>\n\n<div class=\"callout\" data-callout=\"example\">\n<div class=\"callout-title\">\n<div class=\"callout-title-icon\">\n<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-list\"><line x1=\"8\" x2=\"21\" y1=\"6\" y2=\"6\"/><line x1=\"8\" x2=\"21\" y1=\"12\" y2=\"12\"/><line x1=\"8\" x2=\"21\" y1=\"18\" y2=\"18\"/><line x1=\"3\" x2=\"3.01\" y1=\"6\" y2=\"6\"/><line x1=\"3\" x2=\"3.01\" y1=\"12\" y2=\"12\"/><line x1=\"3\" x2=\"3.01\" y1=\"18\" y2=\"18\"/></svg>\n</div>\n<div class=\"callout-title-inner\">Q&amp;A</div>\n</div>\n<div class=\"callout-content\"><p><strong>为什么不在 CDN 同时设置两个加速域名？</strong></p>\n<p>很长一段时间以来一直都是这样设置，但是我觉得每次刷新都要同时刷新两个域名很不优雅，且耗费更多回源流量。此外还无法设置 301 重定向，造成 www 与不含 www 的域名同时存在。</p>\n<p>当然，流程图这种方式可能会暴露公网 IP，这是我认为本篇配置需要改变的原因。</p>\n<p><strong>为什么 www 域名不使用 CNAME 指向？</strong></p>\n<p>CNAME 不能达到“用户浏览器只显示无 www 网址”的目的。<s>（虽然这点好像不太重要，但我总是有这个执念）</s></p>\n</div></div><h1 id=\"操作\"><a class=\"markdownIt-Anchor\" href=\"#操作\"></a> 操作</h1>\n<p>作为新站长，一口气配置正确是不可能的，本文开头给出了循序渐进的配置参考，每一步都做正确了，配置才能逐渐成型。</p>\n<p>我们可以将上一小节的目标简要拆解成以下三个配置任务：</p>\n<p>a. 用户输入 <a href=\"http://uuanqin.top\">http://uuanqin.top</a> 必须跳转到 https: <a href=\"//uuanqin.top\">//uuanqin.top</a></p>\n<p>b. 用户输入 http://<strong>www</strong>.uuanqin.top 必须跳转到 https: <a href=\"//uuanqin.top\">//uuanqin.top</a></p>\n<p>c. 用户输入 http<strong>s</strong>: //<strong>www</strong>.uuanqin.top 必须跳转到 https: <a href=\"//uuanqin.top\">//uuanqin.top</a></p>\n<h2 id=\"dns-解析配置\"><a class=\"markdownIt-Anchor\" href=\"#dns-解析配置\"></a> DNS 解析配置</h2>\n<p>DNS 解析设置了这两条记录：</p>\n<table>\n<thead>\n<tr>\n<th>主机记录</th>\n<th>记录类型</th>\n<th>记录值</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>@</td>\n<td>A</td>\n<td>服务器 IP 地址</td>\n</tr>\n<tr>\n<td>www</td>\n<td>CNAME</td>\n<td>CDN 结点地址</td>\n</tr>\n</tbody>\n</table>\n<p>CNAME 记录的配置详看 CDN 中的要求。</p>\n<h2 id=\"cdn-加速设置\"><a class=\"markdownIt-Anchor\" href=\"#cdn-加速设置\"></a> CDN 加速设置</h2>\n<p>我假设你已经尝试过 CDN 了，你应该懂得啥是加速域名了吧。CDN 我只设置一个加速域名 uuanqin.top</p>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/20230724170143.png\" alt=\"image.png\" width=\"500px\" /></p>\n<p>在 HTTPS 设置中开启 301 强制跳转和 HSTS：</p>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/20230724170240.png\" alt=\"image.png\" width=\"500px\" /></p>\n<p>到此则完成了<strong>任务 a.</strong></p>\n<h2 id=\"nginx-配置\"><a class=\"markdownIt-Anchor\" href=\"#nginx-配置\"></a> Nginx 配置</h2>\n<p>打开 Nginx 的配置文件（不同版本的 Nginx 配置文件路径不太一样，1.22.1 的在/etc/nginx/conf.d/default.conf 中）</p>\n<p>处理 CDN 在进行源站回源时的请求：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server &#123;</span><br><span class=\"line\">     #HTTPS的默认访问端口443。</span><br><span class=\"line\">     #如果未在此处配置HTTPS的默认访问端口，可能会造成Nginx无法启动。</span><br><span class=\"line\">     listen 443 ssl;</span><br><span class=\"line\"></span><br><span class=\"line\">     #填写证书绑定的域名</span><br><span class=\"line\">     server_name  localhost;</span><br><span class=\"line\"></span><br><span class=\"line\">    #access_log  /var/log/nginx/host.access.log  main;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">        root   /var/www/uuanqin.top;</span><br><span class=\"line\">        index  index.html index.htm;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    # 404 页面配置，别忘记了</span><br><span class=\"line\">    error_page  404              /404.html;</span><br><span class=\"line\"></span><br><span class=\"line\">     #填写证书文件名称</span><br><span class=\"line\">     ssl_certificate conf.d/cert/www.uuanqin.top.pem;</span><br><span class=\"line\">     #填写证书私钥文件名称</span><br><span class=\"line\">     ssl_certificate_key conf.d/cert/www.uuanqin.top.key;</span><br><span class=\"line\"></span><br><span class=\"line\">     ssl_session_cache shared:SSL:1m;</span><br><span class=\"line\">     ssl_session_timeout 5m;</span><br><span class=\"line\"></span><br><span class=\"line\">     #默认加密套件</span><br><span class=\"line\">     ssl_ciphers HIGH:!aNULL:!MD5;</span><br><span class=\"line\"></span><br><span class=\"line\">     #自定义设置使用的TLS协议的类型以及加密套件（以下为配置示例，请您自行评估是否需要配置）</span><br><span class=\"line\">     #TLS协议版本越高，HTTPS通信的安全性越高，但是相较于低版本TLS协议，高版本TLS协议对浏览器的兼容性较差。</span><br><span class=\"line\">     #ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;</span><br><span class=\"line\">     #ssl_protocols TLSv1.1 TLSv1.2 TLSv1.3;</span><br><span class=\"line\"></span><br><span class=\"line\">     #表示优先使用服务端加密套件。默认开启</span><br><span class=\"line\">     ssl_prefer_server_ciphers on;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>将 http<strong>s</strong>: //<strong>www.</strong> uuanqin.top 重定向到 http<strong>s</strong>: <a href=\"//uuanqin.top\">//uuanqin.top</a>，完成<strong>任务 c.</strong>：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server &#123;</span><br><span class=\"line\">     #HTTPS的默认访问端口443。</span><br><span class=\"line\">     #如果未在此处配置HTTPS的默认访问端口，可能会造成Nginx无法启动。</span><br><span class=\"line\">     listen 443 ssl;</span><br><span class=\"line\"></span><br><span class=\"line\">     #填写证书绑定的域名</span><br><span class=\"line\">     server_name www.uuanqin.top;</span><br><span class=\"line\"></span><br><span class=\"line\">     rewrite ^(.*) https://uuanqin.top$1 permanent;</span><br><span class=\"line\"></span><br><span class=\"line\">     #填写证书文件名称</span><br><span class=\"line\">     ssl_certificate conf.d/cert/www.uuanqin.top.pem;</span><br><span class=\"line\">     #填写证书私钥文件名称</span><br><span class=\"line\">     ssl_certificate_key conf.d/cert/www.uuanqin.top.key;</span><br><span class=\"line\"></span><br><span class=\"line\">     ssl_session_cache shared:SSL:1m;</span><br><span class=\"line\">     ssl_session_timeout 5m;</span><br><span class=\"line\"></span><br><span class=\"line\">     #默认加密套件</span><br><span class=\"line\">     ssl_ciphers HIGH:!aNULL:!MD5;</span><br><span class=\"line\"></span><br><span class=\"line\">     #自定义设置使用的TLS协议的类型以及加密套件（以下为配置示例，请您自行评估是否需要配置）</span><br><span class=\"line\">     #TLS协议版本越高，HTTPS通信的安全性越高，但是相较于低版本TLS协议，高版本TLS协议对浏览器的兼容性较差。</span><br><span class=\"line\">     #ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;</span><br><span class=\"line\">     #ssl_protocols TLSv1.1 TLSv1.2 TLSv1.3;</span><br><span class=\"line\"></span><br><span class=\"line\">     #表示优先使用服务端加密套件。默认开启</span><br><span class=\"line\">     ssl_prefer_server_ciphers on;</span><br><span class=\"line\"></span><br><span class=\"line\">    #HSTS配置</span><br><span class=\"line\">    add_header Strict-Transport-Security &quot;max-age=3001&quot;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>其中 301 重定向关键：<code>rewrite ^(.*) https://uuanqin.top$1 permanent;</code></p>\n<p>HSTS 配置：<code>add_header Strict-Transport-Security &quot;max-age=3001&quot;;</code>，解释：</p>\n<ul>\n<li>添加一个名为 <code>Strict-Transport-Security</code> 的 HTTP 响应头，并设置了 HSTS 的相关选项</li>\n<li><code>max-age</code> 是必选参数，是一个以秒为单位的数值，它代表着 HSTS Header 的过期时间</li>\n<li><code>includeSubDomains</code> 是可选参数，如果包含它，则意味着当前域名及其子域名均开启 HSTS 保护</li>\n<li><code>preload</code> 是可选参数，只有当你申请将自己的域名加入到浏览器内置列表的时候才需要使用到，指示浏览器将网站添加到 HSTS 预加载列表中，以便所有浏览器都将始终使用 HTTPS 与网站建立连接。</li>\n</ul>\n<p>将 http: //<strong>www.</strong> uuanqin.top 重定向到 http<strong>s</strong>: <a href=\"//uuanqin.top\">//uuanqin.top</a>，完成<strong>任务 b.</strong>。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 首次访问</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen 80;</span><br><span class=\"line\">    #填写证书绑定的域名</span><br><span class=\"line\">    server_name www.uuanqin.top;</span><br><span class=\"line\"></span><br><span class=\"line\">    #将所有HTTP请求通过rewrite指令重定向到HTTPS。</span><br><span class=\"line\">    rewrite ^(.*) https://uuanqin.top$1 permanent;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"其他操作提示\"><a class=\"markdownIt-Anchor\" href=\"#其他操作提示\"></a> 其他操作提示</h1>\n<h2 id=\"清除浏览器chrome-edge的-hsts-307-缓存\"><a class=\"markdownIt-Anchor\" href=\"#清除浏览器chrome-edge的-hsts-307-缓存\"></a> 清除浏览器（Chrome、Edge）的 HSTS 307 缓存</h2>\n<p>配置 HSTS 后我们可以打开浏览器开发者工具，监视网络中包发送情况即可。有时候我们也需要清除 HSTS 的缓存。</p>\n<p><strong>Chrome 浏览器</strong>打开 chrome://net-internals/#hsts （<strong>Edge 浏览器</strong>直接点这个链接也没问题，它会自动重定向）</p>\n<p>先在 <strong>Query HSTS/PKP domain</strong> 查你被 307 Internal Redirect 的域名</p>\n<ul>\n<li>如果是 Not Found，这个就不是你要的答案</li>\n<li>如果有內容，如下图，那就到 Delete domain security policies 输入你被 307 Internal Redirect 的网址，然后 Delete 它。</li>\n</ul>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/20230724035022.png\" alt=\"image.png\" /></p>\n<p>现在你能使用 HTTP 访问该网址了。</p>\n<h2 id=\"nginx-安装配置\"><a class=\"markdownIt-Anchor\" href=\"#nginx-安装配置\"></a> Nginx 安装配置</h2>\n<p>可参考这篇文章：<a class=\"uuanqin-bilink\" target=\"_blank\" href=\"/p/661ecc9/\"><span class=\"yukari\">站内文章</span>Nginx 的安装与反向代理配置</a></p>\n<h2 id=\"百度站长\"><a class=\"markdownIt-Anchor\" href=\"#百度站长\"></a> 百度站长</h2>\n<p>弄好之后可以在百度站长弄个 HTTPS 认证，测试自己的成果。</p>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/20230724224936.png\" alt=\"image.png\" width=\"500px\" /></p>\n<h2 id=\"腾讯云-cdn-配置-https\"><a class=\"markdownIt-Anchor\" href=\"#腾讯云-cdn-配置-https\"></a> 腾讯云 CDN 配置 HTTPS</h2>\n<p>网站的图床也可以自定义域名和 HTTPS 等设置。</p>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/20230824094234.png\" alt=\"image.png\" /></p>\n<h2 id=\"在-cloudflare-dns-配置重定向\"><a class=\"markdownIt-Anchor\" href=\"#在-cloudflare-dns-配置重定向\"></a> 在 Cloudflare DNS 配置重定向</h2>\n<p>详看这篇文章：<a class=\"uuanqin-bilink\" target=\"_blank\" href=\"/p/41b77d61/\"><span class=\"yukari\">站内文章</span>域名 DNS 服务托管至 Cloudflare 以及 301 重定向的配置</a></p>\n<h1 id=\"本文参考\"><a class=\"markdownIt-Anchor\" href=\"#本文参考\"></a> 本文参考</h1>\n<ul>\n<li><a href=\"https://zhuanlan.zhihu.com/p/558171809#:~:text=%E5%93%AA%E4%BA%9B%E6%83%85%E5%86%B5%E9%9C%80%E8%A6%81%E5%81%9A301%E9%87%8D%E5%AE%9A%E5%90%91%EF%BC%9F%20%E7%BD%91%E9%A1%B5%E5%BC%80%E5%8F%91%E8%BF%87%E7%A8%8B%E4%B8%AD%EF%BC%8C%E6%97%B6%E5%B8%B8%E4%BC%9A%E9%81%87%E5%88%B0%E7%BD%91%E7%AB%99%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%E7%9A%84%E8%B0%83%E6%95%B4%EF%BC%8C%E5%B0%86%E9%A1%B5%E9%9D%A2%E8%BD%AC%E7%A7%BB%E5%88%B0%E4%B8%80%E4%B8%AA%E6%96%B0%E5%9C%B0%E5%9D%80%EF%BC%9B%E7%BD%91%E9%A1%B5%E6%89%A9%E5%B1%95%E5%90%8D%E7%9A%84%E6%94%B9%E5%8F%98%EF%BC%8C%E8%BF%99%E4%BA%9B%E5%8F%98%E5%8C%96%E9%83%BD%E4%BC%9A%E5%AF%BC%E8%87%B4%E7%BD%91%E9%A1%B5%E5%9C%B0%E5%9D%80%E5%8F%91%E7%94%9F%E6%94%B9%E5%8F%98%EF%BC%8C%E6%AD%A4%E6%97%B6%E7%94%A8%E6%88%B7%E6%94%B6%E8%97%8F%E5%A4%B9%E5%92%8C%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84%E6%97%A7%E5%9C%B0%E5%9D%80%E6%98%AF%E4%B8%80%E4%B8%AA%E9%94%99%E8%AF%AF%E7%9A%84%E5%9C%B0%E5%9D%80%EF%BC%8C%E8%AE%BF%E9%97%AE%E4%B9%8B%E5%90%8E%E4%BC%9A%E5%87%BA%E7%8E%B0404%E9%A1%B5%E9%9D%A2%EF%BC%8C%E7%9B%B4%E6%8E%A5%E5%AF%BC%E8%87%B4%E7%BD%91%E7%AB%99%E6%B5%81%E9%87%8F%E7%9A%84%E6%8D%9F%E5%A4%B1%E3%80%82%20%E6%88%96%E8%80%85%E6%98%AF%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E5%A4%9A%E4%B8%AA%E5%9F%9F%E5%90%8D%E8%B7%B3%E8%BD%AC%E8%87%B3%E5%90%8C%E4%B8%80%E4%B8%AA%E5%9F%9F%E5%90%8D%EF%BC%8C%E4%BE%8B%E5%A6%82%E6%9C%AC%E7%AB%99%E4%B8%BB%E7%AB%99%E7%82%B9%E5%9F%9F%E5%90%8D%E4%B8%BA%20www.conimi.com%20%EF%BC%8C%E8%80%8C%E8%BF%98%E6%9C%89%E4%B8%80%E4%B8%AA%E5%9F%9F%E5%90%8D%20www.nico.cc%20%EF%BC%8C%E7%94%B1%E4%BA%8E%E5%AF%B9%E8%AF%A5%E5%9F%9F%E5%90%8D%E8%AE%BE%E7%BD%AE%E4%BA%86301%E9%87%8D%E5%AE%9A%E5%90%91%EF%BC%8C%E5%BD%93%E8%BE%93%E5%85%A5,www.nico.cc%20%E6%97%B6%EF%BC%8C%E8%87%AA%E5%8A%A8%E8%B7%B3%E8%BD%AC%E8%87%B3%20www.conimi.com%20%E3%80%82%20%E4%B8%89.%20301%E9%87%8D%E5%AE%9A%E5%90%91%E6%9C%89%E4%BB%80%E4%B9%88%E4%BC%98%E7%82%B9%EF%BC%9F%20%E6%9C%89%E5%88%A9%E4%BA%8E%E7%BD%91%E7%AB%99%E9%A6%96%E9%80%89%E5%9F%9F%E7%9A%84%E7%A1%AE%E5%AE%9A%EF%BC%8C%E5%AF%B9%E4%BA%8E%E5%90%8C%E4%B8%80%E8%B5%84%E6%BA%90%E9%A1%B5%E9%9D%A2%E5%A4%9A%E6%9D%A1%E8%B7%AF%E5%BE%84%E7%9A%84301%E9%87%8D%E5%AE%9A%E5%90%91%E6%9C%89%E5%8A%A9%E4%BA%8EURL%E6%9D%83%E9%87%8D%E7%9A%84%E9%9B%86%E4%B8%AD%E3%80%82\">什么是 301 和 302 重定向，都有哪些用途？ - 知乎 (zhihu.com)</a></li>\n<li><a href=\"https://cloud.tencent.com/developer/article/1762070\">搞懂 HTTP 重定向 - 如何优雅地使用 301-腾讯云开发者社区-腾讯云 (tencent.com)</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/151764515\">HTTP 和 HTTPS 有什么区别？ - 知乎 (zhihu.com)</a></li>\n<li><a href=\"https://cloud.tencent.com/document/product/228/43827\">内容分发网络 CDN 新手指引-文档中心-腾讯云 (tencent.com)</a></li>\n<li><a href=\"https://xinshouzhanzhang.com/hsts.html\">HSTS 详解原理及配置 HTTP 到 HTTPS 再到 HSTS - 新手站长网 (xinshouzhanzhang.com)</a></li>\n<li><a href=\"https://segmentfault.com/a/1190000019745269\">清除 chrome 的 HSTS 307 缓存 - 前端小记 - SegmentFault 思否</a></li>\n<li><a href=\"https://cloud.tencent.com/developer/article/2301990\">如何在 Nginx 中启用 HSTS？-腾讯云开发者社区-腾讯云 (tencent.com)</a></li>\n<li><a href=\"https://cloud.tencent.com/developer/article/1852437\">Nginx 环境开启 ssl 后强制 https 301 全部指向 www 的方法-腾讯云开发者社区-腾讯云 (tencent.com)</a></li>\n</ul>\n","raw":"---\ntitle: Nginx 与 CDN 完成重定向：从 HTTP 重定向到 HTTPS、从 WWW 重定向到根\ntags:\n  - Nginx\n  - CDN\n  - 阿里云\n  - 腾讯云\n  - DNS\n  - HSTS\n  - HTTP\n  - HTTPS\n  - SSL\n  - 阿里巴巴\n  - 腾讯\n  - '301'\ncover: >-\n  https://cdn.gallery.uuanqin.top/img/%E7%BD%91%E7%AB%99%E9%85%8D%E7%BD%AEcover.png\ndescription: 精解本博客域名配置，建议熟悉 CDN、HTTPS 配置后参考。\nabbrlink: 83335cfa\ncategories:\n  - 博客站点维护\ndate: 2023-07-24 01:27:11\ntop_img:\n---\n\n> [!hint] 文章推荐：在 DNS 侧配置重定向\n> 通过 Cloudflare DNS 重定向规则可以更方便配置好重定向。详看这篇文章：[[域名 DNS 服务托管至 Cloudflare 以及 301 重定向的配置]]\n\n今天填了一个一直想填的坑，就是把博客域名的重定向、CDN 回源设置给弄好和捋顺了。以前的做法是 www.uuanqin.top 和 uuanqin.top 同时使用，CDN 也配置两条域名，但我总感觉不优雅、也不安全。通过学习一些**网络相关知识**，我自己尝试动手实验，绘制了**域名解析流程图**（把 DNS 迭代查询和递归查询简化拉平了）。此外把一些关键的**具体配置分享**出来并简要分析。\n\n镇楼图先放出来：\n\n![image.png](https://cdn.gallery.uuanqin.top/img/20230724025849.png)\n\n上图即为本站域名跳转关系，呕心沥血绘制。看着很复杂，实际......这张图体现的配置我还是感觉不太完美，限于目前的知识储备也就这样了，希望路过的大佬们在评论区指点迷津！！\n\n> 本文目的在于**分享交流**，所有操作仅供参考。\n\n> 如果你是萌新站长，建议不要直接上手本篇文章内容，先弄明白这几篇文章循序渐进开始：\n>\n> 1. 拥有了域名，配置主机 A 记录，直接指向源站：[新手引导 (aliyun.com)](https://help.aliyun.com/document_detail/29716.html?spm=a2c4g.11186623.0.0.37fc1f12nXmqC1)\n> 2. 使用 CDN 服务，并加速域名：[内容分发网络 CDN 从零开始配置 CDN-快速入门-文档中心-腾讯云 (tencent.com)](https://cloud.tencent.com/document/product/228/3149)\n> 3. 网站使用 HTTPS：[SSL 证书使用指南 (aliyun.com)](https://help.aliyun.com/document_detail/28534.html?spm=a2c4g.98728.0.0.4aa6115dQ3KtyS)\n\n# 环境\n\n我的整个博客项目不同服务由不同服务商提供，之所以没选择 All in one 除了想自己边折腾边学习外，还是想让各种服务松耦合起来。\n\n博客使用的服务以及部分软件系统版本如下：\n\n| DNS 域名解析 | SSL 证书 | CDN 服务 |      云服务器      |    Web 服务    |\n| :------: | :----: | :----: | :------------: | :----------: |\n|   阿里云    |  阿里云   |  腾讯云   | 阿里云 ECS（Linux） | Nginx 1.22.1 |\n\n不管是阿里云还是腾讯云，相关服务的使用大差不差，本文只是给个思路。\n\n# 配置效果与原因\n\n理想的域名配置效果应该是这样的：\n\n1. 用户在地址栏输入 www.uuanqin.top 时会直接重定向到 uuanqin.top，地址栏不显示 www 地址\n2. 所有 http 不安全链接自动指向 https 链接\n3. 使用 HSTS 在尽可能保证安全的同时减少重定向次数\n4. 精简 CDN 回源配置\n\n如果想直接看操作过程的跳下一节，想看原因的请继续往下阅读。\n\n## 301 重定向的优点（www 重定向到不带 www 的地址）\n\n你会发现互联网上一些网站的输入 www 开头网址跳转后，地址栏 www 会消失（或相反：不输 www 反而跳到显示 www，例如 baidu.com）。它们都使用了一种非常重要的「自动转向」技术——301 重定向。\n\n301 重定向（301 Move Permanently），指**页面永久性转移**，表示为资源或页面永久性地转移到了另一个位置。301 是 HTTP 协议中的一种**状态码**，当用户或搜索引擎向服务器发出浏览请求时，服务器返回的 HTTP 数据流中头信息（header）中包含状态码 301 ，表示该资源已经永久改变了位置。\n\n过程如图：\n\n![image.png](https://cdn.gallery.uuanqin.top/img/20230724020428.png)\n\n利用 301 重定向设置网站别名有利于网站首选域的确定，对于同一资源页面多条路径的 301 重定向有助于 URL 权重的集中，利于网站 SEO。\n\n302 重定向（302 Move Temporarily），指页面**暂时性转移**，表示资源或页面暂时转移到另一个位置，常被用作网址劫持，容易导致网站降权，严重时网站会被封掉，不推荐使用。\n\n搜索引擎是这样对待两种重定向的：\n\n|     重定向方式     |                  搜索引擎抓取操作                  |\n| :----------------: | :------------------------------------------------: |\n| 301 页面永久性转移 | 抓取新内容的同时也将旧的网址替换成重定向之后的网址 |\n| 302 页面暂时性转移 | 抓取新的内容而保存旧的网址并认为新的网址只是暂时的 |\n\n## HTTP 跳转到 HTTPS\n\nHTTP 协议也就是超文本传输协议，是一种使用**明文数据**传输的网络协议，不提供任何方式的数据加密。如果攻击者截取了 Web 浏览器和网站服务器之间的传输报文，就可以直接读懂其中的信息。\n\n为了数据传输的安全，另一种协议 HTTPS（安全套接字层超文本传输协议）诞生。HTTPS 在 HTTP 的基础上加入了 SSL/TLS 协议，SSL/TLS 依靠证书来验证服务器的身份，并为浏览器和服务器之间的通信加密。\n\nHTTP 和 HTTPS 使用的是完全不同的连接方式，同时使用的端口也不同，网络模型工作层不同：\n\n|               协议               |     传输方式     | 端口 | 工作层 |\n| :------------------------------: | :--------------: | :--: | :----: |\n|       HTTP 超文本传输协议        |     明文传输     |  80  | 应用层 |\n| HTTPS 安全套接字层超文本传输协议 | SSL/TLS 协议加密 | 443  | 传输层 |\n\nHTTPS 有利于搜索排名的提升。百度和谷歌两大搜索引擎都已经明确表示，HTTPS 网站将会作为搜索排名的一个重要权重指标。也就是说 HTTPS 网站比起 HTTP 网站在搜索排名中更有优势。\n\n## 为什么使用 CDN？\n\n当用户直接访问源站中的静态内容时，可能面临的体验问题：\n\n- 客户离服务器越远，访问速度越慢。\n- 客户数量越多，网络带宽费用越高。\n- 跨境用户访问体验较差。\n\n![image.png](https://cdn.gallery.uuanqin.top/img/20230724022324.png)\n\nCDN 如何改善您的网络体验：\n\n- CDN 缓存内容后，用户仅需要访问就近的 CDN 节点即可获取静态内容。\n- 缓解源站带宽压力，网络费用更低。\n- 分布全球的跨境节点提升跨境访问体验。\n\n![image.png](https://cdn.gallery.uuanqin.top/img/20230724022332.png)\n\n> [!hint] 为什么不要用 CDN？\n> CDN 增加网站的被攻击风险，若安全措施没有实施到位，容易产生高额账单。比如在 2024 年，本站遭遇大量恶意攻击并造成一定程度的财产损失。\n\n## HSTS 是什么？\n\n上文提到 HTTPS 可以提高安全性，是“更加安全的 HTTP”，但 HTTPS 提供服务也不是安全的。\n\n最初网站是通过 HTTP 协议提供服务，为了安全起见，网站升级为 HTTPS 协议，可是当用户在浏览器中输入网址时，例如 www.uuanqin.top ，而不是输入完整的 www.uuanqin.top ，浏览器会向网站**发起一次 HTTP 请求**，这时浏览器获取到一个重定向到 HTTPS 的请求（就像上文我们说的 301 重定向），然后再使用 HTTPS 协议通信。在这个过程中，我们使用了一次明文的 HTTP 请求和重定向，而这个过程很容易被攻击者利用，攻击者可以以中间人的方式劫持这次请求，从而进行后续的攻击，例如窃听数据，篡改请求和响应，跳转到钓鱼网站等。\n\n为了避免这个问题，我们希望**浏览器**做到：当用户输入网址时（不带 https:// ）将其转换成 HTTPS 请求，从而绕过明文的 HTTP 请求和重定向。我们使用 HSTS 可以告诉浏览器这个网站是否是使用的 HTTPS。\n\nHSTS 的全称是 HTTP Strict-Transport-Security，它是一个 Web 安全策略机制。HSTS 的核心是**HTTP 响应头**（HTTP Response Header），它告诉浏览器在接下来的一段时间，这个域名只能通过 HTTPS 进行访问，如果该域名在浏览器中出现不安全访问，HSTS 会强制用户的访问。\n\nHSTS Header 中可以设置其过期时间，比如 1 年。注意如果网站 SSL 证书出现问题，那么用户在一年的时间里都没法正常访问你的网站了，当然，除非用户清除了浏览器缓存。\n\nHSTS 也并不安全。假设浏览器中没有该域名的 HSTS 信息时，用户第一次访问该网站时，依然需要使用明文的 HTTP 请求和重定向，解决方法是 Preload List，感兴趣的同学可以自己搜索，这里就不再赘述。\n\n# 网址转换过程\n\nDNS 解析链接地址的大致流程如下：\n\n![img|400](https://cdn.gallery.uuanqin.top/img/202410272103714.webp)\n\n如果我们把上面 DNS 递归解析、迭代解析的过程拉平，并取出其中的主要结点，那么可以得到下图：\n\n![image.png](https://cdn.gallery.uuanqin.top/img/20230724025849.png)\n\n过程图解析：\n\n| 浏览器有无 HSTS 缓存 | 用户在地址栏输入                   | 路径                                                                                            |\n| :------------------: | ---------------------------------- | ----------------------------------------------------------------------------------------------- |\n|          ❌          | http://uuanqin.top                 | 腾讯云 CDN 将其重定向至 HTTPS 再访问 CDN 边缘节点，同时浏览器存储 HSTS 缓存                     |\n|          ✅          | http://uuanqin.top                 | 浏览器直接转换成 HTTPS 访问 CDN                                                                 |\n|          -           | http**s**: //uuanqin.top           | 直接访问 CDN                                                                                    |\n|          ❌          | http:// **www.** uuanqin.top       | 直接访问到服务器主机，Nginx 重定向至 https://uuanqin.top 进行访问。过程中浏览器会存储 HSTS 缓存 |\n|          ✅          | http:// **www.** uuanqin.top       | 浏览器直接转换成 HTTPS，并直接访问到服务器主机，Nginx 重定向至 https://uuanqin.top 进行访问     |\n|          -           | http**s**: // **www.** uuanqin.top | 直接访问到服务器主机，Nginx 重定向至 https://uuanqin.top 进行访问                               |\n\n其中 uuanqin.top 为 CDN 加速域名。通常第一次访问时没有 HSTS 缓存。\n\n> [!example] Q&A\n> **为什么不在 CDN 同时设置两个加速域名？**\n>\n> 很长一段时间以来一直都是这样设置，但是我觉得每次刷新都要同时刷新两个域名很不优雅，且耗费更多回源流量。此外还无法设置 301 重定向，造成 www 与不含 www 的域名同时存在。\n>\n> 当然，流程图这种方式可能会暴露公网 IP，这是我认为本篇配置需要改变的原因。\n>\n> **为什么 www 域名不使用 CNAME 指向？**\n>\n> CNAME 不能达到“用户浏览器只显示无 www 网址”的目的。~~（虽然这点好像不太重要，但我总是有这个执念）~~\n\n# 操作\n\n作为新站长，一口气配置正确是不可能的，本文开头给出了循序渐进的配置参考，每一步都做正确了，配置才能逐渐成型。\n\n我们可以将上一小节的目标简要拆解成以下三个配置任务：\n\na. 用户输入 http://uuanqin.top 必须跳转到 https: //uuanqin.top\n\nb. 用户输入 http://**www**.uuanqin.top 必须跳转到 https: //uuanqin.top\n\nc. 用户输入 http**s**: //**www**.uuanqin.top 必须跳转到 https: //uuanqin.top\n\n## DNS 解析配置\n\nDNS 解析设置了这两条记录：\n\n| 主机记录 | 记录类型  | 记录值       |\n| ---- | ----- | --------- |\n| @    | A     | 服务器 IP 地址 |\n| www  | CNAME | CDN 结点地址  |\n\nCNAME 记录的配置详看 CDN 中的要求。\n\n## CDN 加速设置\n\n我假设你已经尝试过 CDN 了，你应该懂得啥是加速域名了吧。CDN 我只设置一个加速域名 uuanqin.top\n\n![image.png|500](https://cdn.gallery.uuanqin.top/img/20230724170143.png)\n\n在 HTTPS 设置中开启 301 强制跳转和 HSTS：\n\n![image.png|500](https://cdn.gallery.uuanqin.top/img/20230724170240.png)\n\n到此则完成了**任务 a.**\n\n## Nginx 配置\n\n打开 Nginx 的配置文件（不同版本的 Nginx 配置文件路径不太一样，1.22.1 的在/etc/nginx/conf.d/default.conf 中）\n\n处理 CDN 在进行源站回源时的请求：\n\n```conf\nserver {\n     #HTTPS的默认访问端口443。\n     #如果未在此处配置HTTPS的默认访问端口，可能会造成Nginx无法启动。\n     listen 443 ssl;\n\n     #填写证书绑定的域名\n     server_name  localhost;\n\n    #access_log  /var/log/nginx/host.access.log  main;\n\n    location / {\n        root   /var/www/uuanqin.top;\n        index  index.html index.htm;\n    }\n    # 404 页面配置，别忘记了\n    error_page  404              /404.html;\n\n     #填写证书文件名称\n     ssl_certificate conf.d/cert/www.uuanqin.top.pem;\n     #填写证书私钥文件名称\n     ssl_certificate_key conf.d/cert/www.uuanqin.top.key;\n\n     ssl_session_cache shared:SSL:1m;\n     ssl_session_timeout 5m;\n\n     #默认加密套件\n     ssl_ciphers HIGH:!aNULL:!MD5;\n\n     #自定义设置使用的TLS协议的类型以及加密套件（以下为配置示例，请您自行评估是否需要配置）\n     #TLS协议版本越高，HTTPS通信的安全性越高，但是相较于低版本TLS协议，高版本TLS协议对浏览器的兼容性较差。\n     #ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;\n     #ssl_protocols TLSv1.1 TLSv1.2 TLSv1.3;\n\n     #表示优先使用服务端加密套件。默认开启\n     ssl_prefer_server_ciphers on;\n}\n```\n\n将 http**s**: //**www.** uuanqin.top 重定向到 http**s**: //uuanqin.top，完成**任务 c.**：\n\n```conf\nserver {\n     #HTTPS的默认访问端口443。\n     #如果未在此处配置HTTPS的默认访问端口，可能会造成Nginx无法启动。\n     listen 443 ssl;\n\n     #填写证书绑定的域名\n     server_name www.uuanqin.top;\n\n     rewrite ^(.*) https://uuanqin.top$1 permanent;\n\n     #填写证书文件名称\n     ssl_certificate conf.d/cert/www.uuanqin.top.pem;\n     #填写证书私钥文件名称\n     ssl_certificate_key conf.d/cert/www.uuanqin.top.key;\n\n     ssl_session_cache shared:SSL:1m;\n     ssl_session_timeout 5m;\n\n     #默认加密套件\n     ssl_ciphers HIGH:!aNULL:!MD5;\n\n     #自定义设置使用的TLS协议的类型以及加密套件（以下为配置示例，请您自行评估是否需要配置）\n     #TLS协议版本越高，HTTPS通信的安全性越高，但是相较于低版本TLS协议，高版本TLS协议对浏览器的兼容性较差。\n     #ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;\n     #ssl_protocols TLSv1.1 TLSv1.2 TLSv1.3;\n\n     #表示优先使用服务端加密套件。默认开启\n     ssl_prefer_server_ciphers on;\n\n    #HSTS配置\n    add_header Strict-Transport-Security \"max-age=3001\";\n}\n```\n\n其中 301 重定向关键：`rewrite ^(.*) https://uuanqin.top$1 permanent;`\n\nHSTS 配置：`add_header Strict-Transport-Security \"max-age=3001\";`，解释：\n\n- 添加一个名为 `Strict-Transport-Security` 的 HTTP 响应头，并设置了 HSTS 的相关选项\n- `max-age` 是必选参数，是一个以秒为单位的数值，它代表着 HSTS Header 的过期时间\n- `includeSubDomains` 是可选参数，如果包含它，则意味着当前域名及其子域名均开启 HSTS 保护\n- `preload` 是可选参数，只有当你申请将自己的域名加入到浏览器内置列表的时候才需要使用到，指示浏览器将网站添加到 HSTS 预加载列表中，以便所有浏览器都将始终使用 HTTPS 与网站建立连接。\n\n将 http: //**www.** uuanqin.top 重定向到 http**s**: //uuanqin.top，完成**任务 b.**。\n\n```conf\n# 首次访问\nserver {\n    listen 80;\n    #填写证书绑定的域名\n    server_name www.uuanqin.top;\n\n    #将所有HTTP请求通过rewrite指令重定向到HTTPS。\n    rewrite ^(.*) https://uuanqin.top$1 permanent;\n}\n```\n\n# 其他操作提示\n\n## 清除浏览器（Chrome、Edge）的 HSTS 307 缓存\n\n配置 HSTS 后我们可以打开浏览器开发者工具，监视网络中包发送情况即可。有时候我们也需要清除 HSTS 的缓存。\n\n**Chrome 浏览器**打开 chrome://net-internals/#hsts （**Edge 浏览器**直接点这个链接也没问题，它会自动重定向）\n\n先在 **Query HSTS/PKP domain** 查你被 307 Internal Redirect 的域名\n\n- 如果是 Not Found，这个就不是你要的答案\n- 如果有內容，如下图，那就到 Delete domain security policies 输入你被 307 Internal Redirect 的网址，然后 Delete 它。\n\n![image.png](https://cdn.gallery.uuanqin.top/img/20230724035022.png)\n\n现在你能使用 HTTP 访问该网址了。\n\n## Nginx 安装配置\n\n可参考这篇文章：[[Nginx 的安装与反向代理配置]]\n\n## 百度站长\n\n弄好之后可以在百度站长弄个 HTTPS 认证，测试自己的成果。\n\n![image.png|500](https://cdn.gallery.uuanqin.top/img/20230724224936.png)\n\n## 腾讯云 CDN 配置 HTTPS\n\n网站的图床也可以自定义域名和 HTTPS 等设置。\n\n![image.png](https://cdn.gallery.uuanqin.top/img/20230824094234.png)\n\n## 在 Cloudflare DNS 配置重定向\n\n详看这篇文章：[[域名 DNS 服务托管至 Cloudflare 以及 301 重定向的配置]]\n\n# 本文参考\n\n- [什么是 301 和 302 重定向，都有哪些用途？ - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/558171809#:~:text=%E5%93%AA%E4%BA%9B%E6%83%85%E5%86%B5%E9%9C%80%E8%A6%81%E5%81%9A301%E9%87%8D%E5%AE%9A%E5%90%91%EF%BC%9F%20%E7%BD%91%E9%A1%B5%E5%BC%80%E5%8F%91%E8%BF%87%E7%A8%8B%E4%B8%AD%EF%BC%8C%E6%97%B6%E5%B8%B8%E4%BC%9A%E9%81%87%E5%88%B0%E7%BD%91%E7%AB%99%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%E7%9A%84%E8%B0%83%E6%95%B4%EF%BC%8C%E5%B0%86%E9%A1%B5%E9%9D%A2%E8%BD%AC%E7%A7%BB%E5%88%B0%E4%B8%80%E4%B8%AA%E6%96%B0%E5%9C%B0%E5%9D%80%EF%BC%9B%E7%BD%91%E9%A1%B5%E6%89%A9%E5%B1%95%E5%90%8D%E7%9A%84%E6%94%B9%E5%8F%98%EF%BC%8C%E8%BF%99%E4%BA%9B%E5%8F%98%E5%8C%96%E9%83%BD%E4%BC%9A%E5%AF%BC%E8%87%B4%E7%BD%91%E9%A1%B5%E5%9C%B0%E5%9D%80%E5%8F%91%E7%94%9F%E6%94%B9%E5%8F%98%EF%BC%8C%E6%AD%A4%E6%97%B6%E7%94%A8%E6%88%B7%E6%94%B6%E8%97%8F%E5%A4%B9%E5%92%8C%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84%E6%97%A7%E5%9C%B0%E5%9D%80%E6%98%AF%E4%B8%80%E4%B8%AA%E9%94%99%E8%AF%AF%E7%9A%84%E5%9C%B0%E5%9D%80%EF%BC%8C%E8%AE%BF%E9%97%AE%E4%B9%8B%E5%90%8E%E4%BC%9A%E5%87%BA%E7%8E%B0404%E9%A1%B5%E9%9D%A2%EF%BC%8C%E7%9B%B4%E6%8E%A5%E5%AF%BC%E8%87%B4%E7%BD%91%E7%AB%99%E6%B5%81%E9%87%8F%E7%9A%84%E6%8D%9F%E5%A4%B1%E3%80%82%20%E6%88%96%E8%80%85%E6%98%AF%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E5%A4%9A%E4%B8%AA%E5%9F%9F%E5%90%8D%E8%B7%B3%E8%BD%AC%E8%87%B3%E5%90%8C%E4%B8%80%E4%B8%AA%E5%9F%9F%E5%90%8D%EF%BC%8C%E4%BE%8B%E5%A6%82%E6%9C%AC%E7%AB%99%E4%B8%BB%E7%AB%99%E7%82%B9%E5%9F%9F%E5%90%8D%E4%B8%BA%20www.conimi.com%20%EF%BC%8C%E8%80%8C%E8%BF%98%E6%9C%89%E4%B8%80%E4%B8%AA%E5%9F%9F%E5%90%8D%20www.nico.cc%20%EF%BC%8C%E7%94%B1%E4%BA%8E%E5%AF%B9%E8%AF%A5%E5%9F%9F%E5%90%8D%E8%AE%BE%E7%BD%AE%E4%BA%86301%E9%87%8D%E5%AE%9A%E5%90%91%EF%BC%8C%E5%BD%93%E8%BE%93%E5%85%A5,www.nico.cc%20%E6%97%B6%EF%BC%8C%E8%87%AA%E5%8A%A8%E8%B7%B3%E8%BD%AC%E8%87%B3%20www.conimi.com%20%E3%80%82%20%E4%B8%89.%20301%E9%87%8D%E5%AE%9A%E5%90%91%E6%9C%89%E4%BB%80%E4%B9%88%E4%BC%98%E7%82%B9%EF%BC%9F%20%E6%9C%89%E5%88%A9%E4%BA%8E%E7%BD%91%E7%AB%99%E9%A6%96%E9%80%89%E5%9F%9F%E7%9A%84%E7%A1%AE%E5%AE%9A%EF%BC%8C%E5%AF%B9%E4%BA%8E%E5%90%8C%E4%B8%80%E8%B5%84%E6%BA%90%E9%A1%B5%E9%9D%A2%E5%A4%9A%E6%9D%A1%E8%B7%AF%E5%BE%84%E7%9A%84301%E9%87%8D%E5%AE%9A%E5%90%91%E6%9C%89%E5%8A%A9%E4%BA%8EURL%E6%9D%83%E9%87%8D%E7%9A%84%E9%9B%86%E4%B8%AD%E3%80%82)\n- [搞懂 HTTP 重定向 - 如何优雅地使用 301-腾讯云开发者社区-腾讯云 (tencent.com)](https://cloud.tencent.com/developer/article/1762070)\n- [HTTP 和 HTTPS 有什么区别？ - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/151764515)\n- [内容分发网络 CDN 新手指引-文档中心-腾讯云 (tencent.com)](https://cloud.tencent.com/document/product/228/43827)\n- [HSTS 详解原理及配置 HTTP 到 HTTPS 再到 HSTS - 新手站长网 (xinshouzhanzhang.com)](https://xinshouzhanzhang.com/hsts.html)\n- [清除 chrome 的 HSTS 307 缓存 - 前端小记 - SegmentFault 思否](https://segmentfault.com/a/1190000019745269)\n- [如何在 Nginx 中启用 HSTS？-腾讯云开发者社区-腾讯云 (tencent.com)](https://cloud.tencent.com/developer/article/2301990)\n- [Nginx 环境开启 ssl 后强制 https 301 全部指向 www 的方法-腾讯云开发者社区-腾讯云 (tencent.com)](https://cloud.tencent.com/developer/article/1852437)\n","categories":[{"name":"博客站点维护","api":"api/categories/博客站点维护.json"}],"tags":[{"name":"阿里云","api":"api/tags/阿里云.json"},{"name":"CDN","api":"api/tags/CDN.json"},{"name":"HTTPS","api":"api/tags/HTTPS.json"},{"name":"SSL","api":"api/tags/SSL.json"},{"name":"腾讯云","api":"api/tags/腾讯云.json"},{"name":"Nginx","api":"api/tags/Nginx.json"},{"name":"DNS","api":"api/tags/DNS.json"},{"name":"HSTS","api":"api/tags/HSTS.json"},{"name":"HTTP","api":"api/tags/HTTP.json"},{"name":"阿里巴巴","api":"api/tags/阿里巴巴.json"},{"name":"腾讯","api":"api/tags/腾讯.json"},{"name":"301","api":"api/tags/301.json"}]},"api":"api/posts/p/83335cfa.json"}