{"data":{"title":"多环境部署项目","slug":"工程/多环境部署项目","description":"不同技术中实现多环境的方式。","date":"2024-07-23T16:10:09.000Z","updated":"2026-02-02T16:47:28.127Z","language":"zh-CN","comments":true,"url":"p/7b0cf4e9/","cover":"https://cdn.gallery.uuanqin.top/img/202602030047339.webp","images":[],"content":"<h1 id=\"不同的环境\"><a class=\"markdownIt-Anchor\" href=\"#不同的环境\"></a> 不同的环境</h1>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/202602021421713.webp\" alt=\"image.png\" width=\"500px\" /></p>\n<p>本地环境：一般用 <code>local</code> 标识，是指前端或后端独立开发、自主测试的环境。通常就是让项目和依赖在我们自己的电脑上运行，比如数据库、缓存、队列等各种服务，可能需要自己在本地搭建。</p>\n<p>开发环境：一般用 <code>dev</code> 标识，是指前端和后端（或者多个程序员）一起协作开发、联调的环境。通常将项目和依赖放在员工电脑可以直接访问的开发机上，不用自己搭建，直接跑起来项目，提高开发和协作效率。对规模不大的团队来说，开发和本地环境其实有一套就够了，毕竟本地也可以连接公用的数据库等服务。</p>\n<p>测试环境：一般用 <code>test</code> 标识，是指前端和后端开发和联调完成，做出完整的新功能后，交给测试人员找 Bug 的环境。通常在测试环境需要有独立的测试数据库和其他服务。每次修改完 Bug 后，也都要再次发布项目到测试环境，让测试人员重新验证。</p>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/202602021425185.webp\" alt=\"image.png\" width=\"400px\" /></p>\n<p>预发布环境：一般用 <code>pre</code> 标识，这是和线上项目最接近的环境，一般是测试验证通过、产品经理体验过后，才能将项目发布到这个环境。实际上，预发布环境的项目调用的后端接口、连接的数据库、服务等都和线上项目一致 ，和线上唯一的区别就是前端访问的域名不同。正因如此，预发布环境看到的都是真实的用户数据，可以发现更多测试环境因为数据不足而没查出来的 Bug。</p>\n<p>生产环境：一般用 <code>prod</code> 标识，又叫线上环境，是给所有真实用户使用的环境。因此不能随意修改，且发布项目到该环境时必须格外小心。线上的数据库、机器等资源一般也是由专业的运维来负责，想要登录机器、修改配置，都需要经过严格审批。</p>\n<p>多环境的目的是，让同一套代码在不同的开发阶段时，根据实际环境调整相应的配置。</p>\n<h1 id=\"可以调整配置的地方\"><a class=\"markdownIt-Anchor\" href=\"#可以调整配置的地方\"></a> 可以调整配置的地方</h1>\n<p>最基本的流程为，我们需要在程序中写好读取环境变量的代码，然后在打包阶段指定环境即可。</p>\n<p>常见的需要多环境配置的变量：</p>\n<ul>\n<li>本地日志级别</li>\n<li>数据库连接参数</li>\n<li>JVM 参数</li>\n</ul>\n<p>程序中编写读入环境变量的代码：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 读取 env 参数</span></span><br><span class=\"line\"><span class=\"type\">String</span> <span class=\"variable\">env</span> <span class=\"operator\">=</span> System.getProperty(<span class=\"string\">&quot;env&quot;</span>);</span><br><span class=\"line\"><span class=\"keyword\">new</span> <span class=\"title class_\">DBConfig</span>(<span class=\"string\">&quot;db-&quot;</span> + env + <span class=\"string\">&quot;.properties&quot;</span>);</span><br></pre></td></tr></table></figure>\n<p>在最后的编译打包环节中，通过注入参数指定环境。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">测试环境</span></span><br><span class=\"line\">java -jar -Denv=test dist.jar</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">生产环境</span></span><br><span class=\"line\">java -jar -Dend=prod dist.jar</span><br></pre></td></tr></table></figure>\n<h1 id=\"springboot-多环境配置\"><a class=\"markdownIt-Anchor\" href=\"#springboot-多环境配置\"></a> SpringBoot 多环境配置</h1>\n<h2 id=\"项目依赖多环境\"><a class=\"markdownIt-Anchor\" href=\"#项目依赖多环境\"></a> 项目依赖多环境</h2>\n<p>引入项目依赖时，可通过 <code>&lt;scope&gt;</code> 字段指定不同环境中需要引入的依赖，通过这种方式可以精简生成环境中项目的依赖，减少体积。常见字段有 <code>test</code>、<code>compile</code>。</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!--测试环境--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-test<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">scope</span>&gt;</span>test<span class=\"tag\">&lt;/<span class=\"name\">scope</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"激活不同的配置文件\"><a class=\"markdownIt-Anchor\" href=\"#激活不同的配置文件\"></a> 激活不同的配置文件</h2>\n<p>我们可以通过配置文件化的方式实现不同环境中的配置。在配置文件加入后缀即可区分多环境应用的配置文件：</p>\n<ul>\n<li><code>application.yml</code> 表示公共配置</li>\n<li><code>application-dev.yml</code> 表示开发环境的额外配置</li>\n<li><code>application-prod.yml</code> 表示生产环境的额外配置</li>\n</ul>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/202602021427380.webp\" alt=\"image.png\" width=\"304px\" /></p>\n<p>Maven 执行打包命令（IDEA 右侧 Maven 工具栏 -&gt; Lifecycle -&gt; package）后，会在 target 文件夹中生成 jar 包。我们可以用环境参数运行这个 jar 包，这样就能实现多环境的切换。</p>\n\n<div class=\"callout\" data-callout=\"hint\">\n<div class=\"callout-title\">\n<div class=\"callout-title-icon\">\n<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-flame\"><path d=\"M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z\"/></svg>\n</div>\n<div class=\"callout-title-inner\">SpringBoot 项目打包操作依赖</div>\n</div>\n<div class=\"callout-content\"><p>进行打包时需要引入 <code>spring-boot-maven-plugin</code>。不过基于官方骨架创建项目，会自动添加这个插件。</p>\n</div></div><blockquote>\n<p>打包时可以在 IDEA 的 Maven 命令面板中选择 <code>Skip Tests</code> 禁掉单元测试。</p>\n</blockquote>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">检查 Java 安装情况</span></span><br><span class=\"line\">java --version</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">指定 prod 生产环境</span></span><br><span class=\"line\">java -jar .\\your-project-0.0.1-SNAPSHOT.jar --spring.profiles.active=prod</span><br></pre></td></tr></table></figure>\n<p>当然，打包环节也可以传入环境参数，只不过这样就没有那么灵活。</p>\n<p>我们可以通过看 SpringBoot 的启动日志查看哪个配置文件生效了：</p>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/202602021601928.webp\" alt=\"image.png\" /></p>\n<h1 id=\"umi-多环境配置\"><a class=\"markdownIt-Anchor\" href=\"#umi-多环境配置\"></a> Umi 多环境配置</h1>\n<p>官方文档参考：<a href=\"https://umijs.org/docs/guides/env-variables#umi_env\">环境变量</a></p>\n<h1 id=\"本文参考\"><a class=\"markdownIt-Anchor\" href=\"#本文参考\"></a> 本文参考</h1>\n<ul>\n<li><a href=\"https://code.yupi.icu/%E5%A4%9A%E7%8E%AF%E5%A2%83/\">多环境 | 鱼皮的编程宝典</a></li>\n</ul>\n","raw":"---\ntitle: 多环境部署项目\ndate: 2024-07-24 00:10:09\ntags:\n    - SpringBoot\n    - Umi\ncover: https://cdn.gallery.uuanqin.top/img/202602030047339.webp\ndescription: 不同技术中实现多环境的方式。\ntop_img: \nkatex: false\n---\n\n# 不同的环境\n\n![image.png|500](https://cdn.gallery.uuanqin.top/img/202602021421713.webp)\n\n本地环境：一般用 `local` 标识，是指前端或后端独立开发、自主测试的环境。通常就是让项目和依赖在我们自己的电脑上运行，比如数据库、缓存、队列等各种服务，可能需要自己在本地搭建。\n\n开发环境：一般用 `dev` 标识，是指前端和后端（或者多个程序员）一起协作开发、联调的环境。通常将项目和依赖放在员工电脑可以直接访问的开发机上，不用自己搭建，直接跑起来项目，提高开发和协作效率。对规模不大的团队来说，开发和本地环境其实有一套就够了，毕竟本地也可以连接公用的数据库等服务。\n\n测试环境：一般用 `test` 标识，是指前端和后端开发和联调完成，做出完整的新功能后，交给测试人员找 Bug 的环境。通常在测试环境需要有独立的测试数据库和其他服务。每次修改完 Bug 后，也都要再次发布项目到测试环境，让测试人员重新验证。\n\n![image.png|400](https://cdn.gallery.uuanqin.top/img/202602021425185.webp)\n\n预发布环境：一般用 `pre` 标识，这是和线上项目最接近的环境，一般是测试验证通过、产品经理体验过后，才能将项目发布到这个环境。实际上，预发布环境的项目调用的后端接口、连接的数据库、服务等都和线上项目一致 ，和线上唯一的区别就是前端访问的域名不同。正因如此，预发布环境看到的都是真实的用户数据，可以发现更多测试环境因为数据不足而没查出来的 Bug。\n\n生产环境：一般用 `prod` 标识，又叫线上环境，是给所有真实用户使用的环境。因此不能随意修改，且发布项目到该环境时必须格外小心。线上的数据库、机器等资源一般也是由专业的运维来负责，想要登录机器、修改配置，都需要经过严格审批。\n\n多环境的目的是，让同一套代码在不同的开发阶段时，根据实际环境调整相应的配置。\n\n# 可以调整配置的地方\n\n最基本的流程为，我们需要在程序中写好读取环境变量的代码，然后在打包阶段指定环境即可。\n\n常见的需要多环境配置的变量：\n\n- 本地日志级别\n- 数据库连接参数\n- JVM 参数\n\n程序中编写读入环境变量的代码：\n\n```java\n// 读取 env 参数\nString env = System.getProperty(\"env\");\nnew DBConfig(\"db-\" + env + \".properties\");\n```\n\n在最后的编译打包环节中，通过注入参数指定环境。\n\n```shell\n# 测试环境\njava -jar -Denv=test dist.jar\n# 生产环境\njava -jar -Dend=prod dist.jar\n```\n\n# SpringBoot 多环境配置\n\n## 项目依赖多环境\n\n引入项目依赖时，可通过 `<scope>` 字段指定不同环境中需要引入的依赖，通过这种方式可以精简生成环境中项目的依赖，减少体积。常见字段有 `test`、`compile`。\n\n```xml\n<!--测试环境-->\n<dependency>\n\t<groupId>org.springframework.boot</groupId>\n\t<artifactId>spring-boot-starter-test</artifactId>\n\t<scope>test</scope> \n</dependency>\n```\n\n## 激活不同的配置文件\n\n我们可以通过配置文件化的方式实现不同环境中的配置。在配置文件加入后缀即可区分多环境应用的配置文件：\n\n- `application.yml` 表示公共配置\n- `application-dev.yml` 表示开发环境的额外配置\n- `application-prod.yml` 表示生产环境的额外配置\n\n![image.png|304](https://cdn.gallery.uuanqin.top/img/202602021427380.webp)\n\nMaven 执行打包命令（IDEA 右侧 Maven 工具栏 -> Lifecycle -> package）后，会在 target 文件夹中生成 jar 包。我们可以用环境参数运行这个 jar 包，这样就能实现多环境的切换。\n\n> [!hint] SpringBoot 项目打包操作依赖\n> 进行打包时需要引入 `spring-boot-maven-plugin`。不过基于官方骨架创建项目，会自动添加这个插件。\n\n> 打包时可以在 IDEA 的 Maven 命令面板中选择 `Skip Tests` 禁掉单元测试。\n\n```shell\n# 检查 Java 安装情况\njava --version\n# 指定 prod 生产环境\njava -jar .\\your-project-0.0.1-SNAPSHOT.jar --spring.profiles.active=prod\n```\n\n当然，打包环节也可以传入环境参数，只不过这样就没有那么灵活。\n\n我们可以通过看 SpringBoot 的启动日志查看哪个配置文件生效了：\n\n![image.png](https://cdn.gallery.uuanqin.top/img/202602021601928.webp)\n\n# Umi 多环境配置\n\n官方文档参考：[环境变量](https://umijs.org/docs/guides/env-variables#umi_env)\n\n# 本文参考\n\n- [多环境 | 鱼皮的编程宝典](https://code.yupi.icu/%E5%A4%9A%E7%8E%AF%E5%A2%83/)\n","categories":[],"tags":[{"name":"SpringBoot","api":"api/tags/SpringBoot.json"},{"name":"Umi","api":"api/tags/Umi.json"}]},"api":"api/posts/p/7b0cf4e9.json"}