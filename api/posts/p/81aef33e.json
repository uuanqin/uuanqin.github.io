{"data":{"title":"Waline 评论安全","slug":"博客站点维护/Waline/Waline 评论安全","description":"避免恶意用户骚扰","date":"2023-04-28T08:15:12.000Z","updated":"2024-12-22T17:01:50.629Z","language":"zh-CN","comments":true,"url":"p/81aef33e/","cover":"https://cdn.gallery.uuanqin.top/img/diy-waline.png","images":[],"content":"\n<div class=\"callout\" data-callout=\"note\">\n<div class=\"callout-title\">\n<div class=\"callout-title-icon\">\n<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-pencil\"><path d=\"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z\"/><path d=\"m15 5 4 4\"/></svg>\n</div>\n<div class=\"callout-title-inner\">文章解耦 <code>241024</code>：解耦自 <a class=\"uuanqin-bilink\" target=\"_blank\" href=\"/p/dd188b35/\"><span class=\"bilink-pop-up\">站内文章</span>【索引】定制自己的 Waline 评论系统</a></div>\n</div>\n<div class=\"callout-content\"><p></p>\n</div></div><p>关于评论安全博主分享自己的一些经验：</p>\n<ol>\n<li>不法分子会利用特殊方法将违规内容评论在站点不存在的链接上。站长需及时接收评论通知并检查 Waline 后端及时处理。</li>\n<li>不法分子的评论文本也许会很正常，但携带只有在外网才能查看的违规图片，导致一些站长在平时日常检视、邮件通知中没有留意。这种情况需要多加留心，我们可以在 Waline 后台点击评论的编辑按钮查看是否携带了不明链接。</li>\n<li>参看官方文档完善更多的安全措施：<a href=\"https://waline.js.org/reference/server/env.html#%E5%AE%89%E5%85%A8\">服务端环境变量 | Waline</a></li>\n</ol>\n<h1 id=\"设置违禁词服务端配置\"><a class=\"markdownIt-Anchor\" href=\"#设置违禁词服务端配置\"></a> 设置违禁词（服务端配置）</h1>\n<blockquote>\n<p>最近苦于梯子广告入侵，设置违禁词可以解决这个问题。</p>\n</blockquote>\n<p>修改在 Github 上 Waline 文件 <code>index.js</code>：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable language_\">module</span>.<span class=\"property\">exports</span> = <span class=\"title class_\">Application</span>(&#123;</span><br><span class=\"line\">  <span class=\"comment\">// 违禁词</span></span><br><span class=\"line\">  <span class=\"attr\">forbiddenWords</span>: [<span class=\"string\">&#x27;免费节点&#x27;</span>],</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n<p>评论带有违禁词的统一当做垃圾评论处理，存在误判的话可以从垃圾箱中恢复。</p>\n<p>参考：<a href=\"https://waline.js.org/reference/server/config.html#forbiddenwords\">服务端配置 | Waline</a></p>\n<h1 id=\"设置-ip-黑名单\"><a class=\"markdownIt-Anchor\" href=\"#设置-ip-黑名单\"></a> 设置 IP 黑名单</h1>\n<blockquote>\n<p>最近存在沙币乱评论，得试试黑名单功能了</p>\n</blockquote>\n<p>配置方法和设置违禁词一样：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable language_\">module</span>.<span class=\"property\">exports</span> = <span class=\"title class_\">Application</span>(&#123;</span><br><span class=\"line\">  <span class=\"comment\">// 黑名单</span></span><br><span class=\"line\">  <span class=\"attr\">disallowIPList</span>: [<span class=\"string\">&#x27;4.4.4.4&#x27;</span>],</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n<p>参考：<a href=\"https://waline.js.org/reference/server/config.html#disallowiplist\">服务端配置 | Waline</a></p>\n<h1 id=\"使用-turnstile-验证码服务\"><a class=\"markdownIt-Anchor\" href=\"#使用-turnstile-验证码服务\"></a> 使用 Turnstile 验证码服务</h1>\n<h2 id=\"turnstile-服务注册\"><a class=\"markdownIt-Anchor\" href=\"#turnstile-服务注册\"></a> Turnstile 服务注册</h2>\n<p><a href=\"https://www.cloudflare-cn.com/products/turnstile/\">Cloudflare Turnstile</a> 是一款替代 CAPTCHA 的免费工具，相比于谷歌 reCAPTCHA，它不需要繁琐的选择红绿灯消防栓之类的交互。</p>\n<p>根据网站提示自己注册一个。</p>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/20240217184356.webp\" alt=\"image.png\" width=\"500px\" /></p>\n<p>配置时安全域名需要同时添加网站地址和 Waline 服务端地址（不包含传输协议，即 <code>http://</code> 或 <code>https://</code>）。</p>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/20240217184318.webp\" alt=\"image.png\" width=\"475px\" /></p>\n<p>记住这两串 KEY，待会配置需要用到：</p>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/20240217184616.webp\" alt=\"image.png\" width=\"500px\" /></p>\n<blockquote>\n<p>注意，打算关闭 Turnstile 时服务端环境变量和客户端配置要同时删去。免去不必要的错误 <sup class=\"footnote-ref\"><a href=\"#fn1\" id=\"fnref1\">[1]</a></sup>。</p>\n</blockquote>\n<h2 id=\"服务端配置\"><a class=\"markdownIt-Anchor\" href=\"#服务端配置\"></a> 服务端配置</h2>\n<blockquote>\n<p>以 Vercel 部署方案为例</p>\n</blockquote>\n<p>打开 Vercel 中 waline 服务端项目的环境变量设置，新建这两个环境变量并输入对应的值。</p>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/20240217185017.webp\" alt=\"image.png\" /></p>\n<table>\n<thead>\n<tr>\n<th>环境变量名</th>\n<th>解释</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>TURNSTILE_KEY</code></td>\n<td>Turnstile key，须与客户端同时配置</td>\n</tr>\n<tr>\n<td><code>TURNSTILE_SECRET</code></td>\n<td>Turnstile secret，服务端使用，不可泄漏</td>\n</tr>\n</tbody>\n</table>\n<p>环境变量配置好后建议执行 Redeploy。</p>\n<h2 id=\"客户端配置\"><a class=\"markdownIt-Anchor\" href=\"#客户端配置\"></a> 客户端配置</h2>\n<blockquote>\n<p>以 Hexo-Butterfly 主题为例</p>\n</blockquote>\n<p>Butterfly 主题配置文件 waline 部分为：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">waline:</span></span><br><span class=\"line\">  <span class=\"attr\">serverURL:</span> <span class=\"comment\"># Waline server address url</span></span><br><span class=\"line\">  <span class=\"attr\">bg:</span> <span class=\"comment\"># waline background</span></span><br><span class=\"line\">  <span class=\"attr\">pageview:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">  <span class=\"attr\">option:</span></span><br><span class=\"line\">    <span class=\"attr\">turnstileKey:</span> <span class=\"string\">&#x27;0x4AAAAAAAXXXXXXXXXXX&#x27;</span> <span class=\"comment\"># 这里填写你的 turnstile site key</span></span><br></pre></td></tr></table></figure>\n\n<div class=\"callout\" data-callout=\"notice\">\n<div class=\"callout-title\">\n<div class=\"callout-title-icon\">\n<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-pencil\"><path d=\"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z\"/><path d=\"m15 5 4 4\"/></svg>\n</div>\n<div class=\"callout-title-inner\">请注意保持 <code>waline.js</code> 为较新版本，否则会出现未知错误</div>\n</div>\n<div class=\"callout-content\"><p>比如，在 Butterfly 主题配置文件使用 <code>waline.js</code> 的 cdn 链接版本至少为 <a href=\"https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/waline/2.15.7/waline.min.js\">https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/waline/2.15.7/waline.min.js</a> 。之前使用 2.15.1 版本会出现报错。</p>\n</div></div><p>部署好后尝试评论，可以在 cloudflare 查看监控数据。</p>\n<p>参考：</p>\n<ul>\n<li><a href=\"https://waline.js.org/reference/client/props.html#turnstilekey\">组件属性 | Waline</a></li>\n<li><a href=\"https://waline.js.org/reference/server/env.html#%E5%AE%89%E5%85%A8\">服务端环境变量 | Waline</a></li>\n</ul>\n<h1 id=\"使用自己的-askimet-反垃圾评论服务\"><a class=\"markdownIt-Anchor\" href=\"#使用自己的-askimet-反垃圾评论服务\"></a> 使用自己的 Askimet 反垃圾评论服务</h1>\n<p>Waline 默认开启了 Askimet 反垃圾评论服务，调用了 Waline 提供的 Akismet API Key。</p>\n<p>如果需要的话，我们也可以注册一个自己的：</p>\n<ul>\n<li>官网 <a href=\"https://akismet.com/\">Akismet – Spam Protection for Websites</a>。网站使用的是 <a href=\"http://Wordpress.com\">Wordpress.com</a> 账号。</li>\n<li>API Key 管理面板：<a href=\"https://akismet.com/account/\">Account Management – Akismet</a></li>\n</ul>\n<h1 id=\"更多\"><a class=\"markdownIt-Anchor\" href=\"#更多\"></a> 更多</h1>\n<p>为了给站长留足充分的时间处理恶意用户携带的危险链接，除了开启审核模式外，中间页的插件必不可少。强烈推荐阅读这篇文章：<a class=\"uuanqin-bilink\" target=\"_blank\" href=\"/p/e1ee5eca/\"><span class=\"bilink-pop-up\">站内文章</span>Hexo 博客与 Waline 评论区实现外链跳转中间页</a>。</p>\n<p>为了防止不法分子镜像网站后评论区还能使用，需要在环境变量中添加安全域名。具体做法详见：<a class=\"uuanqin-bilink\" target=\"_blank\" href=\"/p/7d2de43e/\"><span class=\"bilink-pop-up\">站内文章</span>防止网站被镜像的若干防护措施及反制手段</a>。</p>\n<hr class=\"footnotes-sep\" />\n<section class=\"footnotes\">\n<ol class=\"footnotes-list\">\n<li id=\"fn1\" class=\"footnote-item\"><p><a href=\"https://github.com/walinejs/waline/issues/2427\">[Bug]: 未登录用户评论时报Forbidden提示 Issue #2427 · walinejs/waline (github.com)</a> <a href=\"#fnref1\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n</ol>\n</section>\n","raw":"---\ntitle: Waline 评论安全\ntags:\n  - Waline\n  - Vercel\n  - GitHub\n  - Turnstile\n  - Askimet\n  - Butterfly\ncover: 'https://cdn.gallery.uuanqin.top/img/diy-waline.png'\ndescription: 避免恶意用户骚扰\ncategories:\n  - 博客站点维护\n  - Waline\nabbrlink: 81aef33e\ndate: 2023-04-28 16:15:12\ntop_img:\n---\n\n> [!note] 文章解耦 `241024`：解耦自 [[【索引】定制自己的 Waline 评论系统]]\n\n关于评论安全博主分享自己的一些经验：\n\n1. 不法分子会利用特殊方法将违规内容评论在站点不存在的链接上。站长需及时接收评论通知并检查 Waline 后端及时处理。\n2. 不法分子的评论文本也许会很正常，但携带只有在外网才能查看的违规图片，导致一些站长在平时日常检视、邮件通知中没有留意。这种情况需要多加留心，我们可以在 Waline 后台点击评论的编辑按钮查看是否携带了不明链接。\n3. 参看官方文档完善更多的安全措施：[服务端环境变量 | Waline](https://waline.js.org/reference/server/env.html#%E5%AE%89%E5%85%A8)\n\n# 设置违禁词（服务端配置）\n\n> 最近苦于梯子广告入侵，设置违禁词可以解决这个问题。\n\n修改在 Github 上 Waline 文件 `index.js`：\n\n```js\nmodule.exports = Application({\n  // 违禁词\n  forbiddenWords: ['免费节点'],\n});\n```\n\n评论带有违禁词的统一当做垃圾评论处理，存在误判的话可以从垃圾箱中恢复。\n\n参考：[服务端配置 | Waline](https://waline.js.org/reference/server/config.html#forbiddenwords)\n\n# 设置 IP 黑名单\n\n> 最近存在沙币乱评论，得试试黑名单功能了\n\n配置方法和设置违禁词一样：\n\n```js\nmodule.exports = Application({\n  // 黑名单\n  disallowIPList: ['4.4.4.4'],\n});\n```\n\n参考：[服务端配置 | Waline](https://waline.js.org/reference/server/config.html#disallowiplist)\n\n# 使用 Turnstile 验证码服务\n\n## Turnstile 服务注册\n\n[Cloudflare Turnstile](https://www.cloudflare-cn.com/products/turnstile/) 是一款替代 CAPTCHA 的免费工具，相比于谷歌 reCAPTCHA，它不需要繁琐的选择红绿灯消防栓之类的交互。\n\n根据网站提示自己注册一个。\n\n![image.png|500](https://cdn.gallery.uuanqin.top/img/20240217184356.webp)\n\n配置时安全域名需要同时添加网站地址和 Waline 服务端地址（不包含传输协议，即 `http://` 或 `https://`）。\n\n![image.png|475](https://cdn.gallery.uuanqin.top/img/20240217184318.webp)\n\n记住这两串 KEY，待会配置需要用到：\n\n![image.png|500](https://cdn.gallery.uuanqin.top/img/20240217184616.webp)\n\n> 注意，打算关闭 Turnstile 时服务端环境变量和客户端配置要同时删去。免去不必要的错误 [^turn]。\n\n[^turn]: [[Bug]: 未登录用户评论时报Forbidden提示 Issue #2427 · walinejs/waline (github.com)](https://github.com/walinejs/waline/issues/2427)\n## 服务端配置\n\n> 以 Vercel 部署方案为例\n\n打开 Vercel 中 waline 服务端项目的环境变量设置，新建这两个环境变量并输入对应的值。\n\n![image.png](https://cdn.gallery.uuanqin.top/img/20240217185017.webp)\n\n| 环境变量名 | 解释 |\n| ---- | ---- |\n| `TURNSTILE_KEY` | Turnstile key，须与客户端同时配置 |\n| `TURNSTILE_SECRET` | Turnstile secret，服务端使用，不可泄漏 |\n\n环境变量配置好后建议执行 Redeploy。\n\n## 客户端配置\n\n> 以 Hexo-Butterfly 主题为例\n\nButterfly 主题配置文件 waline 部分为：\n\n```yaml\nwaline:\n  serverURL: # Waline server address url\n  bg: # waline background\n  pageview: false\n  option:\n    turnstileKey: '0x4AAAAAAAXXXXXXXXXXX' # 这里填写你的 turnstile site key\n```\n\n> [!Notice] 请注意保持 `waline.js` 为较新版本，否则会出现未知错误\n> 比如，在 Butterfly 主题配置文件使用 `waline.js` 的 cdn 链接版本至少为 https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/waline/2.15.7/waline.min.js 。之前使用 2.15.1 版本会出现报错。\n\n部署好后尝试评论，可以在 cloudflare 查看监控数据。\n\n参考：\n\n- [组件属性 | Waline](https://waline.js.org/reference/client/props.html#turnstilekey)\n- [服务端环境变量 | Waline](https://waline.js.org/reference/server/env.html#%E5%AE%89%E5%85%A8)\n\n# 使用自己的 Askimet 反垃圾评论服务\n\nWaline 默认开启了 Askimet 反垃圾评论服务，调用了 Waline 提供的 Akismet API Key。\n\n如果需要的话，我们也可以注册一个自己的：\n\n- 官网 [Akismet – Spam Protection for Websites](https://akismet.com/)。网站使用的是 Wordpress.com 账号。\n- API Key 管理面板：[Account Management – Akismet](https://akismet.com/account/)\n\n# 更多\n\n为了给站长留足充分的时间处理恶意用户携带的危险链接，除了开启审核模式外，中间页的插件必不可少。强烈推荐阅读这篇文章：[[Hexo 博客与 Waline 评论区实现外链跳转中间页]]。\n\n为了防止不法分子镜像网站后评论区还能使用，需要在环境变量中添加安全域名。具体做法详见：[[防止网站被镜像的若干防护措施及反制手段]]。","categories":[{"name":"博客站点维护","api":"api/categories/博客站点维护.json"},{"name":"Waline","api":"api/categories/博客站点维护/Waline.json"}],"tags":[{"name":"Waline","api":"api/tags/Waline.json"},{"name":"GitHub","api":"api/tags/GitHub.json"},{"name":"Butterfly","api":"api/tags/Butterfly.json"},{"name":"Vercel","api":"api/tags/Vercel.json"},{"name":"Turnstile","api":"api/tags/Turnstile.json"},{"name":"Askimet","api":"api/tags/Askimet.json"}]},"api":"api/posts/p/81aef33e.json"}