{"data":{"title":"友链朋友圈（By @冰糖红茶）—— Server - SQLite 部署方案","slug":"Archive/OutOfDate/友链朋友圈（By @冰糖红茶）—— Server - SQLite 部署方案","description":"简要介绍我在服务器的部署友链朋友圈过程以示参考","date":"2023-08-13T15:57:42.000Z","updated":"2025-05-13T11:19:09.028Z","language":"zh-CN","comments":true,"url":"p/b0caa9e8/","cover":"https://cdn.gallery.uuanqin.top/img/new-out-of-date-cover.png","images":[],"content":"\n<div class=\"callout\" data-callout=\"warning\">\n<div class=\"callout-title\">\n<div class=\"callout-title-icon\">\n<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-alert-triangle\"><path d=\"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z\"/><path d=\"M12 9v4\"/><path d=\"M12 17h.01\"/></svg>\n</div>\n<div class=\"callout-title-inner\">这是一篇过期文章 <code>241030</code></div>\n</div>\n<div class=\"callout-content\"><p>@Rock-Candy-Tea（冰糖红茶）开发的友链朋友圈项目已年久失修，项目贡献者 <a href=\"https://blog.ccknbc.cc\">@CCKNBC</a> 建议迁往 <a href=\"https://blog.qyliu.top/posts/4dc716ec/\">Friend-Circle-Lite:轻量友链朋友圈</a>（作者 <a href=\"https://blog.qyliu.top/\">@清羽飞扬</a> ）</p>\n</div></div><p>本来不想写的，觉得自己看文档就能实现。但是实际操作过程出现了很多状况，文档不是太详细，MySQL 部署失败…<s>于是打算水一篇 😓</s>。</p>\n<p>官方文档：<a href=\"https://fcircle-doc.yyyzyyyz.cn/#/\">友链朋友圈 - 使用手册</a></p>\n<h1 id=\"环境\"><a class=\"markdownIt-Anchor\" href=\"#环境\"></a> 环境</h1>\n<p>我采用的方案是 Server + SQLite 的部署方案。</p>\n<p>根据文档要求 Python 环境为 3.8，原本我的服务器版本为 3.6，需要升级。（此处由于我忽略版本导致踩坑）</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 适用于CentOS系统。安装db4-devel可能报错，那我们就跳过它......</span></span><br><span class=\"line\">yum -y install zlib-devel bzip2-devel openssl-devel ncurses-devel sqlite-devel readline-devel tk-devel gdbm-devel libpcap-devel xz-devel libffi-devel <span class=\"comment\"># 忽略 db4-devel</span></span><br><span class=\"line\"><span class=\"comment\"># 下面这些基础工具没安的可以安装</span></span><br><span class=\"line\">yum -y install yum vim gcc</span><br><span class=\"line\"><span class=\"comment\"># 下载Python包</span></span><br><span class=\"line\">wget https://www.python.org/ftp/python/3.8.8/Python-3.8.8.tgz</span><br><span class=\"line\"><span class=\"comment\"># 解压并进入目录</span></span><br><span class=\"line\">tar -zxf Python-3.8.8.tgz &amp;&amp; <span class=\"built_in\">cd</span> Python-3.8.8 &amp;&amp; ./configure --prefix=/usr/local/python3</span><br><span class=\"line\">make &amp;&amp; make install</span><br><span class=\"line\"><span class=\"comment\"># 删除原先链接，建立软连接</span></span><br><span class=\"line\"><span class=\"built_in\">rm</span> -rf /usr/bin/python3</span><br><span class=\"line\"><span class=\"built_in\">ln</span> -s /usr/local/python3/bin/python3 /usr/bin/python3</span><br><span class=\"line\"><span class=\"built_in\">rm</span> -rf /usr/bin/pip3</span><br><span class=\"line\"><span class=\"built_in\">ln</span> -s /usr/local/python3/bin/pip3 /usr/bin/pip3</span><br><span class=\"line\"><span class=\"comment\"># 查看是否安装成功</span></span><br><span class=\"line\">python3 --version</span><br><span class=\"line\">pip3 --version</span><br><span class=\"line\"><span class=\"comment\"># 安装YAML模块</span></span><br><span class=\"line\">pip3 install pyyaml</span><br></pre></td></tr></table></figure>\n<p>安装 Git：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y git</span><br></pre></td></tr></table></figure>\n<h1 id=\"项目安装\"><a class=\"markdownIt-Anchor\" href=\"#项目安装\"></a> 项目安装</h1>\n<p>找个好地方克隆仓库：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git <span class=\"built_in\">clone</span> https://github.com/Rock-Candy-Tea/hexo-circle-of-friends.git</span><br></pre></td></tr></table></figure>\n<p>编辑 <code>/hexo_circle_of_friends/fc_settings.yaml</code> 文件：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">LINK:</span> [</span><br><span class=\"line\">\t<span class=\"comment\"># 友链页地址1，修改为你的友链页地址</span></span><br><span class=\"line\">\t<span class=\"comment\"># 因为博客最后生成的网页都在本地，我直接写本地地址</span></span><br><span class=\"line\">     &#123; <span class=\"attr\">link:</span> <span class=\"string\">&quot;http://127.0.0.1/pages/friends/&quot;</span>, <span class=\"attr\">theme:</span> <span class=\"string\">&quot;butterfly&quot;</span> &#125;,</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n<p>部署与测试 API：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">python3 deploy.py        <span class=\"comment\"># 部署</span></span><br><span class=\"line\">curl 127.0.0.1:8000/all  <span class=\"comment\"># 测试接口</span></span><br></pre></td></tr></table></figure>\n\n<div class=\"callout\" data-callout=\"error\">\n<div class=\"callout-title\">\n<div class=\"callout-title-icon\">\n<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-zap\"><polygon points=\"13 2 3 14 12 14 11 22 21 10 12 10 13 2\"/></svg>\n</div>\n<div class=\"callout-title-inner\">ERROR: Could not find a version that satisfies the requirement aiofiles (from versions: none)</div>\n</div>\n<div class=\"callout-content\"><p></p>\n</div></div><p>部署时如遇找不到包的错误，可尝试更换源下载。如针对以上报错，可以执行：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 指定版本</span></span><br><span class=\"line\">pip3 install <span class=\"string\">&quot;aiofiles==0.8.0&quot;</span> -i https://pypi.tuna.tsinghua.edu.cn/simple/ <span class=\"comment\"># 清华源</span></span><br></pre></td></tr></table></figure>\n<p>但是依赖列表这么多，总不能一个个下。我们可以直接执行这条指令：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip3 install -r /var/www/hexo-circle-of-friends/hexo_circle_of_friends/requirements.txt</span><br></pre></td></tr></table></figure>\n<p>完事后，重新部署即可。</p>\n<h1 id=\"nginx-配置\"><a class=\"markdownIt-Anchor\" href=\"#nginx-配置\"></a> Nginx 配置</h1>\n<p>由于之前 <sup class=\"footnote-ref\"><a href=\"#fn1\" id=\"fnref1\">[1]</a></sup> 弄了好一会这个配置，为的是网站实现全程 HTTPS 访问。现在我也想让外部访问朋友圈接口时也使用 HTTPS。</p>\n<figure class=\"highlight diff\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen 443 ssl;</span><br><span class=\"line\">    server_name  localhost;</span><br><span class=\"line\">    access_log  /var/log/nginx/host.access.log  main;</span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">        root   /var/www/uuanqin.top;</span><br><span class=\"line\">        index  index.html index.htm;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"addition\">+   # 友链朋友圈 获取后端内容 前端登录（Heo 方案）</span></span><br><span class=\"line\"><span class=\"addition\">+   location ^~/fc_backend/ &#123;</span></span><br><span class=\"line\"><span class=\"addition\">+        proxy_set_header    X-FORWARDED-FOR $remote_addr;</span></span><br><span class=\"line\"><span class=\"addition\">+        proxy_set_header    X-FORWARDED-PROTO $scheme;</span></span><br><span class=\"line\"><span class=\"addition\">+        proxy_set_header    Host   $http_host;</span></span><br><span class=\"line\"><span class=\"addition\">+        proxy_pass http://127.0.0.1:8000/;</span></span><br><span class=\"line\"><span class=\"addition\">+    &#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    error_page  404              /404.html;</span><br><span class=\"line\">    ssl_certificate conf.d/cert/www.uuanqin.top.pem;</span><br><span class=\"line\">    ssl_certificate_key conf.d/cert/www.uuanqin.top.key;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>通过 location 正则匹配，识别出 <code>/fc_backend/</code> 开头的链接为朋友圈 API 的请求，并将其转发到端口 8000（朋友圈默认端口）。发送给 8000 端口的地址不包含 <code>/fc_backend/</code>。</p>\n<p>当然，这里需要前端也要配合发出 <code>/fc_backend/</code> 开头的请求。</p>\n<p>修改配置文件后别忘了重启 Nginx。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nginx -s reload</span><br></pre></td></tr></table></figure>\n<h1 id=\"前端部署\"><a class=\"markdownIt-Anchor\" href=\"#前端部署\"></a> 前端部署</h1>\n<p>这里我采用了文档方案。</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;hexo-circle-of-friends-root&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"keyword\">let</span> <span class=\"title class_\">UserConfig</span> = &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">\t<span class=\"comment\">// 填写你的api地址</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">\t<span class=\"attr\">private_api_url</span>: <span class=\"string\">&#x27;/fc_backend/&#x27;</span>,</span></span><br><span class=\"line\"><span class=\"language-javascript\">\t<span class=\"comment\">// 初始加载几篇文章</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">\t<span class=\"attr\">page_init_number</span>: <span class=\"number\">20</span>,</span></span><br><span class=\"line\"><span class=\"language-javascript\">\t<span class=\"comment\">// 点击加载更多时，一次最多加载几篇文章，默认10</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">\t<span class=\"attr\">page_turning_number</span>: <span class=\"number\">10</span>,</span></span><br><span class=\"line\"><span class=\"language-javascript\">\t<span class=\"comment\">// 头像加载失败时，默认头像地址</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">\t<span class=\"attr\">error_img</span>: <span class=\"string\">&#x27;/image/404.gif&#x27;</span>,</span></span><br><span class=\"line\"><span class=\"language-javascript\">\t<span class=\"comment\">// 进入页面时第一次的排序规则</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">\t<span class=\"attr\">sort_rule</span>: <span class=\"string\">&#x27;created&#x27;</span>, <span class=\"comment\">// 本地文章缓存数据过期时间（天）</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">\t<span class=\"attr\">expire_days</span>: <span class=\"number\">1</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">&#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;https://npm.elemecdn.com/fcircle-theme-yyyz@1.0.13/dist/fcircle.min.js&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>注意 <code>private_api_url</code> 中的设置。</p>\n<h1 id=\"前端改密码方式\"><a class=\"markdownIt-Anchor\" href=\"#前端改密码方式\"></a> 前端改密码方式</h1>\n<p>友链朋友圈项目的前端第一次登录时即设置密码，如果想要改的话则需要自行删除数据库 <code>auth</code>、<code>secret</code> 表格。</p>\n<p>进入服务器 <code>hexo-circle-of-friends</code> 根目录，找到 <code>data.db</code> 文件</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sqlite3</span><br><span class=\"line\">sqlite&gt; .open data.db <span class=\"comment\"># 打开数据库</span></span><br><span class=\"line\">sqlite&gt; .tables</span><br><span class=\"line\"><span class=\"comment\"># auth  friends  posts  secret</span></span><br><span class=\"line\">sqlite&gt; DROP TABLE auth;</span><br><span class=\"line\">sqlite&gt; DROP TABLE secret;</span><br><span class=\"line\">sqlite&gt; .tables</span><br><span class=\"line\"><span class=\"comment\"># friends  posts</span></span><br><span class=\"line\">sqlite&gt; .<span class=\"built_in\">exit</span></span><br></pre></td></tr></table></figure>\n<p>重新部署朋友圈即可。</p>\n<h1 id=\"可选鱼塘-dlc\"><a class=\"markdownIt-Anchor\" href=\"#可选鱼塘-dlc\"></a> 【可选】鱼塘 DLC</h1>\n<p>鱼塘 DLC 是 <a href=\"https://blog.zhheo.com\">@张洪Heo</a> 写的一个基于友链 - 朋友圈的脚本。它可以随机展示一条抓取记录。与洪涝不同的是，我稍微调整了一下 CSS 以改进页面布局。</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;title-h2-a&quot;</span> <span class=\"attr\">style</span>=<span class=\"string\">&quot;overflow: hidden;&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;title-h2-a-left&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">style</span>=<span class=\"string\">&quot;padding-top: 0;margin: 0 8px 0.6rem; font-size: 20px; font-weight:bold;float: left;&quot;</span>&gt;</span>🎣 钓鱼<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;random-post-start&quot;</span> <span class=\"attr\">href</span>=<span class=\"string\">&quot;javascript:fetchRandomPost();&quot;</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">i</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;fa-solid fa-arrow-rotate-right&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">i</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;random-post&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">     <span class=\"attr\">style</span>=<span class=\"string\">&quot;min-height: 32px; background: var(--heo-card-bg); border: var(--ai-summary-style-border-always); box-shadow: var(--heo-shadow-border); padding: 20px 30px; border-radius: 12px; margin-top: 8px;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">&quot;stylesheet&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/css&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">href</span>=<span class=\"string\">&quot;https://cdn.jsdelivr.net/gh/zhheo/JS-Heo@main/moments/random-friends-post.css&quot;</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">var</span> fdataUser = &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"attr\">apiurl</span>: <span class=\"string\">&#x27;/fc_backend/&#x27;</span>,</span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"attr\">defaultFish</span>: <span class=\"number\">500</span>,</span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"attr\">hungryFish</span>: <span class=\"number\">500</span>,</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">src</span>=<span class=\"string\">&quot;https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.6.0/jquery.min.js&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>需要注意的是，必须使用 <code>jquery.js</code>，记得引入。上面 <code>jquery.js</code> 使用了字节跳动静态资源公共 CDN，可按需替换链接。</p>\n<p>此外不要漏掉 <code>id</code> 为 <code>random-post</code> 的框，这是回显钓鱼信息用的。</p>\n<h1 id=\"可选设置-cdn-的不缓存规则\"><a class=\"markdownIt-Anchor\" href=\"#可选设置-cdn-的不缓存规则\"></a> 【可选】设置 CDN 的不缓存规则</h1>\n<p>由于本站采取了 CDN，接口 <code>https://blog.uuanqin.top/fc_backend/</code> 所有请求应该设置不缓存，否则鱼塘、朋友圈刷新了还是一个样。</p>\n<p>打开 CDN 加速域名配置页面、增加多一个缓存规则即可（以腾讯云 CDN 为例）：</p>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/20230814230524.png\" alt=\"image.png\" /></p>\n<p>腾讯云 EdgeOne 中应该为：</p>\n<p><img src= \"/image/loading.gif\" data-lazy-src=\"https://cdn.gallery.uuanqin.top/img/202408081655135.webp\" alt=\"image.png\" /></p>\n<h1 id=\"后续改进\"><a class=\"markdownIt-Anchor\" href=\"#后续改进\"></a> 后续改进</h1>\n<p><a href=\"https://blog.qyliu.top/\">@清羽飞扬</a> 的作品 <code>241028</code>：轻量友链朋友圈可解决这些问题：</p>\n<ul class=\"contains-task-list\">\n<li class=\"task-list-item\"><input class=\"task-list-item-checkbox\" checked=\"\" disabled=\"\" type=\"checkbox\"> 服务器重启后需要自行手动部署</li>\n<li class=\"task-list-item\"><input class=\"task-list-item-checkbox\" checked=\"\" disabled=\"\" type=\"checkbox\"> 目前使用的朋友圈太庞杂，以后可以开发自己的爬虫</li>\n<li class=\"task-list-item\"><input class=\"task-list-item-checkbox\" checked=\"\" disabled=\"\" type=\"checkbox\"> 夜间模式下部分文字未显示</li>\n</ul>\n<h1 id=\"本文参考\"><a class=\"markdownIt-Anchor\" href=\"#本文参考\"></a> 本文参考</h1>\n<ul>\n<li><a href=\"https://blog.csdn.net/z736248591/article/details/117124631\">CentOS 8 升级 Python3.6 到 Python3.9_雪靡的博客-CSDN 博客</a></li>\n<li><a href=\"https://fcircle-doc.yyyzyyyz.cn/#/problems\">常见问题 (yyyzyyyz.cn)</a></li>\n<li><a href=\"https://blog.csdn.net/weixin_44299027/article/details/107286956\">【Nginx 用法】nginx location 正则表达式写法，详解 Nginx location 匹配规则（很详细哦）_nginx location 正则_No8g 攻城狮的博客-CSDN 博客</a></li>\n<li><a href=\"https://www.runoob.com/sqlite/sqlite-drop-table.html\">SQLite 删除表 | 菜鸟教程 (runoob.com)</a></li>\n<li><a href=\"https://cloud.tencent.com/developer/article/2238065\">Hexo -43- 友链朋友圈 后端部署-腾讯云开发者社区-腾讯云 (tencent.com)</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/451825018\">Nginx 配置反向代理，一篇搞定！ - 知乎 (zhihu.com)</a></li>\n<li><a href=\"https://blog.csdn.net/YUICUI/article/details/108471302\">【python入门】如何生成和安装requirements.txt依赖？_requirements依赖-CSDN博客</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/361790784\">pip安装包报错Could not find a version that satisfies the requirement pymysql (from versions: none) - 知乎 (zhihu.com)</a></li>\n<li><a href=\"https://blog.zhheo.com/p/908df4e2.html\">鱼塘DLC - 钓鱼：你钓到了一篇惊世好文！ | 张洪Heo (zhheo.com)</a></li>\n</ul>\n<hr class=\"footnotes-sep\" />\n<section class=\"footnotes\">\n<ol class=\"footnotes-list\">\n<li id=\"fn1\" class=\"footnote-item\"><p>参见我的折腾过程：<a class=\"uuanqin-bilink\" target=\"_blank\" href=\"/p/83335cfa/\"><span class=\"yukari\">站内文章</span>Nginx 与 CDN 完成重定向：从 HTTP 重定向到 HTTPS、从 WWW 重定向到根</a> <a href=\"#fnref1\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n</ol>\n</section>\n","raw":"---\ntitle: 友链朋友圈（By @冰糖红茶）—— Server - SQLite 部署方案\ntags:\n  - Butterfly\n  - Linux\n  - Python\n  - SQLite\ncover: 'https://cdn.gallery.uuanqin.top/img/new-out-of-date-cover.png'\ndescription: 简要介绍我在服务器的部署友链朋友圈过程以示参考\nabbrlink: b0caa9e8\ncategories:\n  - Archive\n  - OutOfDate\ndate: 2023-08-13 23:57:42\ntop_img:\n---\n\n> [!warning] 这是一篇过期文章 `241030`\n> @Rock-Candy-Tea（冰糖红茶）开发的友链朋友圈项目已年久失修，项目贡献者 [@CCKNBC](https://blog.ccknbc.cc) 建议迁往 [Friend-Circle-Lite:轻量友链朋友圈](https://blog.qyliu.top/posts/4dc716ec/)（作者 [@清羽飞扬](https://blog.qyliu.top/) ）\n\n本来不想写的，觉得自己看文档就能实现。但是实际操作过程出现了很多状况，文档不是太详细，MySQL 部署失败......~~于是打算水一篇 😓~~。\n\n官方文档：[友链朋友圈 - 使用手册](https://fcircle-doc.yyyzyyyz.cn/#/)\n\n# 环境\n\n我采用的方案是 Server + SQLite 的部署方案。\n\n根据文档要求 Python 环境为 3.8，原本我的服务器版本为 3.6，需要升级。（此处由于我忽略版本导致踩坑）\n\n```bash\n# 适用于CentOS系统。安装db4-devel可能报错，那我们就跳过它......\nyum -y install zlib-devel bzip2-devel openssl-devel ncurses-devel sqlite-devel readline-devel tk-devel gdbm-devel libpcap-devel xz-devel libffi-devel # 忽略 db4-devel\n# 下面这些基础工具没安的可以安装\nyum -y install yum vim gcc\n# 下载Python包\nwget https://www.python.org/ftp/python/3.8.8/Python-3.8.8.tgz\n# 解压并进入目录\ntar -zxf Python-3.8.8.tgz && cd Python-3.8.8 && ./configure --prefix=/usr/local/python3\nmake && make install\n# 删除原先链接，建立软连接\nrm -rf /usr/bin/python3\nln -s /usr/local/python3/bin/python3 /usr/bin/python3\nrm -rf /usr/bin/pip3\nln -s /usr/local/python3/bin/pip3 /usr/bin/pip3\n# 查看是否安装成功\npython3 --version\npip3 --version\n# 安装YAML模块\npip3 install pyyaml\n```\n\n安装 Git：\n\n```bash\nyum install -y git\n```\n\n# 项目安装\n\n找个好地方克隆仓库：\n\n```bash\ngit clone https://github.com/Rock-Candy-Tea/hexo-circle-of-friends.git\n```\n\n编辑 `/hexo_circle_of_friends/fc_settings.yaml` 文件：\n\n```yaml\nLINK: [\n\t# 友链页地址1，修改为你的友链页地址\n\t# 因为博客最后生成的网页都在本地，我直接写本地地址\n     { link: \"http://127.0.0.1/pages/friends/\", theme: \"butterfly\" },\n]\n```\n\n部署与测试 API：\n\n```bash\npython3 deploy.py        # 部署\ncurl 127.0.0.1:8000/all  # 测试接口\n```\n\n> [!error] ERROR: Could not find a version that satisfies the requirement aiofiles (from versions: none)\n\n部署时如遇找不到包的错误，可尝试更换源下载。如针对以上报错，可以执行：\n\n```sh\n# 指定版本\npip3 install \"aiofiles==0.8.0\" -i https://pypi.tuna.tsinghua.edu.cn/simple/ # 清华源\n```\n\n但是依赖列表这么多，总不能一个个下。我们可以直接执行这条指令：\n\n```sh\npip3 install -r /var/www/hexo-circle-of-friends/hexo_circle_of_friends/requirements.txt\n```\n\n完事后，重新部署即可。\n\n# Nginx 配置\n\n由于之前 [^cdn] 弄了好一会这个配置，为的是网站实现全程 HTTPS 访问。现在我也想让外部访问朋友圈接口时也使用 HTTPS。\n\n[^cdn]: 参见我的折腾过程：[[Nginx 与 CDN 完成重定向：从 HTTP 重定向到 HTTPS、从 WWW 重定向到根]]\n\n```diff\nserver {\n    listen 443 ssl;\n    server_name  localhost;\n    access_log  /var/log/nginx/host.access.log  main;\n    location / {\n        root   /var/www/uuanqin.top;\n        index  index.html index.htm;\n    }\n+   # 友链朋友圈 获取后端内容 前端登录（Heo 方案）\n+   location ^~/fc_backend/ {\n+        proxy_set_header    X-FORWARDED-FOR $remote_addr;\n+        proxy_set_header    X-FORWARDED-PROTO $scheme;\n+        proxy_set_header    Host   $http_host;\n+        proxy_pass http://127.0.0.1:8000/;\n+    }\n\n    error_page  404              /404.html;\n    ssl_certificate conf.d/cert/www.uuanqin.top.pem;\n    ssl_certificate_key conf.d/cert/www.uuanqin.top.key;\n    ...\n\n}\n\n```\n\n通过 location 正则匹配，识别出 `/fc_backend/` 开头的链接为朋友圈 API 的请求，并将其转发到端口 8000（朋友圈默认端口）。发送给 8000 端口的地址不包含 `/fc_backend/`。\n\n当然，这里需要前端也要配合发出 `/fc_backend/` 开头的请求。\n\n修改配置文件后别忘了重启 Nginx。\n\n```bash\nnginx -s reload\n```\n\n# 前端部署\n\n这里我采用了文档方案。\n\n```html\n<div id=\"hexo-circle-of-friends-root\"></div>\n<script>\nlet UserConfig = {\n\t// 填写你的api地址\n\tprivate_api_url: '/fc_backend/',\n\t// 初始加载几篇文章\n\tpage_init_number: 20,\n\t// 点击加载更多时，一次最多加载几篇文章，默认10\n\tpage_turning_number: 10,\n\t// 头像加载失败时，默认头像地址\n\terror_img: '/image/404.gif',\n\t// 进入页面时第一次的排序规则\n\tsort_rule: 'created', // 本地文章缓存数据过期时间（天）\n\texpire_days: 1\n}\n</script>\n<script type=\"text/javascript\" src=\"https://npm.elemecdn.com/fcircle-theme-yyyz@1.0.13/dist/fcircle.min.js\"></script>\n```\n\n注意 `private_api_url` 中的设置。\n\n# 前端改密码方式\n\n友链朋友圈项目的前端第一次登录时即设置密码，如果想要改的话则需要自行删除数据库 `auth`、`secret` 表格。\n\n进入服务器 `hexo-circle-of-friends` 根目录，找到 `data.db` 文件\n\n```bash\nsqlite3\nsqlite> .open data.db # 打开数据库\nsqlite> .tables\n# auth  friends  posts  secret\nsqlite> DROP TABLE auth;\nsqlite> DROP TABLE secret;\nsqlite> .tables\n# friends  posts\nsqlite> .exit\n```\n\n重新部署朋友圈即可。\n\n# 【可选】鱼塘 DLC\n\n鱼塘 DLC 是 [@张洪Heo](https://blog.zhheo.com) 写的一个基于友链 - 朋友圈的脚本。它可以随机展示一条抓取记录。与洪涝不同的是，我稍微调整了一下 CSS 以改进页面布局。\n\n```html\n\n<div class=\"title-h2-a\" style=\"overflow: hidden;\">\n    <div class=\"title-h2-a-left\">\n        <div style=\"padding-top: 0;margin: 0 8px 0.6rem; font-size: 20px; font-weight:bold;float: left;\">🎣 钓鱼</div>\n\n        <a class=\"random-post-start\" href=\"javascript:fetchRandomPost();\"><i class=\"fa-solid fa-arrow-rotate-right\"></i></a>\n    </div>\n\n</div>\n<div id=\"random-post\"\n     style=\"min-height: 32px; background: var(--heo-card-bg); border: var(--ai-summary-style-border-always); box-shadow: var(--heo-shadow-border); padding: 20px 30px; border-radius: 12px; margin-top: 8px;\"></div>\n<link rel=\"stylesheet\" type=\"text/css\"\n      href=\"https://cdn.jsdelivr.net/gh/zhheo/JS-Heo@main/moments/random-friends-post.css\">\n\n<script type=\"text/javascript\">\n    var fdataUser = {\n        apiurl: '/fc_backend/',\n        defaultFish: 500,\n        hungryFish: 500,\n    }\n</script>\n\n<script type=\"text/javascript\"\n        src=\"https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.6.0/jquery.min.js\"></script>\n```\n\n需要注意的是，必须使用 `jquery.js`，记得引入。上面 `jquery.js` 使用了字节跳动静态资源公共 CDN，可按需替换链接。\n\n此外不要漏掉 `id` 为 `random-post` 的框，这是回显钓鱼信息用的。\n\n# 【可选】设置 CDN 的不缓存规则\n\n由于本站采取了 CDN，接口 `https://blog.uuanqin.top/fc_backend/` 所有请求应该设置不缓存，否则鱼塘、朋友圈刷新了还是一个样。\n\n打开 CDN 加速域名配置页面、增加多一个缓存规则即可（以腾讯云 CDN 为例）：\n\n![image.png](https://cdn.gallery.uuanqin.top/img/20230814230524.png)\n\n腾讯云 EdgeOne 中应该为：\n\n![image.png](https://cdn.gallery.uuanqin.top/img/202408081655135.webp)\n\n# 后续改进\n\n[@清羽飞扬](https://blog.qyliu.top/) 的作品 `241028`：轻量友链朋友圈可解决这些问题：\n\n- [x] 服务器重启后需要自行手动部署\n- [x] 目前使用的朋友圈太庞杂，以后可以开发自己的爬虫\n- [x] 夜间模式下部分文字未显示\n\n# 本文参考\n\n- [CentOS 8 升级 Python3.6 到 Python3.9\\_雪靡的博客-CSDN 博客](https://blog.csdn.net/z736248591/article/details/117124631)\n- [常见问题 (yyyzyyyz.cn)](https://fcircle-doc.yyyzyyyz.cn/#/problems)\n- [【Nginx 用法】nginx location 正则表达式写法，详解 Nginx location 匹配规则（很详细哦）\\_nginx location 正则\\_No8g 攻城狮的博客-CSDN 博客](https://blog.csdn.net/weixin_44299027/article/details/107286956)\n- [SQLite 删除表 | 菜鸟教程 (runoob.com)](https://www.runoob.com/sqlite/sqlite-drop-table.html)\n- [Hexo -43- 友链朋友圈 后端部署-腾讯云开发者社区-腾讯云 (tencent.com)](https://cloud.tencent.com/developer/article/2238065)\n- [Nginx 配置反向代理，一篇搞定！ - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/451825018)\n- [【python入门】如何生成和安装requirements.txt依赖？_requirements依赖-CSDN博客](https://blog.csdn.net/YUICUI/article/details/108471302)\n- [pip安装包报错Could not find a version that satisfies the requirement pymysql (from versions: none) - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/361790784)\n- [鱼塘DLC - 钓鱼：你钓到了一篇惊世好文！ | 张洪Heo (zhheo.com)](https://blog.zhheo.com/p/908df4e2.html)\n","categories":[{"name":"Archive","api":"api/categories/Archive.json"},{"name":"OutOfDate","api":"api/categories/Archive/OutOfDate.json"}],"tags":[{"name":"Linux","api":"api/tags/Linux.json"},{"name":"Python","api":"api/tags/Python.json"},{"name":"Butterfly","api":"api/tags/Butterfly.json"},{"name":"SQLite","api":"api/tags/SQLite.json"}]},"api":"api/posts/p/b0caa9e8.json"}