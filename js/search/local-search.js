class LocalSearch{constructor({path='',unescape=!1,top_n_per_article=1}){this.path=path,this.unescape=unescape,this.top_n_per_article=top_n_per_article,this.isfetched=!1,this.datas=null}getIndexByWord(words,text,caseSensitive=!1){let index=[],included=new Set;return caseSensitive||(text=text.toLowerCase()),words.forEach(word=>{this.unescape&&((div=document.createElement('div')).innerText=word,word=div.innerHTML);var div,wordLen=word.length;if(0!==wordLen){let startPosition=0;var position;for(caseSensitive||(word=word.toLowerCase());-1<(position=text.indexOf(word,startPosition));)index.push({position:position,word:word}),included.add(word),startPosition=position+wordLen}}),index.sort((left,right)=>left.position!==right.position?left.position-right.position:right.word.length-left.word.length),[index,included]}mergeIntoSlice(start,end,index){var item;let{position,word}=index[0];for(var hits=[],count=new Set;position+word.length<=end&&0!==index.length;){count.add(word),hits.push({position:position,length:word.length});var wordEnd=position+word.length;for(index.shift();0!==index.length&&(item=index[0],position=item.position,word=item.word,wordEnd>position);)index.shift()}return{hits:hits,start:start,end:end,count:count.size}}highlightKeyword(val,slice){let result='',index=slice.start;for(var{position,length}of slice.hits)result+=val.substring(index,position),index=position+length,result+=`<mark class="search-keyword">${val.substr(position,length)}</mark>`;return result+=val.substring(index,slice.end)}getResultItems(keywords){let resultItems=[];return this.datas.forEach(({title,content,url})=>{var[indexOfTitle,keysOfTitle]=this.getIndexByWord(keywords,title),[indexOfContent,keysOfContent]=this.getIndexByWord(keywords,content),keysOfTitle=new Set([...keysOfTitle,...keysOfContent]).size,keysOfContent=indexOfTitle.length+indexOfContent.length;if(0!==keysOfContent){var slicesOfTitle=[];0!==indexOfTitle.length&&slicesOfTitle.push(this.mergeIntoSlice(0,title.length,indexOfTitle));let slicesOfContent=[];for(;0!==indexOfContent.length;){var position=indexOfContent[0].position,start=Math.max(0,position-20),position=Math.min(content.length,position+100);slicesOfContent.push(this.mergeIntoSlice(start,position,indexOfContent))}slicesOfContent.sort((left,right)=>left.count!==right.count?right.count-left.count:left.hits.length!==right.hits.length?right.hits.length-left.hits.length:left.start-right.start);indexOfTitle=parseInt(this.top_n_per_article,10);0<=indexOfTitle&&(slicesOfContent=slicesOfContent.slice(0,indexOfTitle));let resultItem='';(url=new URL(url,location.origin)).searchParams.append('highlight',keywords.join(' ')),resultItem+=0!==slicesOfTitle.length?`<li class="local-search-hit-item"><a href="${url.href}"><span class="search-result-title">${this.highlightKeyword(title,slicesOfTitle[0])}</span>`:`<li class="local-search-hit-item"><a href="${url.href}"><span class="search-result-title">${title}</span>`,slicesOfContent.forEach(slice=>{resultItem+=`<p class="search-result">${this.highlightKeyword(content,slice)}...</p></a>`}),resultItem+='</li>',resultItems.push({item:resultItem,id:resultItems.length,hitCount:keysOfContent,includedCount:keysOfTitle})}}),resultItems}fetchData(){let isXml=!this.path.endsWith('json');fetch(this.path).then(response=>response.text()).then(res=>{this.isfetched=!0,this.datas=isXml?[...(new DOMParser).parseFromString(res,'text/xml').querySelectorAll('entry')].map(element=>({title:element.querySelector('title').textContent,content:element.querySelector('content').textContent,url:element.querySelector('url').textContent})):JSON.parse(res),this.datas=this.datas.filter(data=>data.title).map(data=>(data.title=data.title.trim(),data.content=data.content?data.content.trim().replace(/<[^>]+>/g,''):'',data.url=decodeURIComponent(data.url).replace(/\/{2,}/g,'/'),data)),window.dispatchEvent(new Event('search:loaded'))})}highlightText(node,slice,className){var val=node.nodeValue;let index=slice.start;var position,length,children=[];for({position,length}of slice.hits){var text=document.createTextNode(val.substring(index,position)),mark=(index=position+length,document.createElement('mark'));mark.className=className,mark.appendChild(document.createTextNode(val.substr(position,length))),children.push(text,mark)}node.nodeValue=val.substring(index,slice.end),children.forEach(element=>{node.parentNode.insertBefore(element,node)})}highlightSearchWords(body){var params=new URL(location.href).searchParams.get('highlight');let keywords=params?params.split(' '):[];if(keywords.length&&body){for(var walk=document.createTreeWalker(body,NodeFilter.SHOW_TEXT,null),allNodes=[];walk.nextNode();)walk.currentNode.parentNode.matches('button, select, textarea, .mermaid')||allNodes.push(walk.currentNode);allNodes.forEach(node=>{var[indexOfNode]=this.getIndexByWord(keywords,node.nodeValue);indexOfNode.length&&(indexOfNode=this.mergeIntoSlice(0,node.nodeValue.length,indexOfNode),this.highlightText(node,indexOfNode,'search-keyword'))})}}}window.addEventListener('load',()=>{let{path,top_n_per_article,unescape,languages}=GLOBAL_CONFIG.localSearch,localSearch=new LocalSearch({path:path,top_n_per_article:top_n_per_article,unescape:unescape}),input=document.querySelector('#local-search-input input'),statsItem=document.getElementById('local-search-stats-wrap'),$loadingStatus=document.getElementById('loading-status'),isXml=!path.endsWith('json'),inputEventFunction=()=>{if(localSearch.isfetched){let searchText=input.value.trim().toLowerCase();''!==(searchText=isXml?searchText.replace(/</g,'&lt;').replace(/>/g,'&gt;'):searchText)&&($loadingStatus.innerHTML='<i class="fas fa-spinner fa-pulse"></i>');var keywords=searchText.split(/[-\s]+/),container=document.getElementById('local-search-results');let resultItems=[];0<searchText.length&&(resultItems=localSearch.getResultItems(keywords)),1===keywords.length&&''===keywords[0]?(container.textContent='',statsItem.textContent=''):0===resultItems.length?(container.textContent='',(keywords=document.createElement('div')).className='search-result-stats',keywords.textContent=languages.hits_empty.replace(/\$\{query}/,searchText),statsItem.innerHTML=keywords.outerHTML):(resultItems.sort((left,right)=>left.includedCount!==right.includedCount?right.includedCount-left.includedCount:left.hitCount!==right.hitCount?right.hitCount-left.hitCount:right.id-left.id),keywords=languages.hits_stats.replace(/\$\{hits}/,resultItems.length),container.innerHTML=`<ol class="search-result-list">${resultItems.map(result=>result.item).join('')}</ol>`,statsItem.innerHTML=`<hr><div class="search-result-stats">${keywords}</div>`,window.pjax&&window.pjax.refresh(container)),$loadingStatus.textContent=''}},loadFlag=!1,$searchMask=document.getElementById('search-mask'),$searchDialog=document.querySelector('#local-search .search-dialog'),fixSafariHeight=()=>{window.innerWidth<768&&$searchDialog.style.setProperty('--search-height',window.innerHeight+'px')},openSearch=()=>{btf.overflowPaddingR.add(),btf.animateIn($searchMask,'to_show 0.5s'),btf.animateIn($searchDialog,'titleScale 0.5s'),setTimeout(()=>{input.focus()},300),loadFlag||(localSearch.isfetched||localSearch.fetchData(),input.addEventListener('input',inputEventFunction),loadFlag=!0),document.addEventListener('keydown',function f(event){'Escape'===event.code&&(closeSearch(),document.removeEventListener('keydown',f))}),fixSafariHeight(),window.addEventListener('resize',fixSafariHeight)},closeSearch=()=>{btf.overflowPaddingR.remove(),btf.animateOut($searchDialog,'search_close .5s'),btf.animateOut($searchMask,'to_hide 0.5s'),window.removeEventListener('resize',fixSafariHeight)},searchClickFn=()=>{btf.addEventListenerPjax(document.querySelector('#search-button > .search'),'click',openSearch)};window.addEventListener('search:loaded',()=>{var $loadDataItem=document.getElementById('loading-database');$loadDataItem.nextElementSibling.style.display='block',$loadDataItem.remove()}),searchClickFn(),document.querySelector('#local-search .search-close-button').addEventListener('click',closeSearch),$searchMask.addEventListener('click',closeSearch),GLOBAL_CONFIG.localSearch.preload&&localSearch.fetchData(),localSearch.highlightSearchWords(document.getElementById('article-container')),window.addEventListener('pjax:complete',()=>{btf.isHidden($searchMask)||closeSearch(),localSearch.highlightSearchWords(document.getElementById('article-container')),searchClickFn()})});